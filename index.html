<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>SENA | Tablero 12 Reportes</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    :root{
      --g-900:#065f46;
      --g-800:#0f766e;
      --g-700:#15803d;
      --g-600:#16a34a;
      --g-500:#22c55e;

      --g-soft:#e9f7ef;
      --bg:#ffffff;
      --bg-soft:#f8fafc;

      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --warn:#f59e0b;
      --danger:#b91c1c;

      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:sticky; top:0; z-index: 100;}
    }

    /* Sidebar */
    .sidebar{
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, #fff, var(--g-soft));
      padding:16px;
      overflow-y: auto;
      height: 100vh;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px;
      border:1px solid rgba(34,197,94,.25);
      background: rgba(34,197,94,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      width:42px; height:42px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--g-600), var(--g-900));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.4);
    }
    .logo svg{width:26px; height:26px; display:block}

    .brand h1{margin:0; font-size:14px; letter-spacing:.2px}
    .brand p{margin:2px 0 0 0; font-size:12px; color:var(--muted); line-height:1.2}

    /* Menu Categories */
    details {
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid transparent;
    }
    details[open] {
      background-color: #fff;
      border-color: var(--border);
    }
    summary {
      padding: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: var(--g-800);
      list-style: none;
      border-radius: 8px;
      transition: background 0.2s;
    }
    summary:hover {
      background-color: var(--g-soft);
    }
    summary::after {
      content: '+'; 
      float: right;
      font-weight: bold;
    }
    details[open] summary::after {
      content: '-';
    }
    
    .nav-links{
      list-style:none; padding:0; margin:0;
      display: flex; flex-direction: column; gap: 4px;
      padding: 5px 10px 15px 10px;
    }
    .nav-links li button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:none;
      background:transparent;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
      transition:all .2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-links li button:hover{
      background:#f1f5f9;
      color:var(--text);
    }
    .nav-links li button.active{
      background:var(--g-600);
      color:#fff;
      font-weight:500;
      box-shadow: 0 4px 12px rgba(22,163,74,.3);
    }
    .badge{
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }

    /* Main Content */
    .main{
      padding:24px;
      background: var(--bg-soft);
      overflow-y: auto;
      height: 100vh;
    }
    .card{
      background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.10);
      padding: 18px 20px;
      margin-bottom: 24px;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }
    
    /* Upload Step */
    .upload-area{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:30px;
      text-align:center;
      transition:all .3s;
      background: #fafafa;
    }
    .upload-area:hover{
      border-color:var(--g-500);
      background:var(--g-soft);
    }
    .btn{
      background:var(--text); color:#fff;
      border:none; padding:10px 20px;
      border-radius:8px; cursor:pointer;
      font-weight:500; font-size:14px;
      transition:transform .1s;
    }
    .btn:active{transform:scale(0.97)}
    .btn-primary{
      background: linear-gradient(135deg, var(--g-600), var(--g-800));
    }

    /* Progress Bar */
    #progressContainer {
        margin-top: 15px;
        width: 100%;
        display: none; /* Hidden by default */
        text-align: center;
    }
    progress {
        width: 100%;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 10px;
    }
    progress::-webkit-progress-value {
        background-color: var(--g-500);
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    /* Tables */
    .table-container{
      overflow-x:hidden;
      border-radius:8px;
      border:1px solid var(--border);
    }

    
    /* SAT (r18): tabla sin scroll horizontal + anchos ajustados */
    #reportCard[data-report="r18"] .table-container{ overflow-x:hidden; }

    #reportCard[data-report="r18"] table{
      width:100%;
      min-width:0;
      table-layout:fixed;
    }
    #reportCard[data-report="r18"] th,
    #reportCard[data-report="r18"] td{
      padding:6px 6px;
      font-size:11px;
      line-height:1.25;
      vertical-align:top;
    }

    
    /* Ajustes de tabla — r14 (Instructor Responsable) */
    #reportCard[data-report="r14"] .table-container{ overflow-x:auto; }
    #reportCard[data-report="r14"] #dataTable{
      width:max-content;
      min-width:90%;
      margin:0 auto;
      table-layout:fixed;
    }
    #reportCard[data-report="r14"] th,
    #reportCard[data-report="r14"] td{
      padding:10px 12px;
      font-size:11px;
      line-height:1.2;
      vertical-align:top;
    }
    #reportCard[data-report="r14"] th{ white-space:normal; word-break:break-word; }
    #reportCard[data-report="r14"] td{ white-space:nowrap; }

    /* Anchos de columnas — r14 (incluye # como primera columna) */
    #reportCard[data-report="r14"] th:nth-child(1),
    #reportCard[data-report="r14"] td:nth-child(1){ width:48px; } /* # */
    #reportCard[data-report="r14"] th:nth-child(2),
    #reportCard[data-report="r14"] td:nth-child(2){ width:240px; } /* Instructor Responsable */
    #reportCard[data-report="r14"] th:nth-child(3),
    #reportCard[data-report="r14"] td:nth-child(3){ width:120px; } /* Cantidad de Fichas */
    #reportCard[data-report="r14"] th:nth-child(4),
    #reportCard[data-report="r14"] td:nth-child(4){ width:120px; } /* Cantidad de horas */
    #reportCard[data-report="r14"] th:nth-child(n+5),
    #reportCard[data-report="r14"] td:nth-child(n+5){ width:58px; } /* Métricas */

    
    /* Columnas ampliadas (x2) — r14 */
    #reportCard[data-report="r14"] th:nth-child(5),
    #reportCard[data-report="r14"] td:nth-child(5),
    #reportCard[data-report="r14"] th:nth-child(6),
    #reportCard[data-report="r14"] td:nth-child(6),
    #reportCard[data-report="r14"] th:nth-child(7),
    #reportCard[data-report="r14"] td:nth-child(7),
    #reportCard[data-report="r14"] th:nth-child(8),
    #reportCard[data-report="r14"] td:nth-child(8),
    #reportCard[data-report="r14"] th:nth-child(9),
    #reportCard[data-report="r14"] td:nth-child(9),
    #reportCard[data-report="r14"] th:nth-child(10),
    #reportCard[data-report="r14"] td:nth-child(10),
    #reportCard[data-report="r14"] th:nth-child(11),
    #reportCard[data-report="r14"] td:nth-child(11),
    #reportCard[data-report="r14"] th:nth-child(12),
    #reportCard[data-report="r14"] td:nth-child(12),
    #reportCard[data-report="r14"] th:nth-child(13),
    #reportCard[data-report="r14"] td:nth-child(13),
    #reportCard[data-report="r14"] th:nth-child(13),
    #reportCard[data-report="r14"] td:nth-child(13){ width:116px; }
/* Ajustes de tabla — r15 (Programa) */
    #reportCard[data-report="r15"] .table-container{ overflow-x:auto; }
    #reportCard[data-report="r15"] #dataTable{
      width:max-content;
      min-width:90%;
      margin:0 auto;
      table-layout:fixed;
    }
    #reportCard[data-report="r15"] th,
    #reportCard[data-report="r15"] td{
      padding:10px 12px;
      font-size:11px;
      line-height:1.2;
      vertical-align:top;
    }
    #reportCard[data-report="r15"] th{ white-space:normal; word-break:break-word; }
    #reportCard[data-report="r15"] td{ white-space:nowrap; }

    
    /* Programa: ajustar texto a la celda */
    #reportCard[data-report="r15"] td:nth-child(2){
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.15;
    }
/* Anchos de columnas — r15 */
    #reportCard[data-report="r15"] th:nth-child(1),
    #reportCard[data-report="r15"] td:nth-child(1){ width:48px; } /* # */
    #reportCard[data-report="r15"] th:nth-child(2),
    #reportCard[data-report="r15"] td:nth-child(2){ width:300px; } /* Programa */
    #reportCard[data-report="r15"] th:nth-child(3),
    #reportCard[data-report="r15"] td:nth-child(3){ width:120px; } /* Cantidad de Fichas */
    #reportCard[data-report="r15"] th:nth-child(n+4),
    #reportCard[data-report="r15"] td:nth-child(n+4){ width:58px; } /* Métricas */

    /* Columnas ampliadas (x2) — r15 */
    #reportCard[data-report="r15"] th:nth-child(4),
    #reportCard[data-report="r15"] td:nth-child(4),
    #reportCard[data-report="r15"] th:nth-child(5),
    #reportCard[data-report="r15"] td:nth-child(5),
    #reportCard[data-report="r15"] th:nth-child(6),
    #reportCard[data-report="r15"] td:nth-child(6),
    #reportCard[data-report="r15"] th:nth-child(7),
    #reportCard[data-report="r15"] td:nth-child(7),
    #reportCard[data-report="r15"] th:nth-child(8),
    #reportCard[data-report="r15"] td:nth-child(8),
    #reportCard[data-report="r15"] th:nth-child(9),
    #reportCard[data-report="r15"] td:nth-child(9),
    #reportCard[data-report="r15"] th:nth-child(10),
    #reportCard[data-report="r15"] td:nth-child(10),
    #reportCard[data-report="r15"] th:nth-child(11),
    #reportCard[data-report="r15"] td:nth-child(11),
    #reportCard[data-report="r15"] th:nth-child(12),
    #reportCard[data-report="r15"] td:nth-child(12),
    #reportCard[data-report="r15"] th:nth-child(13),
    #reportCard[data-report="r15"] td:nth-child(13){ width:116px; }
/* Ajuste de anchos por columna (sin Centro) — porcentajes para evitar scroll */
    #reportCard[data-report="r18"] th:nth-child(1),  #reportCard[data-report="r18"] td:nth-child(1){  width:6%; }  /* Severidad */
    #reportCard[data-report="r18"] th:nth-child(2),  #reportCard[data-report="r18"] td:nth-child(2){  width:4%; }  /* Score */
    #reportCard[data-report="r18"] th:nth-child(3),  #reportCard[data-report="r18"] td:nth-child(3){  width:5%; }  /* Ficha */
    #reportCard[data-report="r18"] th:nth-child(4),  #reportCard[data-report="r18"] td:nth-child(4){  width:11%; } /* Programa */
    #reportCard[data-report="r18"] th:nth-child(5),  #reportCard[data-report="r18"] td:nth-child(5){  width:9%; }  /* Responsable */
    #reportCard[data-report="r18"] th:nth-child(6),  #reportCard[data-report="r18"] td:nth-child(6){  width:5%; }  /* Días a fin */

    /* Columnas numéricas compactas */
    #reportCard[data-report="r18"] th:nth-child(7),  #reportCard[data-report="r18"] td:nth-child(7){  width:5%; }  /* % Con juicio */
    #reportCard[data-report="r18"] th:nth-child(8),  #reportCard[data-report="r18"] td:nth-child(8){  width:5%; }  /* En Tránsito */
    #reportCard[data-report="r18"] th:nth-child(9),  #reportCard[data-report="r18"] td:nth-child(9){  width:5%; }  /* Sin Ruta */
    #reportCard[data-report="r18"] th:nth-child(10), #reportCard[data-report="r18"] td:nth-child(10){ width:6%; }  /* Sin Programar */
    #reportCard[data-report="r18"] th:nth-child(11), #reportCard[data-report="r18"] td:nth-child(11){ width:6%; }  /* Retención % */

    /* Alertas: más espacio para lectura */
    #reportCard[data-report="r18"] th:nth-child(12), #reportCard[data-report="r18"] td:nth-child(12){ width:14%; } /* Alertas */
    #reportCard[data-report="r18"] td:nth-child(12){ white-space:normal; overflow-wrap:anywhere; word-break:break-word; }

    /* Columnas explicativas */
    #reportCard[data-report="r18"] th:nth-child(13), #reportCard[data-report="r18"] td:nth-child(13){ width:9%; }  /* Causa probable */
    #reportCard[data-report="r18"] th:nth-child(14), #reportCard[data-report="r18"] td:nth-child(14){ width:10%; } /* Acción recomendada */
    #reportCard[data-report="r18"] th:nth-child(15), #reportCard[data-report="r18"] td:nth-child(15){ width:7%; }  /* Responsable SAT */
    #reportCard[data-report="r18"] th:nth-child(16), #reportCard[data-report="r18"] td:nth-child(16){ width:5%; }  /* SLA */

    #reportCard[data-report="r18"] td:nth-child(4),
    #reportCard[data-report="r18"] td:nth-child(5),
    #reportCard[data-report="r18"] td:nth-child(13),
    #reportCard[data-report="r18"] td:nth-child(14),
    #reportCard[data-report="r18"] td:nth-child(15){
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

/* Compacto y centrado (Resumen/Backlog/Top/Ocupación) */
    .table-container.compact{
      max-width: 1550px;
      margin: 0 auto;
    }
    #dataTable.compact th, 
    #dataTable.compact td{
      text-align:center !important;
      padding:6px 8px;
      font-size:12px;
      line-height:1.25;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed; /* evita scroll horizontal: ajusta columnas al contenedor */
    }
    th, td{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.25;
      vertical-align:top;
    }
    th{
      background:#f8fafc;
      font-weight:600;
      color:var(--muted);
      position:sticky; top:0;
    }
    
    .sort-ind{font-size:10px; color:var(--muted); flex-shrink:0;}

    .th-wrap{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      white-space:normal;
    }
    /* Compact headers truly centered (fix flex layout) */
    #dataTable.compact th .th-wrap{
      justify-content:center;
      align-items:center;
    }

    /* Charts (similar to tabla.html) */
    .charts-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom: 18px;
    }
    /* Compact charts (Resumen ejecutivo global y Embudo operativo) */
    .charts-grid.small-charts{
      grid-template-columns: repeat(2, minmax(0, 320px));
      justify-content:center;
      gap:10px;
    }
    @media (max-width: 980px){
      .charts-grid{grid-template-columns:1fr;}
      .charts-grid.small-charts{grid-template-columns:1fr;}
    }
.chart-card{
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding:12px;
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
    }
    .chart-title{
      margin:0 0 8px 0;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .chart-card canvas{max-width:100%;}
    .chart-wrap{
      position:relative;
      height:260px;
      width:100%;
    }
    .chart-wrap.h220{height:220px;}
    .chart-wrap.h230{height:230px;}
    .chart-wrap.h240{height:240px;}
    .chart-wrap.h260{height:260px;}
    .chart-wrap.h280{height:280px;}
        .h360{height:360px;}
        .chart-wrap.hAutoSat{height:auto; max-height:320px; overflow-y:auto; overflow-x:hidden;}
.chart-wrap canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }
    /* Full-width charts for r13/r17 */
    .charts-grid.full-width{
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .charts-grid.full-width{grid-template-columns:1fr;}
    }



    
    
    .chart-card.small{
      padding:8px;
      max-width: 320px;
      justify-self:center;
    }
    .chart-card.small .chart-title{
      font-size:12px;
      margin-bottom:6px;
    }
    .sort-controls{
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .sort-btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      padding:2px 6px;
      border-radius:6px;
      font-size:10px;
      cursor:pointer;
      line-height:1.2;
    }
    .sort-btn:hover{
      border-color: rgba(22,163,74,.35);
      color: var(--text);
    }
    .sort-btn.active{
      border-color: var(--g-600);
      color: var(--g-900);
      background: rgba(34,197,94,.10);
      font-weight:600;
    }
tr:hover{background:#f1f5f9}
    .num{text-align:right}


    /* Dashboard: KPIs arriba 100% */
    #dashboardArea .dash-kpis{ width:100%; }

    /* KPI cards (v2) */
    #dashboardArea .dash-kpis{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin: 12px 0 14px;
    }
    #dashboardArea .kpi-top-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 1400px){
      #dashboardArea .kpi-top-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 980px){
      #dashboardArea .kpi-top-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      #dashboardArea .kpi-top-grid{ grid-template-columns: 1fr; }
    }
    #dashboardArea .kpi-card{
      border: 1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      padding: 14px 16px 12px;
      min-height: 92px;
      height:100%;
      display:flex;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 1px 0 rgba(2,6,23,.04);
    }
    #dashboardArea .kpi-left{ min-width:0; }
    #dashboardArea .kpi-title{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .01em;
    }
    #dashboardArea .kpi-value{
      margin-top: 6px;
      font-size: 28px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #dashboardArea .kpi-meta{
      margin-top: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      font-size: 11px;
      color: var(--muted);
    }
    #dashboardArea .kpi-pill{
      display:inline-flex;
      align-items:center;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      color: rgba(37,99,235,1);
      font-weight: 800;
      border: 1px solid rgba(37,99,235,.12);
    }
    #dashboardArea .kpi-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:flex-start;
      gap:8px;
      flex:0 0 auto;
    }
    #dashboardArea .kpi-badge{
      font-size: 12px;
      font-weight: 900;
      line-height:1;
      color: var(--g-700);
    }
    #dashboardArea .kpi-badge.purple{ color: #7c3aed; }
    #dashboardArea .kpi-badge.red{ color: #dc2626; }
    #dashboardArea .kpi-icon{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(100,116,139,.08);
      color: rgba(100,116,139,1);
    }
    #dashboardArea .kpi-progress{
      margin-top: 10px;
      height: 8px;
      background: rgba(226,232,240,1);
      border-radius: 999px;
      overflow:hidden;
    }
    #dashboardArea .kpi-progress > span{
      display:block;
      height:100%;
      background: rgba(34,197,94,1);
      width: 0%;
    }

    /* Embudo */
    #dashboardArea .kpi-embudo{
      border: 1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      padding: 12px 14px 12px;
    }
    #dashboardArea .kpi-embudo-head{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      color: var(--g-900);
    }
    #dashboardArea .kpi-embudo-head .ico{
      color: rgba(16,185,129,1);
      display:inline-flex;
      align-items:center;
    }
    #dashboardArea .kpi-steps{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 1100px){
      #dashboardArea .kpi-steps{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 640px){
      #dashboardArea .kpi-steps{ grid-template-columns: 1fr; }
    }
    #dashboardArea .step-card{
      background: rgba(248,250,252,1);
      border: 1px solid rgba(226,232,240,1);
      border-radius: 14px;
      padding: 12px 14px;
      position: relative;
      overflow: visible;
      min-height: 78px;
    }
    #dashboardArea .step-card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:4px;
      border-radius: 14px 0 0 14px;
      background: rgba(59,130,246,1);
    }
    #dashboardArea .step-card:not(:last-child)::after{
      content:"›";
      position:absolute;
      right:-14px;
      top:50%;
      transform: translateY(-50%);
      font-size: 26px;
      color: rgba(203,213,225,1);
      font-weight: 800;
      pointer-events:none;
    }
    #dashboardArea .step-title{
      font-size: 11px;
      font-weight: 900;
      color: rgba(37,99,235,1);
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    #dashboardArea .step-value{
      margin-top: 10px;
      font-size: 22px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.05;
    }
    #dashboardArea .step-sub{
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
    }
    #dashboardArea .step-icon{
      position:absolute;
      right: 10px;
      top: 10px;
      opacity: .55;
      color: rgba(100,116,139,1);
    }
    #dashboardArea .step-card.step-induccion::before{ background: rgba(99,102,241,1); }
    #dashboardArea .step-card.step-induccion .step-title{ color: rgba(79,70,229,1); }
    #dashboardArea .step-card.step-formacion::before{ background: rgba(16,185,129,1); }
    #dashboardArea .step-card.step-formacion .step-title{ color: rgba(5,150,105,1); }
    #dashboardArea .step-card.step-cert::before{ background: rgba(20,184,166,1); }
    #dashboardArea .step-card.step-cert .step-title{ color: rgba(13,148,136,1); }

    /* KPI extra row */
    #dashboardArea .kpi-extra-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 1200px){
      #dashboardArea .kpi-extra-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      #dashboardArea .kpi-extra-grid{ grid-template-columns: 1fr; }
    }
    #dashboardArea .kpi-mini{
      border: 1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    #dashboardArea .kpi-mini .t{ font-size:11px; color: var(--muted); font-weight:800; text-transform:uppercase; letter-spacing:.04em; }
    #dashboardArea .kpi-mini .v{ font-size:20px; font-weight:950; color: var(--text); margin-top:6px; line-height:1.05; }


    /* Dashboard: fila única de filtros (en el mismo div, uno seguido del otro) */
    #dashboardArea .dash-inline-filters{
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
  overflow:visible;
  padding-bottom:0;
  margin-bottom:12px;
}
.dash-inline-filters .dash-search{ flex: 1 1 520px; min-width: 320px; }
.dash-inline-filters .dash-year-dd{ flex: 0 0 180px; width: 180px; }
@media (max-width: 700px){
  .dash-inline-filters .dash-year-dd{ flex: 1 1 240px; width: auto; }
}

    #dashboardArea .dash-inline-filters::-webkit-scrollbar{ height:8px; }
    #dashboardArea .dash-inline-filters::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.35); border-radius:999px; }

    #dashboardArea .fblk{
      flex:0 0 auto;
      min-width:180px;
      max-width:240px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
    }
    #dashboardArea .fblk-title{
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
      margin-bottom:8px;
    }

    /* Bloque búsqueda más angosto */
    #dashboardArea .f-search{ min-width:220px; max-width:280px; }
    #dashboardArea .f-search .dash-search{ margin:0; }
    #dashboardArea .f-search input[type=search]{ width:100%; }
    #dashboardArea .f-search details.year-dd{ margin-top:8px; }
    /* Reutiliza estilo slicer dentro de bloques pequeños */
    #dashboardArea .fblk .slicer{ box-shadow:none; border:0; padding:0; }
    #dashboardArea .fblk .slicer-head{ display:none; }

    /* Excepción: Programa/Responsable deben mostrar botón "Nada" */
    #dashboardArea .fblk.f-prog .slicer-head,
    #dashboardArea .fblk.f-resp .slicer-head{
      display:flex;
      align-items:center;
      justify-content:flex-end; /* solo mostrar herramientas */
      gap:8px;
      margin: 0 0 8px 0;
    }
    #dashboardArea .fblk.f-prog .slicer-head .slicer-title,
    #dashboardArea .fblk.f-resp .slicer-head .slicer-title{ display:none; }

    #dashboardArea .fblk.f-prog,
    #dashboardArea .fblk.f-resp{
      min-width:240px;
      max-width:320px;
    }


    /* Agrupación vertical Programa + Responsable */
    #dashboardArea .fblk-stack{
      flex:0 0 auto;
      min-width:240px;
      max-width:320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #dashboardArea .fblk-stack .fblk{
      width:100%;
      min-width:0;
      max-width:none;
      margin:0;
    }
    #dashboardArea .fblk-stack .fblk.fblk-compact{
      padding:8px 10px;
    }
    #dashboardArea .fblk-stack .slicer-selected{
      max-height:48px;
      overflow:auto;
    }
    #dashboardArea .fblk-stack .slicer-search{
      padding:6px 8px;
    }

    /* Slicers Programa/Responsable con solo barra de búsqueda */
    .slicer-search{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      outline:none;
      font-size:12px;
      background:#fff;
    }
    .slicer-search:focus{ border-color: var(--g-500); box-shadow:0 0 0 3px rgba(34,197,94,.18); }
    .slicer-selected{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .slicer-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border:1px solid var(--border);
      border-radius:999px; background: var(--bg-soft);
      font-size:11px; max-width:100%;
    }
    .slicer-chip span{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
    .slicer-chip button{ border:0; background:transparent; cursor:pointer; color:var(--muted); font-weight:700; line-height:1; }

    /* Dashboard: grid principal (izquierda resto / derecha contenido) */
    #dashboardArea .dash-grid{ grid-template-columns: 330px 1fr; gap:14px; }
    #dashboardArea .dash-main{ min-width:0; }
    .ctr{text-align:center}
    .th-counter{width:52px; text-align:center}
    .th-counter .th-wrap{justify-content:center}

    
    /* Stats */
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:20px;
    }
    .stat-card{
      background:#fff; border:1px solid var(--border);
      padding:16px; border-radius:12px;
    }
    .stat-val{font-size:24px; font-weight:700; color:var(--text)}
    .stat-lbl{font-size:12px; color:var(--muted)}


    /* Table Tools (Búsqueda + filtros + año) */
    .table-tools{
      margin: 0 0 14px 0;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    .tools-top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content: space-between;
    }
    .tools-divider{
      height:1px;
      background: rgba(2,6,23,.06);
      margin: 12px 0;
    }

    /* Search */
    .searchbox{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      height: 40px;
      padding: 0 12px;
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 10px;
      background: #fff;
      color: var(--muted);
    }
    .searchbox .icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color: #64748b;
    }
    .searchbox input{
      border:none !important;
      outline:none !important;
      margin:0 !important;
      padding:0 !important;
      height: 38px;
      font-size: 13px;
      color: var(--text);
      background: transparent;
    }

    .searchbox svg{
      width:16px;
      height:16px;
      max-width:16px;
      max-height:16px;
      flex: 0 0 auto;
      display:block;
    }

    /* Pivot-like table (DF-03 Aprendices) */
    .pivot-head th{
      background: rgba(226,232,240,.95);
      color: #0f172a;
      font-weight: 700;
      font-size: 12px;
    }
    .pivot-total td{
      background: rgba(226,232,240,.75);
      font-weight: 700;
      border-top: 2px solid rgba(2,6,23,.12);
    }
    .num{ text-align:right !important; }
    .pivot-caption{
      font-size:12px;
      color: var(--muted);
      margin: 10px 0 8px 0;
    }

    .searchbox.disabled{
      background: rgba(2,6,23,.02);
      opacity: .85;
    }

    /* Year dropdown (multi-select) */
    .year-dd{
      position: relative;
      min-width: 190px;
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 10px;
      background: #fff;
    }
    .year-dd > summary{
      list-style:none;
      cursor:pointer;
      padding: 0 12px;
      height: 40px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      user-select:none;
      color: var(--text);
      font-size: 13px;
      border-radius: 10px;
    }
    .year-s-left{
      display:flex;
      align-items:center;
      gap:10px;
      color: #111827;
      font-weight: 600;
    }
    .year-dd > summary::-webkit-details-marker{ display:none; }
    .year-dd[open]{
      border-color: rgba(34,197,94,.75);
      box-shadow: 0 0 0 2px rgba(34,197,94,.20);
    }
    .year-panel{
      position:absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 260px;
      padding: 10px 12px;
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 10px 25px rgba(2,6,23,.12);
      z-index: 50;
      max-height: 280px;
      overflow:auto;
    }
    .year-panel-title{
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 8px;
    }
    .year-opt{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 7px 8px;
      border-radius: 10px;
      font-size: 13px;
      color: #0f172a;
      cursor:pointer;
    }
    .year-opt:hover{ background: rgba(2,6,23,.03); }
    .year-opt input{ width:auto; margin:0; }

    /* Filter blocks */
    .filters-block{ margin-top: 10px; }
    .filters-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      margin: 0 0 8px 0;
    }
    .filters-label{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #64748b;
    }
    .filters-label::before{
      content:"";
      width: 3px;
      height: 14px;
      border-radius: 999px;
      background: rgba(2,6,23,.12);
      display:inline-block;
    }
    .clear-link{
      background: transparent;
      border: none;
      padding: 0;
      font-size: 12px;
      font-weight: 600;
      color: #16a34a;
      cursor: pointer;
    }
    .clear-link:hover{ text-decoration: underline; }

    .level-filters, .prog-filters{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }

    /* Nivel buttons (filled) */
    .level-btn{
      --btn:#0f766e;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(2,6,23,.10);
      background: rgba(2,6,23,.02);
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      cursor:pointer;
      line-height: 1;
      transition: transform .05s, background .15s, border-color .15s, color .15s;
    }
    .level-btn:active{ transform: scale(0.98); }
    .level-btn .check{
      width: 14px;
      display:inline-flex;
      justify-content:center;
      opacity: 0;
      color: #fff;
      font-weight: 800;
    }
    .level-btn.active{
      background: var(--btn);
      border-color: var(--btn);
      color: #fff;
    }
    .level-btn.active .check{ opacity: 1; }

    /* Programa especial (pastel) */
    .prog-btn{
      --btn:#e2e8f0;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border:1px solid rgba(2,6,23,.10);
      background: rgba(2,6,23,.02);
      color: #0f172a;
      font-size: 12px;
      cursor: pointer;
      line-height: 1;
      transition: transform .05s, background .15s, border-color .15s, color .15s;
    }
    .prog-btn:active{ transform: scale(0.98); }
    .prog-btn.active{
      background: var(--btn);
      border-color: rgba(2,6,23,.18);
      color: var(--text);
      font-weight: 700;
    }
.chart-card.full-span{ grid-column: 1 / -1; }
/* Utilities */
    .hidden{display:none}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    input, select{
      width:100%; padding:8px 12px;
      border:1px solid var(--border);
      border-radius:6px; margin-top:4px;
      font-size:13px;
    }
  
    /* =========================================================
       AJUSTE 1: Archivos esperados + lista de chequeo
       ========================================================= */
    .expected-files{
      margin:0 0 12px 18px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .expected-files li{ margin: 6px 0; }
    .expected-files strong{ color: var(--text); font-weight: 800; }

    .checklist{
      margin-top: 14px;
      text-align:left;
      max-width: 860px;
      margin-left:auto;
      margin-right:auto;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 6px 14px rgba(2,6,23,.05);
    }
    .checklist-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .checklist-title h4{
      margin:0;
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .checklist-count{
      font-size:12px;
      font-weight:800;
      color: var(--text);
      white-space:nowrap;
    }
    .check-items{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .check-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border:1px solid rgba(2,6,23,.06);
      border-radius: 10px;
      background: #fafafa;
    }
    .check-name{
      font-size:12px;
      color: var(--text);
      font-weight:700;
      line-height:1.2;
    }
    .check-hint{
      font-size:11px;
      color: var(--muted);
      margin-top:3px;
    }
    .check-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius: 999px;
      font-size:11px;
      font-weight:900;
      letter-spacing:.02em;
      flex-shrink:0;
      margin-top:1px;
    }
    .check-status.ok{
      background: rgba(34,197,94,.12);
      color: #15803d;
      border:1px solid rgba(34,197,94,.25);
    }
    .check-status.miss{
      background: rgba(185,28,28,.10);
      color: #b91c1c;
      border:1px solid rgba(185,28,28,.20);
    }
    .check-status.pending{
      background: rgba(2,6,23,.05);
      color: #475569;
      border:1px solid rgba(2,6,23,.08);
    }

    /* =========================================================
       AJUSTE 2: Footer (según imagen)
       ========================================================= */
    .main{ padding-bottom: 120px; }
    .sidebar{ padding-bottom: 120px; }

    .app-footer{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding: 10px 14px;
      background: rgba(255,255,255,.96);
      border-top:1px solid var(--border);
      backdrop-filter: blur(8px);
      z-index: 500;
    }
    .footer-stack{
      width:100%;
      max-width: 520px;
      margin:0 auto;
      text-align:center;
    }
    .footer-title{
      font-size:11px;
      font-weight:900;
      letter-spacing:.22em;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .footer-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(2,6,23,.08);
      background:#fff;
      box-shadow: 0 10px 25px rgba(2,6,23,.12);
    }
    .footer-icon{
      width:34px;
      height:34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 34px;
    }
    .footer-icon.left{
      background:#f97316;
      color:#fff;
      font-size:20px;
      font-weight:900;
      line-height:1;
    }
    .footer-icon.right{
      background:#fff;
      border:1px solid rgba(37,99,235,.22);
      color:#2563eb;
    }
    .footer-user{
      flex:1;
      text-align:left;
      line-height:1.1;
    }
    .footer-role{
      font-size:11px;
      font-weight:900;
      letter-spacing:.10em;
      color:#94a3b8;
      text-transform:uppercase;
    }
    .footer-name{
      font-size:13px;
      font-weight:900;
      color:#0f172a;
    }
    .footer-btn{
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
    }
    .footer-btn:focus{
      outline:2px solid rgba(37,99,235,.35);
      outline-offset:2px;
      border-radius:999px;
    }
    @media (max-width: 980px){
      .footer-stack{ max-width: 480px; }
    }

    /* =========================
       SAT (Alertas Tempranas)
       ========================= */
    .sat-pill{
      display:inline-flex;
      align-items:center;
      padding:3px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid rgba(15,23,42,.15);
      background:rgba(15,23,42,.05);
      color:#0f172a;
      white-space:nowrap;
    }
    .sat-red{ background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.25); color:#7f1d1d; }
    .sat-orange{ background: rgba(249,115,22,.14); border-color: rgba(249,115,22,.28); color:#7c2d12; }
    .sat-yellow{ background: rgba(234,179,8,.16); border-color: rgba(234,179,8,.30); color:#713f12; }
    .sat-gray{ background: rgba(100,116,139,.12); border-color: rgba(100,116,139,.25); color:#334155; }

    .sat-mini{
      display:inline-block;
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.04);
      white-space:nowrap;
    }

    
    .sat-heatmap{
      width:100%;
      overflow-x:hidden;
      overflow-y:auto;
    }
    .sat-heatmap table{
      width:100%;
      table-layout:fixed;
      border-collapse:separate;
      border-spacing:0;
    }
    .sat-heatmap th, .sat-heatmap td{
      border-bottom:1px solid var(--border);
      border-right:1px solid var(--border);
      padding:8px 8px;
      font-size:12px;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sat-heatmap thead th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:3;
      font-weight:900;
    }
    .sat-heatmap thead th:first-child{ width:52px; }
    .sat-heatmap thead th:nth-child(2){ width:38%; }
    .sat-heatmap thead th:nth-child(n+3){ width:12%; }

    /* Col 1 (#): sticky + centrado */
    .sat-heatmap th:first-child, .sat-heatmap td:first-child{
      position:sticky;
      left:0;
      background:#fff;
      text-align:center;
      font-weight:800;
      z-index:4;
      white-space:nowrap;
    }
    /* Col 2 (Centro): sticky */
    .sat-heatmap th:nth-child(2), .sat-heatmap td:nth-child(2){
      position:sticky;
      left:52px;
      background:#fff;
      text-align:left;
      font-weight:800;
      z-index:3;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      word-break:break-word;
    }
    .sat-heatmap td{
      font-variant-numeric: tabular-nums;
    }

  
/* =========================================================
   FICHA ACUMULATIVA (DF-03)
   ========================================================= */
.fa-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-top: 12px;
}
@media (max-width: 980px){
  .fa-grid{ grid-template-columns: 1fr; }
}
.fa-panel{
  border:1px solid var(--border);
  border-radius: 12px;
  background:#fff;
  padding:12px;
  box-shadow: 0 6px 14px rgba(2,6,23,.06);
}
.fa-panel h4{
  margin:0 0 10px 0;
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:.2px;
  text-transform:uppercase;
}
.fa-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  border:1px solid var(--border);
  background:#f8fafc;
  margin-right:6px;
  margin-bottom:6px;
}
.fa-dot{ width:10px; height:10px; border-radius:50%; background: var(--g-500); }
.fa-dot.red{ background: var(--danger); }
.fa-dot.amb{ background: var(--warn); }
.fa-dot.green{ background: var(--g-600); }
.fa-list{
  display:flex; flex-direction:column; gap:8px;
  max-height: 360px;
  overflow:auto;
  padding-right: 6px;
}
.fa-item{
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  background:#fff;
}
.fa-item .t{
  font-weight:700; font-size:12px;
  margin-bottom:4px;
}
.fa-item .m{
  font-size:12px; color:var(--muted);
  display:flex; gap:10px; flex-wrap:wrap;
}
.fa-apr-table td, .fa-apr-table th{ font-size:12px; }
.wa-btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(37,211,102,.35);
  background: rgba(37,211,102,.12);
  color:#0f172a;
  text-decoration:none;
  font-weight:700;
  font-size:12px;
  white-space:nowrap;
}

    /* ===== DF-03 (Ficha Acumulativa) - Datos generales / Competencias ===== */
    #faGeneralArea{margin: 8px 0 14px 0;}
    .fa-general{
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      background: #fff;
      padding:14px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .fa-general h4{margin:0; font-size:14px; color: var(--g-900);}
    .fa-kv{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .fa-kv .kv{
      border:1px solid rgba(2,6,23,.06);
      background: rgba(2,6,23,.02);
      border-radius:12px;
      padding:10px;
    }
    .fa-kv .k{
      font-size:11px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .fa-kv .v{
      font-size:13px;
      font-weight:800;
      color: var(--g-900);
      margin-top:4px;
      word-break: break-word;
    }
    .fa-details{
      margin-top:10px;
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .fa-details > summary{
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color: var(--g-900);
      background: rgba(2,6,23,.02);
      border-bottom:1px solid rgba(2,6,23,.08);
      list-style:none;
    }
    .fa-details > summary::-webkit-details-marker{display:none;}
    .fa-details > summary::after{content:"";} /* override sidebar plus/minus */
    .fa-details[open] > summary::after{content:"";}
    .fa-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:10px 12px 12px 12px;
    }
    .fa-tag{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(2,6,23,.03);
      border:1px solid rgba(2,6,23,.10);
      font-size:12px;
      font-weight:800;
      color: var(--g-900);
      max-width:100%;
    }

    /* ===== DF-03 (Ficha Acumulativa) - Diseño tipo "detalle" (estilo dashboard) ===== */
    .fa-general-v2{ padding:18px; }
    .fa-hero{ display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .fa-crumb{ display:flex; gap:8px; align-items:center; font-size:12px; color: var(--muted); font-weight:800; }
    .fa-badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(37,211,102,.35);
      background: rgba(37,211,102,.14);
      color: var(--g-900);
      font-weight:900;
      white-space:nowrap;
    }
    .fa-title-lg{ font-size:28px; font-weight:950; color: var(--g-900); margin:6px 0 2px 0; letter-spacing:-.02em; }
    .fa-responsable{ font-size:12px; color: var(--muted); font-weight:700; margin:2px 0 2px 0; }
    .fa-subline{ font-size:12px; color: var(--muted); font-weight:800; }
    .fa-progress-card{
      min-width: 280px;
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      background:#fff;
      padding:12px 14px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .fa-progress-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .fa-progress-top .t{ font-size:11px; color: var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; }
    .fa-progress-top .p{ font-size:12px; font-weight:950; color: var(--g-900); }
    .fa-progress-bar{ height:8px; border-radius:999px; background: rgba(2,6,23,.08); overflow:hidden; margin-top:10px; }
    .fa-progress-bar > span{ display:block; height:100%; background: rgba(37,211,102,.95); width:0%; }
    .fa-progress-dates{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; font-size:11px; color: var(--muted); font-weight:800; }
    .fa-kpi-row{
      display:grid;
      grid-template-columns: repeat(4, minmax(210px, 1fr));
      gap:12px;
      margin-top:14px;
    }
    .fa-kpi-card{
      background:#fff;
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(2,6,23,.05);
      position:relative;
      min-height:86px;
    }
    .fa-kpi-card .k{ font-size:11px; color: var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; }
    .fa-kpi-card .v{ font-size:26px; font-weight:950; color: var(--g-900); margin-top:6px; }
    .fa-kpi-card .s{ font-size:12px; color: var(--muted); margin-top:2px; font-weight:800; }
    .fa-kpi-mini{ display:flex; gap:10px; margin-top:8px; font-size:11px; color: var(--muted); font-weight:800; }
    .fa-kpi-mini b{ color: var(--g-900); }
    .fa-detail-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:16px;
    }
    .fa-detail-card{
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      background:#fff;
      padding:14px;
    }
    .fa-detail-title{
      display:flex; align-items:center; gap:10px;
      font-weight:950; color: var(--g-900);
      margin-bottom:10px;
    }
    .fa-detail-title .dot{
      width:18px; height:18px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(37,211,102,.18);
      border:1px solid rgba(37,211,102,.30);
      color: rgba(15,118,110,1);
      font-size:12px;
      line-height:1;
    }
    @media (max-width: 980px){
      .fa-kpi-row{ grid-template-columns: repeat(2, minmax(210px, 1fr)); }
    }
    @media (max-width: 560px){
      .fa-kpi-row{ grid-template-columns: 1fr; }
      .fa-title-lg{ font-size:22px; }
    }

    .pill-row{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background: rgba(2,6,23,.02);
      font-weight:800;
      font-size:12px;
      color: var(--g-900);
    }
    @media (max-width: 720px){
      .pill-row{justify-content:flex-start;}
    }



    /* ============================================================
       OVERRIDE r14/r15: sin scroll horizontal, ajustado a la hoja
       ============================================================ */
    #reportCard[data-report="r14"] .table-container,
    #reportCard[data-report="r15"] .table-container{
      overflow-x:hidden !important;
    }

    #reportCard[data-report="r14"] #dataTable,
    #reportCard[data-report="r15"] #dataTable{
      width:100% !important;
      max-width:100% !important;
      min-width:0 !important;
      margin:0 auto !important;
      table-layout:fixed !important;
    }

    #reportCard[data-report="r14"] th,
    #reportCard[data-report="r14"] td,
    #reportCard[data-report="r15"] th,
    #reportCard[data-report="r15"] td{
      white-space:normal !important;
      overflow-wrap:anywhere !important;
      word-break:break-word !important;
    }

    /* r14 (Instructor Responsable): anchos en % para encajar sin scroll */
    #reportCard[data-report="r14"] th:nth-child(1),
    #reportCard[data-report="r14"] td:nth-child(1){ width:3% !important; }
    #reportCard[data-report="r14"] th:nth-child(2),
    #reportCard[data-report="r14"] td:nth-child(2){ width:22% !important; }
    #reportCard[data-report="r14"] th:nth-child(3),
    #reportCard[data-report="r14"] td:nth-child(3){ width:8% !important; }
    #reportCard[data-report="r14"] th:nth-child(4),
    #reportCard[data-report="r14"] td:nth-child(4){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(5),
    #reportCard[data-report="r14"] td:nth-child(5){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(6),
    #reportCard[data-report="r14"] td:nth-child(6){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(7),
    #reportCard[data-report="r14"] td:nth-child(7){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(8),
    #reportCard[data-report="r14"] td:nth-child(8){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(9),
    #reportCard[data-report="r14"] td:nth-child(9){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(10),
    #reportCard[data-report="r14"] td:nth-child(10){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(11),
    #reportCard[data-report="r14"] td:nth-child(11){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(12),
    #reportCard[data-report="r14"] td:nth-child(12){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(13),
    #reportCard[data-report="r14"] td:nth-child(13){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(14),
    #reportCard[data-report="r14"] td:nth-child(14){ width:5.55% !important; }
    #reportCard[data-report="r14"] th:nth-child(15),
    #reportCard[data-report="r14"] td:nth-child(15){ width:5.55% !important; }


    /* r15 (Programa): anchos en % para encajar sin scroll */
    #reportCard[data-report="r15"] th:nth-child(1),
    #reportCard[data-report="r15"] td:nth-child(1){ width:3% !important; }
    #reportCard[data-report="r15"] th:nth-child(2),
    #reportCard[data-report="r15"] td:nth-child(2){ width:24% !important; }
    #reportCard[data-report="r15"] th:nth-child(3),
    #reportCard[data-report="r15"] td:nth-child(3){ width:8% !important; }
    #reportCard[data-report="r15"] th:nth-child(4),
    #reportCard[data-report="r15"] td:nth-child(4){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(5),
    #reportCard[data-report="r15"] td:nth-child(5){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(6),
    #reportCard[data-report="r15"] td:nth-child(6){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(7),
    #reportCard[data-report="r15"] td:nth-child(7){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(8),
    #reportCard[data-report="r15"] td:nth-child(8){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(9),
    #reportCard[data-report="r15"] td:nth-child(9){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(10),
    #reportCard[data-report="r15"] td:nth-child(10){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(11),
    #reportCard[data-report="r15"] td:nth-child(11){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(12),
    #reportCard[data-report="r15"] td:nth-child(12){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(13),
    #reportCard[data-report="r15"] td:nth-child(13){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(14),
    #reportCard[data-report="r15"] td:nth-child(14){ width:5.4% !important; }
    #reportCard[data-report="r15"] th:nth-child(15),
    #reportCard[data-report="r15"] td:nth-child(15){ width:5.4% !important; }


/* =========================
   DF-03 Dropzone (Ficha Acumulativa)
   ========================= */
.card.df03-card{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:30px;
      transition:all .3s;
      background: #fafafa;
      box-shadow:none;
      position:relative;
    }
    .card.df03-card .df03-head{ text-align:left; }
.df03-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  flex-wrap:wrap;
}
.df03-title{ display:flex; align-items:flex-start; gap:10px; }
.df03-title-ico{
  width:40px;
  height:40px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(2,6,23,.03);
  border:1px solid rgba(2,6,23,.08);
  color: var(--g-800);
  flex:0 0 40px;
}
.df03-h{ font-weight:900; color:var(--g-900); font-size:14px; }
.df03-sub{ color:var(--muted); font-size:12px; margin-top:4px; max-width:62ch; }
.df03-meta{ justify-content:flex-end; margin-top:2px; }

.df03-dropzone{
  margin-top:12px;
  border:2px dashed rgba(2,6,23,.14);
  border-radius:14px;
  padding:34px 18px;
  text-align:center;
  background:#fff;
  cursor:pointer;
  transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
  user-select:none;
}
.df03-dropzone:hover{
  border-color: rgba(34,197,94,.55);
  background: rgba(34,197,94,.05);
}
.df03-dropzone.dragover{
  border-color: rgba(34,197,94,.85);
  background: rgba(34,197,94,.08);
  box-shadow: inset 0 0 0 2px rgba(34,197,94,.18);
}
.df03-dropzone:focus{
  outline: 2px solid rgba(34,197,94,.35);
  outline-offset: 2px;
}
.df03-dropzone .dz-icon{
  width:56px;
  height:56px;
  margin: 0 auto 10px auto;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(2,6,23,.03);
  border:1px solid rgba(2,6,23,.08);
  color: var(--g-800);
}
.df03-dropzone .dz-h{
  font-size:14px;
  font-weight:900;
  color: var(--g-900);
  margin:0;
}
.df03-dropzone .dz-p{
  font-size:12px;
  color: var(--muted);
  margin-top:6px;
}
.df03-dropzone .dz-p a{
  color: var(--g-800);
  font-weight:900;
  text-decoration: underline;
}

.df03-filechips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
.df03-filechip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(2,6,23,.10);
  background: rgba(2,6,23,.02);
  font-weight:800;
  font-size:12px;
  color: var(--g-900);
  max-width:100%;
}
.df03-filechip .name{
  overflow:hidden;
  text-overflow: ellipsis;
  white-space:nowrap;
  max-width:52ch;
}

.df03-consulta{ margin-top:16px; }
.df03-consulta-title{ font-weight:900; color:var(--g-900); font-size:13px; }
.df03-consulta-box{ position:relative; margin-top:8px; }
.df03-consulta-row{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.df03-consulta-row input{
  flex:1 1 220px;
  font-size:15px;
  padding:10px;
  border-radius:10px;
  border:2px solid var(--g-soft);
}
.df03-consulta-row input:disabled{
  background: rgba(2,6,23,.03);
  border-color: rgba(2,6,23,.10);
  color: rgba(15,23,42,.65);
}
.df03-consulta-row .btn{ height:44px; }
.df03-consulta-row.disabled{ opacity:.75; }

.df03-consulta-lock{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
.lock-pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(2,6,23,.10);
  background:#fff;
  box-shadow: 0 10px 25px rgba(2,6,23,.12);
  font-weight:900;
  color:#0f172a;
  font-size:12px;
}
.df03-consulta-hint{ font-size:12px; color: var(--muted); margin-top:6px; }

@media (max-width: 720px){
  .df03-meta{ justify-content:flex-start; }
}

/* =========================
   DASHBOARD (NOVEDADES)
   ========================= */
#dashboardArea{ margin-top: 10px; }
.dash-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:12px; }
.dash-title{ font-weight:900; color:var(--g-900); font-size:18px; letter-spacing:.2px; }
.dash-subtitle{ color:var(--muted); font-size:12px; margin-top:4px; max-width: 920px; line-height:1.35; }
.dash-actions{ display:flex; gap:8px; align-items:center; }
.dash-grid{ display:grid; grid-template-columns: 340px 1fr; gap:14px; }
@media (max-width: 1100px){
  .dash-grid{ grid-template-columns: 1fr; }
}
.dash-left{ display:flex; flex-direction:column; gap:12px; }
.dash-main{ display:flex; flex-direction:column; gap:12px; min-width: 0; }

.dash-card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 1px 0 rgba(0,0,0,0.02);
}
.dash-card-title{ font-weight:800; color:var(--g-900); font-size:13px; margin-bottom:10px; }
.dash-note{ margin-top:8px; font-size:12px; color:var(--muted); }

.dash-search{
  display:flex; align-items:center; gap:8px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  background: #fff;
}
.dash-search input{
  border: none;
  outline: none;
  width: 100%;
  font-size: 13px;
  background: transparent;
}

.dash-pills{ display:flex; flex-wrap:wrap; gap:6px; }
.dash-pill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 12px;
  color: #111;
  cursor: pointer;
  user-select:none;
}
.dash-pill .x{ font-weight:900; color: var(--muted); }
.dash-pill:hover{ border-color: #cfd8e3; }

.dash-quick{ display:flex; flex-direction:column; gap:8px; }
.dash-check{ display:flex; align-items:center; gap:10px; font-size: 12.5px; color:#111; }
.dash-check input{ width: 16px; height: 16px; }

.dash-slicers{ display:flex; flex-direction:column; gap:10px; }
.slicer{
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 10px;
  background: #fff;
}
.slicer-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.slicer-title{ font-weight:900; font-size: 12px; color: var(--g-900); text-transform:uppercase; letter-spacing:.4px; }
.slicer-tools{ display:flex; gap:6px; align-items:center; }
.slicer-tools button{
  border: 1px solid var(--border);
  background: #fff;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 12px;
  cursor: pointer;
}
.slicer-tools button:hover{ border-color:#cfd8e3; }
.slicer-search{
  margin-top: 8px;
  display:flex; align-items:center; gap:8px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 10px;
}
.slicer-search input{ border:none; outline:none; width:100%; font-size:12.5px; }
.slicer-options{ margin-top: 8px; max-height: 220px; overflow:auto; padding-right: 4px; }
/* Compactar slicers específicos */
#dashboardArea .fblk.f-tipo .slicer-options,
#dashboardArea .fblk.f-etapa .slicer-options{ max-height: 120px; }
#slicer_municipio .slicer-options{ max-height: 160px; }

.slicer-opt{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 6px 4px; border-radius: 10px; }
.slicer-opt:hover{ background: #f6f8fb; }
.slicer-opt.disabled{ opacity:.45; }
.slicer-opt label{ display:flex; align-items:center; gap:10px; font-size:12.5px; color:#111; cursor:pointer; min-width:0; }
.slicer-opt input{ width: 16px; height: 16px; }
.slicer-opt .count{ font-size:12px; color: var(--muted); white-space:nowrap; }

.dash-kpis{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
@media (max-width: 1100px){
  .dash-kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
.kpi{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  background: #fff;
}
.kpi .kpi-val{ font-size: 20px; font-weight: 900; color: var(--g-900); line-height: 1.05; }
.kpi .kpi-lab{ font-size: 12px; color: var(--muted); margin-top: 4px; }
.kpi .kpi-sub{ font-size: 12px; color: #111; margin-top: 8px; }

.dash-charts{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
@media (max-width: 1100px){
  .dash-charts{ grid-template-columns: 1fr; }
}
/* Layout: mapa a la izquierda, tres gráficos apilados a la derecha */
.dash-charts-top{ display:grid; grid-template-columns: 50% 50%; gap: 12px; align-items:stretch; }
.dash-chart-card.dash-chart-map{ min-height: 740px; }

.dash-chart-stack{ display:flex; flex-direction:column; gap: 12px; min-width:0; }
@media (max-width: 1100px){
  .dash-charts-top{ grid-template-columns: 50% 50%; }
}
.dash-charts-below{ margin-top: 12px; }
.dash-chart-wrap.h820{ height: 920px; }
.dash-chart-wrap.is-map{ display:flex; flex-direction:column; height:100%; }
.dash-chart-wrap.is-map .dash-map-toolbar{ flex:0 0 auto; }
.dash-chart-wrap.is-map .dash-leafletmap{ flex:1 1 auto; height:auto; }

.dash-map-hover-tip{
  position:absolute;
  z-index: 9999;
  pointer-events:none;
  background:#0f172a;
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  line-height:1.2;
  box-shadow: 0 8px 24px rgba(0,0,0,.18);
  white-space:nowrap;
  transform: translate3d(0,0,0);
}


.dash-chart-card{
  border: 1px solid var(--border);
  border-radius: 16px;
  background:#fff;
  padding: 12px;
  min-width:0;
}
.dash-chart-card.full{ grid-column: 1 / -1; }

.dash-chart-split{
  display:flex;
  gap:12px;
  align-items:stretch;
}
.dash-chart-split > .dash-chart-wrap{
  flex:1 1 0;
  position:relative;
}
.dash-mini-title{
  font-size:12px;
  color:#555;
  margin: 0 0 4px 2px;
}
.dash-chart-pane{
  padding-top:16px;
}
.dash-chart-pane .dash-mini-title{
  position:absolute;
  top:0;
  left:2px;
  margin:0;
}
.dash-chart-title{ font-weight: 800; font-size: 13px; color: var(--g-900); margin-bottom: 8px; }
.dash-chart-wrap{ width:100%; }
.dash-chart-wrap.h260{ height:260px; }
.dash-chart-wrap.h320{ height:320px; }
.dash-chart-wrap canvas{ width:100% !important; height:100% !important; }

/* Tile-map (tipo mapa) para Municipios */
.dash-map-toolbar{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.dash-map-legend{
  font-size:12px;
  color: var(--muted);
  line-height:1.2;
}
.dash-map-metric{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  color:#111;
}
.dash-map-metric label{ color: var(--muted); font-weight:700; }
.dash-map-metric select{
  border:1px solid var(--border);
  border-radius: 10px;
  padding: 6px 10px;
  font-size:12px;
  background:#fff;
}
.dash-tilemap{
  height: calc(100% - 34px);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 10px;
  overflow:auto;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  background: #fff;
}
.dash-tile{
  border: 1px solid rgba(2,6,23,.10);
  border-radius: 14px;
  padding: 10px;
  min-height: 70px;
  cursor:pointer;
  user-select:none;
  position:relative;
  overflow:hidden;
}
.dash-tile:hover{ border-color: rgba(2,6,23,.18); }
.dash-tile.selected{
  outline: 3px solid rgba(34,197,94,.35);
  border-color: rgba(34,197,94,.55);
}
.dash-tile .t-name{
  font-weight: 900;
  font-size: 12px;
  color: #0f172a;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 6px;
}
.dash-tile .t-val{
  font-weight: 900;
  font-size: 16px;
  color: var(--g-900);
}
.dash-tile .t-sub{
  font-size: 12px;
  color: rgba(15,23,42,.70);
  margin-top: 2px;
}
.dash-tile .t-bar{
  position:absolute;
  left:0; right:0; bottom:0;
  height: 6px;
  background: rgba(34,197,94,.22);
}

.dash-tables{ display:grid; grid-template-columns: 1fr; gap: 12px; }
.dash-table-wrap{ width:100%; overflow:auto; border: 1px solid var(--border); border-radius: 14px; background: #fff; }
.dash-table{ width:100%; border-collapse: separate; border-spacing: 0; font-size: 12.5px; }
.dash-table thead th{
  position: sticky; top: 0;
  background: #f7fafc;
  color: var(--g-900);
  font-weight: 900;
  text-align: left;
  padding: 10px 10px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.dash-table tbody td{
  padding: 9px 10px;
  border-bottom: 1px solid #eef2f7;
  vertical-align: top;
  white-space: nowrap;
}
.dash-table tbody tr:hover{ background: #f6f8fb; cursor: pointer; }
.dash-table .num{ text-align: right; }
.dash-table-topscroll{ width:100%; overflow-x:auto; overflow-y:hidden; height:14px; border: 1px solid var(--border); border-radius: 14px; background:#fff; }
.dash-table-topscroll-inner{ height:1px; }
.dash-pager{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; }
.dash-pager .pages{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.dash-pager button{ border:1px solid var(--border); background:#fff; color:var(--text); padding:6px 10px; border-radius:12px; cursor:pointer; font-size:12px; line-height:1; }
.dash-pager button:hover{ border-color: rgba(22,163,74,.35); }
.dash-pager button.active{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.55); font-weight:700; }
.dash-pager button:disabled{ opacity:.55; cursor:not-allowed; }
.dash-pager .meta{ white-space:nowrap; }
.dash-pager .ellipsis{ padding:0 6px; }
/* Dashboard: Overlay selección inicial de años */
.dash-year-overlay{ position:fixed; inset:0; background:rgba(15,23,42,.55); display:flex; align-items:center; justify-content:center; z-index:9999; }
.dash-year-overlay.hidden{ display:none; }
.dash-year-modal{ width:min(620px, calc(100vw - 28px)); background:#fff; border:1px solid rgba(15,23,42,.10); border-radius:18px; padding:18px; box-shadow: 0 20px 60px rgba(2,6,23,.28); }
.dash-year-modal-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:12px; }
.dash-year-modal-title{ font-weight:900; color:var(--text); font-size:16px; letter-spacing:.2px; }
.dash-year-modal-sub{ color:var(--muted); font-size:12px; margin-top:4px; }
.dash-year-actions{ display:flex; align-items:center; gap:8px; margin:12px 0 10px; flex-wrap:wrap; }
.dash-year-selected{ color:var(--muted); font-size:12px; white-space:nowrap; }
.dash-year-list{ border:1px solid var(--border); border-radius:14px; padding:10px 12px; max-height:280px; overflow:auto; }
.dash-year-list .year-opt{ display:flex; align-items:center; gap:10px; padding:8px 8px; border-radius:10px; cursor:pointer; }
.dash-year-list .year-opt:hover{ background: rgba(2,6,23,.03); }
.dash-year-footer{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:14px; flex-wrap:wrap; }
.dash-year-note{ color:var(--muted); font-size:12px; }



/* === Ajustes solicitados (tablas auto-fit + scroll + columnas avanzadas + mapa real) === */
.dash-table-wrap{ overflow-x:auto; }
/* FIX: permitir que el contenedor en CSS Grid se encoja y el scroll horizontal funcione */
.main{ min-width:0; } /* evita que el grid expanda la columna principal por contenido ancho */
.dash-card{ min-width:0; } /* evita que las cards se expandan por tablas anchas */
.dash-table-wrap{ min-width:0; max-width:100%; overflow-x:auto !important; }
.dash-table-wrap::-webkit-scrollbar{ height:10px; }
.dash-table-wrap::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.35); border-radius:999px; }

.dash-table{ width:max-content; min-width:100%; table-layout:auto; }
.dash-table th, .dash-table td{ white-space:nowrap; }
.dash-table td{ max-width: 340px; overflow:hidden; text-overflow:ellipsis; }
.dash-table th.sticky, .dash-table td.sticky{ position:sticky; left:0; background:#fff; z-index:2; }

/* Crit table (Top 25 por atraso): scroll horizontal (muchas columnas) */
#dashTblCrit{
  table-layout:auto !important;
  width:max-content !important;
  min-width:2600px; /* fuerza overflow horizontal para navegar columnas */

  display:inline-table !important;}
#dashTblCrit th, #dashTblCrit td{ white-space:nowrap; }
#dashTblCrit th.num, #dashTblCrit td.num{ min-width:90px; }
#dashTblCrit th:not(.num), #dashTblCrit td:not(.num){ min-width:160px; }
#dashTblCrit th:first-child, #dashTblCrit td:first-child{ min-width:110px; }

#dashTblMunicipio{
  table-layout:auto !important;
  width:max-content !important;
  min-width:2400px;
  display:inline-table !important;
}
#dashTblMunicipio th, #dashTblMunicipio td{ white-space:nowrap; }
#dashTblMunicipio th.num, #dashTblMunicipio td.num{ min-width:90px; }
#dashTblMunicipio th:first-child, #dashTblMunicipio td:first-child{ min-width:180px; }


/* Doble scroll horizontal (arriba + abajo) para Fichas Detalle */
#dashTblCritTopScroll{
  overflow-x:auto;
  overflow-y:hidden;
  max-width:100%;
  height:14px; /* muestra scrollbar superior */
}
#dashTblCritTopInner{ height:1px; }

/* Crit table: ordenar por encabezado (A-Z / Z-A) */
#dashTblCrit thead th.crit-sortable{
  cursor:pointer;
  user-select:none;
}
#dashTblCrit thead th.crit-sortable.sorted{
  background: rgba(17,24,39,0.04);
}
#dashTblCrit thead th.crit-sortable[data-sort-dir="asc"]::after{
  content:" ▲";
  font-size:0.78em;
  opacity:0.75;
}
#dashTblCrit thead th.crit-sortable[data-sort-dir="desc"]::after{
  content:" ▼";
  font-size:0.78em;
  opacity:0.75;
}

#dashTblMunicipio thead th.muni-sortable{
  cursor:pointer;
  user-select:none;
}
#dashTblMunicipio thead th.muni-sortable.sorted{
  background: rgba(17,24,39,0.04);
}
#dashTblMunicipio thead th.muni-sortable[data-sort-dir="asc"]::after{
  content:" ▲";
  font-size:0.78em;
  opacity:0.75;
}
#dashTblMunicipio thead th.muni-sortable[data-sort-dir="desc"]::after{
  content:" ▼";
  font-size:0.78em;
  opacity:0.75;
}

.dash-table th.sticky{ z-index:3; }
.dash-table.hide-adv th.adv, .dash-table.hide-adv td.adv{ display:none; }
.dash-card-title-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.btn.btn-sm{ padding:6px 10px; font-size:12px; border-radius:10px; }
.dash-leafletmap{ height: 320px; width:100%; border:1px solid var(--border); border-radius: 12px; overflow:hidden; }
.leaflet-container{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; }



/* =========================
   AJUSTES (Municipio + Unificación de segmentaciones)
   ========================= */
#dashboardArea .dash-grid{ grid-template-columns: 1fr !important; }
.dash-grid{ grid-template-columns: 1fr !important; }

.dash-slicers-all{ display:flex; flex-direction:column; gap:10px; }

/* Segmentaciones (layout tipo Power BI) */
.seg-head{ margin-bottom: 6px; }

/* Mejora visual de Segmentaciones (dash-card) */
#dashboardArea .seg-card{
  background: linear-gradient(180deg, rgba(16,185,129,0.08), rgba(255,255,255,0) 58%), var(--card);
  border-color: rgba(2,6,23,0.10);
  box-shadow: 0 14px 40px rgba(2,6,23,0.06);
  padding: 14px;
}
#dashboardArea .seg-card .seg-head{
  padding: 6px 4px 10px 4px;
  border-bottom: 1px solid rgba(2,6,23,0.06);
  margin: 0 0 10px 0;
}
#dashboardArea .seg-card .seg-title-row{ align-items:center; }

#dashboardArea .seg-icon{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  background: rgba(16,185,129,0.14);
  color: #059669;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: inset 0 0 0 1px rgba(5,150,105,0.20);
  margin-top: 0;
}
#dashboardArea .seg-icon svg{ width:18px; height:18px; }

/* Iconos en tarjetas de slicers */
#dashboardArea .slicer-head-left{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
#dashboardArea .slicer-ico{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
  box-shadow: inset 0 0 0 1px rgba(2,6,23,0.08);
}
#dashboardArea .slicer-ico svg{ width:16px; height:16px; }
#dashboardArea .sico-responsable{ background: rgba(59,130,246,0.14); color:#2563eb; }
#dashboardArea .sico-programa{ background: rgba(168,85,247,0.14); color:#7c3aed; }
#dashboardArea .sico-municipio{ background: rgba(239,68,68,0.14); color:#dc2626; }
#dashboardArea .sico-estadoCurso{ background: rgba(16,185,129,0.14); color:#059669; }
#dashboardArea .sico-nivel{ background: rgba(245,158,11,0.16); color:#b45309; }
#dashboardArea .sico-estado{ background: rgba(14,165,233,0.16); color:#0284c7; }
#dashboardArea .sico-modalidad{ background: rgba(20,184,166,0.16); color:#0f766e; }
#dashboardArea .sico-programaEspecial{ background: rgba(236,72,153,0.14); color:#db2777; }
#dashboardArea .sico-tipo{ background: rgba(100,116,139,0.18); color:#475569; }

/* Micro-afinaciones de slicers (sin cambiar funcionalidad) */
#dashboardArea .slicer{
  border-radius: 18px;
  padding: 12px;
}
#dashboardArea .slicer-head{ align-items:flex-start; }
#dashboardArea .slicer-title{ margin-top: 1px; }

.seg-title-row{ display:flex; gap:10px; align-items:flex-start; }
.seg-icon{ color: var(--accent); display:flex; margin-top:2px; }
.seg-title{ font-weight:900; color:var(--g-900); font-size:16px; line-height:1.1; }
.seg-subtitle{ color: var(--muted); font-size:12px; margin-top:2px; }
.seg-search{ height: 42px; }
.dash-year-dd{ height: 42px; }
.dash-year-dd summary{ height: 42px; display:flex; align-items:center; }

/* Acciones Todo | Nada como enlaces */
.slicer-tools{ gap:0; }
.slicer-tools button{
  border:none;
  background:transparent;
  padding:0;
  border-radius: 0;
  font-size: 11px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .2px;
  color: var(--muted);
}
.slicer-tools button:hover{ color: var(--g-900); }
.slicer-tools button + button{ margin-left: 8px; padding-left: 8px; position:relative; }
.slicer-tools button + button:before{
  content: "|";
  position:absolute;
  left:0;
  top:0;
  color:#cbd5e1;
}

/* Alturas consistentes de tarjetas */
.slicer{ min-height: 250px; }
.slicer-options{ max-height: 170px; overflow:auto; }
#slicer_municipio .slicer-options{ max-height: 190px; }
#slicer_programaEspecial .slicer-options{ max-height: 190px; }
#slicer_responsable .slicer-options{ max-height: 170px; }
#slicer_programa .slicer-options{ max-height: 170px; }
#slicer_estadoCurso .slicer-options{ max-height: 190px; }

.dash-slicers-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 1100px){
  .dash-slicers-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 720px){
  .dash-slicers-grid{ grid-template-columns: 1fr; }
}


/* Segmentaciones rápidas (tipo botones) */
.dash-fast-slicers{
  margin-top: 10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 1100px){
  .dash-fast-slicers{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 720px){
  .dash-fast-slicers{ grid-template-columns: 1fr; }
}
.fast-slicer{
  border:1px solid var(--border);
  border-radius: 16px;
  background:#fff;
  padding: 10px;
}
.fast-head{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.fast-title{
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .2px;
  text-transform: uppercase;
  color: var(--g-900);
}
.fast-tools button{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size: 11px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .2px;
  color: var(--muted);
}
.fast-tools button:hover{ color: var(--g-900); }

.fast-btns{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.fast-btn{
  border:1px solid rgba(2,6,23,.12);
  background: rgba(241,245,249,.7);
  color:#0f172a;
  border-radius: 999px;
  padding: 6px 10px;
  cursor:pointer;
  font-size: 12px;
  line-height:1;
  display:flex;
  gap:8px;
  align-items:center;
  max-width: 100%;
}
.fast-btn .lbl{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width: 220px;
}
.fast-btn .cnt{
  font-weight:900;
  color: var(--muted);
}
.fast-btn:hover{ border-color: rgba(22,163,74,.35); background: rgba(34,197,94,.10); }
.fast-btn.active{
  background: rgba(34,197,94,.16);
  border-color: rgba(34,197,94,.55);
}
.fast-btn.active .cnt{ color: var(--g-900); }
.fast-btn:disabled{ opacity:.55; cursor:not-allowed; }


/* Municipio: menor altura + scroll vertical */
#slicer_municipio .slicer-options{ max-height: 140px !important; overflow-y:auto; }
#slicer_municipio .slicer-search{ margin-top: 6px; padding: 6px 8px; }
#slicer_municipio .slicer-selected{ margin-top: 6px; }



/* Ajuste: reducir altura de ETAPA FICHA, TIPO y MODALIDAD */
#slicer_estado, #slicer_tipo, #slicer_modalidad{ min-height: 150px !important; }
#slicer_estado .slicer-options,
#slicer_tipo .slicer-options,
#slicer_modalidad .slicer-options{ max-height: 120px !important; overflow:auto; }


.dash-empty{ text-align:center; padding:14px; opacity:0.75; }

    /* Map details table (Ajuste: detalle por municipio) */
    .dash-chart-wrap.is-map{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .dash-chart-wrap.is-map .dash-map-toolbar{
      flex:0 0 auto;
    }
    .dash-chart-wrap.is-map #dashMapMunicipios{
      flex:1 1 auto;
      min-height: 460px;
      width:100%;
    }
    .dash-map-detail{
      flex:0 0 auto;
      width:100%;
    }
    .dash-map-detail-title{
      font-weight:700;
      font-size:12px;
      color:#0f172a;
      margin:0 0 6px 0;
    }
    .dash-map-detail-scroll{
      max-height: 160px;
      overflow:auto;
      border:1px solid rgba(15,23,42,.15);
      border-radius:12px;
      background:#fff;
      padding-bottom:6px;
    }
    table.dash-mini-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
    }
    table.dash-mini-table thead th{
      position:sticky;
      top:0;
      background:#f8fafc;
      z-index:1;
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid rgba(15,23,42,.12);
      white-space:nowrap;
    }
    table.dash-mini-table tbody td{
      padding:7px 10px;
      border-bottom:1px solid rgba(15,23,42,.08);
      vertical-align:top;
    }
    table.dash-mini-table tbody tr:hover{
      background:#f1f5f9;
      cursor:pointer;
    }
    table.dash-mini-table td.num, table.dash-mini-table th.num{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

.nav-links button.is-disabled{ opacity:.45; cursor:not-allowed; }
.nav-links button:disabled{ opacity:.45; cursor:not-allowed; }


/* =========================
   Dashboard - Tabla Aprendices DF-03
   ========================= */
.dash-apr-wrap{ overflow:auto; border:1px solid var(--border); border-radius:14px; background:#fff; }
.dash-apr-table{ width:100%; border-collapse:collapse; min-width: 1250px; }
.dash-apr-table th, .dash-apr-table td{ padding:10px 10px; border-bottom:1px solid rgba(2,6,23,.06); font-size:12.5px; }
.dash-apr-table th{ background:#f8fafc; position:sticky; top:0; z-index:1; text-align:left; font-weight:900; }
.dash-apr-table td.num, .dash-apr-table th.num{ text-align:right; font-variant-numeric: tabular-nums; }
.dash-apr-table tr:hover{ background:#f6f8fb; }
.dash-apr-phone{ display:inline-flex; align-items:center; gap:8px; }
.dash-apr-wa{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:10px; border:1px solid rgba(37,211,102,.35); background: rgba(37,211,102,.12); text-decoration:none; }
.dash-apr-wa svg{ width:16px; height:16px; }

    /* SAT (r18) — anchos de columnas y legibilidad */
    #reportCard[data-report="r18"] th,
    #reportCard[data-report="r18"] td{
      padding:10px 12px;
      font-size:11px;
      line-height:1.2;
      vertical-align:top;
    }
    #reportCard[data-report="r18"] th{ white-space:normal; word-break:break-word; }
    #reportCard[data-report="r18"] td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Permitir saltos de línea en columnas descriptivas */
    #reportCard[data-report="r18"] td:nth-child(13),
    #reportCard[data-report="r18"] td:nth-child(14),
    #reportCard[data-report="r18"] td:nth-child(15){
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
    }

    /* Anchos de columnas — r18 (incluye # como primera columna) */
    #reportCard[data-report="r18"] th:nth-child(1),
    #reportCard[data-report="r18"] td:nth-child(1){ width:48px; }  /* # */
    #reportCard[data-report="r18"] th:nth-child(2),
    #reportCard[data-report="r18"] td:nth-child(2){ width:160px; } /* Severidad */
    #reportCard[data-report="r18"] th:nth-child(3),
    #reportCard[data-report="r18"] td:nth-child(3){ width:70px; }  /* Score */
    #reportCard[data-report="r18"] th:nth-child(4),
    #reportCard[data-report="r18"] td:nth-child(4){ width:90px; }  /* Ficha */
    #reportCard[data-report="r18"] th:nth-child(5),
    #reportCard[data-report="r18"] td:nth-child(5){ width:260px; } /* Programa */
    #reportCard[data-report="r18"] th:nth-child(6),
    #reportCard[data-report="r18"] td:nth-child(6){ width:240px; } /* Instructor Responsable */

    /* Columnas numéricas / compactas */
    #reportCard[data-report="r18"] th:nth-child(7),
    #reportCard[data-report="r18"] td:nth-child(7){ width:78px; }  /* Días a fin */
    #reportCard[data-report="r18"] th:nth-child(8),
    #reportCard[data-report="r18"] td:nth-child(8){ width:78px; }  /* % Con juicio */
    #reportCard[data-report="r18"] th:nth-child(9),
    #reportCard[data-report="r18"] td:nth-child(9){ width:78px; }  /* En Tránsito */
    #reportCard[data-report="r18"] th:nth-child(10),
    #reportCard[data-report="r18"] td:nth-child(10){ width:78px; } /* Sin Ruta */
    #reportCard[data-report="r18"] th:nth-child(11),
    #reportCard[data-report="r18"] td:nth-child(11){ width:90px; } /* Sin Programar */
    #reportCard[data-report="r18"] th:nth-child(12),
    #reportCard[data-report="r18"] td:nth-child(12){ width:90px; } /* Retención % */

    #reportCard[data-report="r18"] th:nth-child(13),
    #reportCard[data-report="r18"] td:nth-child(13){ width:220px; } /* Alertas */
    #reportCard[data-report="r18"] th:nth-child(14),
    #reportCard[data-report="r18"] td:nth-child(14){ width:240px; } /* Causa probable */
    #reportCard[data-report="r18"] th:nth-child(15),
    #reportCard[data-report="r18"] td:nth-child(15){ width:360px; } /* Acción recomendada */
    #reportCard[data-report="r18"] th:nth-child(16),
    #reportCard[data-report="r18"] td:nth-child(16){ width:170px; } /* Responsable SAT */
    #reportCard[data-report="r18"] th:nth-child(17),
    #reportCard[data-report="r18"] td:nth-child(17){ width:130px; } /* SLA sugerido */

    /* Notas SAT */
    .sat-notes{
      max-width: 1200px;
      margin: 10px auto 12px;
      padding: 12px 14px;
      background: #f6fbf8;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .sat-notes .title{
      font-weight: 800;
      letter-spacing: .2px;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .sat-notes .grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 10px 14px;
    }
    @media (max-width: 900px){
      .sat-notes .grid{ grid-template-columns: 1fr; }
    }
    .sat-notes .box{
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .sat-notes .box h4{
      margin:0 0 6px 0;
      font-size: 12px;
      font-weight: 800;
    }
    .sat-notes ul{
      margin:0;
      padding-left: 16px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .sat-notes .sat-sub{
      margin-top: 6px;
      padding-left: 18px;
    }
    .sat-notes .sat-sub li{
      font-size: 11.5px;
      line-height: 1.3;
    }

/* =========================
   Reportes (PDF) selector
   ========================= */
.reports-panel{ display:none; }
.reports-panel .rp-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; }
.reports-panel .rp-title{ font-size:18px; font-weight:800; margin:0; }
.reports-panel .rp-sub{ color:var(--muted); margin-top:4px; font-size:13px; }
.reports-panel .rp-actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.reports-panel .rp-actions .btn{ padding:8px 12px; border-radius:10px; }
.reports-panel .rp-footer{ display:flex; justify-content:flex-end; margin-top:14px; }
.reports-panel .rp-footer .btn{ padding:10px 14px; border-radius:12px; }
.reports-panel .rp-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
@media(max-width: 980px){ .reports-panel .rp-grid{ grid-template-columns:1fr; } }
.reports-panel .rp-item{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.reports-panel .rp-check{ padding-top:2px; }
.reports-panel .rp-check input[type="checkbox"]{
  width:16px;
  height:16px;
  margin:0;
  accent-color: var(--g-700);
  transform: scale(1);
}
.reports-panel .rp-meta{ flex:1; min-width:0; }
.reports-panel .rp-name{ font-weight:800; font-size:13px; line-height:1.2; }
.reports-panel .rp-desc{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.25; }
.reports-panel .rp-pill{ display:inline-flex; align-items:center; gap:6px; font-size:11px; color:var(--muted); margin-top:6px; }
.reports-panel .rp-pill .dot{ width:8px; height:8px; border-radius:99px; background:var(--g-600); opacity:.9; }

body.reports-mode #satNotes,
body.reports-mode .table-container,
body.reports-mode #mainTablePager{
  display:none !important;
}

body.reports-mode .table-tools,
body.reports-mode #tableTools,
body.reports-mode #faAprTools{
  display:none !important;
}


/* ===== Top Empresas split (tabla + gráfica) ===== */
.emp-split{ display:flex; gap:14px; align-items:stretch; margin-top:10px; }
.emp-half{ flex:1 1 0; min-width:280px; display:flex; flex-direction:column; }

.emp-split .emp-half.emp-left{ flex:0 0 40%; max-width:40%; }
.emp-split .emp-half.emp-right{ flex:0 0 60%; max-width:60%; }
@media (max-width: 980px){
  .emp-split .emp-half.emp-left, .emp-split .emp-half.emp-right{ flex:1 1 0; max-width:none; }
}
.emp-chart-title{ font-weight:800; font-size:12px; color:#0f172a; margin:0 0 8px 0; }
.emp-chart-wrap{ background:#fff; border:1px solid rgba(15,23,42,.08); border-radius:14px; padding:10px; flex:1; display:flex; align-items:center; justify-content:center; }
.emp-chart-wrap canvas{ width:100% !important; height:260px !important; }
.emp-chart-note{ margin-top:8px; font-size:12px; opacity:.75; }
.dash-table tr.is-selected td{ background: rgba(34,197,94,.12); }
@media (max-width: 980px){
  .emp-split{ flex-direction:column; }
  .emp-chart-wrap canvas{ height:240px !important; }
}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
<div class="brand">
<div aria-label="Logo SENA" class="logo">
<svg aria-hidden="true" focusable="false" role="img" viewbox=".515 .76148307 73.922 72.10751693" xmlns="http://www.w3.org/2000/svg"><path d="m37.73.767a7.967 7.967 0 0 0 -7.957 7.975 7.967 7.967 0 0 0 7.972 7.96 7.967 7.967 0 0 0 7.963-7.968v-.015a7.967 7.967 0 0 0 -7.979-7.952zm-26.284 18.403c-1.4.008-2.824.086-4.159.422-.88.223-1.731.59-2.284 1.16-.694.714-.783 1.683-.444 2.51.302.73 1.116 1.276 2.023 1.589 1.95.668 4.117.81 6.168 1.23.378.093.796.195 1.03.453.243.307.1.73-.299.923-.666.339-1.517.341-2.293.33-.708-.03-1.486-.089-2.05-.444-.414-.255-.487-.689-.394-1.062h-4.57c-.012.696.123 1.423.633 2.02.426.51 1.114.87 1.854 1.086 1.183.348 2.464.453 3.725.485 1.711.029 3.456-.022 5.1-.41.98-.239 1.942-.625 2.57-1.251 1.113-1.118.851-2.889-.63-3.758-.737-.43-1.62-.696-2.52-.868-1.317-.273-2.658-.473-3.992-.693-.469-.091-.964-.172-1.358-.393-.412-.221-.445-.743-.025-.97.543-.307 1.266-.305 1.916-.305.685.012 1.43.055 1.994.376a.855.855 0 0 1 .446.758l4.345-.01c-.017-.55-.119-1.123-.521-1.598-.467-.585-1.288-.954-2.133-1.17-1.325-.335-2.74-.404-4.131-.41zm9.426.328-.002 10.382h12.67v-2.263h-8.023v-2.015h7.155v-2.213h-7.155l-.001-1.652 7.734-.002-.005-2.237zm20.875.004-5.872.001-.001 10.382h4.448l-.002-6.986 6.093 6.981 6.105.006-.002-10.383-4.452.001.005 6.936zm18.702.017s-4.795 6.926-7.204 10.384h4.669l1.12-1.873h7.214l1.046 1.874 5.186-.001-6.873-10.382zm2.334 2.478 2.214 3.761-4.577.007zm-62.268 10.82.04 5.65 21.12-.074c1.077.231 1.702.933 1.482 2.526l-12.99 22.739 4.232 3.955 20.118-34.797zm40.3.048 19.784 34.649 4.372-3.93-13.14-22.679c-.22-1.599.405-2.308 1.483-2.54l21.123.075-.006-5.558zm-3.338 5.733-18.553 31.846 4.928 2.401 12.38-20.924c.427-.349.859-.534 1.29-.552.456-.017.917.151 1.379.512l12.351 20.988 5.083-2.652z" fill="currentColor"></path></svg>
</div>
<div>
<h1>SENA Analytics</h1>
<p>Gestión Académica</p>
</div>
</div>
<nav>
<details open="">
<summary>Fase de Inicio y Matrícula</summary>
<ul class="nav-links">
<li><button id="nav-r2" onclick="setActiveReport('r2')">2. Matrícula con Tránsito <span class="badge" id="c-r2">0</span></button></li>
<li><button id="nav-r3" onclick="setActiveReport('r3')">3. Matrícula con Inducción <span class="badge" id="c-r3">0</span></button></li>
</ul>
</details>
<details open="">
<summary>Ejecución y Formación</summary>
<ul class="nav-links">
<li><button id="nav-r1" onclick="setActiveReport('r1')">1. Ejecución sin Programar <span class="badge" id="c-r1">0</span></button></li>
<li><button id="nav-r4" onclick="setActiveReport('r4')">4. Ejecución sin Ruta <span class="badge" id="c-r4">0</span></button></li>
<li><button id="nav-r5" onclick="setActiveReport('r5')">5. Ejecución con Inducción <span class="badge" id="c-r5">0</span></button></li>
<li><button id="nav-r6" onclick="setActiveReport('r6')">6. Ejecución con Tránsito <span class="badge" id="c-r6">0</span></button></li>
<li><button id="nav-r19" onclick="setActiveReport('r19')">Ficha Acumulativa <span class="badge" id="c-r19">0</span></button></li>
</ul>
</details>
<details open="">
<summary>Cierre y Certificación</summary>
<ul class="nav-links">
<li><button id="nav-r7" onclick="setActiveReport('r7')">7. Terminada con Inducción <span class="badge" id="c-r7">0</span></button></li>
<li><button id="nav-r8" onclick="setActiveReport('r8')">8. Terminada con Tránsito <span class="badge" id="c-r8">0</span></button></li>
<li><button id="nav-r9" onclick="setActiveReport('r9')">9. Terminada sin Asociar <span class="badge" id="c-r9">0</span></button></li>
<li><button id="nav-r11" onclick="setActiveReport('r11')">11. Result. Pendientes <span class="badge" id="c-r11">0</span></button></li>
<li><button id="nav-r12" onclick="setActiveReport('r12')">12. Por Certificar <span class="badge" id="c-r12">0</span></button></li>
</ul>
</details>
<details open="">
<summary>Novedades</summary>
<ul class="nav-links">
<li><button id="nav-r10" onclick="setActiveReport('r10')">10. Condicionados/Aplazados <span class="badge" id="c-r10">0</span></button></li>
<li><button id="nav-r13" onclick="setActiveReport('r13')">Resumen ejecutivo global <span class="badge" id="c-r13">0</span></button></li>
<li><button id="nav-r14" onclick="setActiveReport('r14')">Instructor Responsable <span class="badge" id="c-r14">0</span></button></li>
<li><button id="nav-r15" onclick="setActiveReport('r15')">Programa <span class="badge" id="c-r15">0</span></button></li>
<li><button id="nav-r16" onclick="setActiveReport('r16')">Ocupación y efectividad <span class="badge" id="c-r16">0</span></button></li>
<li><button id="nav-r17" onclick="setActiveReport('r17')">Embudo operativo <span class="badge" id="c-r17">0</span></button></li>
<li><button id="nav-dashboard" onclick="setActiveReport('dashboard')">Dashboard <span class="badge" id="c-dashboard">0</span></button></li>
<li><button id="nav-r18" onclick="setActiveReport('r18')">SAT - Alertas Tempranas <span class="badge" id="c-r18">0</span></button></li>
<li><button id="nav-reports" onclick="setActiveReport('reports')">Reportes</button></li>

</ul>
</details>
</nav>
</div>
<div class="main">
<div class="card" id="step1">
<h2>1. Cargar Datos (XML y Excel)</h2>
<p style="color:var(--muted); margin-bottom:14px">
        Selecciona los siguientes <b>6 reportes</b> descargados de SofíaPlus. Se consolidarán automáticamente (5 XML + 1 Excel).
        Recomendación: exportar los reportes con rango de los <b>últimos 2 años</b>.
      </p>
<ul class="expected-files">
<li><strong>PE-04_ PROGRAMACIÓN ESPECÍFICA DE CURSOS LARGOS, ESPECIALES Y EVENTOS POR REGIONAL Y CENTRO</strong> (XML · se recomienda últimos 2 años)</li>
<li><strong>DF-14A_MATRICULADOS_RESUMEN_POR_FICHA</strong> (XML)</li>
<li><strong>DF-53_ CONSOLIDADO_FICHAS_CON_Y_SIN_PROGRAMACION_ESPECIFICA (EVENTOS)</strong> (XML)</li>
<li><strong>DF-51_CONSOLIDADO_DE_FICHAS_CON_O_SIN_RUTA</strong> (XML)</li>
<li><strong>DF-49_REPORTE_CONSOLIDADO_DE_APRENDICES_POR_FICHA</strong> (XML)</li>
</ul>
<p style="color:var(--muted); margin:0 0 20px 0; font-size:12px">
        La lista de chequeo se actualizará al seleccionar archivos e indicará si falta alguno.
      </p>
<div class="upload-area">
<input accept=".xml,.xls,.xlsx" id="fileInput" multiple="" onchange="handleFiles()" style="display:none" type="file"/>
<button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Seleccionar Archivos</button>

<div id="driveFolderWrap" style="margin-top:10px; width:100%; display:flex; flex-direction:column; align-items:center;">
  <div style="font-size:12px; color:var(--muted); margin-bottom:6px; text-align:center;">Carpeta Drive pública (URL o ID)</div>
  <div class="searchbox" style="max-width:820px; width:100%; margin:0 auto;">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm9.707 4.293-4.2-4.2a1 1 0 0 0-1.414 1.414l4.2 4.2a1 1 0 0 0 1.414-1.414Z"/></svg>
    <input autocomplete="off" id="driveFolderInput" type="text" value="https://drive.google.com/drive/folders/1_ixN-3NoVSN2wkRnNyoDkDvkxmDdN5u0?usp=sharing" readonly />
  </div>
  <div style="margin-top:6px; font-size:12px; color:var(--muted); text-align:center;">
    <a href="https://drive.google.com/drive/folders/1_ixN-3NoVSN2wkRnNyoDkDvkxmDdN5u0?usp=sharing" target="_blank" rel="noopener">Abrir carpeta</a>
  </div>
</div>


<p id="fileCount" style="margin-top:10px; font-size:13px"></p>
<div aria-live="polite" class="checklist" id="requiredChecklist"></div>
<div id="progressContainer">
<label>Procesando...</label>
<progress id="progressBar" max="100" value="0"></progress>
<span id="progressText">0%</span>
</div>
<button class="btn hidden" id="btnParse" onclick="processFiles()" style="margin-top:10px; background:var(--g-800)">Procesar Reportes</button>
</div>
</div>


<!-- =========================
     Carga opcional DF-03 (Ficha Acumulativa) - Paso 1
     Si se carga aquí, se habilita el menú "Ficha Acumulativa".
     ========================= -->
<div class="card df03-card" id="df03StartCard" style="margin-top:14px">
  <div class="df03-head">
    <div class="df03-title">
      <div class="df03-title-ico" aria-hidden="true">📦</div>
      <div>
        <div class="df03-h">Carga opcional DF-03 (Ficha Acumulativa)</div>
        <div class="df03-sub">Sube de 1 a 5 XML DF-03 para habilitar el menú <b>Ficha Acumulativa</b>. Si no los cargas aquí, el menú permanecerá inhabilitado.</div>
      </div>
    </div>
  </div>

  <div class="pill-row df03-meta">
    <span class="pill" id="df03FilesBadgeStart"><span class="miniDot"></span> <span id="df03FilesTxtStart">0 archivos</span></span>
    <span class="pill" id="df03RowsBadgeStart"><span class="miniDot"></span> <span id="df03RowsTxtStart">0 filas</span></span>
    <span class="pill" style="margin-left:auto; opacity:.9">Opcional</span>
  </div>

  <div id="df03StartMsg" class="fa-msg hidden" style="margin-top:10px"></div>

  <input type="file" id="df03InputStart" accept=".xml" multiple style="display:none" />

  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-primary" onclick="document.getElementById('df03InputStart').click()">Seleccionar Archivos</button>
</div>


  <div id="df03DropzoneStart" class="df03-dropzone" role="button" tabindex="0" aria-label="Subir archivos DF-03 (opcional)">
    <div class="dz-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 17.5a4.5 4.5 0 0 0-1.8-8.6 6 6 0 0 0-11.7 1.6A4 4 0 0 0 6 18h14z"></path>
        <path d="M12 12v7"></path>
        <path d="M8.5 15.5 12 12l3.5 3.5"></path>
      </svg>
    </div>
    <div class="dz-h">Arrastra tus archivos XML aquí</div>
    <div class="dz-p">O <a href="#" id="df03BrowseLinkStart">haz clic para explorar</a>. Soporta carga múltiple (DF-03 1-5).</div>
  </div>

  <div id="df03FileChipsStart" class="df03-filechips" style="display:none;"></div>

  <div id="df03ProgressWrapStart" class="hidden" style="margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px;">
      <div id="df03ProgressLabelStart" style="font-weight:800; font-size:12px; color:#0f172a;">Procesando DF-03...</div>
      <div id="df03ProgressTextStart" style="font-weight:900; font-size:12px; color:#0f172a;">0%</div>
    </div>
    <progress id="df03ProgressBarStart" max="100" value="0" style="width:100%"></progress>
  </div>
</div>
<div class="hidden" id="step2">
<div class="card" id="filtersCard">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
<h3 style="margin:0">Filtros Globales</h3>
<button class="btn" onclick="resetApp()" style="font-size:12px; padding:6px 12px; background:var(--border); color:#333">Volver a cargar</button>
</div>
<div class="grid2">
<label>Fecha de Corte (Cálculo Días)
             <input id="cutoffDate" type="date"/>
</label>
<label> 
             <button class="btn btn-primary" id="btnApplyFilters" style="width:100%; margin-top:6px;">Aplicar</button>
</label>
</div>
</div>
<div class="card" id="reportCard">
<div style="display:flex; justify-content:space-between; margin-bottom:20px">
<div>
<h2 id="reportTitle" style="margin:0">Selecciona un reporte</h2>
<p id="reportDesc" style="color:var(--muted); margin:5px 0 0 0"></p>
</div>
<button class="btn" onclick="exportTable()">Excel</button>
</div>
<div class="table-tools" id="tableTools">
<div class="tools-top">
<div class="searchbox" id="searchBox">
<span aria-hidden="true" class="icon">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<circle cx="11" cy="11" r="7"></circle>
<path d="M21 21l-4.3-4.3"></path>
</svg>
</span>
<input autocomplete="off" id="tableSearch" placeholder="Buscar por número de ficha, programa o código..." type="text"/>
</div>
<details class="year-dd" id="yearDropdown">
<summary id="yearSummary">
<span class="year-s-left">
<span aria-hidden="true" class="icon">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<rect height="18" rx="2" width="18" x="3" y="4"></rect>
<path d="M16 2v4M8 2v4M3 10h18"></path>
</svg>
</span>
<span id="yearSummaryText">Años: Todos</span>
</span>
<span aria-hidden="true" class="icon chev">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M6 9l6 6 6-6"></path>
</svg>
</span>
</summary>
<div class="year-panel" id="yearOptions"></div>
</details>
</div>
<div class="tools-divider"></div>
<div class="filters-block" id="nivelBlock">
<div class="filters-head">
<div class="filters-label">NIVEL DE FORMACIÓN</div>
<button class="clear-link" id="clearNivel" type="button">Limpiar</button>
</div>
<div class="level-filters" id="nivelFilters"></div>
</div>
<div class="filters-block" id="progEspBlock">
<div class="filters-head">
<div class="filters-label">NOMBRE PROGRAMA ESPECIAL</div>
<button class="clear-link" id="clearProgEsp" type="button">Limpiar</button>
</div>
<div class="prog-filters" id="progEspFilters"></div>
</div>
<div class="search-hint" id="tableToolsHint" style="display:none">La búsqueda no aplica a este módulo. El filtro por año sí.</div>
</div>
<div id="faGeneralArea" class="hidden"></div>
      <div class="stats-grid" id="kpiArea"></div>
<div id="faArea" class="hidden">
  <div class="callout ok" style="margin-top:10px">
    <b>Ficha Acumulativa (DF-03)</b>: carga de 1 a 5 archivos DF-03 en XML y consulta por número de ficha.
  </div>

  <div class="card df03-card" style="margin-top:12px; padding:16px; border-left:5px solid var(--g-600);">
  <div class="df03-head">
    <div class="df03-title">
      <div class="df03-title-ico" aria-hidden="true">📌</div>
      <div>
        <div class="df03-h">Ficha Acumulativa (DF-03)</div>
        <div class="df03-sub">Los archivos DF-03 se cargan en el <b>bloque opcional del inicio</b>. Aquí solo se habilita la consulta por número de ficha.</div>
      </div>
    </div>
  </div>
<div class="df03-consulta">
    <div class="df03-consulta-title">Consultar Ficha</div>

    <div class="df03-consulta-box">
      <div id="faConsultaRow" class="df03-consulta-row">
        <input type="text" id="faFichaInput" placeholder="Ej: 261005" disabled />
        <button class="btn btn-primary" id="btnFaBuscar" type="button" disabled>Consultar</button>
      </div>

      <div id="faConsultaLock" class="df03-consulta-lock">
        <div class="lock-pill" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="6" y="11" width="12" height="10" rx="2"></rect>
            <path d="M8 11V8a4 4 0 0 1 8 0v3"></path>
          </svg>
          Carga archivos para desbloquear
        </div>
      </div>
    </div>

    <div class="df03-consulta-hint">Ingresa el número de ficha para ver el reporte acumulativo.</div>
  </div>

  <div id="faMsg" class="callout warn hidden" style="margin-top:12px;"></div>
</div><div id="faResults" class="hidden"></div>
</div>

<div id="dashboardArea" class="hidden">
  <div class="dash-head">
    <div>
      <div class="dash-title">Dashboard</div>
      <div class="dash-subtitle">Vista interactiva tipo Power BI (clic en gráficas y segmentaciones para actualizar todo). Fuente: RAW_DATA con exclusión de estados aplicada.</div>
    </div>
    <div class="dash-actions">
      <button class="btn" id="dashClearBtn" type="button">Limpiar filtros</button>
    </div>
  </div>

  <div class="dash-kpis" id="dashKpis"></div>

  <div class="dash-grid">
    <div class="dash-main">
      
<div class="dash-card seg-card">
  <div class="seg-head">
    <div class="seg-title-row">
      <span class="seg-icon" aria-hidden="true"><svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18">
  <path d="M4 21v-7"></path><path d="M4 10V3"></path><path d="M12 21v-9"></path><path d="M12 8V3"></path><path d="M20 21v-5"></path><path d="M20 12V3"></path>
  <path d="M1 14h6"></path><path d="M9 8h6"></path><path d="M17 16h6"></path>
</svg></span>
      <div class="seg-title-stack">
        <div class="seg-title">Segmentaciones de Cursos</div>
        <div class="seg-subtitle">Utilice los filtros a continuación para segmentar la información de las fichas.</div>
      </div>
    </div>
  </div>

  <div class="dash-slicers-all">
    <div class="dash-inline-filters seg-topbar" id="dashInlineFilters">
      <div class="dash-search seg-search">
        <span aria-hidden="true" class="icon"><svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18">
  <circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path>
</svg></span>
        <input id="dashSearch" type="search" placeholder="Buscar ficha, programa, responsable..." autocomplete="off"/>
      </div>
      <details class="year-dd dash-year-dd" id="dashYearDropdown">
            <summary id="dashYearSummary">
              <span class="year-s-left">
                <span aria-hidden="true" class="icon"><svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18">
              <rect height="18" rx="2" width="18" x="3" y="4"></rect>
              <path d="M16 2v4M8 2v4M3 10h18"></path>
            </svg></span>
                <span id="dashYearSummaryText">Año inicio: (cargando...)</span>
              </span>
              <span aria-hidden="true" class="icon chev"><svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18">
              <path d="M6 9l6 6 6-6"></path>
            </svg></span>
            </summary>
            <div class="year-panel" id="dashYearOptions"></div>
          </details>
    </div>

    <div id="dashActiveFilters" class="dash-pills" style="display:none"></div>

    <div id="dashSlicersLeft" class="dash-slicers dash-slicers-grid"></div>
    <div id="dashSlicersButtons" class="dash-fast-slicers"></div>
    </div>
  </div>
        <div class="dash-card">
          <div class="dash-card-title-row">
            <div class="dash-card-title">Top 10 Empresas por Aprendices</div>
          </div>

          <div class="emp-split">
            <div class="emp-half emp-left">
              <div class="dash-table-wrap">
                <table class="dash-table" id="dashTblEmpresa">
                  <thead>
                    <tr>
                      <th class="sticky">Empresa</th>
                      <th class="num">Aprendices</th>
                    </tr>
                  </thead>
                  <tbody id="dashTblEmpresaBody"></tbody>
                </table>
              </div>
            </div>

            <div class="emp-half emp-right">
              <div class="emp-chart-title">Participación por empresa (clic para filtrar)</div>
              <div class="emp-chart-wrap">
                <canvas id="dashChartEmpresaPie" aria-label="Gráfica circular de empresas"></canvas>
              </div>
              <div class="emp-chart-note">Basado en PE-04 (AQ). Excluye SENA/DEMANDA SOCIAL/Sin nombre.</div>
            </div>
          </div>
        </div>

<div class="dash-charts-top">
  <div class="dash-chart-card dash-chart-map">
          <div class="dash-chart-title">Mapa de municipios (clic para filtrar)</div>
          <div class="dash-chart-wrap h820 is-map">
<div id="dashMapMunicipios" class="dash-leafletmap" aria-label="Mapa de municipios"></div>
            <div class="dash-map-detail" aria-label="Detalle por municipio">
              <div class="dash-map-detail-title">Detalle por municipio (fichas)</div>
              <div class="dash-map-detail-scroll">
                <table id="dashMapDetailTable" class="dash-mini-table">
                  <thead>
                    <tr>
                      <th>Municipio</th>
                      <th class="num">Fichas</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
  <div class="dash-chart-stack">
    <div class="dash-chart-card">
          <div class="dash-chart-title">Fichas por ESTADO_CURSO (clic para filtrar)</div>
          <div class="dash-chart-wrap h260"><canvas id="dashChartEstado"></canvas></div>
        </div>
    <div class="dash-chart-card">
          <div class="dash-chart-title">Fichas por nivel (clic para filtrar)</div>
          <div class="dash-chart-split">
            <div class="dash-chart-wrap h260"><canvas id="dashChartNivel"></canvas></div>
            <div class="dash-chart-wrap h260 dash-chart-pane">
              <div class="dash-mini-title">Etapa ficha (clic para filtrar)</div>
              <canvas id="dashChartEtapa"></canvas>
            </div>
          </div>
        </div>
    <div class="dash-chart-card">
          <div class="dash-chart-title">Modalidad (clic para filtrar)</div>
          <div class="dash-chart-split">
            <div class="dash-chart-wrap h260"><canvas id="dashChartModalidad"></canvas></div>
            <div class="dash-chart-wrap h260 dash-chart-pane">
              <div class="dash-mini-title">Programa especial (clic para filtrar)</div>
              <canvas id="dashChartProgEsp"></canvas>
            </div>
          </div>
        </div>
    <div class="dash-chart-card">
          <div class="dash-chart-title">Tipo (clic para filtrar)</div>
          <div class="dash-chart-wrap h260"><canvas id="dashChartTipo"></canvas></div>
        </div>

  </div>
</div>

<div class="dash-tables">
        <div class="dash-card">
          <div class="dash-card-title">Fichas Detalle</div>
          <div class="dash-table-topscroll" id="dashTblCritTopScroll"><div class="dash-table-topscroll-inner" id="dashTblCritTopInner"></div></div>
          <div class="dash-table-wrap" id="dashTblCritWrap">
            <table class="dash-table" id="dashTblCrit">
              <thead>
                <tr>
                  <th>Ficha</th><th>Estado</th><th>Municipio</th><th>Programa</th><th>Responsable</th>
                  <th class="num">Días Atraso</th><th class="num">Matriculados</th><th class="num">Activos</th>
                  <th class="num">Sin Ruta</th><th class="num">Sin Juicio</th><th class="num">Novedades</th>
                  <th class="num">En Tránsito</th><th class="num">En Inducción</th><th class="num">En Formación</th>
                  <th class="num">Condicionado</th><th class="num">Aplazado</th><th class="num">Retiro Voluntario</th>
                  <th class="num">Cancelado</th><th class="num">Por Certificar</th><th class="num">Certificado</th><th class="num">Trasladado</th></tr>
              </thead>
              <tbody id="dashTblCritBody"></tbody>
            </table>
          </div>
          <div id="dashTblCritPager" class="dash-pager"></div>
          <div class="dash-note">Tip: clic en una ficha para aplicar el filtro por búsqueda.</div>
        </div>

        <div class="dash-card">
          <div class="dash-card-title-row"><div class="dash-card-title">Resumen por municipio</div><button class="btn btn-sm" id="dashMuniToggleCols" type="button">Columnas avanzadas</button></div>
          <div class="dash-table-wrap">
            <table class="dash-table hide-adv" id="dashTblMunicipio">
              <thead>
                <tr>
                  <th class="sticky">Municipio</th>
                  <th class="num">Fichas</th>
                  <th class="num">Cupo</th>
                  <th class="num">Matric.</th>
                  <th class="num">Activos</th>
                  <th class="num">Ocupación %</th>
                  <th class="num">Efectividad %</th>
                  <th class="num">Atrasadas</th>
                  <th class="num adv">En tránsito</th>
                  <th class="num adv">En inducción</th>
                  <th class="num adv">En formación</th>
                  <th class="num adv">Condicionado</th>
                  <th class="num adv">Aplazado</th>
                  <th class="num adv">Retiro voluntario</th>
<th class="num adv">Cancelado</th>
                  <th class="num adv">Por certificar</th>
                  <th class="num adv">Certificado</th>
                  <th class="num adv">Trasladado</th>
<th class="num adv">Aprendices sin certificados</th>
                  <th class="num adv">Aprendices sin juicio</th>
                  <th class="num adv">Aprendices no aprobados</th>
                </tr>
              </thead>
              <tbody id="dashTblMunicipioBody"></tbody>
            </table>
          </div>
          <div id="dashTblMunicipioPager" class="dash-pager"></div>
        </div>
      </div>

<div class="dash-charts dash-charts-below">
  <div class="dash-chart-card full">
          <div class="dash-chart-title">Top Programas por Matriculados (clic para filtrar)</div>
          <div class="dash-chart-wrap h320"><canvas id="dashChartPrograma"></canvas></div>
        </div>
  <div class="dash-chart-card full">
          <div class="dash-chart-title">Tendencia de inicio (fichas por mes)</div>
          <div class="dash-chart-wrap h260"><canvas id="dashChartInicio"></canvas></div>
        </div>
</div>

    </div>
  </div>


  <!-- =========================
       Aprendices DF-03 según filtros del Dashboard
       (un registro por aprendiz por ficha; puede repetirse si tomó varios cursos)
       Visible solo si DF-03 está cargado.
       ========================= -->
  <div class="dash-card" id="dashAprDF03Card" style="display:none; margin-top:12px;">
    <div class="dash-card-title">Aprendices (DF-03) según filtros</div>
    <div class="dash-card-sub" style="color:var(--muted); font-size:12px; margin-top:-6px; margin-bottom:10px;">
      Se muestra <b>un registro por aprendiz por ficha</b> (puede repetirse si el aprendiz tomó varios cursos). Solo aparece cuando se cargan los archivos DF-03.
    </div>

    <div class="dash-inline-filters" style="margin-bottom:10px;">
      <div class="dash-search" style="max-width:520px;">
        <span aria-hidden="true" class="icon">
          <svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18">
            <circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path>
          </svg>
        </span>
        <input id="dashAprSearch" type="search" placeholder="Buscar por ficha, programa, documento, nombre o teléfono..." autocomplete="off"/>
      </div>
      <div style="flex:1"></div>
      <button class="btn" id="dashAprExportBtn" style="font-size:12px; padding:6px 12px; background:var(--border); color:#333">Exportar Excel</button>
    </div>

    <div class="dash-apr-wrap">
      <table id="dashAprDF03Table" class="dash-apr-table">
        <thead>
          <tr>
            <th class="num">#</th>
            <th class="sortable" data-key="td">TD <span class="sort-ind"></span></th>
            <th class="sortable" data-key="ficha">Ficha <span class="sort-ind"></span></th>
            <th class="sortable" data-key="doc">Número documento <span class="sort-ind"></span></th>
            <th class="sortable" data-key="nombre">Nombre aprendiz <span class="sort-ind"></span></th>
            <th class="sortable" data-key="programa">Programa <span class="sort-ind"></span></th>
            <th class="sortable" data-key="tel">Tel. principal <span class="sort-ind"></span></th>
            <th class="num sortable" data-key="aprob">Aprobado <span class="sort-ind"></span></th>
            <th class="num sortable" data-key="pend">Pendiente por evaluar <span class="sort-ind"></span></th>
            <th class="num sortable" data-key="noap">No aprobado <span class="sort-ind"></span></th>
            <th class="num sortable" data-key="total">Total general <span class="sort-ind"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="dashAprDF03Empty" style="display:none; color:var(--muted); font-size:12px; padding:10px 4px;">
        No hay aprendices DF-03 para las fichas filtradas. (Recuerda que DF-03 solo incluye las fichas presentes en los XML cargados.)
      </div>
      <div id="dashAprDF03Pager" class="dash-pager"></div>
    </div>
  </div>
</div>

<div class="charts-grid" id="chartsArea" style="display:none"></div>
      <div class="table-tools hidden" id="faAprTools">
        <div class="tools-top">
          <div class="searchbox">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path></svg>
            <input id="faAprSearch" type="search" placeholder="Buscar en aprendices (nombre, documento o teléfono)..." />
          </div>
          <div id="faAprCounts" class="pill-row"></div>
        </div>
      </div>


<div id="reportsPanel" class="reports-panel">
  <div class="rp-head">
    <div>
      <h2 class="rp-title">Reportes</h2>
      <div class="rp-sub">Selecciona los reportes a exportar a PDF. Se exportan <b>sin filtros</b> (no incluye Dashboard).</div>
    </div>
    <div class="rp-actions">
      <button class="btn" type="button" id="rpAll">Todo</button>
      <button class="btn" type="button" id="rpNone">Nada</button>
          </div>
  </div>
  <div class="rp-grid" id="reportsList"></div>
  <div class="rp-footer">
    <button class="btn primary" type="button" id="rpExportPdf">Exportar PDF</button>
  </div>
</div>
<div id="satNotes" class="sat-notes" style="display:none;"></div>
<div class="table-container">
<table id="dataTable">
<thead id="tableHead"></thead>
<tbody id="tableBody"></tbody>
</table>
</div>
<div id="mainTablePager" class="dash-pager" style="margin-top:10px; display:none;"></div>

</div>
</div>
</div>
</div>
<!-- Dashboard: Overlay de selección inicial de años -->
<div id="dashYearOverlay" class="dash-year-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="dashYearOverlayTitle">
  <div class="dash-year-modal">
    <div class="dash-year-modal-head">
      <div>
        <div class="dash-year-modal-title" id="dashYearOverlayTitle">Seleccionar años</div>
        <div class="dash-year-modal-sub">El Dashboard se calculará con los años seleccionados (según <b>FechaInicio</b>).</div>
      </div>
    </div>

    <div class="dash-year-actions">
      <button class="btn" id="dashYearOvAll" type="button" style="background:var(--border); color:#333; padding:6px 12px; font-size:12px;">Todo</button>
      <button class="btn" id="dashYearOvNone" type="button" style="background:var(--border); color:#333; padding:6px 12px; font-size:12px;">Nada</button>
      <div style="flex:1"></div>
      <div class="dash-year-selected" id="dashYearOverlaySelected">—</div>
    </div>

    <div class="dash-year-list" id="dashYearOverlayList"></div>

    <div class="dash-year-footer">
      <div class="dash-year-note" id="dashYearOverlayNote">Puedes cambiar esto después desde el filtro <b>Año inicio</b>.</div>
      <button class="btn btn-primary" id="dashYearOvContinue" type="button">Continuar</button>
    </div>
  </div>
</div>
<footer aria-label="Créditos" class="app-footer" role="contentinfo">
<div class="footer-stack">
<div class="footer-title">DISEÑO Y DESARROLLO</div>
<div class="footer-pill">
<div aria-hidden="true" class="footer-icon left">×</div>
<div class="footer-user">
<div class="footer-role">INSTRUCTOR DISEÑADOR</div>
<div class="footer-name">Yeison Castellanos Gordillo</div>
</div>
<button aria-label="Acción" class="footer-btn footer-icon right" type="button">
<svg aria-hidden="true" fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2-2h6l2 2h4a2 2 0 0 1 2 2z"></path>
<circle cx="12" cy="13" r="4"></circle>
</svg>
</button>
</div>
</div>
</footer>
<script>
/* =========================================================
   CONFIGURACIÓN DE REPORTES (Ajustes 1, 2, 3, 4, 5)
   ========================================================= */

function normalizeFicha(v){
  const s = (v === undefined || v === null) ? "" : String(v).trim();
  if(!s) return "";
  // Common Excel numeric patterns: "123456.0", "123456,0"
  const m = s.match(/^(\d+)(?:[\.,]0+)?$/);
  if(m) return m[1];
  // Remove non-digit separators to improve cross-file joins
  const digits = s.replace(/\D/g, "");
  return digits || s;
}

function stripBolNauticoPrefix(v){
  const s0 = (v === undefined || v === null) ? "" : String(v).trim();
  if(!s0) return "";
  const flat = s0.replace(/\s+/g," ").trim();
  // Caso especial: valor únicamente "BOL NAUTICO" (no es un nombre de instructor). Se trata como faltante
  if(/^BOL\s*N[ÁA]UTICO$/i.test(flat)){
    return "";
  }
  // Quita prefijos tipo "BOL NAUTICO", "BOL NÁUTICO" con/ sin separador ("/", "-", ":", espacios)
  const cleaned = s0
    .replace(/^BOL\s*N[ÁA]UTICO(?:\s*(?:\/|\-|\:)?\s*)?/i, "")
    .trim();
  return cleaned || s0;
}


function isEventoOrCursoEspecial(nivelRaw){
  const s = (nivelRaw ?? "").toString().trim();
  if(!s) return false;
  const n = s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/\s+/g," ").trim();
  return (n === "EVENTO" || n === "CURSO ESPECIAL");
}
function mergeSlashNames(a,b){
  const seen = new Set();
  const out = [];
  const add = (s) => {
    (String(s||"").split("/").map(x=>x.trim()).filter(Boolean)).forEach(p=>{
      const key = normNoAccents(p); // may appear later; function hoisting ok
      if(key === "BOL NAUTICO") return; // limpiar prefijo tipo "BOL NAUTICO / NOMBRE"
      if(!seen.has(key)){ seen.add(key); out.push(p); }
    });
  };
  add(a);
  add(b);
  return out.join(" / ");
}

const REPORTS = {
  // --- FASE 1: INICIO Y MATRÍCULA ---
  r2: {
    title: "2. Fichas en Matrícula con Aprendices en Tránsito",
    desc: "Fichas en estado En Matrícula con aprendices marcados 'En Tránsito'. Fuentes: DF-49 (aprendices por ficha: tránsito/inducción/otros estados), DF-14A (matriculados/cupo/activos) y PE-04 (programa, modalidad, nivel, tipo, fechas y centro/municipio).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("enTransito"), label:"En Tránsito"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enTransito", label:"En Tránsito", align:"num"}
    ],
    filter: f => (f.estado === "En matricula" || f.estado === "En matrícula") && (f.enTransito > 0)
  },

  r3: {
    title: "3. Fichas en Matrícula con Aprendices en Inducción",
    desc: "Fichas en estado En Matrícula con aprendices en inducción. Fuentes: DF-49 (conteos por estado del aprendiz), DF-14A (matriculados/cupo/activos) y PE-04 (programa, modalidad, nivel, tipo, fechas y centro/municipio).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("enInduccion"), label:"En Inducción"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enInduccion", label:"En Inducción", align:"num"}
    ],
    filter: f => (f.estado === "En matricula" || f.estado === "En matrícula") && (f.enInduccion > 0)
  },

  // --- FASE 2: EJECUCIÓN Y FORMACIÓN ---
  r1: {
    title: "1. Fichas en Ejecución sin Programar",
    desc: "Fichas en estado En Ejecución cuyo indicador de programación específica está en 'No' (sin programación). Fuentes: DF-53 (Consolidado de fichas con/sin programación específica), PE-04 (programa, fechas, centro/municipio y estado), y DF-14A/DF-49 para cupo, matriculados y activos.",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"sinProgramar", label:"Sin Programar"}
    ],
    filter: f => (f.estado === "En ejecucion" || f.estado === "En ejecución") && String(f.sinProgramar||"").toUpperCase().trim().startsWith("N")
  },

  r4: {
    title: "4. Fichas en Ejecución con Aprendices sin Ruta",
    desc: "Fichas en Ejecución que presentan aprendices 'Sin Ruta'. Fuentes: DF-51 (consolidado de fichas con/sin ruta), DF-14A/DF-49 (cupo, matriculados, activos) y PE-04 (programa, fechas, centro/municipio y estado).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("sinRuta"), label:"Sin Ruta"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"sinRuta", label:"Sin Ruta", align:"num"}
    ],
    filter: f => (f.estado === "En ejecucion" || f.estado === "En ejecución") && (f.sinRuta > 0)
  },

  r5: {
    title: "5. Fichas en Ejecución con Aprendices en Inducción",
    desc: "Fichas en Ejecución que aún registran aprendices en inducción. Fuentes: DF-49 (aprendices por ficha: inducción), DF-14A (matriculados/cupo/activos) y PE-04 (programa, fechas, centro/municipio y estado).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("enInduccion"), label:"En Inducción"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enInduccion", label:"En Inducción", align:"num"}
    ],
    filter: f => (f.estado === "En ejecucion" || f.estado === "En ejecución") && (f.enInduccion > 0)
  },

  r6: {
    title: "6. Fichas en Ejecución con Aprendices en Tránsito",
    desc: "Fichas en Ejecución que tienen aprendices pendientes 'En Tránsito'. Fuentes: DF-49 (aprendices por ficha: tránsito), DF-14A (matriculados/cupo/activos) y PE-04 (programa, fechas, centro/municipio y estado).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("enTransito"), label:"En Tránsito"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enTransito", label:"En Tránsito", align:"num"}
    ],
    filter: f => (f.estado === "En ejecucion" || f.estado === "En ejecución") && (f.enTransito > 0)
  },

  // --- Nuevo reporte: Ficha Acumulativa (DF-03) ---
  r19: {
    title: "Ficha Acumulativa",
    desc: "DF-03 (1 a 5 XML): carga de archivos masivos y consulta por ficha para ver semáforo de competencias, métricas, gráficas y lista de aprendices con acceso a WhatsApp.",
    // Este módulo renderiza su propia vista (no usa la tabla genérica).
    custom: true,
    filter: f => false
  },

// --- FASE 3: CIERRE Y CERTIFICACIÓN ---
  r7: {
    title: "7. Terminadas por fecha con aprendices en Inducción",
    desc: "Fichas cuyo cierre por fecha ya ocurrió y aún tienen aprendices en inducción. Fuentes: PE-04 (FECHA_TERMINACION_FICHA para identificar vencidas y datos de ficha), DF-49 (conteos de inducción) y DF-14A (cupo/matriculados/activos).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enInduccion", label:"En Inducción", align:"num"}
    ],
    filter: f => f.terminada && f.enInduccion > 0
  },

  r8: {
    title: "8. Terminadas por fecha con aprendices en Tránsito",
    desc: "Fichas cuyo cierre por fecha ya ocurrió y aún tienen aprendices en tránsito. Fuentes: PE-04 (FECHA_TERMINACION_FICHA y datos de ficha), DF-49 (conteos de tránsito) y DF-14A (cupo/matriculados/activos).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"enTransito", label:"En Tránsito", align:"num"}
    ],
    filter: f => f.terminada && f.enTransito > 0
  },

  r9: {
    title: "9. Terminadas por fecha con aprendices sin asociar",
    desc: "Fichas vencidas con aprendices sin ruta / sin asociar. Fuentes: PE-04 (FECHA_TERMINACION_FICHA y datos de ficha), DF-51 (sin ruta) y DF-14A/DF-49 (cupo, matriculados, activos).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"sinRuta", label:"Sin Ruta", align:"num"}
    ],
    filter: f => normNoAccents(f.estado) === "TERMINADA" && f.sinRuta > 0
  },

  r11: {
    title: "11. Resultados Pendientes",
    desc: "Fichas con aprendices sin juicio / evaluación pendiente, priorizando las 'Terminada por fecha'. Fuentes: DF-49 (Aprendices sin juicio, certificados y en formación) y PE-04/DF-14A para datos generales de ficha (programa, fechas, cupo, matriculados y activos).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("aprendicesSinJuicio"), label:"Aprendices sin juicio"},
        {value: sum("activos"), label:"Activos"},
        {value: sum("certificados"), label:"Certificados"},
        {value: sum("enFormacion"), label:"En Formación"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"aprendicesSinJuicio", label:"Aprendices sin juicio", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"certificados", label:"Certificados", align:"num"},
      {key:"enFormacion", label:"En Formación", align:"num"}
    ],
    filter: f => (f.aprendicesSinJuicio || 0) > 0 && normNoAccents(f.estado) === "TERMINADA POR FECHA"
  },

  r12: {
    title: "12. Fichas terminadas con aprendices por certificar",
    desc: "Fichas terminadas que aún tienen aprendices por certificar. Fuentes: DF-49 (Por certificar, certificados y formación) y PE-04/DF-14A para datos generales de ficha (programa, fechas, cupo, matriculados y activos).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("formacion"), label:"Formación"},
        {value: sum("certificados"), label:"Certificados"},
        {value: sum("porCertificar"), label:"Por Certificar"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"formacion", label:"Formación", align:"num"},
      {key:"certificados", label:"Certificados", align:"num"},
      {key:"porCertificar", label:"Por Certificar", align:"num"}
    ],
    filter: f => f.terminada && f.porCertificar > 0
  },

  // --- FASE 4: NOVEDADES ---
  r10: {
    title: "10. Fichas con aprendices condicionado, aplazado y reingresado",
    desc: "Novedades administrativas por ficha (condicionado/aplazado) para priorizar seguimiento. Fuentes: DF-49 (conteos de novedades/estados del aprendiz), DF-14A (cupo/matriculados/activos) y PE-04 (programa, fechas, centro/municipio y estado).",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      const etapaCounts = rows.reduce((m,r)=>{
        const e = (r.etapa && String(r.etapa).trim()) ? String(r.etapa).trim() : "Sin dato";
        m[e] = (m[e]||0) + 1;
        return m;
      }, {});
      const etapaTxt = Object.entries(etapaCounts)
        .sort((a,b)=> b[1]-a[1])
        .map(([e,c])=> `${e}: ${c}`)
        .join(" · ");
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: etapaTxt || "—", label:"Etapa"},
        {value: sum("condicionado"), label:"Condicionado"},
        {value: sum("aplazado"), label:"Aplazado"}
      ];
    },
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"programa", label:"Programa"},
      {key:"modalidad", label:"Modalidad"},
      {key:"nivel", label:"Nivel"},
      {key:"tipo", label:"Tipo"},
      {key:"fechaInicio", label:"FechaInicio"},
      {key:"fechaFin", label:"FechaFin"},
      {key:"diasAtraso", label:"Días atraso", align:"num"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"etapa", label:"Etapa"},
      {key:"condicionado", label:"Condicionado", align:"num"},
      {key:"aplazado", label:"Aplazado", align:"num"}
    ],
    filter: f => (f.condicionado + f.aplazado) > 0
  },

  // --- ANALÍTICOS (Ajuste 1) ---
  r13: {
    title: "Resumen ejecutivo global",
    desc: "Indicadores consolidados por estado de la ficha (fichas, cupo, matriculados, activos y atraso). Fuentes: PE-04 (estado/fechas/datos base), DF-14A (matriculados/cupo/activos) y DF-49/DF-51/DF-53 para señales operativas (tránsito, sin ruta, sin programar).",
    columns: [
      {key:"segmento", label:"Segmento"},
      {key:"fichas", label:"Fichas", align:"num"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"atrasadas", label:"Atrasadas", align:"num"}
    ],
    filter: f => true,
    data: rows => {
      const byEstado = {};
      rows.forEach(r => {
        const est = (r.estado || "Sin estado").trim() || "Sin estado";
        if(!byEstado[est]) byEstado[est] = {segmento: est, fichas:0, cupo:0, matriculados:0, activos:0, atrasadas:0};
        byEstado[est].fichas += 1;
        byEstado[est].cupo += (r.cupo || 0);
        byEstado[est].matriculados += (r.matriculados || 0);
        byEstado[est].activos += (r.activos || 0);
        byEstado[est].atrasadas += (r.diasAtraso || 0) > 0 ? 1 : 0;
      });
      return Object.values(byEstado).sort((a,b)=> b.fichas - a.fichas);
    },
    kpis: rows => {
      const fichas = rows.length;
      const cupo = rows.reduce((s,r)=>s+(r.cupo||0),0);
      const matriculados = rows.reduce((s,r)=>s+(r.matriculados||0),0);
      const activos = rows.reduce((s,r)=>s+(r.activos||0),0);
      const atrasadas = rows.reduce((s,r)=> s + ((r.diasAtraso||0)>0 ? 1:0), 0);
      return [
        {value: fichas, label:"Fichas"},
        {value: cupo, label:"Cupo"},
        {value: matriculados, label:"Matriculados"},
        {value: activos, label:"Activos"},
        {value: atrasadas, label:"Fichas atrasadas"}
      ];
    }
  },

  r14: {
    title: "Instructor Responsable",
    desc: "Resumen por Instructor Responsable (fichas y conteos operativos). Fuentes: PE-04, DF-14A, DF-49, DF-51 y DF-53; adicionalmente, IGI (Informe General Instructores) se usa para enriquecer/normalizar el nombre del instructor, sin crear fichas nuevas.",
    pageSize: 15,
    columns: [
      {key:"responsable", label:"Instructor Responsable"},
      {key:"fichas", label:"Cantidad de Fichas", align:"num"},
      {key:"horasTotal", label:"Cantidad de horas", align:"time"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"enInduccion", label:"En Inducción", align:"num"},
      {key:"condicionado", label:"Condicionado", align:"num"},
      {key:"cancelado", label:"Cancelado", align:"num"},
      {key:"aplazado", label:"Aplazado", align:"num"},
      {key:"retiro", label:"Retiro Voluntario", align:"num"},
      {key:"porCertificar", label:"Por Certificar", align:"num"},
      {key:"certificados", label:"Certificado", align:"num"},
      {key:"enTransito", label:"Tránsito", align:"num"},
      {key:"sinRuta", label:"Sin Ruta", align:"num"},
      {key:"sinProgramar", label:"Sin Programar", align:"num"}
    ],
    filter: f => dashHasAllowedSource(f),
    data: rows => {
      // Solo NIVEL_FORMACION = Evento / Curso Especial
      const baseRows = (rows||[]).filter(r => isEventoOrCursoEspecial(r.nivel));
      const useRows = baseRows;

      const g = {};
      useRows.forEach(r=>{
        const respRaw = String(r.responsable || IGI_RESP_MAP.get(r.ficha) || "").trim();
        const respNorm = respRaw.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/\s+/g," ").trim();
        const resp = (respNorm === "BOL NAUTICO" ? "" : respRaw);
        const k = resp.trim() || "Sin responsable";
        if(!g[k]) g[k] = {
          responsable:k,
          fichas:0,
          horasTotal:0,
          activos:0,
          matriculados:0,
          enInduccion:0,
          condicionado:0,
          cancelado:0,
          aplazado:0,
          retiro:0,
          porCertificar:0,
          certificados:0,
          enTransito:0,
          sinRuta:0,
          sinProgramar:0
        };
        const x = g[k];
        x.fichas += 1;
        x.horasTotal += (Number(r.horasTotal)||0);
        x.activos += (Number(r.activos)||0);
        x.matriculados += (Number(r.matriculados)||0);
        x.enTransito += (Number(r.enTransito)||0);
        x.sinRuta += (Number(r.sinRuta)||0);

        // "Sin Programar" viene como texto (p.ej. "No"). Se cuenta por ficha.
        const sp = String(r.sinProgramar||"").toUpperCase().trim();
        if(sp && sp.startsWith("N")) x.sinProgramar += 1;

        x.enInduccion += (Number(r.enInduccion)||0);
        x.condicionado += (Number(r.condicionado)||0);
        x.cancelado += (Number(r.cancelado)||0);
        x.aplazado += (Number(r.aplazado)||0);
        x.retiro += (Number(r.retiro)||0);
        x.porCertificar += (Number(r.porCertificar)||0);
        x.certificados += (Number(r.certificados)||0);
      });
      return Object.values(g)
        .sort((a,b)=> (b.fichas - a.fichas) || String(a.responsable||"").localeCompare(String(b.responsable||"")))
        ;
    },
    kpis: rows => {
      const fichas = rows.length;
      const activos = rows.reduce((s,r)=> s + (Number(r.activos)||0), 0);
      const matriculados = rows.reduce((s,r)=> s + (Number(r.matriculados)||0), 0);
      const transito = rows.reduce((s,r)=> s + (Number(r.enTransito)||0), 0);
      return [
        {value: fichas, label:"Fichas"},
        {value: activos, label:"Activos"},
        {value: matriculados, label:"Matriculados"},
        {value: transito, label:"Tránsito"}
      ];
    }
  },

  r15: {
    title: "Programa",
    desc: "Resumen por Programa de formación (fichas y conteos operativos). Fuentes: PE-04 (NOMBRE_PROGRAMA_FORMACION y datos base), DF-14A, DF-49, DF-51 y DF-53. No considera IGI para evitar fichas huérfanas o programas incompletos.",
    pageSize: 15,
    kpis: rows => {
      const fichas = rows.length;
      const activos = rows.reduce((s,r)=> s + (Number(r.activos)||0), 0);
      const matriculados = rows.reduce((s,r)=> s + (Number(r.matriculados)||0), 0);
      return [
        {value: fichas, label:"Fichas"},
        {value: activos, label:"Activos"},
        {value: matriculados, label:"Matriculados"}
      ];
    },
    columns: [
      {key:"programa", label:"Programa"},
      {key:"fichas", label:"Cantidad de Fichas", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"enInduccion", label:"En Inducción", align:"num"},
      {key:"condicionado", label:"Condicionado", align:"num"},
      {key:"cancelado", label:"Cancelado", align:"num"},
      {key:"aplazado", label:"Aplazado", align:"num"},
      {key:"retiro", label:"Retiro Voluntario", align:"num"},
      {key:"porCertificar", label:"Por Certificar", align:"num"},
      {key:"certificados", label:"Certificado", align:"num"},
      {key:"enTransito", label:"Tránsito", align:"num"},
      {key:"sinRuta", label:"Sin Ruta", align:"num"},
      {key:"sinProgramar", label:"Sin Programar", align:"num"}
    ],
    filter: f => dashHasAllowedSource(f),
    data: rows => {
      const g = {};
      rows.forEach(r=>{
        const k = (r.programa || "Sin programa").trim() || "Sin programa";
        if(!g[k]) g[k] = {
          programa:k,
          fichas:0,
          activos:0,
          matriculados:0,
          enInduccion:0,
          condicionado:0,
          cancelado:0,
          aplazado:0,
          retiro:0,
          porCertificar:0,
          certificados:0,
          enTransito:0,
          sinRuta:0,
          sinProgramar:0
        };
        const x = g[k];
        x.fichas += 1;
        x.activos += (Number(r.activos)||0);
        x.matriculados += (Number(r.matriculados)||0);
        x.enTransito += (Number(r.enTransito)||0);
        x.sinRuta += (Number(r.sinRuta)||0);

        const sp = String(r.sinProgramar||"").toUpperCase().trim();
        if(sp && sp.startsWith("N")) x.sinProgramar += 1;

        x.enInduccion += (Number(r.enInduccion)||0);
        x.condicionado += (Number(r.condicionado)||0);
        x.cancelado += (Number(r.cancelado)||0);
        x.aplazado += (Number(r.aplazado)||0);
        x.retiro += (Number(r.retiro)||0);
        x.porCertificar += (Number(r.porCertificar)||0);
        x.certificados += (Number(r.certificados)||0);
      });
      return Object.values(g)
        .sort((a,b)=> (b.fichas - a.fichas) || String(a.programa||"").localeCompare(String(b.programa||"")))
        ;
    }
  },

  r16: {
    title: "Ocupación y efectividad",
    desc: "Indicadores por programa: Ocupación = Matriculados/Cupo y Efectividad = Activos/Matriculados. Fuentes: DF-14A y DF-49 para cupo/matriculados/activos, y PE-04 para el nombre del programa. Excluye IGI.",
    pageSize: 15,
    kpis: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (Number(r[k])||0), 0);
      return [
        {value: sum("cupo"), label:"Cupo"},
        {value: sum("matriculados"), label:"Matriculados"},
        {value: sum("activos"), label:"Activos"}
      ];
    },
    columns: [
      {key:"programa", label:"Programa"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"ocupacion", label:"Ocupación %", align:"num"},
      {key:"efectividad", label:"Efectividad %", align:"num"}
    ],
    filter: f => dashHasAllowedSource(f),
    data: rows => {
      const g = {};
      rows.forEach(r=>{
        const k=(r.programa||"Sin programa").trim()||"Sin programa";
        if(!g[k]) g[k]={programa:k, cupo:0, matriculados:0, activos:0};
        g[k].cupo += (r.cupo||0);
        g[k].matriculados += (r.matriculados||0);
        g[k].activos += (r.activos||0);
      });
      return Object.values(g).map(x=>{
        const oc = x.cupo ? (x.matriculados/x.cupo)*100 : 0;
        const ef = x.matriculados ? (x.activos/x.matriculados)*100 : 0;
        return {programa:x.programa, cupo:x.cupo, matriculados:x.matriculados, activos:x.activos,
                ocupacion: Math.round(oc), efectividad: Math.round(ef)};
      }).sort((a,b)=> b.ocupacion - a.ocupacion).slice(0,50);
    }
  },

  r17: {
    title: "Embudo operativo",
    desc: "Embudo operativo (suma de aprendices por fase): Tránsito → Inducción → Formación → Por certificar → Certificados. Fuentes: DF-49 (conteos por estado del aprendiz) y DF-14A para contraste de matriculados/activos.",
    columns: [
      {key:"paso", label:"Paso"},
      {key:"cantidad", label:"Cantidad", align:"num"}
    ],
    filter: f => true,
    data: rows => {
      const sum = (k) => rows.reduce((s,r)=> s + (r[k]||0), 0);
      return [
        {paso:"En Tránsito", cantidad: sum("enTransito")},
        {paso:"En Inducción", cantidad: sum("enInduccion")},
        {paso:"En Formación", cantidad: sum("enFormacion")},
        {paso:"Por certificar", cantidad: sum("porCertificar")},
        {paso:"Certificados", cantidad: sum("certificados")}
      ];
    },
    kpis: rows => {
      const totalActivos = rows.reduce((s,r)=>s+(r.activos||0),0);
      const totalMat = rows.reduce((s,r)=>s+(r.matriculados||0),0);
      const ratio = totalMat ? Math.round((totalActivos/totalMat)*100) : 0;
      return [
        {value: totalMat, label:"Matriculados"},
        {value: totalActivos, label:"Activos"},
        {value: ratio, label:"Activos/Matriculados %"}
      ];
    }
  },

  
  dashboard: {
    title: "Dashboard",
    desc: "Tablero interactivo (RAW_DATA) con segmentaciones y gráficas clicables. Aplica exclusión de estados como r13–r18.",
    columns: [
      {key:"ficha", label:"Ficha"},
      {key:"estado", label:"Estado"},
      {key:"centro", label:"Centro"},
      {key:"programa", label:"Programa"},
      {key:"responsable", label:"Responsable"},
      {key:"cupo", label:"Cupo", align:"num"},
      {key:"matriculados", label:"Matriculados", align:"num"},
      {key:"activos", label:"Activos", align:"num"},
      {key:"diasAtraso", label:"Días atraso", align:"num"}
    ],
    filter: f => true
  },

r18: {
    title: "SAT - Sistema de Alertas Tempranas",
    desc: "Motor de riesgo multivariable que prioriza fichas y sugiere acciones. Fuentes: PE-04 (FECHA_TERMINACION_FICHA, centro/municipio y programa), DF-14A (cupo/matriculados/activos), DF-49 (% con juicio, tránsito, formación y certificación), DF-51 (sin ruta) y DF-53 (sin programar). Excluye IGI.",
    pageSize: 15,
    kpis: rows => {
      const ctx = SAT_CONTEXT || { prevStore: satLoadStore(), curDate: satCutoffKey() };
      const computed = satCompute(rows || [], ctx.prevStore || satLoadStore(), ctx.curDate || satCutoffKey());
      const st = computed.stats || {};
      return [
        {value: st.total || 0, label:"Fichas analizadas"},
        {value: st.alertas || 0, label:"Fichas con riesgo"},
        {value: st.criticas || 0, label:"Críticas"},
        {value: st.observacion || 0, label:"En observación"},
        {value: st.higiene || 0, label:"Higiene de datos"}
      ];
    },
    columns: [
      {key:"severidad", label:"Severidad"},
      {key:"score", label:"Score", align:"num"},
      {key:"ficha", label:"Ficha"},
      {key:"programa", label:"Programa"},
      {key:"responsable", label:"Instructor Responsable"},
      {key:"diasParaFin", label:"Días a fin", align:"num"},
      {key:"conJuicioPct", label:"% Con juicio", align:"num"},
      {key:"enTransito", label:"En Tránsito", align:"num"},
      {key:"sinRuta", label:"Sin Ruta", align:"num"},
      {key:"sinProgramar", label:"Sin Programar"},
      {key:"retencionPct", label:"Retención %", align:"num"},
      {key:"alerts", label:"Alertas"},
      {key:"causaProbable", label:"Causa probable"},
      {key:"accionRecomendada", label:"Acción recomendada"},
      {key:"responsableSAT", label:"Responsable SAT"},
      {key:"sla", label:"SLA sugerido"}
    ],
    filter: f => true,
    data: rows => {
      const ctx = SAT_CONTEXT || { prevStore: satLoadStore(), curDate: satCutoffKey() };
      const computed = satCompute(rows || [], ctx.prevStore || satLoadStore(), ctx.curDate || satCutoffKey());
      return [...(computed.topRows || []), ...(computed.issueRows || [])];
    }
  }


,
reports: {
  title: "Reportes",
  desc: "Selecciona cuáles reportes deseas exportar a PDF. Se exportan sin filtros (no incluye Dashboard).",
  pageSize: 0,
  columns: [],
  filter: f => true
}};


/* =========================================================
   GLOBAL STATE
   ========================================================= */
let RAW_DATA = [];
let IGI_RESP_MAP = new Map(); // ficha -> "Instructor1 / Instructor2" (INFORME GENERAL INSTRUCTORES)
let DF14A_UNIF_FICHAS = new Set(); // fichas DF-14A con estado 'Terminada por unificación'
let DF14A_SAT_END_FICHAS = new Set(); // fichas DF-14A con estado 'Terminada', 'Terminada por fecha' o 'Terminada por unificación' (exclusión solo SAT)
let DF49_EXCL_FICHAS = new Set(); // fichas DF-49 con estado 'Cancelada' o 'Terminada por unificación'
let ESTADO_EXCL_FICHAS = new Set(); // unión de exclusiones por estado (DF-49/DF-14A)
let PE04_HOURS_PLANTA_TOTAL = 0;
let PE04_HOURS_CONTRATISTAS_TOTAL = 0;
let PE04_HOURS_TOTAL = 0;
let ACTIVE_REPORT_ID = "r1";

// Búsqueda + filtro por NIVEL (aplica a reportes 1-12; se excluyen módulos analíticos)
const EXCLUDE_SEARCH_REPORTS = new Set(["r13","r17","r19","dashboard"]);
const COMPACT_REPORTS = new Set(["r13","r14","r15","r16","r17"]);

let TABLE_SEARCH_Q = "";
const DEFAULT_NIVEL_FILTERS = ["CURSO ESPECIAL","TÉCNICO","TECNÓLOGO","OPERARIO","AUXILIAR","EVENTO","OTRO"]; // todos activos por defecto
let NIVEL_FILTERS_BY_REPORT = {}; // { [reportId]: Set<string> }

function getNivelFilters(reportId){
  const rid = reportId || ACTIVE_REPORT_ID;
  if(!NIVEL_FILTERS_BY_REPORT[rid]){
    NIVEL_FILTERS_BY_REPORT[rid] = new Set(DEFAULT_NIVEL_FILTERS);
  }
  return NIVEL_FILTERS_BY_REPORT[rid];
}

function setNivelFilters(reportId, newSet){
  const rid = reportId || ACTIVE_REPORT_ID;
  NIVEL_FILTERS_BY_REPORT[rid] = new Set(Array.from(newSet || []));
}

const NIVEL_OPTIONS = [
  {label:"CURSO ESPECIAL", color:"#0f766e"},
  {label:"TÉCNICO",       color:"#15803d"},
  {label:"TECNÓLOGO",     color:"#2563eb"},
  {label:"OPERARIO",      color:"#7c3aed"},
  {label:"AUXILIAR",      color:"#b45309"},
  {label:"EVENTO",        color:"#be123c"}
];

// Filtros adicionales por NOMBRE_PROGRAMA_ESPECIAL (multi-select; vacío => sin restricción)
const PROGESP_OPTIONS = [
  {label:"AMBIENTES VIRTUALES DE APRENDIZAJE", color:"#cfe8ff"},
  {label:"ATENCION A INSTITUCIONES", color:"#ffe7d1"},
  {label:"CAMPESENA", color:"#d7f5e3"},
  {label:"FULL POPULAR", color:"#f6e6ff"},
  {label:"FULL POPULAR  FORMACIÓN CONTINUA ESPECIAL POPULAR", color:"#fff4c2"},
  {label:"INTEGRACIÓN CON LA EDUCACIÓN MEDIA ACADÉMICA", color:"#e0f2fe"},
  {label:"INTEGRACIÓN CON LA EDUCACIÓN MEDIA TÉCNICA", color:"#dcfce7"},
  {label:"PROGRAMA DE BILINGUISMO", color:"#fde2f3"},
  {label:"SENATEC", color:"#d9f99d"},
  {label:"TECNOACADEMIA", color:"#e9d5ff"},
  {label:"SENNOVA", color:"#dbeafe"},
  {label:"VACIAS", color:"#f1f5f9"}
];

let PROGESP_FILTERS_BY_REPORT = {}; // { [reportId]: Set<string> }

function getProgEspFilters(reportId){
  const rid = reportId || ACTIVE_REPORT_ID;
  if(!PROGESP_FILTERS_BY_REPORT[rid]){
    PROGESP_FILTERS_BY_REPORT[rid] = new Set(); // vacío => no filtra
  }
  return PROGESP_FILTERS_BY_REPORT[rid];
}

function setProgEspFilters(reportId, newSet){
  const rid = reportId || ACTIVE_REPORT_ID;
  PROGESP_FILTERS_BY_REPORT[rid] = new Set(Array.from(newSet || []));
}

function renderProgEspButtons(){
  const wrap = document.getElementById("progEspFilters");
  if(!wrap) return;

  const filters = getProgEspFilters(ACTIVE_REPORT_ID);
  const selected = filters ? new Set(Array.from(filters).map(normNoAccents)) : new Set();

  wrap.innerHTML = PROGESP_OPTIONS.map(opt => {
    const key = normNoAccents(opt.label);
    const active = selected.has(key);
    return `<button class="prog-btn ${active ? "active" : ""}" data-progesp="${escapeHtml(opt.label)}" style="--btn:${opt.color}">${escapeHtml(opt.label)}</button>`;
  }).join("");

  wrap.querySelectorAll("button.prog-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const val = btn.getAttribute("data-progesp") || "";
      if(!val) return;

      const current = new Set(Array.from(getProgEspFilters(ACTIVE_REPORT_ID) || []));
      const key = normNoAccents(val);

      const has = Array.from(current).map(normNoAccents).includes(key);
      if(has){
        // eliminar el valor original que coincide por normalización
        for(const it of Array.from(current)){
          if(normNoAccents(it) === key){ current.delete(it); break; }
        }
      }else{
        current.add(val);
      }
      setProgEspFilters(ACTIVE_REPORT_ID, current);
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
    });
  });
}

function applyProgEspFilter(rows, reportId){
  let out = rows;
  const filters = getProgEspFilters(reportId);
  if(!filters || filters.size === 0){
    return out; // sin restricción
  }

  const sel = Array.from(filters).map(normNoAccents);
  const wantEmpty = sel.includes("VACIAS");
  const selNoEmpty = sel.filter(x => x !== "VACIAS");

  out = out.filter(r => {
    const raw = (r?.programaEspecial ?? "").toString().trim();
    const v = normNoAccents(raw);
    if(!v){
      return wantEmpty;
    }
    if(selNoEmpty.length === 0){
      return false;
    }
    return selNoEmpty.some(s => v.includes(s));
  });

  return out;
}


function normNoAccents(v){
  return (v ?? "")
    .toString()
    .trim()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ")
    .toUpperCase();
}




/* =========================================================
   FILTRO POR AÑOS (FECHA DE INICIO)
   - Multi-selección (checkboxes en lista desplegable)
   - Por defecto: "Periodo completo" (sin restricción)
   ========================================================= */
let YEAR_FILTERS_BY_REPORT = {}; // { [reportId]: Set<string> } ; vacío => todos

function getYearFilters(reportId){
  const rid = reportId || ACTIVE_REPORT_ID;
  if(!YEAR_FILTERS_BY_REPORT[rid]){
    YEAR_FILTERS_BY_REPORT[rid] = new Set(); // vacío => no filtra
  }
  return YEAR_FILTERS_BY_REPORT[rid];
}

function setYearFilters(reportId, newSet){
  const rid = reportId || ACTIVE_REPORT_ID;
  YEAR_FILTERS_BY_REPORT[rid] = new Set(Array.from(newSet || []));
}

function parseDateLoose(v){
  if(v === undefined || v === null) return null;
  if(v instanceof Date && !isNaN(v.getTime())) return v;

  const s = String(v).trim();
  if(!s) return null;

  // Excel serial date (days since 1899-12-30)
  if(/^[0-9]+(\.[0-9]+)?$/.test(s)){
    const n = Number(s);
    if(isFinite(n) && n > 20000 && n < 90000){
      const ms = (n - 25569) * 86400000; // 25569 = 1970-01-01
      const dt = new Date(ms);
      if(!isNaN(dt.getTime())) return dt;
    }
  }

  // dd/mm/yyyy o dd-mm-yyyy
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if(m){
    const dd = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    const yy = parseInt(m[3], 10);
    const dt = new Date(yy, mm - 1, dd);
    if(!isNaN(dt.getTime())) return dt;
  }

  // yyyy-mm-dd o yyyy/mm/dd
  m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if(m){
    const yy = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    const dd = parseInt(m[3], 10);
    const dt = new Date(yy, mm - 1, dd);
    if(!isNaN(dt.getTime())) return dt;
  }

  const dt = new Date(s);
  if(!isNaN(dt.getTime())) return dt;
  return null;
}

function yearFromValue(v){
  const dt = parseDateLoose(v);
  if(!dt) return "";
  return String(dt.getFullYear());
}

function applyYearFilter(rows, reportId){
  const filters = getYearFilters(reportId);
  if(!filters || filters.size === 0){
    return rows;
  }
  const sel = new Set(Array.from(filters).map(String));
  return (rows || []).filter(r => {
    const y = yearFromValue((r?.fechaInicioRaw || r?.fechaInicio) ?? "");
    return y && sel.has(String(y));
  });
}

function buildYearOptions(config, reportId){
  const rid = reportId || ACTIVE_REPORT_ID;
  // Opciones de años se construyen SIN aplicar el filtro de años (para permitir cambiar)
  const baseNoYear = applyProgEspFilter(applyNivelFilter(getBaseRows(config), rid), rid);

  const years = new Set();
  (baseNoYear || []).forEach(r => {
    const y = yearFromValue((r?.fechaInicioRaw || r?.fechaInicio) ?? "");
    if(y) years.add(String(y));
  });

  return Array.from(years).sort();
}

function renderYearDropdown(){
  const dd = document.getElementById("yearDropdown");
  const panel = document.getElementById("yearOptions");
  const summaryText = document.getElementById("yearSummaryText");
  if(!dd || !panel || !summaryText) return;

  const cfg = REPORTS[ACTIVE_REPORT_ID];
  const years = cfg ? buildYearOptions(cfg, ACTIVE_REPORT_ID) : [];

  if(!years || years.length === 0){
    summaryText.textContent = "Años: Todos";
    panel.innerHTML = '<div class="year-panel-title">SELECCIONAR AÑOS</div><div class="search-hint">No hay fechas de inicio para filtrar.</div>';
    dd.removeAttribute("open");
    dd.style.opacity = 0.6;
    return;
  }
  dd.style.opacity = 1;

  const cur = getYearFilters(ACTIVE_REPORT_ID);
  const selected = cur ? new Set(Array.from(cur).map(String)) : new Set();
  const treatAll = (selected.size === 0);

  panel.innerHTML = `<div class="year-panel-title">SELECCIONAR AÑOS</div>` + years.map(y => {
    const checked = treatAll || selected.has(String(y));
    return `<label class="year-opt"><input type="checkbox" data-year="${y}" ${checked ? "checked" : ""}>${y}</label>`;
  }).join("");

  const updateSummary = () => {
    const s = getYearFilters(ACTIVE_REPORT_ID);
    const arr = s ? Array.from(s).map(String) : [];
    if(!arr || arr.length === 0){
      summaryText.textContent = "Años: Todos";
    }else{
      summaryText.textContent = "Años: " + arr.sort().join(", ");
    }
  };
  updateSummary();

  panel.querySelectorAll('input[type="checkbox"][data-year]').forEach(chk => {
    chk.addEventListener("change", () => {
      const checkedYears = Array.from(panel.querySelectorAll('input[type="checkbox"][data-year]'))
        .filter(x => x.checked)
        .map(x => x.getAttribute("data-year"));

      // Si selecciona TODOS o NINGUNO => Periodo completo (sin restricción)
      let newSet = new Set();
      if(checkedYears.length > 0 && checkedYears.length < years.length){
        checkedYears.forEach(y => newSet.add(String(y)));
      }

      setYearFilters(ACTIVE_REPORT_ID, newSet);
      updateSummary();
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
    });
  });
}

function shouldUseTableTools(reportId){
  return true; // tool container visible; search may be excluded per módulo
}

function shouldUseSearch(reportId){
  return !EXCLUDE_SEARCH_REPORTS.has(reportId);
}

function applyCompactMode(){
  const compact = COMPACT_REPORTS.has(ACTIVE_REPORT_ID);
  const tc = document.querySelector(".table-container");
  const tbl = document.getElementById("dataTable");
  if(tc) tc.classList.toggle("compact", compact);
  if(tbl) tbl.classList.toggle("compact", compact);
}


function applyNivelFilter(rows, reportId){
  let out = rows;

  // Filtro por NIVEL (multi-select) por reporte.
  // - "CURSO ESPECIAL" inicia activo por defecto, pero puede desactivarse.
  // - Si no hay ningún NIVEL seleccionado => NO se muestran filas.
  const filters = getNivelFilters(reportId);
  if(!filters || filters.size === 0){
    return [];
  }

  const nvs = Array.from(filters).map(normNoAccents);
  out = out.filter(r => {
    const rv = normNoAccents(r?.nivel || "");
    if(!rv) return false;
    return nvs.some(nv => rv.includes(nv));
  });

  return out;
}

function applySearchFilter(rows, config, reportId, searchQ){
  let out = rows;
  const rid = reportId || ACTIVE_REPORT_ID;

  // Búsqueda libre sobre las columnas visibles del reporte
  if(shouldUseSearch(rid)){
    const q = (searchQ !== undefined ? searchQ : (rid === ACTIVE_REPORT_ID ? (TABLE_SEARCH_Q || "") : "")).trim().toLowerCase();
    if(q){
      const terms = q.split(/\s+/).filter(Boolean);
      const keys = (config?.columns || []).map(c => c.key);
      out = out.filter(r => {
        const hay = keys.map(k => (r?.[k] ?? "")).join(" ").toLowerCase();
        return terms.every(t => hay.includes(t));
      });
    }
  }

  return out;
}

// Compat: ambos filtros sobre filas detalladas (no agregadas)
function applyViewFilters(rows, config, reportId, searchQ){
  return applySearchFilter(applyProgEspFilter(applyNivelFilter(applyYearFilter(rows, reportId), reportId), reportId), config, reportId, searchQ);
}

// Base rows del reporte (antes de agregaciones)
function getBaseRows(config){
  if(!config) return [];
  if(typeof config.filter === "function") return RAW_DATA.filter(config.filter);
  return RAW_DATA;
}

// Para módulos analíticos: hacer que la búsqueda filtre también el universo base
function applyAnalyticSearchOnBase(rows, reportId, searchQ){
  const rid = reportId || ACTIVE_REPORT_ID;
  if(!shouldUseSearch(rid)) return rows;
  const q = (searchQ !== undefined ? searchQ : (rid === ACTIVE_REPORT_ID ? (TABLE_SEARCH_Q || "") : "")).trim().toLowerCase();
  if(!q) return rows;

  const terms = q.split(/\s+/).filter(Boolean);
  if(rid === "r18"){
    return rows.filter(r => {
      const hay = `${r?.ficha ?? ""} ${r?.programa ?? ""} ${r?.centro ?? ""} ${r?.responsable ?? ""}`.toLowerCase();
      return terms.every(t => hay.includes(t));
    });
  }

  const field = (rid === "r14") ? "responsable"
              : ((rid === "r15" || rid === "r16") ? "programa" : "");
  if(!field) return rows;

  return rows.filter(r => {
    const hay = String(r?.[field] ?? "").toLowerCase();
    return terms.every(t => hay.includes(t));
  });
}

// Modelo de vista: baseRows (KPIs) + tableRows (render tabla / charts)

/* =========================================================
   EXCLUSIÓN DE FICHAS POR ESTADO (DF-49 / DF-14A)
   - Aplica a: Resumen ejecutivo global (r13), Instructor Responsable (r14),
               Programa (r15), Ocupación y efectividad (r16),
               Embudo operativo (r17)
   - También se reutiliza en SAT (r18)
   ========================================================= */

const ESTADO_EXCLUSION_REPORTS = new Set(["r13","r14","r15","r16","r17","r18","dashboard"]);

function isFichaEstadoExcluded(row, reportId){
  if(!row) return false;

  const rid = reportId || ACTIVE_REPORT_ID;
  const ficha = normalizeFicha(row.ficha || "");

  // Exclusión global (r13-r18): Cancelada o Terminada por unificación
  if(ficha && ESTADO_EXCL_FICHAS && ESTADO_EXCL_FICHAS.has(ficha)) return true;
  if(ficha && DF14A_UNIF_FICHAS && DF14A_UNIF_FICHAS.has(ficha)) return true;

  // Exclusión adicional SOLO SAT (r18): DF-14A => Terminada / Terminada por fecha / Terminada por unificación
  if(rid === "r18" && ficha && DF14A_SAT_END_FICHAS && DF14A_SAT_END_FICHAS.has(ficha)) return true;

  // Exclusión adicional SOLO SAT (r18): fichas creadas SOLO desde INFORME GENERAL INSTRUCTORES (IGI)
  // (evita filas huérfanas sin programa/municipio en el SAT)
  if(rid === "r18"){
    try{
      const tags = row._srcTags || null;
      if(tags){
        const ks = Object.keys(tags);
        if(ks.length === 1 && ks[0] === "IGI") return true;
      }
    }catch(e){}
  }

  const estados = [];
  if(row.estado) estados.push(row.estado);

  const bySrc = row._estadoBySrc || {};
  if(bySrc.DF49) estados.push(bySrc.DF49);
  if(bySrc.DF14A) estados.push(bySrc.DF14A);

  const norm = (v) => normNoAccents((v ?? "").toString().trim().toUpperCase());

  const hasCancel = estados.some(s => norm(s).includes("CANCELAD"));

  const hasUnif = estados.some(s => {
    const t = norm(s);
    return t.includes("TERMINADA POR UNIFICACION") || (t.includes("UNIFICACION") && t.includes("TERMINAD"));
  });

  const hasTerm = (rid === "r18") && estados.some(s => {
    const t = norm(s);
    return (t.trim() === "TERMINADA") || t.includes("TERMINADA POR FECHA");
  });

  return hasCancel || hasUnif || hasTerm;
}

function applyEstadoExclusion(rows, reportId){
  if(!ESTADO_EXCLUSION_REPORTS.has(reportId)) return rows || [];
  return (rows || []).filter(r => !isFichaEstadoExcluded(r, reportId));
}

function getViewModel(config, reportId, searchQ){
  const rid = reportId || ACTIVE_REPORT_ID;
  let base = applyProgEspFilter(applyNivelFilter(applyYearFilter(getBaseRows(config), rid), rid), rid);
  base = applyEstadoExclusion(base, rid);

  if(typeof config.data === "function"){
    const agg = (config.data(base) || []);
    const tableRows = applySearchFilter(agg, config, rid, searchQ);
    const baseForKpi = applyAnalyticSearchOnBase(base, rid, searchQ);
    return { baseRows: baseForKpi, tableRows, baseAll: base, aggAll: agg };
  }

  const tableRows = applySearchFilter(base, config, rid, searchQ);
  return { baseRows: tableRows, tableRows, baseAll: base, aggAll: null };
}

function renderNivelButtons(){
  const wrap = document.getElementById("nivelFilters");
  if(!wrap) return;

  const filters = getNivelFilters(ACTIVE_REPORT_ID);
  const selected = filters ? new Set(Array.from(filters).map(normNoAccents)) : new Set();

  wrap.innerHTML = NIVEL_OPTIONS.map(opt => {
    const active = selected.has(normNoAccents(opt.label));
    return `<button class="level-btn ${active ? "active" : ""}" data-nivel="${opt.label}" title="Filtrar por ${opt.label}" style="--btn:${opt.color}"><span class="check">✓</span><span class="lbl">${opt.label}</span></button>`;
  }).join("");

  wrap.querySelectorAll("button.level-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const nv = btn.getAttribute("data-nivel") || "";
      if(!nv) return;

      const current = new Set(Array.from(getNivelFilters(ACTIVE_REPORT_ID) || []));
      const key = normNoAccents(nv);
      const has = Array.from(current).some(x => normNoAccents(x) === key);
      if(has){
        // remove
        for(const x of Array.from(current)){
          if(normNoAccents(x) === key) current.delete(x);
        }
        btn.classList.remove("active");
      }else{
        current.add(nv);
        btn.classList.add("active");
      }

      setNivelFilters(ACTIVE_REPORT_ID, current);
      // Re-render current view (sin reiniciar búsqueda)
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
    });
  });
}

function updateTableToolsUI(){
  const tools = document.getElementById("tableTools");
  const faTools = document.getElementById("faAprTools");

  const search = document.getElementById("tableSearch");
  const hint = document.getElementById("tableToolsHint");
  const searchRow = tools ? tools.querySelector(".search-row") : null;
  const yearDd = document.getElementById("yearDropdown");
  if(!tools) return;

  tools.style.display = "block";

  // La búsqueda se puede deshabilitar por módulo, pero el filtro de año debe permanecer visible
  const searchEnabled = shouldUseSearch(ACTIVE_REPORT_ID);

  if(searchRow) searchRow.style.display = "flex";

  if(search){
    search.disabled = !searchEnabled;
    search.style.display = "block";
    const sb = document.getElementById("searchBox");
    if(sb) sb.classList.toggle("disabled", !searchEnabled);
    search.placeholder = searchEnabled ? "Buscar por número de ficha, programa o código..." : "Búsqueda no disponible en este módulo";
  }

  if(yearDd) yearDd.style.display = "block";

  if(hint) hint.style.display = searchEnabled ? "none" : "block";
}


// Ordenamiento (A-Z / Z-A) por reporte y columna
const SORT_STATE = {}; // { [reportId]: { key: string, dir: 'asc'|'desc' } }

// Paginación en tablas (solo en reportes específicos)
const TABLE_PAGE_STATE = {}; // { [reportId]: number }


// Preferencias de fuente para completar campos cuando vienen vacíos (Ajustes 2-6)
const FIELD_PREF = {
  estado: ["DF49","DF51","DF53","DF14A","PE04","IGI","OTRO"],
  modalidad: ["PE04"],
  centro: ["PE04","IGI"],
  municipio: ["DF53","DF49","DF51","DF14A","PE04","IGI","OTRO"],
  responsable: ["PE04","IGI"],
  programaEspecial: ["PE04","DF14A","DF53","DF49"],
  etapa: ["PE04"],
  tipo: ["PE04","DF53","DF51"],
  nivel: ["PE04","DF14A","DF53","DF51","DF49"],
  matriculados: ["DF49","DF14A","DF51","DF53","PE04"],
  totalApreMasculinos: ["PE04"],
  totalApreFemeninos: ["PE04"],
  totalApreNoBinario: ["PE04"]
};

// Lista maestra de municipios (PE-04, columna AG NOMBRE_MUNICIPIO_CURSO)
let PE04_MUNICIPIOS_MASTER = new Set();

function detectSource(fileName){
  const norm = normFileKey(fileName || "");
  if(norm.includes("pe04")) return "PE04";
  if(norm.includes("df14a")) return "DF14A";
  if(norm.includes("df49")) return "DF49";
  if(norm.includes("df51")) return "DF51";
  if(norm.includes("df53")) return "DF53";
  // IGI / instructores
  if(norm.includes("instructores") || norm.includes("informegeneralinstructores")) return "IGI";
  return "OTRO";
}

function prefIndex(src, list){
  if(!list) return 999;
  const i = list.indexOf(src || "");
  return i === -1 ? 999 : i;
}

function mergePreferred(existing, field, value, srcTag){
  const v = (value === undefined || value === null) ? "" : String(value).trim();
  if(!v) return;

  if(!existing._src) existing._src = {};
  const cur = (existing[field] === undefined || existing[field] === null) ? "" : String(existing[field]).trim();

  if(!cur){
    existing[field] = v;
    existing._src[field] = srcTag;
    return;
  }

  const pref = FIELD_PREF[field];
  if(!pref) return;

  const curSrc = existing._src[field] || "";
  if(prefIndex(srcTag, pref) < prefIndex(curSrc, pref)){
    existing[field] = v;
    existing._src[field] = srcTag;
  }
}

function mergeMax(existing, field, value){
  const v = Number(value);
  if(!isFinite(v)) return;
  const cur = Number(existing[field]);
  if(!isFinite(cur)) existing[field] = v;
  else existing[field] = Math.max(cur, v);
}


function mergePreferredNumber(existing, field, value, srcTag){
  const v = Number(value);
  if(!isFinite(v)) return;

  if(!existing._src) existing._src = {};
  const pref = FIELD_PREF[field];

  const curVal = Number(existing[field]);
  const hasCur = isFinite(curVal);

  if(!hasCur){
    existing[field] = v;
    existing._src[field] = srcTag;
    return;
  }

  if(!pref){
    existing[field] = Math.max(curVal, v);
    return;
  }

  const curSrc = existing._src[field] || "";
  const a = prefIndex(srcTag, pref);
  const b = prefIndex(curSrc, pref);

  if(a < b){
    existing[field] = v;
    existing._src[field] = srcTag;
    return;
  }
  if(a === b){
    existing[field] = Math.max(curVal, v);
  }
}

function mergeDate(existing, field, value, mode){
  // mode: "min" or "max"
  if(!value) return;
  const d = parseDateLoose(value);
  if(!d) return;

  const curV = existing[field];
  if(!curV){
    existing[field] = value;
    return;
  }
  const curD = parseDateLoose(curV);
  if(!curD){
    existing[field] = value;
    return;
  }
  if(mode === "min" && d < curD) existing[field] = value;
  if(mode === "max" && d > curD) existing[field] = value;
}

function upsertFicha(map, row){
  const ficha = normalizeFicha(row.ficha || "");
  if(!ficha) return;

  const srcTag = row._srcTag || "OTRO";
  const existing = map.get(ficha) || {ficha};

  // Track de fuentes que aportan a la ficha (para exclusiones por reporte)
  try{
    if(!existing._srcTags) existing._srcTags = {};
    existing._srcTags[srcTag] = 1;
  }catch(e){}


  // Guardar estado por fuente para exclusiones (DF-49 / DF-14A)
  if(row.estado){
    if(!existing._estadoBySrc) existing._estadoBySrc = {};
    existing._estadoBySrc[srcTag] = row.estado;
  }

  // Texto con preferencia
  mergePreferred(existing, "estado", row.estado, srcTag);
  mergePreferred(existing, "programa", row.programa, srcTag);
  mergePreferred(existing, "centro", row.centro, srcTag);
  mergePreferred(existing, "municipio", row.municipio, srcTag);
  

  // Departamento (para mapa y homónimos de municipio)
  if(row.departamentoCurso){
    if(!existing.departamentoCurso || srcTag === "PE04") existing.departamentoCurso = row.departamentoCurso;
  }
mergePreferred(existing, "modalidad", row.modalidad, srcTag);
  mergePreferred(existing, "nivel", row.nivel, srcTag);
  mergePreferred(existing, "tipo", row.tipo, srcTag);
  mergePreferred(existing, "responsable", row.responsable, srcTag);
  // Empresa y matriculados PE-04
  if(srcTag === "PE04"){ mergePreferred(existing, "empresa", row.empresa, srcTag); }
  if(srcTag === "PE04" && row.matriculadosPE04 !== undefined){
    if(existing.matriculadosPE04 === undefined || existing.matriculadosPE04 === null) existing.matriculadosPE04 = 0;
    existing.matriculadosPE04 += (Number(row.matriculadosPE04)||0);
  }

  // Horas (PE-04): acumular por ficha y totales globales
  if(srcTag === "PE04" && isEventoOrCursoEspecial(row.nivel || row.nivelFormacion || existing.nivel)){
    // Horas vienen como minutos (ver parsePE04Fixed). Para el total se prioriza TOTAL_HORAS (AW).
    const _hp = Number(row.horasPlanta)||0;           // minutos
    const _hc = Number(row.horasContratistas)||0;     // minutos
    const _ht = Number(row.horasTotal)||0;            // minutos (AW si existe, si no AR+AS)

    if(existing.horasPlanta === undefined || existing.horasPlanta === null) existing.horasPlanta = 0;
    if(existing.horasContratistas === undefined || existing.horasContratistas === null) existing.horasContratistas = 0;
    if(existing.horasTotal === undefined || existing.horasTotal === null) existing.horasTotal = 0;

    existing.horasPlanta += _hp;
    existing.horasContratistas += _hc;
    existing.horasTotal += (_ht > 0 ? _ht : (_hp + _hc));

    PE04_HOURS_PLANTA_TOTAL += _hp;
    PE04_HOURS_CONTRATISTAS_TOTAL += _hc;
    PE04_HOURS_TOTAL += (_ht > 0 ? _ht : (_hp + _hc));
  }
  mergePreferred(existing, "programaEspecial", row.programaEspecial, srcTag);
  mergePreferred(existing, "etapa", row.etapa, srcTag);

  // Fechas (mejor esfuerzo)
  mergeDate(existing, "fechaInicioRaw", row.fechaInicioRaw || row.fechaInicio, "min");
  mergeDate(existing, "fechaFinRaw", row.fechaFinRaw || row.fechaFin, "max");

  // Versión formateada
  if(existing.fechaInicioRaw) existing.fechaInicio = fmtDate(existing.fechaInicioRaw);
  if(existing.fechaFinRaw) existing.fechaFin = fmtDate(existing.fechaFinRaw);

  // Completar NIVEL si quedó vacío (Ajuste 2)
  if(!String(existing.nivel||"" ).trim()){
    const t = String(existing.tipo||"" ).trim();
    existing.nivel = t ? t : "OTRO";
  }

  // Numéricos
  mergePreferredNumber(existing, "matriculados", row.matriculados, srcTag);
  mergePreferredNumber(existing, "totalApreMasculinos", row.totalApreMasculinos, srcTag);
  mergePreferredNumber(existing, "totalApreFemeninos", row.totalApreFemeninos, srcTag);
  mergePreferredNumber(existing, "totalApreNoBinario", row.totalApreNoBinario, srcTag);
  ["cupo","activos","enTransito","enInduccion","sinRuta","formacion","enFormacion",
   "certificado","certificados","porCertificar","condicionado","cancelado","aplazado","retiro","aprendicesSinJuicio",
   "cancelamientoVirtComp","desercionVirtComp","trasladado","otro"].forEach(k => mergeMax(existing, k, row[k]));

  // Texto sin preferencia estricta
  if(row.sinProgramar && !existing.sinProgramar) existing.sinProgramar = row.sinProgramar;

  map.set(ficha, existing);
}

/* =========================================================
   FILE HANDLING
   ========================================================= */

const REQUIRED_UPLOADS = [
  {
    id: "PE-04",
    key: "pe04",
    label: "PE-04_ PROGRAMACIÓN ESPECÍFICA DE CURSOS LARGOS, ESPECIALES Y EVENTOS POR REGIONAL Y CENTRO",
    hint: "XML · se recomienda últimos 2 años"
  },
  { id: "DF-14A", key: "df14a", label: "DF-14A_MATRICULADOS_RESUMEN_POR_FICHA", hint: "XML" },
  { id: "DF-53",  key: "df53",  label: "DF-53_ CONSOLIDADO_FICHAS_CON_Y_SIN_PROGRAMACION_ESPECIFICA (EVENTOS)", hint: "XML" },
  { id: "DF-51",  key: "df51",  label: "DF-51_CONSOLIDADO_DE_FICHAS_CON_O_SIN_RUTA", hint: "XML" },
  { id: "DF-49",  key: "df49",  label: "DF-49_REPORTE_CONSOLIDADO_DE_APRENDICES_POR_FICHA", hint: "XML" }
];

function normFileKey(s){
  return (s ?? "")
    .toString()
    .trim()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "");
}


/* =========================================================
   CARGA LOCAL (ARCHIVOS)
   ========================================================= */

function evaluateRequiredUploads(files){
  const list = Array.from(files || []);
  const names = list.map(f => (f && f.name) ? String(f.name) : "");
  const norms = names.map(normFileKey);

  const items = REQUIRED_UPLOADS.map(req => {
    let found = false;
    let matchedName = "";

    for(let i=0; i<norms.length; i++){
      const n = norms[i];
      const ok = (typeof req.matcher === "function") ? !!req.matcher(n) : n.includes(req.key);
      if(ok){
        found = true;
        matchedName = names[i] || "";
        break;
      }
    }
    return {req, found, matchedName};
  });

  const foundCount = items.filter(x => x.found).length;
  return {items, foundCount, total: REQUIRED_UPLOADS.length};
}

function renderRequiredChecklist(files){
  const el = document.getElementById("requiredChecklist");
  if(!el) return;

  const hasFiles = !!(files && files.length);
  const st = evaluateRequiredUploads(files);

  const countTxt = hasFiles
    ? `Encontrados ${st.foundCount}/${st.total}`
    : `Pendiente (${st.total} requeridos)`;

  const itemsHtml = st.items.map(it => {
    const statusClass = hasFiles ? (it.found ? "ok" : "miss") : "pending";
    const statusText  = hasFiles ? (it.found ? "OK" : "FALTA") : "PENDIENTE";
    const hint = it.found
      ? `Coincide: ${escapeHtml(it.matchedName || "")}`
      : (it.req.hint || "");

    return `
      <li class="check-item">
        <div>
          <div class="check-name">${escapeHtml(it.req.label)}</div>
          <div class="check-hint">${escapeHtml(hint)}</div>
        </div>
        <span class="check-status ${statusClass}">${statusText}</span>
      </li>`;
  }).join("");

  el.innerHTML = `
    <div class="checklist-title">
      <h4>Lista de chequeo de archivos</h4>
      <div class="checklist-count">${escapeHtml(countTxt)}</div>
    </div>
    <ul class="check-items">${itemsHtml}</ul>
  `;
}

function warnIfMissingUploads(files){
  const st = evaluateRequiredUploads(files);
  const missing = st.items.filter(x => !x.found).map(x => x.req.label);
  if(missing.length === 0) return true;

  const msg = "Faltan los siguientes archivos requeridos:\n\n- " + missing.join("\n- ") +
              "\n\nSi continúas, algunos cálculos pueden quedar incompletos.\n\n¿Deseas continuar?";
  return window.confirm(msg);
}

function handleFiles(){
  const files = document.getElementById("fileInput").files;
  const btn = document.getElementById("btnParse");
  const count = document.getElementById("fileCount");
  
  if(files.length > 0){
    count.textContent = `${files.length} archivo(s) seleccionado(s)`;
    btn.classList.remove("hidden");
  } else {
    count.textContent = "";
    btn.classList.add("hidden");
  }

  // Lista de chequeo (Ajuste 1)
  renderRequiredChecklist(files);
}

// Ajuste 5: Carga con barra de progreso
async function processFiles(filesOverride){
  const inputEl = document.getElementById("fileInput");
  const files = filesOverride ? Array.from(filesOverride) : Array.from((inputEl && inputEl.files) ? inputEl.files : []);
  if(!files.length) return;

  // Lista de chequeo (Ajuste 1)
  renderRequiredChecklist(files);
  if(!warnIfMissingUploads(files)){
    return;
  }

  const btn = document.getElementById("btnParse");
  btn.disabled = true;
  
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  
  progressContainer.style.display = "block";
  RAW_DATA = []; // Reset
  IGI_RESP_MAP = new Map(); // reset IGI mapping
  DF14A_UNIF_FICHAS = new Set();
  DF14A_SAT_END_FICHAS = new Set();
  DF49_EXCL_FICHAS = new Set();
  ESTADO_EXCL_FICHAS = new Set();
  PE04_HOURS_PLANTA_TOTAL = 0;
  PE04_HOURS_CONTRATISTAS_TOTAL = 0;
  PE04_HOURS_TOTAL = 0;
  const fichaMap = new Map();

  for(let i=0; i<files.length; i++){
    try {
      const data = await readFileAsync(files[i]);
      const nameL = (files[i].name || "").toLowerCase();
      let rows = [];
      if(nameL.endsWith(".xls") || nameL.endsWith(".xlsx")){
        rows = parseInstructoresXLS(data, files[i].name);
      } else {
        rows = parseXML(data, files[i].name);
      }
      rows.forEach(r => { try{
          if(!r) return;

          // INFORME GENERAL INSTRUCTORES (IGI): solo enriquece Instructor Responsable (no crea fichas nuevas)
          if(r._srcTag === "IGI"){
            const f = normalizeFicha(r.ficha || "");
            const nom = String(r.responsable || "").trim();
            if(f && nom){
              const cur = IGI_RESP_MAP.get(f) || "";
              IGI_RESP_MAP.set(f, mergeSlashNames(cur, nom));
            }
            return;
          }
          const f = normalizeFicha(r.ficha || "");
          const st = normNoAccents(String(r.estado || "").toUpperCase());
          const isUnif = st.includes("TERMINADA POR UNIFICACION") || (st.includes("UNIFICACION") && st.includes("TERMINAD"));
          const isCancel = st.includes("CANCELAD");
          const isTerm = (st.trim() === "TERMINADA") || st.includes("TERMINADA POR FECHA");

          // DF-14A (P): Terminada (incluye por fecha / unificación)
          // - SAT: marcar para exclusión
          // - Unificación: además excluir globalmente y no consolidar la fila DF-14A
          if(r._srcTag === "DF14A"){
            if(f && (isUnif || isTerm)){ DF14A_SAT_END_FICHAS.add(f); }
            if(isUnif){
              if(f){ DF14A_UNIF_FICHAS.add(f); ESTADO_EXCL_FICHAS.add(f); }
              return; // no consolidar fila DF-14A (tabla DF-14A)
            }
          }

          // DF-49 (H): Cancelada o Terminada por unificación => excluir
          if(r._srcTag === "DF49" && (isCancel || isUnif)){
            if(f){ DF49_EXCL_FICHAS.add(f); ESTADO_EXCL_FICHAS.add(f); }
            return; // no consolidar fila DF-49 (ficha excluida)
          }
        }catch(e){}
        upsertFicha(fichaMap, r);
      });
      
      // Update Progress
      const pct = Math.round(((i + 1) / files.length) * 100);
      progressBar.value = pct;
      progressText.textContent = pct + "%";
      
      // Allow UI render
      await new Promise(r => setTimeout(r, 10));
      
    } catch(e) {
      console.error("Error parsing file", files[i].name, e);
    }
  }

  
  // Enriquecer responsable con IGI (sin crear fichas nuevas)
  try{
    for(const [f, nom] of IGI_RESP_MAP.entries()){
      const ex = fichaMap.get(f);
      if(!ex) continue;
      const cur = String(ex.responsable || "").trim();
      const merged = mergeSlashNames(cur, nom);
      if(merged){
        ex.responsable = merged;
        try{
          if(!ex._srcTags) ex._srcTags = {};
          ex._srcTags["IGI"] = 1;
        }catch(e){}
      }
    }
  }catch(e){}

  RAW_DATA = Array.from(fichaMap.values());
  RAW_DATA.forEach(r => {
    r.estado = r.estado || "";
    r.terminada = (r.estado.toUpperCase().includes("TERMINADA") || r.estado.toUpperCase().includes("CERRADA"));
    r.fechaFinRaw = r.fechaFinRaw || r.fechaFin || "";
    r.diasAtraso = calcDiasAtraso(r.fechaFinRaw);
  });

  // Finalize
  setTimeout(() => {
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
      
      // Init / preserve cutoff date
      const _cd = document.getElementById("cutoffDate");
      if(_cd && (!_cd.value || !_cd.value.trim())){
        _cd.valueAsDate = new Date();
      }

      // SAT snapshot (persistencia / tendencia)
      satUpdateSnapshot(applyEstadoExclusion(RAW_DATA, "r18"));
      
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
  }, 500);
}

function readFileAsync(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = (e) => resolve(e.target.result);
    fr.onerror = (e) => reject(e);

    const name = (file && file.name ? file.name : "").toLowerCase();
    if(name.endsWith(".xls") || name.endsWith(".xlsx")){
      fr.readAsArrayBuffer(file);
    } else {
      fr.readAsText(file); // XML (Excel 2003) / texto
    }
  });
}

/* =========================================================
   PARSER (XML EXCEL)
   ========================================================= */

function parseInstructoresXLS(arrayBuffer, fileName=""){
  // Requiere SheetJS (XLSX) - se carga en <head>
  const out = [];
  try{
    const wb = XLSX.read(arrayBuffer, {type:"array"});
    const sheetName = wb.SheetNames[0];
    if(!sheetName) return out;
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    // Datos desde fila 8 (index 7). FICHA = Col H (index 7), Nombre Instructor = Col O (index 14)
    const map = new Map();
    for(let i=7; i<rows.length; i++){
      const r = rows[i] || [];
      const fichaRaw = (r[7] !== undefined && r[7] !== null) ? String(r[7]).trim() : "";
      const nomRaw = (r[14] !== undefined && r[14] !== null) ? String(r[14]).trim() : "";
      const ficha = normalizeFicha(fichaRaw);
      const nombre = nomRaw;
      if(!ficha || !nombre) continue;
      const cur = map.get(ficha) || [];
      if(!cur.includes(nombre)) cur.push(nombre);
      map.set(ficha, cur);
    }
    for(const [ficha, nombres] of map.entries()){
      out.push({ficha, responsable: nombres.join(" / "), _srcTag:"IGI"});
    }
  } catch(e){
    console.error("Error leyendo INFORME GENERAL INSTRUCTORES", fileName, e);
  }
  return out;
}


function parseXML(xmlText, fileName="") {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "text/xml");
  
    const _srcTag = detectSource(fileName);

  // Densifica celdas para respetar ss:Index (filas con celdas omitidas)
  const densifyCells = (cells) => {
    const dense = [];
    let currentIdx = 0;
    cells.forEach(c => {
      const attrIdx = c.getAttribute("ss:Index") || c.getAttribute("Index") || c.getAttribute("index") || c.getAttributeNS("urn:schemas-microsoft-com:office:spreadsheet","Index");
      if(attrIdx) currentIdx = parseInt(attrIdx) - 1; // 1-based -> 0-based
      dense[currentIdx] = c;
      currentIdx++;
    });
    return dense;
  };

  const cellText = (c) => (c ? (c.textContent || "").trim() : "");


// --- Escaneo robusto para exclusión por estado en DF-14A ---
// Motivo: algunos DF-14A no se detectan por encabezado y se requiere leer por posición fija:
//   FICHA = Col L (index 11), ESTADO_FICHA = Col P (index 15)
if(_srcTag === "DF14A"){
  try{
    const allRowsScan = Array.from(xmlDoc.getElementsByTagName("Row"));
    for(const rr of allRowsScan){
      const cc = Array.from(rr.getElementsByTagName("Cell"));
      if(!cc.length) continue;
      const dense = densifyCells(cc);
      const fichaScan = normalizeFicha(cellText(dense[11])); // L
      const estadoScan = cellText(dense[15]);                // P
      if(!fichaScan || !estadoScan) continue;
      const stScan = normNoAccents(estadoScan);
      const isUnifScan = stScan.includes("TERMINADA POR UNIFICACION") || (stScan.includes("UNIFICACION") && stScan.includes("TERMINAD"));
      const isTermScan = (stScan.trim() === "TERMINADA") || stScan.includes("TERMINADA POR FECHA");

      // SAT: excluir 'Terminada' / 'Terminada por fecha' / 'Terminada por unificación'
      if(isUnifScan || isTermScan){
        DF14A_SAT_END_FICHAS.add(fichaScan);
      }

      // Exclusión global (como venía): solo unificación
      if(isUnifScan){
        DF14A_UNIF_FICHAS.add(fichaScan);
        ESTADO_EXCL_FICHAS.add(fichaScan);
      }
    }
  }catch(e){}
}

  const normKeyLocal = (s) => {
    return (s || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .replace(/\s+/g, "_")
      .replace(/[^A-Z0-9_]/g, "");
  };

  // Extracción fija PE-04 (equivalente a BUSCARV sobre columnas por letra):
  // Key en columna E; Nivel=I, Tipo=L, Etapa=O, Modalidad=P, Responsable=Q
  const parsePE04Fixed = () => {
    const out = [];
    let idxHorasPlanta = 43;        // AR (fallback)
    let idxHorasContratistas = 44;  // AS (fallback)
    let idxTotalHoras = 48;         // AW (fallback)
    const allRows = Array.from(xmlDoc.getElementsByTagName("Row"));
    for(const r of allRows){
      const cells = Array.from(r.getElementsByTagName("Cell"));
      if(!cells.length) continue;
      const dense = densifyCells(cells);

      const keyE = cellText(dense[4]); // E
      if(!keyE) continue;
      if(normKeyLocal(keyE) === "FICHA"){
        // Detecta índices por encabezado cuando el XML no incluye ss:Index para celdas vacías
        for(let i=0;i<dense.length;i++){
          const h = normKeyLocal(cellText(dense[i]));
          if(!h) continue;
          if(h === "HORAS_PLANTA" || h.endsWith("_HORAS_PLANTA") || h.includes("HORAS_PLANTA")) idxHorasPlanta = i;
          if(h === "TOTAL_HORAS" || h.endsWith("_TOTAL_HORAS") || h.includes("TOTAL_HORAS")) idxTotalHoras = i;
          if(h === "HORAS_CONTRATISTAS" || h.endsWith("_HORAS_CONTRATISTAS") || h.includes("HORAS_CONTRATISTAS")) idxHorasContratistas = i;
        }
        continue;
      }

      const ficha = normalizeFicha(keyE);
      if(!ficha) continue;

      const nivel = cellText(dense[8]);        // I
      const tipo = cellText(dense[11]);        // L
      const etapa = cellText(dense[14]);       // O
      const modalidad = cellText(dense[15]);   // P
      const responsable = stripBolNauticoPrefix(cellText(dense[16])); // Q
      const empresa = cellText(dense[19]);   // T (NOMBRE_EMPRESA)
      const programa = stripBolNauticoPrefix(cellText(dense[26]));      // AA (NOMBRE_PROGRAMA_FORMACION)
      const departamentoCurso = cellText(dense[30]);   // AE (NOMBRE_DEPARTAMENTO_CURSO)
      const municipio = cellText(dense[32]);   // AG (NOMBRE_MUNICIPIO_CURSO)
      const horasPlanta = parseHoursLoose(cellText(dense[idxHorasPlanta]));        // HORAS_PLANTA (AR por defecto) -> minutos
      const horasContratistas = parseHoursLoose(cellText(dense[idxHorasContratistas]));  // HORAS_CONTRATISTAS (AS por defecto) -> minutos
      const totalHoras = parseHoursLoose(cellText(dense[idxTotalHoras]));              // TOTAL_HORAS (AW por defecto) -> minutos
      const horasTotal = (totalHoras > 0 ? totalHoras : (horasPlanta + horasContratistas));
      // Totales globales PE-04 (minutos) para KPIs
      PE04_HOURS_PLANTA_TOTAL += (Number(horasPlanta)||0);
      PE04_HOURS_CONTRATISTAS_TOTAL += (Number(horasContratistas)||0);
      PE04_HOURS_TOTAL += (Number(horasTotal)||0);

      const fechaInicioRaw = cellText(dense[12]); // M (FECHA_INICIO_FICHA)
      const fechaFinRaw = cellText(dense[13]); // N (FECHA_TERMINACION_FICHA)
      const programaEspecial = cellText(dense[37]); // AL (NOMBRE_PROGRAMA_ESPECIAL)


      // Totales aprendices por género (PE-04: AN-AO-AP) y total (AQ)
      const totalApreMasculinos = cellText(dense[39]); // AN TOTAL_APRENDICES_MASCULINOS
      const totalApreFemeninos  = cellText(dense[40]); // AO TOTAL_APRENDICES_FEMENINOS
      const totalApreNoBinario  = cellText(dense[41]); // AP TOTAL_APRENDICES_NOBINARIO
      const matriculados        = cellText(dense[42]); // AQ TOTAL_APRENDICES
      // Evita filas basura

      const muniNorm = (municipio||"" ).toString().trim();
      if(muniNorm) PE04_MUNICIPIOS_MASTER.add(muniNorm);
      if(!modalidad && !responsable && !nivel && !tipo && !etapa && !programaEspecial && !fechaInicioRaw) continue;

      out.push({ 
        ficha, empresa, programa, nivel, tipo, etapa, modalidad, responsable, horasTotal, horasPlanta, horasContratistas, departamentoCurso, municipio, 
        programaEspecial,
        // KPIs (Matriculados) + desglose por género
        matriculados,
        matriculadosPE04: matriculados,
        totalApreMasculinos,
        totalApreFemeninos,
        totalApreNoBinario,
        fechaInicioRaw,
        fechaInicio: fmtDate(fechaInicioRaw),
        fechaFinRaw,
        fechaFin: fmtDate(fechaFinRaw),
        _srcTag: _srcTag 
      });
}
    return out;
  };

  // Si es PE-04, prioriza extracción fija (más estable que encabezados)
  if(_srcTag === "PE04"){
    const fixed = parsePE04Fixed();
    if(fixed.length) return fixed;
  }

// Excel XML structure: <Worksheet><Table><Row><Cell><Data>...
  // We need to find the Header row to map columns.
  const rows = Array.from(xmlDoc.getElementsByTagName("Row"));
  if(rows.length < 2) return [];

  // 1. Find Header Row (look for known keywords)
  let headerMap = {};
  let dataStartIndex = -1;

  const normKey = (s) => {
    return (s || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .replace(/[^A-Z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
  };

  for(let i=0; i<Math.min(rows.length, 20); i++){
    const cells = Array.from(rows[i].getElementsByTagName("Cell"));
    const denseHeaderCells = densifyCells(cells);
    const cellTexts = denseHeaderCells.map(c => (c ? c.textContent.trim().toUpperCase() : ""));
    
    // Check for key columns
    if(cellTexts.includes("FICHA") && (cellTexts.includes("PROGRAMA") || cellTexts.includes("NOMBRE_PROGRAMA"))){
      // Map indices
      cellTexts.forEach((txt, idx) => {
        if(!txt) return;
        headerMap[txt] = idx;
        headerMap[normKey(txt)] = idx;
      });
      dataStartIndex = i + 1;
      break;
    }
  }

  if(dataStartIndex === -1){
    // Fallback por posición fija cuando no se detectan encabezados (DF-51 / DF-49)
    // Plantillas: encabezado fila 5, datos desde fila 6
    if(_srcTag === "DF51" || _srcTag === "DF49"){
      dataStartIndex = 5;
      headerMap = {};
    } else {
      return [];
    }
  }

  const result = [];
  
  // Helper to extract value by multiple possible header names
  // Ajuste de Mapeo para Modalidad, Nivel, Tipo, Responsable
  const getVal = (cells, keys) => {
    for(let k of keys){
      const idx = (headerMap[k] !== undefined) ? headerMap[k] : headerMap[normKey(k)];
      if(idx !== undefined && cells[idx]){
        return cells[idx].textContent.trim();
      }
    }
    return "";
  };

  const getNum = (cells, keys) => {
    const v = getVal(cells, keys);
    return parseInt(v) || 0;
  };

  for(let i=dataStartIndex; i<rows.length; i++){
    const cells = Array.from(rows[i].getElementsByTagName("Cell"));
    // Need to handle sparse cells in Excel XML? 
    // Usually Excel XML <Cell> has ss:Index if it skips. 
    // For simplicity, we assume full rows or standard generation. 
    // A robust parser checks ss:Index attributes. Let's do a simple map first.
    
    // Expand cells based on ss:Index if needed (simple robustification)
    let denseCells = densifyCells(cells);

    let fichaRaw = getVal(denseCells, ["FICHA", "ID_FICHA"]);
    // Fallback específico PE-04 (BUSCARV: ficha en columna E) cuando el encabezado no se detecta bien
    const cellText = (idx) => (denseCells[idx] ? denseCells[idx].textContent.trim() : "");
    if(!fichaRaw && _srcTag === "PE04") fichaRaw = cellText(4) || cellText(0);
    if(!fichaRaw && (_srcTag === "DF51" || _srcTag === "DF49")) fichaRaw = cellText(4); // E
    const ficha = normalizeFicha(fichaRaw);
    if(!ficha) continue; // Skip empty rows

    let programa = stripBolNauticoPrefix(getVal(denseCells, ["PROGRAMA", "NOMBRE_PROGRAMA", "PROGRAMA_FORMACION"]));
    const centro = getVal(denseCells, ["CENTRO", "CENTRO_DE_FORMACION", "NOMBRE_CENTRO", "CENTRO_FORMACION", "CENTRO_DE_FORMACION_PROFESIONAL"]);
    let municipio = getVal(denseCells, ["NOMBRE_MUNICIPIO_CURSO","MUNICIPIO_CURSO","NOMBRE_MUNICIPIO","MUNICIPIO","MUNICIPIO_DEL_CURSO","MUNICIPIO DEL CURSO"]);
    let departamentoCurso = getVal(denseCells, ["NOMBRE_DEPARTAMENTO_CURSO","DEPARTAMENTO_CURSO","NOMBRE_DEPARTAMENTO","DEPARTAMENTO"]);
    let estado = getVal(denseCells, ["ESTADO_FICHA", "ESTADO"]);
    // Fallback DF-51 / DF-49 por posición fija
    if(!estado && _srcTag === "DF51") estado = cellText(10); // K
    if(!estado && _srcTag === "DF49") estado = cellText(7);  // H
    if(!estado && _srcTag === "DF14A") estado = cellText(15); // P
    let fechaInicio = getVal(denseCells, ["FECHA_INICIO_FICHA", "FECHA_INICIO", "FECHA_INICIAL"]);
    let fechaInicioRaw = fechaInicio;

    // Fallback por posición fija (solo FECHA INICIO)
    // PE-04: Col M (FECHA_INICIO_FICHA)
    if(_srcTag === "PE04"){ const v = cellText(12); if(v){ fechaInicio = v; fechaInicioRaw = v; } }
    // DF-14A: Col M (FECHA_INICIO_FICHA)
    if(_srcTag === "DF14A"){ const v = cellText(12); if(v){ fechaInicio = v; fechaInicioRaw = v; } }
    // DF-53: Col J (FECHA_INICIO)
    if(_srcTag === "DF53"){ const v = cellText(9);  if(v){ fechaInicio = v; fechaInicioRaw = v; } }
    // DF-51: Col I (FECHA_INICIAL)
    if(_srcTag === "DF51"){ const v = cellText(8);  if(v){ fechaInicio = v; fechaInicioRaw = v; } }
    // DF-49: Col F (FECHA_INICIAL)
    if(_srcTag === "DF49"){ const v = cellText(5);  if(v){ fechaInicio = v; fechaInicioRaw = v; } }

    const fechaFin = getVal(denseCells, ["FECHA_FIN_FICHA", "FECHA_FIN", "FECHA_FINAL"]);
    
    // New fields requested
    let nivel = getVal(denseCells, ["NIVEL_FORMACION", "NIVEL", "RESPUESTA"]);
    let tipo = getVal(denseCells, ["TIPO_FORMACION", "TIPO_OFERTA", "TIPO"]);
    let modalidad = getVal(denseCells, ["MODALIDAD_FORMACION", "MODALIDAD"]); // Note: might be empty if XML doesn't have it
    let responsable = stripBolNauticoPrefix(getVal(denseCells, ["RESPONSABLE", "GESTOR_FICHA", "INSTRUCTOR_LIDER", "GESTOR"]));

    let programaEspecial = getVal(denseCells, ["NOMBRE_PROGRAMA_ESPECIAL","PROGRAMA_ESPECIAL","PROGRAMA ESPECIAL"]);
    // Fallback por posición fija (según archivo)
    if(_srcTag === "PE04"){ const v = cellText(37); if(v) programaEspecial = v; }  // AL
    if(_srcTag === "DF14A"){ const v = cellText(17); if(v) programaEspecial = v; } // R
    if(_srcTag === "DF53"){ const v = cellText(15); if(v) programaEspecial = v; }  // P
    if(_srcTag === "DF49"){ const v = cellText(21); if(v) programaEspecial = v; }  // V
 // Note: might be empty

    // Numeric / flags
    const cupo = getNum(denseCells, ["CUPO"]);
    let matriculados = getNum(denseCells, ["MATRICULADOS","APRENDICES_MATRICULADOS","APRENDICES MATRICULADOS"]);
    const enTransito = getNum(denseCells, ["EN_TRANSITO", "TRANSITO", "EN TRANSITO"]);
    const enInduccion = getNum(denseCells, ["EN_INDUCCION", "INDUCCION", "EN INDUCCIÓN", "INDUCCIÓN"]);

    // Activos: solo desde columnas de activos (no reutilizar 'FORMACION')
    const activos = getNum(denseCells, ["APRENDICES_ACTIVOS", "ACTIVOS"]);


    // Totales por género (si están disponibles en el XML)
    let totalApreMasculinos = getNum(denseCells, ["TOTALAPRENDICESMASCULINOS","TOTAL_APRENDICES_MASCULINOS","TOTAL APRENDICES MASCULINOS","APRENDICES_MASCULINOS","APRENDICES MASCULINOS","MASCULINOS"]);
    let totalApreFemeninos = getNum(denseCells, ["TOTALAPRENDICESFEMENINOS","TOTAL_APRENDICES_FEMENINOS","TOTAL APRENDICES FEMENINOS","APRENDICES_FEMENINOS","APRENDICES FEMENINOS","FEMENINOS"]);
    let totalApreNoBinario = getNum(denseCells, ["TOTALAPRENDICESNOBINARIO","TOTAL_APRENDICES_NO_BINARIO","TOTAL APRENDICES NO BINARIO","APRENDICES_NOBINARIO","APRENDICES NO BINARIO","NO_BINARIO","NO BINARIO","NOBINARIO"]);

    // Formación / En Formación (se usan en reportes 11 y 12)
    const formacion = getNum(denseCells, ["FORMACION", "EN_FORMACION", "EN FORMACION", "FORMACIÓN", "EN FORMACIÓN"]);
    const enFormacion = formacion;

    let sinRuta = getNum(denseCells, ["SIN_RUTA", "ACTIVOS_SIN_RUTA", "SIN RUTA"]);

    // DF-51: ACTIVOS_SIN_RUTA en columna O (datos desde fila 6)
    if(_srcTag === "DF51"){
      const v = parseInt(cellText(14)) || 0; // O
      sinRuta = Math.max(sinRuta || 0, v);
    }
    const porCertificar = getNum(denseCells, ["POR_CERTIFICAR", "POR CERTIFICAR"]);
    const certificados = getNum(denseCells, ["CERTIFICADOS", "CERTIFICADO"]);

    const condicionado = getNum(denseCells, ["CONDICIONADO"]);
    const cancelado = getNum(denseCells, ["CANCELADO","CANCELADA","CANCELADOS","CANCELADAS"]); 
    const aplazado = getNum(denseCells, ["APLAZADO"]);
    const retiro = getNum(denseCells, ["RETIRO_VOLUNTARIO", "RETIRO VOLUNTARIO"]);

    // Flags / texto
    let sinProgramar = getVal(denseCells, ["SIN_PROGRAMAR", "SIN PROGRAMAR"]);
    // Compatibilidad DF-53: algunas versiones traen la columna PROGRAMADA (S/N) en lugar de SIN_PROGRAMAR
    const programada = getVal(denseCells, ["PROGRAMADA"]);
    if(!sinProgramar && programada) sinProgramar = programada;

    // DF-49: resultados pendientes (aprendices sin juicio)
    let aprendicesSinJuicio = getNum(denseCells, ["APRENDICES_SIN_JUICIO","APRENDICES SIN JUICIO","SIN_JUICIO","SIN JUICIO"]);
    // DF-49: APRENDICES_SIN_JUICIO en columna P (datos desde fila 6)
    if(_srcTag === "DF49"){
      const v = parseInt(cellText(15)) || 0; // P
      aprendicesSinJuicio = Math.max(aprendicesSinJuicio || 0, v);
    }
    // DF-49: matriculados (aprendices matriculados) en columna M (datos desde fila 6)
    if(_srcTag === "DF49"){
      const v = parseInt(cellText(12)) || 0; // M
      matriculados = Math.max(matriculados || 0, v);
    }

    let etapa = getVal(denseCells, ["ETAPA", "ETAPA_FICHA", "ETAPA FORMACION", "ETAPA FORMACIÓN"]);

    // Ajustes 2-6: completar campos desde columnas específicas por archivo (cuando vienen vacíos)
    if(_srcTag === "PE04"){
      // Equivalente a BUSCARV sobre '[PE-04_1.xml]Reporte'!E:Q:
      // - Ficha en columna E, Modalidad en P, Responsable en Q.
      // Algunos XML omiten columnas iniciales; se ajusta el desplazamiento.
      const fichaE = cellText(4);
      const fichaA = cellText(0);
      const nfRaw = normalizeFicha(fichaRaw || "");
      const fromA = nfRaw && normalizeFicha(fichaA) === nfRaw;
      const fromE = nfRaw && normalizeFicha(fichaE) === nfRaw;
      const shift = (fromA && !fromE) ? 4 : 0;

      if(!modalidad) modalidad = cellText(15 - shift);      // P
      if(!responsable) responsable = cellText(16 - shift);  // Q
      if(!tipo) tipo = cellText(11 - shift);                // L
      if(!nivel) nivel = cellText(8 - shift);               // I
      if(!etapa) etapa = cellText(14 - shift);              // O

      // Ubicación (PE-04): Departamento (AE) y Municipio (AG) para evitar homónimos
      if(!departamentoCurso) departamentoCurso = cellText(30 - shift); // AE
      if(!municipio) municipio = cellText(32 - shift); // AG

      // Género (PE-04): columnas AN/AO/AP => TOTAL_APRENDICES_MASCULINOS/FEMENINOS/NOBINARIO
      const _gM = parseInt(cellText(39 - shift)) || 0; // AN
      const _gF = parseInt(cellText(40 - shift)) || 0; // AO
      const _gNB = parseInt(cellText(41 - shift)) || 0; // AP
      if(_gM || _gF || _gNB){
        totalApreMasculinos = _gM;
        totalApreFemeninos = _gF;
        totalApreNoBinario = _gNB;
      }
    } else if(_srcTag === "DF53"){
      if(!tipo) tipo = cellText(7);                 // H
      if(!nivel) nivel = cellText(8);               // I (Respuesta)
    } else if(_srcTag === "DF51"){
      if(!tipo) tipo = cellText(6);                 // G
      if(!nivel) nivel = cellText(7);               // H (Respuesta)
    } else if(_srcTag === "DF14A"){
      if(!nivel) nivel = cellText(7);               // H
    } else if(_srcTag === "DF49"){
      if(!nivel) nivel = cellText(11);              // L
    }



    // Derived
    const terminada = (estado.toUpperCase().includes("TERMINADA") || estado.toUpperCase().includes("CERRADA")); // Broad check
    const diasAtraso = calcDiasAtraso(fechaFin);

    result.push({
      ficha, estado, programa, centro, municipio, departamentoCurso,
      _srcTag,
      nivel, tipo, modalidad, responsable, programaEspecial,
      fechaInicio: fmtDate(fechaInicioRaw),
      fechaInicioRaw: fechaInicioRaw,
      fechaFin: fmtDate(fechaFin),
      fechaFinRaw: fechaFin, // for calculations

      // base
      cupo, matriculados, activos,

      // género
      totalApreMasculinos, totalApreFemeninos, totalApreNoBinario,


      // estados / métricas
      enTransito, enInduccion, sinRuta,
      formacion, enFormacion, certificados, porCertificar,
      condicionado, cancelado, aplazado, retiro,
      aprendicesSinJuicio,
      sinProgramar, etapa,

      // derived
      terminada,
      diasAtraso
    });
  }
  return result;
}

function calcDiasAtraso(dateStr){
  if(!dateStr) return 0;
  // Try parse "YYYY-MM-DD" or similar
  const d = new Date(dateStr);
  if(isNaN(d.getTime())) return 0;
  
  const now = document.getElementById("cutoffDate").valueAsDate || new Date();
  const diff = now - d;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  return days > 0 ? days : 0;
}

function fmtDate(s){
  if(!s) return "";
  // Typically comes as YYYY-MM-DD...
  return s.substring(0, 10);
}


/* =========================================================
   SAT (Sistema de Alertas Tempranas)
   ========================================================= */

let SAT_CONTEXT = { prevStore: null, curDate: "" };

function satCutoffKey(){
  const el = document.getElementById("cutoffDate");
  const v = el ? (el.value || "") : "";
  if(v && v.length >= 10) return v.substring(0,10);
  return (new Date()).toISOString().substring(0,10);
}

function calcDiasParaFin(dateStr){
  const d = parseDateLoose(dateStr);
  if(!d) return null;
  const now = document.getElementById("cutoffDate").valueAsDate || new Date();
  const diff = d - now;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function calcDiasDesdeInicio(dateStr){
  const d = parseDateLoose(dateStr);
  if(!d) return null;
  const now = document.getElementById("cutoffDate").valueAsDate || new Date();
  const diff = now - d;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function satSafeNum(v){
  const n = Number(v);
  return isFinite(n) ? n : 0;
}

function satPill(text, cls){
  return `<span class="sat-pill ${cls}">${text}</span>`;
}

function satMini(text){
  return `<span class="sat-mini">${text}</span>`;
}

/**
 * SAT Score (0-100) para una ficha específica.
 * Implementa la misma lógica base de satCompute(), pero a nivel de una sola fila,
 * sin depender de snapshots anteriores.
 *
 * @param {Object} row - Fila base consolidada (RAW_DATA).
 * @param {Date} cutoffDate - Fecha de corte (Date). Si no se pasa, usa cutoffDate del UI o new Date().
 * @returns {{score:number, contrib:Array, signals:Object}}
 */
function calculateRiskScore(row, cutoffDate){
  const r = row || {};
  const cutoff = (cutoffDate instanceof Date && !isNaN(cutoffDate.getTime()))
    ? cutoffDate
    : (document.getElementById("cutoffDate")?.valueAsDate || new Date());

  // Safe numbers
  const cupo = satSafeNum(r?.cupo);
  const matriculados = satSafeNum(r?.matriculados);
  const activos = satSafeNum(r?.activos);
  const enTransito = satSafeNum(r?.enTransito);
  const sinRuta = satSafeNum(r?.sinRuta);
  const sinJuicio = satSafeNum(r?.aprendicesSinJuicio);

  const estadoTxt = (r?.estado ?? "").toString().trim().toUpperCase();
  const sinProgramarTxt = (r?.sinProgramar ?? "").toString().trim().toUpperCase();

  // Dates: prefer *Raw (YYYY-MM-DD...) if present
  const fechaFin = r?.fechaFinRaw || r?.fechaFin || "";
  const fechaIni = r?.fechaInicioRaw || r?.fechaInicio || "";

  const parseDate = (s) => {
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  };

  const dFin = parseDate(fechaFin);
  const dIni = parseDate(fechaIni);

  const diasParaFin = dFin ? Math.floor((dFin - cutoff) / (1000*60*60*24)) : null;
  const diasDesdeInicio = dIni ? Math.floor((cutoff - dIni) / (1000*60*60*24)) : null;

  const retencionPct = matriculados > 0 ? Math.round((activos / matriculados) * 100) : 0;
  const conJuicioPct = matriculados > 0 ? Math.round(((matriculados - sinJuicio) / matriculados) * 100) : 0;

  // Radar de cierre inminente
  let cierreLevel = "";
  if(diasParaFin !== null && diasParaFin >= 0){
    if(diasParaFin <= 7 && conJuicioPct < 90) cierreLevel = "Rojo";
    else if(diasParaFin <= 15 && conJuicioPct < 80) cierreLevel = "Naranja";
    else if(diasParaFin <= 30 && conJuicioPct < 70) cierreLevel = "Amarillo";
  }
  const cierreCond = !!cierreLevel;

  // Cuellos de botella (Tránsito)
  const thrTransito = Math.max(3, Math.ceil(matriculados * 0.30));
  const transitoCond = (diasDesdeInicio !== null && diasDesdeInicio > 14 && enTransito >= thrTransito);

  // Sin programar (solo si está en ejecución)
  const isEjecucion = (estadoTxt.includes("EJECUCION") || estadoTxt.includes("EJECUCIÓN"));
  const sinProgramar = isEjecucion && sinProgramarTxt.startsWith("N");

  // Retención baja
  const retencionBaja = (matriculados >= 10 && retencionPct < 80);

  // Scoring (cap 100)
  let score = 0;
  const contrib = [];

  if(cierreCond){
    const pts = (cierreLevel === "Rojo") ? 30 : (cierreLevel === "Naranja" ? 22 : 15);
    score += pts;
    contrib.push({cause:"Resultados", pts});
  }
  if(transitoCond){
    score += 20;
    contrib.push({cause:"Tránsito", pts:20});
  }
  if(sinRuta > 0){
    score += 20;
    contrib.push({cause:"Sin Ruta", pts:20});
  }
  if(sinProgramar){
    score += 15;
    contrib.push({cause:"Sin Programar", pts:15});
  }
  if(retencionBaja){
    score += 15;
    contrib.push({cause:"Retención", pts:15});
  }
  score = Math.min(100, score);

  return {
    score,
    contrib,
    signals: { cierreLevel, transitoCond, sinRuta, sinProgramar, retencionBaja, diasParaFin, diasDesdeInicio, conJuicioPct, retencionPct }
  };
}


function satLoadStore(){
  try{
    const raw = localStorage.getItem("SAT_STORE_V1");
    if(!raw) return {version:1, lastDate:"", fichas:{}, history:[]};
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") throw new Error("bad");
    if(!obj.fichas) obj.fichas = {};
    if(!obj.history) obj.history = [];
    return obj;
  }catch(e){
    return {version:1, lastDate:"", fichas:{}, history:[]};
  }
}

function satSaveStore(store){
  try{
    localStorage.setItem("SAT_STORE_V1", JSON.stringify(store || {}));
  }catch(e){}
}

function satUpdateSnapshot(allRows){
  const curDate = satCutoffKey();
  const store = satLoadStore();
  const prevStore = {
    version: store.version || 1,
    lastDate: store.lastDate || "",
    fichas: store.fichas || {},
    history: store.history || []
  };
  SAT_CONTEXT = { prevStore, curDate };

  const computed = satCompute(allRows || [], prevStore, curDate);

  // Commit current snapshot for future comparisons
  const next = satLoadStore();
  next.version = 1;
  next.lastDate = curDate;
  next.fichas = computed.perFichaCurrent || {};

  // Update history (keep last 24 points)
  const hist = Array.isArray(next.history) ? next.history : [];
  const filtered = hist.filter(x => (x && x.date) ? String(x.date).substring(0,10) !== curDate : true);
  filtered.push({date: curDate, total: computed.stats?.total || 0, criticas: computed.stats?.criticas || 0, alertas: computed.stats?.alertas || 0});
  filtered.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
  next.history = filtered.slice(Math.max(0, filtered.length - 24));

  satSaveStore(next);
  return computed;
}

function satCompute(rows, prevStore, curDate){
  const prevDate = (prevStore && prevStore.lastDate) ? String(prevStore.lastDate).substring(0,10) : "";
  const prevFichas = (prevStore && prevStore.fichas) ? prevStore.fichas : {};

  const universe = [];
  const issues = [];
  const perFichaCurrent = {};

  const causeCounts = {
    "Resultados": 0,
    "Tránsito": 0,
    "Sin Ruta": 0,
    "Sin Programar": 0,
    "Retención": 0
  };

  const heatmap = {}; // {centro:{cause:count}}

  let criticas = 0;
  let alertas = 0;
  let observacion = 0;
  let totalEligible = 0;
  const hasPrevSnapshot = !!prevDate && prevDate !== curDate;

  rows.forEach(r => {
    const ficha = normalizeFicha(r?.ficha || "");
    if(!ficha) return;

    const centroRaw = (r?.centro && String(r.centro).trim()) ? String(r.centro).trim() : "";
    const centroHeat = (centroRaw && !/^\(?\s*sin\s+centro\s*\)?$/i.test(centroRaw)) ? centroRaw : "";
    const centro = centroRaw ? centroRaw : "(Sin centro)";
    const responsable = (r?.responsable && String(r.responsable).trim()) ? String(r.responsable).trim() : "(Sin responsable)";
    const _p = (r?.programa && String(r.programa).trim()) ? String(r.programa).trim() : "";
    const programa = (dashNormSimple(_p) && dashNormSimple(_p) !== "SIN_PROGRAMA" && dashNormSimple(_p) !== "(SIN_PROGRAMA)") ? _p : "Sin programa";

    const cupo = satSafeNum(r?.cupo);
    const matriculados = satSafeNum(r?.matriculados);
    const activos = satSafeNum(r?.activos);
    const enTransito = satSafeNum(r?.enTransito);
    const sinRuta = satSafeNum(r?.sinRuta);
    const sinJuicio = satSafeNum(r?.aprendicesSinJuicio);
    const sinProgramarTxt = (r?.sinProgramar ?? "").toString().trim().toUpperCase();
    const estadoTxt = (r?.estado ?? "").toString().trim().toUpperCase();

    // Excluir fichas canceladas / terminadas por unificación (DF-49 y/o DF-14A)
    if(isFichaEstadoExcluded(r, "r18")) return;

    totalEligible++;
    const diasParaFin = calcDiasParaFin(r?.fechaFinRaw || r?.fechaFin);
    const diasDesdeInicio = calcDiasDesdeInicio(r?.fechaInicioRaw || r?.fechaInicio);

    const ocupacionPct = cupo > 0 ? Math.round((matriculados / cupo) * 100) : 0;
    const retencionPct = matriculados > 0 ? Math.round((activos / matriculados) * 100) : 0;
    const conJuicioPct = matriculados > 0 ? Math.round(((matriculados - sinJuicio) / matriculados) * 100) : 0;

    // Higiene de datos
    const issuesList = [];
    if(diasDesdeInicio === null) issuesList.push("FECHA_INICIO inválida");
    if(matriculados === 0 && activos > 0) issuesList.push("Incongruencia: Matriculados=0 y Activos>0");
    if(!r?.responsable || !String(r.responsable).trim()) issuesList.push("Responsable vacío");
    const respNorm = normNoAccents(responsable);
    if(respNorm.includes("BOL NAUTICO")) issuesList.push("Responsable residual (BOL NAUTICO)");

    const prev = prevFichas[ficha] || null;
    const prevFlags = prev?.flags || {};
    const prevActivos = satSafeNum(prev?.activos);

    // Radar de cierre inminente (preventiva)
    let cierreLevel = "";
    if(diasParaFin !== null && diasParaFin >= 0){
      if(diasParaFin <= 7 && conJuicioPct < 90) cierreLevel = "Rojo";
      else if(diasParaFin <= 15 && conJuicioPct < 80) cierreLevel = "Naranja";
      else if(diasParaFin <= 30 && conJuicioPct < 70) cierreLevel = "Amarillo";
    }
    const cierreCond = !!cierreLevel;

    // Cuellos de botella (Tránsito)
    const thrTransito = Math.max(3, Math.ceil(matriculados * 0.30));
    const transitoCond = (diasDesdeInicio !== null && diasDesdeInicio > 14 && enTransito >= thrTransito);

    // Retención: baja / caída súbita
    const retencionBaja = (matriculados >= 10 && retencionPct < 80);
    const caidaSubita = (hasPrevSnapshot && prevActivos > 0 && activos <= Math.floor(prevActivos * 0.80));

    // Sin programar
    const isEjecucion = (estadoTxt.includes("EJECUCION") || estadoTxt.includes("EJECUCIÓN"));
    const sinProgramar = isEjecucion && sinProgramarTxt.startsWith("N");

    // Persistencia (si existe snapshot anterior)
    const cierreConfirmado = !hasPrevSnapshot ? true : !!prevFlags.cierre;
    const transitoConfirmado = !hasPrevSnapshot ? true : !!prevFlags.transito;

    const cierreActivo = cierreCond && cierreConfirmado;
    const transitoActivo = transitoCond && transitoConfirmado;
    const cierreObs = cierreCond && hasPrevSnapshot && !cierreConfirmado;
    const transitoObs = transitoCond && hasPrevSnapshot && !transitoConfirmado;

    // Scoring
    let score = 0;
    const contrib = [];

    if(cierreActivo){
      const pts = (cierreLevel === "Rojo") ? 30 : (cierreLevel === "Naranja" ? 22 : 15);
      score += pts;
      contrib.push({cause:"Resultados", pts});
    }
    if(transitoActivo){
      score += 20;
      contrib.push({cause:"Tránsito", pts:20});
    }
    if(sinRuta > 0){
      score += 20;
      contrib.push({cause:"Sin Ruta", pts:20});
    }
    if(sinProgramar){
      score += 15;
      contrib.push({cause:"Sin Programar", pts:15});
    }
    if(caidaSubita || retencionBaja){
      score += 15;
      contrib.push({cause:"Retención", pts:15});
    }
    score = Math.min(100, score);

    // Señales (incluye observación)
    const hasSignal = cierreCond || transitoCond || (sinRuta > 0) || sinProgramar || caidaSubita || retencionBaja;
    const hasIssues = issuesList.length > 0;

    // Store current flags for next snapshot
    perFichaCurrent[ficha] = {
      flags: { cierre: cierreCond, transito: transitoCond },
      activos: activos
    };

    if(!hasSignal && !hasIssues) return;

    // Labels/alertas
    const alertsList = [];
    if(cierreActivo) alertsList.push(`${satPill("Cierre " + cierreLevel, cierreLevel==="Rojo"?"sat-red":(cierreLevel==="Naranja"?"sat-orange":"sat-yellow"))} · Fin ≤ ${diasParaFin}d · Juicios ${conJuicioPct}%`);
    if(cierreObs) { observacion++; alertsList.push(`${satPill("Cierre (Obs.)", "sat-gray")} · Fin ≤ ${diasParaFin}d · Juicios ${conJuicioPct}%`); }

    if(transitoActivo) alertsList.push(`${satPill("Tránsito alto", "sat-orange")} · ${enTransito} (umbral ${thrTransito}) · Inicio +${diasDesdeInicio}d`);
    if(transitoObs) { observacion++; alertsList.push(`${satPill("Tránsito (Obs.)", "sat-gray")} · ${enTransito} (umbral ${thrTransito}) · Inicio +${diasDesdeInicio}d`); }

    if(sinRuta > 0) alertsList.push(`${satPill("Sin Ruta", "sat-yellow")} · ${sinRuta}`);
    if(sinProgramar) alertsList.push(`${satPill("Sin Programar", "sat-yellow")}`);
    if(caidaSubita) alertsList.push(`${satPill("Caída súbita Activos", "sat-red")} · ${prevActivos} → ${activos}`);
    else if(retencionBaja) alertsList.push(`${satPill("Retención baja", "sat-orange")} · ${retencionPct}%`);

    // Causa principal (solo confirmadas por puntaje)
    let primary = "";
    if(contrib.length){
      primary = contrib.sort((a,b)=> b.pts - a.pts)[0].cause;
      causeCounts[primary] = (causeCounts[primary]||0) + 1;
    }

    // Asignación y acciones
    let causaProb = "";
    let accion = "";
    let respSat = "";
    let sla = "";

    if(hasIssues){
      causaProb = "Inconsistencias en datos fuente (higiene de datos).";
      accion = "Corregir en el origen (SOFIA/Excel/XML) y reprocesar los reportes DF-49/DF-51/PE-04.";
      respSat = "Admin. Educativa";
      sla = "48 horas";
    } else if(primary === "Resultados"){
      causaProb = "Juicios evaluativos pendientes frente a un cierre cercano.";
      if(cierreLevel === "Rojo"){ sla = "48 horas"; }
      else if(cierreLevel === "Naranja"){ sla = "72 horas"; }
      else { sla = "5 días"; }
      accion = "Priorizar evaluación y registro de juicios en SOFIA; verificar avance evaluativo real (DF-49).";
      respSat = "Instructor / Coordinación";
    } else if(primary === "Tránsito"){
      causaProb = (transitoCond && sinJuicio > 0) ? "Posible bloqueo administrativo/registro (Tránsito alto + sin juicios)." : "Acumulación anormal en Tránsito (maduración > 14 días).";
      accion = "Validar matrícula/estado y tránsito en SOFIA; revisar programación y registros (DF-51/DF-49).";
      respSat = "Admin. Educativa / Coordinación";
      sla = "72 horas";
    } else if(primary === "Sin Ruta"){
      causaProb = "Ruta de aprendizaje no asociada o incompleta.";
      accion = "Asociar ruta y validar estructura curricular; revalidar en SOFIA.";
      respSat = "Coordinación";
      sla = "5 días";
    } else if(primary === "Sin Programar"){
      causaProb = "Falta de programación específica (en ejecución).";
      accion = "Crear o vincular programación específica (PE-04) y validar coherencia de calendario.";
      respSat = "Coordinación / Admin. Educativa";
      sla = "72 horas";
    } else if(primary === "Retención"){
      causaProb = caidaSubita ? "Deserción/abandono masivo (caída > 20% vs corte anterior)." : "Baja actividad (Activos/Matriculados).";
      accion = "Activar seguimiento de bienestar; contacto y verificación de asistencia; registrar novedades.";
      respSat = "Bienestar / Coordinación";
      sla = caidaSubita ? "24 horas" : "72 horas";
    } else {
      // Observaciones sin confirmación aún
      causaProb = "Señal en observación (requiere confirmación en el siguiente corte).";
      accion = "Monitorear y validar en el próximo corte; verificar integridad de carga.";
      respSat = "Coordinación";
      sla = "—";
    }

    // Severidad general
    let sev = "";
    if(hasIssues){
      sev = satPill("Calidad de datos", "sat-gray");
    } else if(score >= 70 || (cierreActivo && cierreLevel === "Rojo") || caidaSubita){
      sev = satPill("Crítico", "sat-red");
      criticas++;
    } else if(score >= 40){
      sev = satPill("Alto", "sat-orange");
    } else if(score > 0){
      sev = satPill("Medio", "sat-yellow");
    } else {
      sev = satPill("Observación", "sat-gray");
    }

    if(score > 0) alertas++;

    // Heatmap (solo por causa principal confirmada) — excluir centros vacíos / (Sin centro)
    if(primary && centroHeat){
      if(!heatmap[centroHeat]) heatmap[centroHeat] = {};
      heatmap[centroHeat][primary] = (heatmap[centroHeat][primary]||0) + 1;
    }
const rowOut = {
      severidad: sev,
      score: score,
      ficha,
      programa,
      centro,
      responsable,
      fechaInicio: r?.fechaInicio || fmtDate(r?.fechaInicioRaw || ""),
      fechaFin: r?.fechaFin || fmtDate(r?.fechaFinRaw || ""),
      diasParaFin: (diasParaFin === null ? "—" : diasParaFin),
      conJuicioPct: conJuicioPct,
      retencionPct: retencionPct,
      ocupacionPct: ocupacionPct,
      enTransito: enTransito,
      sinRuta: sinRuta,
      sinProgramar: sinProgramar ? "Sí" : "",
      alerts: alertsList.join(" <br> "),
      causaPrincipal: primary || (hasIssues ? "Calidad de datos" : "Observación"),
      causaProbable: causaProb,
      accionRecomendada: accion,
      responsableSAT: respSat,
      sla: sla,
      _hasIssues: hasIssues ? 1 : 0
    };

    if(hasIssues) issues.push(rowOut);
    else universe.push(rowOut);
  });

  // Ranking: score desc (top 20); include observations if tie
  const top = [...universe].sort((a,b)=>{
    const s = (b.score||0) - (a.score||0);
    if(s !== 0) return s;
    return String(a.ficha||"").localeCompare(String(b.ficha||""));
  }).slice(0, 20);

  // Append hygiene rows (up to 20)
  const hygiene = [...issues].sort((a,b)=> String(a.ficha||"").localeCompare(String(b.ficha||""))).slice(0, 20);

  return {
    topRows: top,
    issueRows: hygiene,
    universeRows: universe,
    issuesAll: issues,
    perFichaCurrent,
    causeCounts,
    heatmap,
    stats: {
      total: totalEligible,
      alertas,
      criticas,
      observacion,
      higiene: issues.length
    }
  };
}

function satRenderHeatmap(containerId, heatmap, causes){
  const el = document.getElementById(containerId);
  if(!el) return;
  const cols = causes || ["Resultados","Tránsito","Sin Ruta","Sin Programar","Retención"];
  const centers = Object.keys(heatmap || {}).sort((a,b)=> a.localeCompare(b));

  if(centers.length === 0){
    el.innerHTML = `<div class="search-hint">No hay datos suficientes para el mapa de calor con los filtros actuales.</div>`;
    return;
  }

  let maxV = 0;
  centers.forEach(c => {
    cols.forEach(k => {
      const v = satSafeNum(heatmap[c]?.[k] || 0);
      if(v > maxV) maxV = v;
    });
  });
  maxV = Math.max(1, maxV);

  const cellBg = (v) => {
    const a = Math.min(0.28, Math.max(0.04, (v / maxV) * 0.28));
    return `background: rgba(37,99,235,${a});`;
  };

  const thead = `<thead><tr><th>#</th><th>Centro</th>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
  const tbody = `<tbody>` + centers.map((c, idx) => {
    const row = cols.map(k => {
      const v = satSafeNum(heatmap[c]?.[k] || 0);
      const style = v ? cellBg(v) : "";
      return `<td style="${style}">${v || ""}</td>`;
    }).join("");
    return `<tr><td class="ctr">${idx+1}</td><td>${escapeHtml(c)}</td>${row}</tr>`;
  }).join("") + `</tbody>`;

  if(!el.classList.contains("sat-heatmap")) el.classList.add("sat-heatmap");
  el.innerHTML = `<table>${thead}${tbody}</table>`;
}


/* =========================================================
   UI LOGIC
   ========================================================= */
function getReportData(config){
  if(!config) return [];
  if(typeof config.data === "function"){
    return config.data(RAW_DATA) || [];
  }
  if(typeof config.filter === "function"){
    return RAW_DATA.filter(config.filter);
  }
  return RAW_DATA;
}

function fmtNum(n){
  const v = Number(n);
  if(!isFinite(v)) return "0";
  return v.toLocaleString("es-CO");
}


function fmtTime(mins){
  const v = Number(mins);
  if(!isFinite(v) || v <= 0) return "0:00";
  const t = Math.round(v);
  const h = Math.floor(t/60);
  const m = t % 60;
  return `${h}:${String(m).padStart(2,"0")}`;
}

function setActiveReport(id){
  const changed = (ACTIVE_REPORT_ID !== id);
  const prevId = ACTIVE_REPORT_ID;
  ACTIVE_REPORT_ID = id;
  // Reset paginación (en reportes que la usen) al cambiar filtros/selección
  if(id !== "dashboard" && id !== "r19") TABLE_PAGE_STATE[id] = 1;
  if(prevId === "r19" && id !== "r19"){ hideFichaAcumulativaView(); }
  if(prevId === "dashboard" && id !== "dashboard"){ hideDashboardView(); }
  const rc = document.getElementById('reportCard');
  if(rc) rc.setAttribute('data-report', id);

  // Highlight menu
  document.querySelectorAll(".nav-links button").forEach(b => b.classList.remove("active"));
  const btn = document.getElementById("nav-"+id);
  if(btn) btn.classList.add("active");

  const config = REPORTS[id];
  if(!config) return;

  document.getElementById("reportTitle").textContent = config.title;
  document.getElementById("reportDesc").textContent = config.desc;


// Módulo especializado: Ficha Acumulativa (DF-03)

  // Vista Reportes (exportación múltiple a PDF)
  if(id === "reports"){
    showReportsPanel();
    return;
  } else {
    hideReportsPanel();
  }
if(id === "r19"){
  renderFichaAcumulativaView();
  return;
}




// Módulo especializado: Dashboard (Novedades)
if(id === "dashboard"){
  renderDashboardView();
  return;
}

  // Al cambiar de reporte, reiniciar búsqueda (el filtro por nivel se mantiene)
  if(changed){
    TABLE_SEARCH_Q = "";
    TABLE_PAGE_STATE[id] = 1;
    const inp = document.getElementById("tableSearch");
    if(inp) inp.value = "";
  }

  updateTableToolsUI();
  renderNivelButtons();
  renderProgEspButtons();
  renderYearDropdown();
  applyCompactMode();

  if(id === "r19"){
    renderFichaAcumulativaView();
    return;
  }


  renderTable(config);
  renderStats(config);
  renderCharts(config);
}

function renderTable(config){
  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("tableBody");
  const pager = document.getElementById("mainTablePager");

  // Notas (solo SAT)
  const satNotes = document.getElementById("satNotes");
  if(satNotes){
    if(ACTIVE_REPORT_ID === "r18"){
      satNotes.style.display = "block";
      satNotes.innerHTML = `
        <div class="title">Notas SAT (Severidad y tipos de alerta)</div>
        <div class="grid">
          <div class="box">
            <h4>Severidad</h4>
            <ul>
              <li><b>Crítico</b>: intervención prioritaria (riesgo alto por score, caída súbita o cierre cercano en rojo).</li>
              <li><b>Alto</b>: seguimiento prioritario (riesgo relevante).</li>
              <li><b>Medio</b>: monitoreo y validaciones puntuales.</li>
              <li><b>Observación</b>: sin señales fuertes; mantener seguimiento.</li>
              <li><b>Calidad de datos</b>: inconsistencias en fuentes; revisar registros.</li>
            </ul>
          </div>
          <div class="box">
            <h4>Tipos de alerta (pueden coexistir)</h4>
            <ul>
              <li><b>Sin Programar</b>: ficha en ejecución sin programación registrada.</li>
              <li><b>Sin Ruta</b>: aprendices sin ruta asociada.</li>
              <li><b>Tránsito alto</b> / <b>Tránsito (Obs.)</b>: volumen de tránsito relevante (según umbrales).</li>
              <li><b>Retención baja</b>: activos bajo lo esperado vs matriculados.</li>
              <li><b>Caída súbita Activos</b>: descenso reciente de activos.</li>
              <li><b>Cierre</b> / <b>Cierre (Obs.)</b>: fin cercano de ficha (con o sin señales adicionales).<ul class="sat-sub"><li><b>Cierre Rojo</b>: fin ≤ 7 días y % con juicio < 90%</li><li><b>Cierre Naranja</b>: fin ≤ 15 días y % con juicio < 80%</li><li><b>Cierre Amarillo</b>: fin ≤ 30 días y % con juicio < 70%</li></ul></li>
            </ul>
          </div>
        </div>
      `;
    } else {
      satNotes.style.display = "none";
      satNotes.innerHTML = "";
    }
  }

  // Headers (clic para ordenar)
  let hHtml = "<tr>";
  hHtml += `<th class=\"th-counter\">#</th>`;
  const curSort = SORT_STATE[ACTIVE_REPORT_ID] || {};
  config.columns.forEach(col => {
    const isActive = (curSort.key === col.key);
    const dir = isActive ? curSort.dir : "";
    const indicator = isActive ? (dir === "asc" ? "▲" : "▼") : "";
    hHtml += `<th class="sortable" data-sort-key="${col.key}" title="Ordenar"><div class="th-wrap"><span>${col.label}</span><span class="sort-ind">${indicator}</span></div></th>`;
  });
  hHtml += "</tr>";
  tableHead.innerHTML = hHtml;

  // Bind sorting (click en encabezado)
  tableHead.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", (e) => {
      e.preventDefault();
      const key = th.getAttribute("data-sort-key");
      const cur = SORT_STATE[ACTIVE_REPORT_ID] || {};
      let dir = "asc";
      if(cur.key === key){
        dir = (cur.dir === "asc") ? "desc" : "asc";
      }
      SORT_STATE[ACTIVE_REPORT_ID] = { key, dir };

      // Al cambiar orden, volver a la página 1 (si hay paginación)
      TABLE_PAGE_STATE[ACTIVE_REPORT_ID] = 1;

      renderTable(REPORTS[ACTIVE_REPORT_ID]);
    });
  });

  // Body
  // 1. Filter Data
  const model = getViewModel(config);
  let data = model.tableRows;

  // 1.1 Ordenamiento (A-Z / Z-A)
  const s = SORT_STATE[ACTIVE_REPORT_ID];
  if(s && s.key){
    const colDef = config.columns.find(c => c.key === s.key) || {};
    const isNum = colDef.align === "num";
    const dirMul = (s.dir === "desc") ? -1 : 1;

    data = [...data].sort((a,b) => {
      const av = (a[s.key] ?? "");
      const bv = (b[s.key] ?? "");

      // Vacíos al final
      const aEmpty = (av === null || av === undefined || String(av).trim() === "");
      const bEmpty = (bv === null || bv === undefined || String(bv).trim() === "");
      if(aEmpty && bEmpty) return 0;
      if(aEmpty) return 1;
      if(bEmpty) return -1;

      if(isNum){
        const an = Number(av);
        const bn = Number(bv);
        const aa = isFinite(an) ? an : -Infinity;
        const bb = isFinite(bn) ? bn : -Infinity;
        return (aa - bb) * dirMul;
      }

      // Fechas tipo YYYY-MM-DD comparan bien como string; y para texto general usamos localeCompare
      return String(av).localeCompare(String(bv), "es", {numeric:true, sensitivity:"base"}) * dirMul;
    });
  }

  // 2. Paginación (solo si el reporte la define)
  const pageSize = Number(config.pageSize || 0);
  const usePaging = isFinite(pageSize) && pageSize > 0;
  const totalRows = data.length;

  let displayData = data;
  let startIndex = 0;
  if(usePaging){
    const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    const curPage = Math.min(Math.max(1, Number(TABLE_PAGE_STATE[ACTIVE_REPORT_ID] || 1)), totalPages);
    TABLE_PAGE_STATE[ACTIVE_REPORT_ID] = curPage;
    startIndex = (curPage - 1) * pageSize;
    displayData = data.slice(startIndex, startIndex + pageSize);
    renderMainTablePager(totalRows, curPage, pageSize);
    if(pager) pager.style.display = (totalPages > 1) ? "flex" : "none";
  }else{
    if(pager){ pager.innerHTML = ""; pager.style.display = "none"; }
    // Limit render for performance if massive
    const limit = 2000;
    displayData = data.slice(0, limit);
  }

  // 3. Render
  let bHtml = "";
  displayData.forEach((row, idx) => {
    bHtml += "<tr>";
    const n = usePaging ? (startIndex + idx + 1) : (idx + 1);
    bHtml += `<td class="ctr">${n}</td>`;
    config.columns.forEach(col => {
      let val = (row[col.key] ?? "");
      if(col.align === "num"){
        const nn = Number(val);
        if(isFinite(nn)) val = fmtNum(nn);
      }else if(col.align === "time"){
        // val se interpreta como minutos (numérico). Si viene string, se intenta convertir.
        const mm = Number(val);
        val = isFinite(mm) ? fmtTime(mm) : fmtTime(parseHoursLoose(val));
      }
      const cls = (col.align === "num" || col.align === "time") ? "num" : "";
      bHtml += `<td class="${cls}">${val}</td>`;
    });
    bHtml += "</tr>";
  });

  if(!usePaging){
    const limit = 2000;
    if(data.length > limit){
      bHtml += `<tr><td colspan="${config.columns.length + 1}" style="text-align:center; color:var(--warn)">Mostrando primeros ${limit} de ${data.length} registros. Exporta para ver todo.</td></tr>`;
    }
  }

  if(totalRows === 0){
    bHtml = `<tr><td colspan="${config.columns.length + 1}" style="text-align:center; padding:20px">No se encontraron datos con los filtros actuales.</td></tr>`;
    if(pager){ pager.innerHTML = ""; pager.style.display = "none"; }
  }

  tableBody.innerHTML = bHtml;
}

function renderMainTablePager(totalRows, page, pageSize){
  const el = document.getElementById("mainTablePager");
  if(!el) return;

  const totalPages = Math.max(1, Math.ceil((totalRows || 0) / pageSize));
  const p = Math.min(Math.max(1, page), totalPages);
  TABLE_PAGE_STATE[ACTIVE_REPORT_ID] = p;

  if(totalPages <= 1){
    el.innerHTML = "";
    el.style.display = "none";
    return;
  }

  const from = totalRows ? ((p - 1) * pageSize + 1) : 0;
  const to = Math.min(p * pageSize, totalRows);

  // Ventana de páginas (compacta con elipsis)
  let view = [];
  if(totalPages <= 9){
    for(let i=1;i<=totalPages;i++) view.push(i);
  }else{
    const keep = new Set([1,2,totalPages-1,totalPages,p-1,p,p+1]);
    const left = Math.max(1, p - 2);
    const right = Math.min(totalPages, p + 2);
    for(let i=left; i<=right; i++) keep.add(i);

    const compact = [];
    const sorted = Array.from(keep).filter(x=>x>=1 && x<=totalPages).sort((a,b)=>a-b);
    let prev = null;
    for(const x of sorted){
      if(prev != null && x - prev > 1) compact.push("…");
      compact.push(x);
      prev = x;
    }
    view = compact;
  }

  const btn = (label, target, disabled, active) => {
    if(label === "…") return `<span class="ellipsis">…</span>`;
    const cls = active ? "active" : "";
    const dis = disabled ? "disabled" : "";
    const t = String(target);
    return `<button type="button" class="${cls}" data-tpage="${escHtml(t)}" ${dis}>${escHtml(String(label))}</button>`;
  };

  const htmlPages = view.map(x => btn(x, x, false, x === p)).join("");

  el.innerHTML = `
    <div class="meta">Mostrando ${fmtNum(from)}–${fmtNum(to)} de ${fmtNum(totalRows)}</div>
    <div class="pages">
      ${btn("Anterior", p-1, p<=1, false)}
      ${htmlPages}
      ${btn("Siguiente", p+1, p>=totalPages, false)}
    </div>
  `;

  el.querySelectorAll('button[data-tpage]').forEach(b => {
    b.addEventListener("click", () => {
      const t = b.getAttribute("data-tpage");
      const n = parseInt(t, 10);
      if(!isFinite(n)) return;
      const next = Math.min(Math.max(1, n), totalPages);
      TABLE_PAGE_STATE[ACTIVE_REPORT_ID] = next;
      renderTable(REPORTS[ACTIVE_REPORT_ID]);
    });
  });
}

function renderStats(config){
  const kpiArea = document.getElementById("kpiArea");

  const model = getViewModel(config);
  const baseRows = model.baseRows;
  const data = model.tableRows;

  const kpis = (typeof config.kpis === "function")
    ? (config.kpis(baseRows) || [])
    : [{value: data.length, label:"Fichas"}];

  kpiArea.innerHTML = kpis.map(k => `
    <div class="stat-card">
      <div class="stat-val">${(typeof k.value === "number") ? fmtNum(k.value) : k.value}</div>
      <div class="stat-lbl">${k.label}</div>
    </div>
  `).join("");
}

/* =========================================================
   CHARTS (Ajuste 3)
========================================================= */
let CHART_INSTANCES = [];

function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function destroyCharts(){
  for(const ch of CHART_INSTANCES){
    try{ ch.destroy(); }catch(e){}
  }
  CHART_INSTANCES = [];
}

function renderCharts(config){
  const area = document.getElementById("chartsArea");
  if(!area) return;

  const CHART_REPORTS = new Set(["r13","r14","r15","r16","r17","r18"]);
  if(!CHART_REPORTS.has(ACTIVE_REPORT_ID)){
    area.style.display = "none";
    area.innerHTML = "";
    destroyCharts();
    return;
  }

  // data visible in the current view (respects Nivel filters and, where enabled, search)
  const model = getViewModel(config);
  const view = model.tableRows;

  // Si no hay datos visibles (por ejemplo, sin NIVEL seleccionado), no se grafican.
  if(!view || view.length === 0){
    area.style.display = "none";
    area.innerHTML = "";
    destroyCharts();
    return;
  }

  // Build DOM
  const smallCharts = false; // charts full width (r13/r17 also)
  const mkCard = (id, title, heightClass) => `
    <div class="chart-card ${smallCharts ? "small" : ""}">
      <div class="chart-title">${escapeHtml(title)}</div>
      <div class="chart-wrap ${heightClass || "h260"}"><canvas id="${id}"></canvas></div>
    </div>
  `;
  const cid = (suffix) => `ch_${ACTIVE_REPORT_ID}_${suffix}`;

  let cardsHtml = "";
  if(ACTIVE_REPORT_ID === "r13"){
    cardsHtml =
      `<div class="chart-card full-span"><div class="chart-title">Tendencia mensual (fecha relevante)</div><div class="chart-wrap h260"><canvas id="${cid("0")}"></canvas></div></div>` +
      mkCard(cid("1"), "Fichas por estado") +
      mkCard(cid("2"), "Fichas atrasadas vs no atrasadas");
  }else if(ACTIVE_REPORT_ID === "r14"){
    cardsHtml =
      `<div class="chart-card full-span"><div class="chart-title">${escapeHtml("Instructor Responsable - métricas")}</div><div class="chart-wrap h360"><canvas id="${cid("1")}"></canvas></div></div>` +
      `<div class="chart-card full-span"><div class="chart-title">${escapeHtml("Instructor Responsable - Cantidad de fichas")}</div><div class="chart-wrap h260"><canvas id="${cid("2")}"></canvas></div></div>`;
  }else if(ACTIVE_REPORT_ID === "r15"){
    cardsHtml =
      `<div class="chart-card full-span"><div class="chart-title">${escapeHtml("Programa - métricas")}</div><div class="chart-wrap h360"><canvas id="${cid("1")}"></canvas></div></div>` +
      `<div class="chart-card full-span"><div class="chart-title">${escapeHtml("Programa - Cantidad de fichas")}</div><div class="chart-wrap h260"><canvas id="${cid("2")}"></canvas></div></div>`;
  }else if(ACTIVE_REPORT_ID === "r16"){
    cardsHtml =
      mkCard(cid("1"), "Top programas: Ocupación % vs Efectividad % (radial)", "h260") +
      mkCard(cid("2"), "Top programas: Cupo vs Matriculados vs Activos", "h260");
  }else if(ACTIVE_REPORT_ID === "r17"){
    cardsHtml =
      mkCard(cid("1"), "Embudo operativo (cantidad por paso)", "h220") +
      mkCard(cid("2"), "Participación por paso", "h220");
  }else if(ACTIVE_REPORT_ID === "r18"){
    cardsHtml =
      `<div class="chart-card full-span"><div class="chart-title">Distribución por causa (actual)</div><div class="chart-wrap h260"><canvas id="${cid("2")}"></canvas></div></div>` +
      `<div class="chart-card full-span"><div class="chart-title">Mapa de calor: Centro × Causa</div><div class="chart-wrap hAutoSat"><div id="${cid("3")}" class="sat-heatmap"></div></div></div>`;
  }

  destroyCharts();

  area.innerHTML = cardsHtml;

  // Full-width for r13/r17 (use two columns to occupy page width)
  const fullWidth = (ACTIVE_REPORT_ID === "r13" || ACTIVE_REPORT_ID === "r17" || ACTIVE_REPORT_ID === "r18");
  area.classList.toggle("full-width", fullWidth);
  area.style.gridTemplateColumns = ""; // rely on CSS classes
  area.classList.toggle("small-charts", false); // deprecated
  area.style.display = "grid";
if(typeof Chart === "undefined"){
    area.innerHTML = `<div class="chart-card"><div class="chart-title">Gráficas</div><div class="muted">No se pudo cargar Chart.js (requiere conexión a internet). Las tablas sí funcionan con normalidad.</div></div>`;
    area.style.display = "block";
    return;
  }

  // Helpers
  const topN = (arr, n, key) => [...arr].sort((a,b)=>(b[key]||0)-(a[key]||0)).slice(0,n);
  const sum = (arr, key) => arr.reduce((s,r)=> s + (Number(r?.[key])||0), 0);
  const truncLabel = (s, n=15) => {
    const v = (s ?? "").toString();
    return v.length > n ? (v.slice(0, n).trimEnd() + "…") : v;
  };
  const truncLabels = (arr, n=15) => (arr || []).map(v => truncLabel(v, n));

  const monthKeyFrom = (d) => {
    const dt = (d instanceof Date) ? d : new Date(d);
    if(isNaN(dt.getTime())) return "";
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  };
  const relevantDate = (r) => {
    const est = (r?.estado || "").toString().toUpperCase();
    const fin = r?.fechaFinRaw || r?.fechaFin;
    const ini = r?.fechaInicioRaw || r?.fechaInicio;
    const pick = (est.includes("TERMINADA")) ? (fin || ini) : (ini || fin);
    if(!pick) return "";
    return monthKeyFrom(pick);
  };
  const buildMonthlyTrend = (rows, maxMonths=18) => {
    const m = new Map();
    (rows || []).forEach(r=>{
      const k = relevantDate(r);
      if(!k) return;
      m.set(k, (m.get(k) || 0) + 1);
    });
    const keys = Array.from(m.keys()).sort();
    const slice = keys.slice(Math.max(0, keys.length - maxMonths));
    return { labels: slice, data: slice.map(k=> m.get(k) || 0) };
  };
  const tooltipTitleFrom = (full) => (items) => {
    const i = (items && items[0] && typeof items[0].dataIndex === "number") ? items[0].dataIndex : 0;
    return (full && full[i]) ? full[i] : ((items && items[0] && items[0].label) ? items[0].label : "");
  };

  
  try{
    if(ACTIVE_REPORT_ID === "r13"){
      const fullLabels = view.map(r=>r.segmento);
      const labels = truncLabels(fullLabels, 15);
      const fichas = view.map(r=>Number(r.fichas)||0);

      const atrasadas = sum(view, "atrasadas");
      const total = sum(view, "fichas");

      const c0 = document.getElementById(cid("0"));
      const c1 = document.getElementById(cid("1"));
      const c2 = document.getElementById(cid("2"));


      if(c0){
        const trend = buildMonthlyTrend(model.baseRows || []);
        CHART_INSTANCES.push(new Chart(c0, {
          type:"line",
          data:{labels: trend.labels, datasets:[{label:"Fichas", data: trend.data, fill:false, tension:0.35, pointRadius:2}]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            plugins:{legend:{display:true}, tooltip:{mode:"index", intersect:false}},
            scales:{y:{beginAtZero:true, ticks:{precision:0}}}
          }
        }));
      }

      if(c1){
        CHART_INSTANCES.push(new Chart(c1, {
          type:"bar",
          data:{labels, datasets:[{label:"Fichas", data:fichas}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:150, plugins:{legend:{display:false}, tooltip:{callbacks:{title: tooltipTitleFrom(fullLabels)}}}}
        }));
      }
      if(c2){
        CHART_INSTANCES.push(new Chart(c2, {
          type:"doughnut",
          data:{labels:["Atrasadas","No atrasadas"], datasets:[{data:[atrasadas, Math.max(0,total-atrasadas)]}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:150, plugins:{legend:{position:"bottom"}}}
        }));
      }
    }

    if(ACTIVE_REPORT_ID === "r14"){
      const all = [...view].sort((a,b)=> (Number(b.fichas)||0) - (Number(a.fichas)||0) || String(a.responsable||"").localeCompare(String(b.responsable||"")));
      const fullLabels = all.map(r=>r.responsable || "(Sin responsable)");
      const labels = truncLabels(fullLabels, 18);

      const metrics = [
        {k:"activos", label:"Activos"},
        {k:"matriculados", label:"Matriculados"},
        {k:"enInduccion", label:"En Inducción"},
        {k:"condicionado", label:"Condicionado"},
        {k:"cancelado", label:"Cancelado"},
        {k:"aplazado", label:"Aplazado"},
        {k:"retiro", label:"Retiro Voluntario"},
        {k:"porCertificar", label:"Por Certificar"},
        {k:"certificados", label:"Certificado"},
        {k:"enTransito", label:"Tránsito"},
        {k:"sinRuta", label:"Sin Ruta"},
        {k:"sinProgramar", label:"Sin Programar"}
      ];

      const datasets = metrics.map(m=>({
        label:m.label,
        data: all.map(r=>Number(r[m.k])||0),
        fill:true,
        tension:0.25,
        pointRadius:0,
        stack:"s"
      }));

      const c1 = document.getElementById(cid("1"));
      if(c1){
        CHART_INSTANCES.push(new Chart(c1, {
          type:"line",
          data:{labels, datasets},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            interaction:{mode:"index", intersect:false},
            plugins:{
              legend:{position:"bottom"},
              tooltip:{callbacks:{ title: tooltipTitleFrom(fullLabels) }}
            },
            scales:{
              x:{stacked:true, ticks:{autoSkip:true, maxRotation:60, minRotation:0}},
              y:{stacked:true, beginAtZero:true}
            }
          }
        }));
      }

      const c2 = document.getElementById(cid("2"));
      if(c2){
        CHART_INSTANCES.push(new Chart(c2, {
          type:"bar",
          data:{labels, datasets:[{label:"Cantidad de fichas", data: all.map(r=>Number(r.fichas)||0)}]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            plugins:{
              legend:{display:false},
              tooltip:{callbacks:{ title: tooltipTitleFrom(fullLabels) }}
            },
            scales:{
              x:{ticks:{autoSkip:true, maxRotation:60, minRotation:0}},
              y:{beginAtZero:true}
            }
          }
        }));
      }
    }

    if(ACTIVE_REPORT_ID === "r15"){
      const all = [...view].sort((a,b)=> (Number(b.fichas)||0) - (Number(a.fichas)||0) || String(a.programa||"").localeCompare(String(b.programa||"")));
      const fullLabels = all.map(r=>r.programa || "Sin programa");
      const labels = truncLabels(fullLabels, 18);

      const metrics = [
        {k:"activos", label:"Activos"},
        {k:"matriculados", label:"Matriculados"},
        {k:"enTransito", label:"Tránsito"},
        {k:"sinRuta", label:"Sin Ruta"},
        {k:"sinProgramar", label:"Sin Programar"},
        {k:"condicionado", label:"Condicionado"},
        {k:"enInduccion", label:"En Inducción"},
        {k:"porCertificar", label:"Por Certificar"},
        {k:"certificados", label:"Certificado"}
      ];

      const datasets = metrics.map(m=>({
        label:m.label,
        data: all.map(r=>Number(r[m.k])||0),
        fill:true,
        tension:0.25,
        pointRadius:0,
        stack:"s"
      }));

      const c1 = document.getElementById(cid("1"));
      if(c1){
        CHART_INSTANCES.push(new Chart(c1, {
          type:"line",
          data:{labels, datasets},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            interaction:{mode:"index", intersect:false},
            plugins:{
              legend:{position:"bottom"},
              tooltip:{callbacks:{ title: tooltipTitleFrom(fullLabels) }}
            },
            scales:{
              x:{stacked:true, ticks:{autoSkip:true, maxRotation:60, minRotation:0}},
              y:{stacked:true, beginAtZero:true}
            }
          }
        }));
      }

      const c2 = document.getElementById(cid("2"));
      if(c2){
        CHART_INSTANCES.push(new Chart(c2, {
          type:"bar",
          data:{labels, datasets:[{label:"Cantidad de fichas", data: all.map(r=>Number(r.fichas)||0)}]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            plugins:{
              legend:{display:false},
              tooltip:{callbacks:{ title: tooltipTitleFrom(fullLabels) }}
            },
            scales:{
              x:{ticks:{autoSkip:true, maxRotation:60, minRotation:0}},
              y:{beginAtZero:true}
            }
          }
        }));
      }
    }

    if(ACTIVE_REPORT_ID === "r16"){
      const top = topN(view, 50, "activos");
      const fullLabels = top.map(r=>r.programa || "Sin programa");
      const labels = truncLabels(fullLabels, 15);

      const oc = top.map(r=>Number(r.ocupacion)||0);
      const ef = top.map(r=>Number(r.efectividad)||0);
      const cupo = top.map(r=>Number(r.cupo)||0);
      const mat = top.map(r=>Number(r.matriculados)||0);
      const act = top.map(r=>Number(r.activos)||0);

      const c1 = document.getElementById(cid("1"));
      const c2 = document.getElementById(cid("2"));

      if(c1){
        CHART_INSTANCES.push(new Chart(c1, {
          type:"radar",
          data:{
            labels,
            datasets:[
              {label:"Ocupación %", data: oc, fill:true, tension:0.25, pointRadius:2},
              {label:"Efectividad %", data: ef, fill:true, tension:0.25, pointRadius:2}
            ]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:false,
            resizeDelay:150,
            interaction:{mode:"index", intersect:false},
            plugins:{
              legend:{position:"bottom"},
              tooltip:{
                callbacks:{
                  title: tooltipTitleFrom(fullLabels),
                  label:(ctx)=>{
                    const raw = (ctx?.parsed?.r ?? ctx?.parsed ?? 0);
                    const v = Number(raw) || 0;
                    return `${ctx.dataset.label}: ${v.toFixed(1)}%`;
                  }
                }
              }
            },
            scales:{
              r:{beginAtZero:true, suggestedMax:100, ticks:{callback:(v)=> `${v}%`}}
            }
          }
        }));
      }

if(c2){
        CHART_INSTANCES.push(new Chart(c2, {
          type:"bar",
          data:{labels, datasets:[
            {label:"Cupo", data:cupo},
            {label:"Matriculados", data:mat},
            {label:"Activos", data:act}
          ]},
          options:{
            responsive:true, maintainAspectRatio:false,
            indexAxis:"y",
            plugins:{
              legend:{position:"bottom"},
              tooltip:{callbacks:{title: tooltipTitleFrom(fullLabels)}}
            },
            scales:{x:{beginAtZero:true}}
          }
        }));
      }
    }

    if(ACTIVE_REPORT_ID === "r18"){
      const ctx = SAT_CONTEXT || { prevStore: satLoadStore(), curDate: satCutoffKey() };
      const computed = satCompute(model.baseRows || [], ctx.prevStore || satLoadStore(), ctx.curDate || satCutoffKey());

      const c2 = document.getElementById(cid("2"));
      const hmId = cid("3");

      if(c2){
        const cc = computed.causeCounts || {};
        const causes = ["Resultados","Tránsito","Sin Ruta","Sin Programar","Retención"];
        const data = causes.map(k => satSafeNum(cc[k] || 0));
        CHART_INSTANCES.push(new Chart(c2, {
          type:"bar",
          data:{labels: causes, datasets:[{label:"Fichas", data}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false,
            plugins:{legend:{display:false}},
            scales:{y:{beginAtZero:true}}
          }
        }));
      }

      satRenderHeatmap(hmId, computed.heatmap, ["Resultados","Tránsito","Sin Ruta","Sin Programar","Retención"]);
    }


if(ACTIVE_REPORT_ID === "r17"){
      const fullLabels = view.map(r=>r.paso);
      const labels = truncLabels(fullLabels, 15);
      const qty = view.map(r=>Number(r.cantidad)||0);
      const total = qty.reduce((s,v)=>s+v,0);

      const c1 = document.getElementById(cid("1"));
      const c2 = document.getElementById(cid("2"));

      if(c1){
        CHART_INSTANCES.push(new Chart(c1, {
          type:"bar",
          data:{labels, datasets:[{label:"Cantidad", data:qty}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:150, plugins:{legend:{display:false}, tooltip:{callbacks:{title: tooltipTitleFrom(fullLabels)}}}}
        }));
      }
      if(c2){
        CHART_INSTANCES.push(new Chart(c2, {
          type:"doughnut",
          data:{labels, datasets:[{data:qty}]},
          options:{responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:150, plugins:{legend:{position:"bottom"}, tooltip:{callbacks:{label:(ctx)=> {
            const v = ctx.parsed;
            const pct = total ? Math.round((v/total)*100) : 0;
            return `${ctx.label}: ${v} (${pct}%)`;
          }}}}}
        }));
      }
    }
  }catch(e){
    console.error("Error rendering charts", e);
  }
}



/* =========================================================
   DASHBOARD (NOVEDADES) - Interactivo tipo Power BI
   Fuente: RAW_DATA (solo consolidado), con exclusión de estados aplicada (igual r13–r18)
   ========================================================= */

const DASH_MODALIDAD_ALLOWED = ["PRESENCIAL","VIRTUAL","A DISTANCIA"];

const DASH_PROGESP_ALLOWED = [
  "ATENCION A INSTITUCIONES",
  "CAMPESENA",
  "AMBIENTES VIRTUALES DE APRENDIZAJE",
  "PROGRAMA DE BILINGUISMO",
  "FULL POPULAR",
  "FULL POPULAR – FORMACIÓN CONTINUA ESPECIAL POPULAR",
  "POPULAR",
  "INTEGRACIÓN CON LA EDUCACIÓN MEDIA TÉCNICA",
  "INTEGRACIÓN CON LA EDUCACIÓN MEDIA ACADÉMICA",
  "SENATEC",
  "TecnoAcademia - SENNOVA"
];

const DASH_PROGESP_EMPTY = "(SIN PROGRAMA ESPECIAL)";

function dashNormSimple(v){
  return (v ?? "")
    .toString()
    .trim()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[–]/g, "-")
    .replace(/\s+/g, " ")
    .toUpperCase();
}

function dashModalidadValue(v){
  const t = dashNormSimple(v);
  if(!t) return "(Sin modalidad)";
  if(t.includes("PRESENCIAL")) return "PRESENCIAL";
  if(t.includes("VIRTUAL")) return "VIRTUAL";
  if(t.includes("DISTANCIA")) return "A DISTANCIA";
  return "(Sin modalidad)";
}

function dashProgEspValue(v){
  const raw = (v ?? "").toString().trim();
  if(!raw) return DASH_PROGESP_EMPTY;
  const t = dashNormSimple(raw);
  for(const opt of DASH_PROGESP_ALLOWED){
    const o = dashNormSimple(opt);
    if(t === o || t.includes(o)) return opt;
  }
  return DASH_PROGESP_EMPTY;
}
function dashAvailableYears(){
  const base = dashGetBaseRows();
  const set = new Set();
  (base||[]).forEach(r => {
    const y = yearFromValue((r?.fechaInicioRaw || r?.fechaInicio) ?? "");
    if(y) set.add(String(y));
  });
  return Array.from(set).sort();
}
function dashEnsureDefaultYear(force){
  if(!DASH_STATE || !DASH_STATE.filters || !DASH_STATE.filters.year) return;

  // Solo aplicar el "año por defecto" cuando el usuario ya cerró el overlay inicial
  // y NO ha realizado una selección explícita de años.
  if(!force){
    if(!DASH_STATE.yearOverlayDone) return;
    if(DASH_STATE.yearPicked) return;
  }

  const years = dashAvailableYears();
  const curYear = String(new Date().getFullYear());
  const sel = DASH_STATE.filters.year;
  if(!sel) return;

  if(force || sel.size === 0){
    if(years.includes(curYear)) DASH_STATE.filters.year = new Set([curYear]);
  }
}
function dashRenderYearDropdown(){
  const dd = document.getElementById('dashYearDropdown');
  const panel = document.getElementById('dashYearOptions');
  const summaryText = document.getElementById('dashYearSummaryText');
  if(!dd || !panel || !summaryText) return;
  const years = dashAvailableYears();
  if(!years || years.length === 0){
    summaryText.textContent = 'Año inicio: (sin datos)';
    panel.innerHTML = '<div class="year-panel-title">SELECCIONAR AÑOS</div><div class="search-hint">No hay fechas de inicio para filtrar.</div>';
    dd.removeAttribute('open');
    dd.style.opacity = 0.6;
    return;
  }
  dd.style.opacity = 1;
  dashEnsureDefaultYear(false);
  const selected = DASH_STATE.filters.year || new Set();
  panel.innerHTML = '<div class="year-panel-title">SELECCIONAR AÑOS</div>' + years.map(y => {
    const checked = selected.size === 0 ? false : selected.has(String(y));
    return `<label class="year-opt"><input type="checkbox" data-year="${y}" ${checked ? 'checked' : ''}>${y}</label>`;
  }).join('');
  const updateSummary = () => {
    const arr = Array.from(DASH_STATE.filters.year || []).map(String);
    summaryText.textContent = (arr.length ? ('Año inicio: ' + arr.sort().join(', ')) : 'Año inicio: Todos');
  };
  updateSummary();
  panel.querySelectorAll('input[type="checkbox"][data-year]').forEach(chk => {
    chk.addEventListener('change', () => {
      const checkedYears = Array.from(panel.querySelectorAll('input[type="checkbox"][data-year]')).filter(x => x.checked).map(x => x.getAttribute('data-year'));
      DASH_STATE.filters.year = new Set(checkedYears.map(String));
      updateSummary();
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  });
}


function dashShowYearOverlayIfNeeded(){
  const ov = document.getElementById("dashYearOverlay");
  const list = document.getElementById("dashYearOverlayList");
  const selTxt = document.getElementById("dashYearOverlaySelected");
  const btnAll = document.getElementById("dashYearOvAll");
  const btnNone = document.getElementById("dashYearOvNone");
  const btnGo = document.getElementById("dashYearOvContinue");
  if(!ov || !list || !btnGo) return false;

  const years = dashAvailableYears();
  if(!years || years.length === 0) return false;

  if(DASH_STATE && DASH_STATE.yearOverlayDone) return false;

  // Si aún no hay selección guardada, por defecto marcar "Todo" (todos los años)
  const existing = (DASH_STATE && DASH_STATE.filters && DASH_STATE.filters.year) ? DASH_STATE.filters.year : new Set();
  const effective = (existing && existing.size) ? new Set(Array.from(existing).map(String)) : new Set(years.map(String));

  list.innerHTML = years.map(y => {
    const yy = String(y);
    const checked = effective.has(yy);
    return `<label class="year-opt"><input type="checkbox" data-year="${escHtml(yy)}" ${checked ? "checked" : ""}>${escHtml(yy)}</label>`;
  }).join("");

  const updateSelected = () => {
    const checkedYears = Array.from(list.querySelectorAll('input[type="checkbox"][data-year]'))
      .filter(x => x.checked)
      .map(x => x.getAttribute("data-year"));
    const n = checkedYears.length;
    if(selTxt){
      if(n === 0 || n === years.length) selTxt.textContent = "Seleccionados: Todos";
      else selTxt.textContent = "Seleccionados: " + n;
    }
  };
  updateSelected();

  list.querySelectorAll('input[type="checkbox"][data-year]').forEach(chk => {
    chk.addEventListener("change", updateSelected);
  });

  if(btnAll){
    btnAll.onclick = () => {
      list.querySelectorAll('input[type="checkbox"][data-year]').forEach(x => x.checked = true);
      updateSelected();
    };
  }
  if(btnNone){
    btnNone.onclick = () => {
      list.querySelectorAll('input[type="checkbox"][data-year]').forEach(x => x.checked = false);
      updateSelected();
    };
  }

  btnGo.onclick = () => {
    const checkedYears = Array.from(list.querySelectorAll('input[type="checkbox"][data-year]'))
      .filter(x => x.checked)
      .map(x => x.getAttribute("data-year"));

    // Regla: si queda "todo" (o nada), representamos como Set vacío = Todos
    if(!DASH_STATE.filters) DASH_STATE.filters = {};
    if(checkedYears.length === 0 || checkedYears.length === years.length){
      DASH_STATE.filters.year = new Set();
    }else{
      DASH_STATE.filters.year = new Set(checkedYears.map(String));
    }

    DASH_STATE.yearOverlayDone = true;
    DASH_STATE.yearPicked = true;

    ov.classList.add("hidden");
    dashRenderYearDropdown();
    dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
  };

  // Bloquear click accidental fuera (se mantiene visible hasta "Continuar")
  ov.classList.remove("hidden");
  return true;
}



// ==========================
// Ajustes (Dashboard):
// - Segmentador "Estado" = ETAPA FICHA (LECTIVA/PRACTICA)
// - Segmentador "ESTADO_CURSO" = 6 estados permitidos (todos habilitados)
// - Limpieza de encabezados en Tipo/Nivel/Municipio
// ==========================
const DASH_ETAPA_FICHA_ALLOWED = ["LECTIVA","PRACTICA"];
const DASH_ESTADO_CURSO_ALLOWED = [
  "Terminada",
  "Terminada por fecha",
  "En matricula",
  "En ejecución",
  "TERMINADO",
  "Terminada por unificación"
];

function dashEtapaFichaValue(v){
  const t = dashNormSimple(v);
  if(!t) return "";
  if(t === "ETAPA" || t === "ETAPA_FICHA") return "";
  if(t.includes("LECT")) return "LECTIVA";
  if(t.includes("PRAC")) return "PRACTICA";
  return "";
}

function dashEstadoCursoValue(v){
  const t = dashNormSimple(v);
  if(!t) return "";
  if(t === "ESTADO" || t === "ESTADO_CURSO") return "";
  if(t.includes("TERMINADA") && t.includes("UNIFIC")) return "Terminada por unificación";
  if(t.includes("TERMINADA") && t.includes("FECHA")) return "Terminada por fecha";
  if(t === "TERMINADO") return "TERMINADO";
  if(t === "TERMINADA") return "Terminada";
  if(t.includes("EN") && t.includes("MATRIC")) return "En matricula";
  if(t.includes("EN") && t.includes("EJECUC")) return "En ejecución";
  return "";
}

function dashTipoValue(v){
  const t = dashNormSimple(v);
  if(!t) return "";
  if(t === "TIPO" || t === "TIPO_DE_FORMACION" || t === "TIPO_FORMACION") return "";
  return (v ?? "").toString().trim();
}

function dashNivelValue(v){
  const t = dashNormSimple(v);
  if(!t) return "";
  if(t === "NIVEL" || t === "NIVEL_FORMACION" || t === "NIVEL_DE_FORMACION") return "";
  return (v ?? "").toString().trim();
}

function dashMunicipioValue(v){
  const t = dashNormSimple(v);
  if(!t) return "";
  if(t === "MUNICIPIO" || t === "NOMBRE_MUNICIPIO_CURSO" || t === "NOMBRE_MUNICIPIO") return "";
  return (v ?? "").toString().trim();
}


/* =========================================================
   OPTIMIZACIÓN DE RENDIMIENTO (caches + debounce)
   - Sin cambios de diseño ni funcionalidad
   ========================================================= */

function debounce(fn, wait){
  let t = 0;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

let __dashRenderRaf = 0;
function dashRequestRender(){
  if(__dashRenderRaf) return;
  __dashRenderRaf = requestAnimationFrame(() => {
    __dashRenderRaf = 0;
    dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
  });
}

function dashBumpRev(){
  try{
    DASH_STATE._rev = (DASH_STATE._rev || 0) + 1;
    if(DASH_STATE._filteredCache) DASH_STATE._filteredCache.clear();

    // Bundle de filtrado (optimización): invalida cachés por rev
    DASH_STATE._bundleRev = -1;
    DASH_STATE._bundleFull = [];
    DASH_STATE._bundleFailOnly = Object.create(null);
    DASH_STATE._bundleMerged = Object.create(null);

    // Limpia caches derivados del dashboard (aprendices DF-03)
    if(DASH_STATE._aprViewCache) DASH_STATE._aprViewCache = null;
  }catch(e){}
}

function dashOnFiltersChanged(){
  try{
    DASH_STATE.critPage = 1;
    DASH_STATE.muniPage = 1;
  }catch(e){}
  dashBumpRev();
  dashRequestRender();
}

function dashGetSearchTerms(){
  try{
    const q = (DASH_STATE.search || "").trim().toLowerCase();
    if(DASH_STATE._searchQ === q) return DASH_STATE._searchTerms || [];
    DASH_STATE._searchQ = q;
    DASH_STATE._searchTerms = q ? q.split(/\s+/).filter(Boolean) : [];
    return DASH_STATE._searchTerms;
  }catch(e){
    return [];
  }
}

function dashGetRowCache(r){
  if(!r) return { hay:"", dim:Object.create(null), atrasoBucket:"" };
  let c = r.__dashCache;
  if(!c){
    c = r.__dashCache = { hay:null, dim:Object.create(null), atrasoBucket:null };
  }
  return c;
}

function dashGetDimCached(row, dim){
  const c = dashGetRowCache(row);
  const k = dim.key;
  if(Object.prototype.hasOwnProperty.call(c.dim, k)) return c.dim[k];
  let v = "";
  try{ v = dim.get(row); }catch(e){ v = ""; }
  c.dim[k] = v;
  return v;
}

function dashGetAtrasoBucketCached(row){
  const c = dashGetRowCache(row);
  if(c.atrasoBucket != null) return c.atrasoBucket;
  c.atrasoBucket = dashBucketAtraso(row?.diasAtraso);
  return c.atrasoBucket;
}



let DASH_STATE = {
  inited: false,
  yearOverlayDone: false,
  yearPicked: false,
  search: "",
  mapMetric: "fichas",
  filters: {
    estado: new Set(),
    estadoCurso: new Set(),
    nivel: new Set(),
    modalidad: new Set(),
    tipo: new Set(),
    municipio: new Set(),
    responsable: new Set(),
    programa: new Set(),
        empresa: new Set(),
programaEspecial: new Set(),
    year: new Set(),
    atrasoBucket: new Set()
  },
  charts: {},
  critSort: null,
  critPage: 1,
  critPageSize: 20,
  muniSort: null,
  muniPage: 1,
  muniPageSize: 20,
  aprPage: 1,
  aprPageSize: 15,
  _rev: 0,
  _filteredCache: new Map(),
  _bundleRev: -1,
  _bundleFull: [],
  _bundleFailOnly: Object.create(null),
  _bundleMerged: Object.create(null),
  _baseCache: { rawRef: null, rows: [] },
  _searchQ: null,
  _searchTerms: [],
  _aprViewCache: null,
  _aprRowsCache: null
};

const DASH_DIMS = [
  {key:"estado", label:"ETAPA FICHA", get:r => dashEtapaFichaValue(r?.etapa)},
  {key:"estadoCurso", label:"ESTADO_CURSO", get:r => dashEstadoCursoValue(r?.estado)},
  {key:"municipio", label:"Municipio", get:r => dashMunicipioValue(r?.municipio)},
  {key:"programa", label:"Programa", get:r => dashStr(r?.programa, "(Sin programa)")},
    {key:"empresa", label:"Empresa", get:r => dashStr(r?.empresa, "(Sin empresa)")},
{key:"responsable", label:"Responsable", get:r => dashStr(r?.responsable, "(Sin responsable)")},
  {key:"modalidad", label:"Modalidad", get:r => dashModalidadValue(r?.modalidad)},
  {key:"nivel", label:"Nivel", get:r => dashNivelValue(r?.nivel)},
  {key:"tipo", label:"Tipo", get:r => dashTipoValue(r?.tipo)},
  {key:"programaEspecial", label:"Programa especial", get:r => dashProgEspValue(r?.programaEspecial)},
  {key:"year", label:"Año inicio", get:r => {
    const y = yearFromValue((r?.fechaInicioRaw || r?.fechaInicio) ?? "");
    return y ? String(y) : "";
  }}
];

function dashStr(v, fb){
  const s = (v === undefined || v === null) ? "" : String(v);
  const t = s.trim();
  return t ? t : (fb || "(Sin dato)");
}
function dashBucketAtraso(d){
  const n = Number(d) || 0;
  if(n <= 0) return "0";
  if(n <= 7) return "1-7";
  if(n <= 15) return "8-15";
  if(n <= 30) return "16-30";
  if(n <= 60) return "31-60";
  return "61+";
}
function dashFmtPct(ratio){
  const v = Number(ratio);
  if(!isFinite(v) || v < 0) return "0%";
  return (v * 100).toFixed(1).replace(".", ",") + "%";
}
function dashHaystack(r){
  const c = dashGetRowCache(r);
  if(c.hay != null) return c.hay;
  c.hay = `${r?.ficha ?? ""} ${r?.programa ?? ""} ${r?.municipio ?? ""} ${r?.centro ?? ""} ${r?.responsable ?? ""}`.toLowerCase();
  return c.hay;
}


// Dashboard: fuentes válidas para considerar una ficha en el tablero (excluye fichas creadas solo por IGI u otros reportes)
const DASH_ALLOWED_SRC_TAGS = new Set(["PE04","DF14A","DF53","DF51","DF49"]);
function dashHasAllowedSource(row){
  const tags = row && row._srcTags ? row._srcTags : null;
  if(!tags) return true; // compat
  for(const k in tags){
    if(DASH_ALLOWED_SRC_TAGS.has(k)) return true;
  }
  return false;
}

function dashGetBaseRows(){
  const bc = (DASH_STATE && DASH_STATE._baseCache) ? DASH_STATE._baseCache : null;
  if(bc && bc.rawRef === RAW_DATA) return bc.rows;

  if(!Array.isArray(RAW_DATA) || RAW_DATA.length === 0){
    if(bc){ bc.rawRef = RAW_DATA; bc.rows = []; }
    return [];
  }

  // Aplica exclusión global (Cancelada / Terminada por unificación)
  // NOTA: al incluir "dashboard" en ESTADO_EXCLUSION_REPORTS, applyEstadoExclusion ya la aplica.
  let rows = applyEstadoExclusion(RAW_DATA, "dashboard");
  rows = rows.filter(dashHasAllowedSource);
  if(bc){ bc.rawRef = RAW_DATA; bc.rows = rows; }
  return rows;
}

function dashAllValuesForKey(key){
  if(key === "modalidad") return [...DASH_MODALIDAD_ALLOWED];
  if(key === "programaEspecial") return [...DASH_PROGESP_ALLOWED, DASH_PROGESP_EMPTY];
  if(key === "estado") return [...DASH_ETAPA_FICHA_ALLOWED];
  if(key === "estadoCurso") return [...DASH_ESTADO_CURSO_ALLOWED];

  const dim = DASH_DIMS.find(d => d.key === key);
  if(!dim) return [];
  const base = dashGetBaseRows();
  const set = new Set((base||[]).map(r => dim.get(r)).filter(v => String(v||"").trim() !== ""));
  return Array.from(set);
}

function dashPassFilters(row, exceptKey){
  const f = DASH_STATE.filters || {};
  const terms = dashGetSearchTerms();
  if(terms.length){
    const hay = dashHaystack(row);
    for(const t of terms){
      if(!hay.includes(t)) return false;
    }
  }
  // (Segmentación rápida removida por requerimiento)
  // Filtros por dimensión
  for(const dim of DASH_DIMS){
    const key = dim.key;
    if(key === exceptKey) continue;
    const set = f[key];
    if(set && set.size > 0){
      const val = dashGetDimCached(row, dim);
      if(!set.has(val)) return false;
    }
  }

  // Bucket de atraso (derivado)
  if(exceptKey !== "atrasoBucket"){
    const ab = f.atrasoBucket;
    if(ab && ab.size > 0){
      const b = dashGetAtrasoBucketCached(row);
      if(!ab.has(b)) return false;
    }
  }

  return true;
}

function dashGetFilteredBundle(){
  const rev = (DASH_STATE && DASH_STATE._rev) ? DASH_STATE._rev : 0;
  if(DASH_STATE && DASH_STATE._bundleRev === rev && DASH_STATE._bundleFull && DASH_STATE._bundleFailOnly){
    return {
      full: DASH_STATE._bundleFull,
      failOnly: DASH_STATE._bundleFailOnly,
      merged: DASH_STATE._bundleMerged || (DASH_STATE._bundleMerged = Object.create(null))
    };
  }

  const base = dashGetBaseRows();
  const f = (DASH_STATE && DASH_STATE.filters) ? DASH_STATE.filters : {};
  const terms = dashGetSearchTerms();
  const dims = DASH_DIMS || [];

  const full = [];
  const failOnly = Object.create(null);
  for(const dim of dims){ failOnly[dim.key] = []; }

  // Para cada fila: evaluar búsqueda + cuántos filtros (dimensiones) falla
  for(const row of base){
    if(terms.length){
      const hay = dashHaystack(row);
      let ok = true;
      for(const t of terms){
        if(!hay.includes(t)){ ok = false; break; }
      }
      if(!ok) continue;
    }

    let failKey = null;
    let multiFail = false;

    for(const dim of dims){
      const key = dim.key;
      const set = f[key];
      if(!set || set.size === 0) continue;

      const v = dim.get(row);
      if(!set.has(v)){
        if(failKey === null) failKey = key;
        else { multiFail = true; break; }
      }
    }

    if(multiFail) continue;
    if(failKey === null) full.push(row);
    else if(failOnly[failKey]) failOnly[failKey].push(row);
  }

  if(DASH_STATE){
    DASH_STATE._bundleRev = rev;
    DASH_STATE._bundleFull = full;
    DASH_STATE._bundleFailOnly = failOnly;
    DASH_STATE._bundleMerged = Object.create(null);
  }

  return { full, failOnly, merged: (DASH_STATE ? DASH_STATE._bundleMerged : Object.create(null)) };
}

function dashGetFilteredRows(exceptKey){
  // Optimización: en cada _rev calculamos una vez:
  //  - filas que pasan TODOS los filtros (full)
  //  - filas que fallan SOLO un filtro (failOnly[key])
  // así, rows(exceptKey) = full + failOnly[exceptKey]
  const b = dashGetFilteredBundle();
  if(!exceptKey) return b.full;

  // cache por exceptKey dentro del mismo rev
  if(b.merged && b.merged[exceptKey]) return b.merged[exceptKey];

  // Si la dimensión no existe (caso raro), usa el método tradicional
  if(!b.failOnly || !(exceptKey in b.failOnly)){
    const rows = dashGetBaseRows().filter(r => dashPassFilters(r, exceptKey));
    if(b.merged) b.merged[exceptKey] = rows;
    return rows;
  }

  const merged = b.full.concat(b.failOnly[exceptKey] || []);
  if(b.merged) b.merged[exceptKey] = merged;
  return merged;
}

function dashMatchValue(key, raw){
  const s = (raw ?? "").toString().trim();
  if(!s) return s;
  try{
    const all = dashAllValuesForKey(key) || [];
    const ns = dashNormSimple(s);
    let match = all.find(v => dashNormSimple(v) === ns);
    if(match) return String(match);

    // Equivalencias especiales (municipios)
    if(key === 'municipio'){
      const alias = [];
      if(ns === 'SAN SEBASTIAN DE MARIQUITA' || ns === 'SAN SEBASTIAN MARIQUITA') alias.push('MARIQUITA');
      if(ns === 'MARIQUITA') alias.push('SAN SEBASTIAN DE MARIQUITA');
      if(ns.includes('MARIQUITA') && !alias.includes('MARIQUITA')) alias.push('MARIQUITA');

      for(const a of alias){
        const na = dashNormSimple(a);
        match = all.find(v => dashNormSimple(v) === na);
        if(match) return String(match);
      }
    }

    return s;
  }catch(e){
    return s;
  }
}

function dashToggleFilter(key, value){
  const set = DASH_STATE.filters[key] || new Set();
  if(set.has(value)) set.delete(value); else set.add(value);
  DASH_STATE.filters[key] = set;
  DASH_STATE.critPage = 1;
  DASH_STATE.muniPage = 1;
  dashBumpRev();
  dashRequestRender();
}

function dashToggleSingleFilter(key, value){
  const cur = DASH_STATE.filters[key] || new Set();
  const alreadyOnly = (cur.size === 1 && cur.has(value));
  const next = new Set();
  if(!alreadyOnly) next.add(value);
  DASH_STATE.filters[key] = next;
  DASH_STATE.critPage = 1;
  DASH_STATE.muniPage = 1;
  dashBumpRev();
  dashRequestRender();
}


function dashSetFilterOnly(key, value){
  DASH_STATE.filters[key] = new Set([value]);
  DASH_STATE.critPage = 1;
  DASH_STATE.muniPage = 1;
  dashBumpRev();
  dashRequestRender();
}

function dashClearFilter(key){
  DASH_STATE.filters[key] = new Set();
  DASH_STATE.critPage = 1;
  DASH_STATE.muniPage = 1;
  dashBumpRev();
  dashRequestRender();
}

function dashResetAll(){
  DASH_STATE.search = "";
  Object.keys(DASH_STATE.filters).forEach(k => DASH_STATE.filters[k] = new Set());
  dashEnsureDefaultYear(true);

  const s = document.getElementById("dashSearch");
  if(s) s.value = "";
  dashBumpRev();
  dashRequestRender();
}

function dashDestroyCharts(){
  try{
    Object.values(DASH_STATE.charts || {}).forEach(ch => { try{ ch.destroy(); }catch(e){} });
  }catch(e){}
  DASH_STATE.charts = {};
}

function hideDashboardView(){
  const dash = document.getElementById("dashboardArea");
  const tools = document.getElementById("tableTools");
  const tbl = document.querySelector("#reportCard .table-container");
  const charts = document.getElementById("chartsArea");
  const kpi = document.getElementById("kpiArea");
  const pager = document.getElementById("mainTablePager");
  const excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");

  if(dash) dash.classList.add("hidden");
  if(tools) tools.style.display = "block";
  if(tbl) tbl.style.display = "block";
  if(kpi) kpi.style.display = "";
  if(excelBtn) excelBtn.style.display = "inline-block";
  if(pager) pager.style.display = "none";

  // Los charts estándar se manejan por renderCharts; aquí solo limpiamos charts del dashboard
  dashDestroyCharts();
}

function renderDashboardView(){
  const dash = document.getElementById("dashboardArea");
  const tools = document.getElementById("tableTools");
  const tbl = document.querySelector("#reportCard .table-container");
  const charts = document.getElementById("chartsArea");
  const kpi = document.getElementById("kpiArea");
  const pager = document.getElementById("mainTablePager");
  const excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");

  if(tools) tools.style.display = "none";
  if(tbl) tbl.style.display = "none";
  if(charts){ charts.style.display = "none"; charts.innerHTML = ""; }
  if(kpi){ kpi.innerHTML = ""; kpi.style.display = "none"; }
  if(excelBtn) excelBtn.style.display = "none";
  if(pager) pager.style.display = "none";

  destroyCharts(); // charts estándar (r13-r18)

  if(dash) dash.classList.remove("hidden");

  if(!DASH_STATE.inited){
    dashInitUI();
    DASH_STATE.inited = true;
  }

  // Overlay inicial de años: se muestra la primera vez que se abre Dashboard (si hay años disponibles)
  dashRenderYearDropdown();
  const overlayShown = dashShowYearOverlayIfNeeded();
  if(!overlayShown){
    dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
  }

  // Bind UI (búsqueda / export) de tabla aprendices DF-03
  dashBindAprDF03UI();
}

function dashInitUI(){
  const search = document.getElementById("dashSearch");
  if(search){
    const onSearch = debounce(() => {
      DASH_STATE.search = search.value || "";
      dashBumpRev();
      dashRequestRender();
    }, 120);
    search.addEventListener("input", onSearch);
  }

  const clearBtn = document.getElementById("dashClearBtn");
  if(clearBtn) clearBtn.addEventListener("click", dashResetAll);

  const mm = document.getElementById("dashMapMetric");
  if(mm){
    try{ mm.value = (DASH_STATE.mapMetric || "matriculados"); }catch(e){}
    mm.addEventListener("change", () => {
      DASH_STATE.mapMetric = mm.value || "matriculados";
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  }

  // Toggle columnas avanzadas en tabla de municipios (Ajuste 3)
  const tbtn = document.getElementById("dashMuniToggleCols");
  const ttbl = document.getElementById("dashTblMunicipio");
  if(tbtn && ttbl){
    tbtn.addEventListener("click", () => {
      ttbl.classList.toggle("hide-adv");
      const on = !ttbl.classList.contains("hide-adv");
      tbtn.textContent = on ? "Ocultar columnas" : "Columnas avanzadas";
    });
  }



  // Ordenamiento de la tabla crítica (Top 25 por atraso)
  dashInitCritSortUI();
  dashInitCritDoubleScroll();
  dashInitMuniSortUI();
}

function dashRender(){
  dashEnsureDefaultYear(false);
  dashRenderYearDropdown();

  if(ACTIVE_REPORT_ID !== "dashboard") return;

  const rows = dashGetFilteredRows(null);

  dashRenderActiveFilters();
  dashRenderKpis(rows);
  dashRenderSlicers();
  dashRenderCharts(rows);

  // Tabla de aprendices (DF-03) según filtros del Dashboard
  dashRenderAprendicesDF03(rows);

  dashRenderTables(rows);
  // badge
  try{
    const b = document.getElementById("c-dashboard");
    if(b) b.textContent = rows.length;
  }catch(e){}
}

function dashRenderActiveFilters(){
  const wrap = document.getElementById("dashActiveFilters");
  if(!wrap) return;

  const pills = [];

  const q = (DASH_STATE.search || "").trim();
  if(q){
    pills.push({label:`Búsqueda: ${q}`, onClick: () => { DASH_STATE.search=""; const s=document.getElementById("dashSearch"); if(s) s.value=""; dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){} }});
  }

  // dimension filters
  for(const dim of DASH_DIMS){
    const set = DASH_STATE.filters[dim.key];
    if(set && set.size > 0){
      const arr = Array.from(set);
      if(arr.length === 1){
        pills.push({label:`${dim.label}: ${arr[0]}`, onClick: () => { dashClearFilter(dim.key); }});
      }else{
        pills.push({label:`${dim.label}: ${arr.length} seleccionados`, onClick: () => { dashClearFilter(dim.key); }});
      }
    }
  }
  // atraso bucket
  const ab = DASH_STATE.filters.atrasoBucket;
  if(ab && ab.size > 0){
    const arr = Array.from(ab);
    pills.push({label:`Atraso: ${arr.join(", ")}`, onClick: () => { dashClearFilter("atrasoBucket"); }});
  }

  wrap.innerHTML = pills.length
    ? pills.map((p, idx) => `<span class="dash-pill" data-idx="${idx}">${escHtml(p.label)} <span class="x">×</span></span>`).join("")
    : `<span style="color:var(--muted); font-size:12px;">Sin filtros activos</span>`;

  // bind
  const nodes = wrap.querySelectorAll(".dash-pill");
  nodes.forEach(n => {
    const idx = Number(n.getAttribute("data-idx"));
    n.addEventListener("click", () => { try{ pills[idx].onClick(); }catch(e){} });
  });
}

function dashRenderKpis(rows){
  const wrap = document.getElementById("dashKpis");
  if(!wrap) return;

  const sum = (k) => rows.reduce((s,r)=> s + (Number(r?.[k])||0), 0);

  const fichas = rows.length;
  const cupo = sum("cupo");
  const matric = sum("matriculados");
  const activos = sum("activos");
  const sinRuta = sum("sinRuta");
  const sinJuicio = sum("aprendicesSinJuicio") + sum("sinJuicio");

  const genMasculino = sum("totalApreMasculinos");
  const genFemenino = sum("totalApreFemeninos");
  const genNoBinario = sum("totalApreNoBinario");
  const horasRows = rows.filter(r => isEventoOrCursoEspecial(r.nivel));
  const horasPlanta = horasRows.reduce((s,r)=> s + (Number(r?.horasPlanta)||0), 0);
  const horasContratistas = horasRows.reduce((s,r)=> s + (Number(r?.horasContratistas)||0), 0);

  const ocup = (cupo > 0) ? (matric / cupo) : 0;
  const efect = (matric > 0) ? (activos / matric) : 0;

  const atrasadas = rows.reduce((s,r)=> s + ((Number(r?.diasAtraso)||0) > 0 ? 1 : 0), 0);
  const atrasoProm = (() => {
    const arr = rows.map(r => Number(r?.diasAtraso)||0).filter(n => n>0);
    if(arr.length === 0) return 0;
    return arr.reduce((a,b)=>a+b,0) / arr.length;
  })();

  // Embudo operativo (compat con distintos nombres)
  const enTransito = sum("enTransito");
  const enInduccion = sum("induccion") + sum("enInduccion"); // compat
  const enFormacion = sum("formacion") + sum("enFormacion"); // compat
  const porCert = sum("porCertificar");
  const cert = sum("certificados");

  const novedades = rows.reduce((s,r)=> s
    + (Number(r?.condicionado)||0)
    + (Number(r?.aplazado)||0)
    + (Number(r?.cancelado)||0)
    + (Number(r?.retiro)||0)
    + (Number(r?.desercion)||0)
    + (Number(r?.trasladado)||0)
    , 0);

  const iconFolder = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"></path>
    </svg>`;
  const iconBar = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 3v18h18"></path>
      <path d="M7 14v4"></path>
      <path d="M11 10v8"></path>
      <path d="M15 6v12"></path>
      <path d="M19 12v6"></path>
    </svg>`;
  const iconUsers = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="9" cy="7" r="4"></circle>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
    </svg>`;
  const iconWarn = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
      <line x1="12" y1="9" x2="12" y2="13"></line>
      <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>`;

  wrap.innerHTML = `
    <div class="kpi-top-grid">
      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Total Fichas</div>
          <div class="kpi-value">${escHtml(fmtNum(fichas))}</div>
          <div class="kpi-meta">
            <span class="kpi-pill">Atrasadas: ${escHtml(fmtNum(atrasadas))}</span>
            <span>Promedio ${escHtml(Number(atrasoProm).toFixed(1).replace(".",","))} días</span>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-icon" aria-hidden="true">${iconFolder}</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Cupo Total</div>
          <div class="kpi-value">${escHtml(fmtNum(cupo))}</div>
          <div class="kpi-progress" title="Ocupación">
            <span style="width:${Math.max(0, Math.min(100, ocup*100)).toFixed(1)}%"></span>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-badge">${escHtml(dashFmtPct(ocup))}</div>
          <div class="kpi-icon" aria-hidden="true">${iconBar}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700;">Ocupación</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Matriculados</div>
          <div class="kpi-value">${escHtml(fmtNum(matric))}</div>
          <div class="kpi-meta">
            <span><b>${escHtml(fmtNum(activos))}</b> Activos</span>
            <span class="kpi-pill">Masculino: ${escHtml(fmtNum(genMasculino))}</span>
            <span class="kpi-pill">Femenino: ${escHtml(fmtNum(genFemenino))}</span>
            <span class="kpi-pill">No binario: ${escHtml(fmtNum(genNoBinario))}</span>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-badge purple">${escHtml(dashFmtPct(efect))}</div>
          <div class="kpi-icon" aria-hidden="true">${iconUsers}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700;">Efectividad</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Novedades</div>
          <div class="kpi-value">${escHtml(fmtNum(novedades))}</div>
          <div class="kpi-meta" style="gap:8px;">
            <span style="color:#dc2626;font-weight:900;">- ${escHtml(fmtNum(sinRuta))} Sin Ruta</span>
            <span>· ${escHtml(fmtNum(sinJuicio))} Sin Juicio</span>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-icon" aria-hidden="true" style="background:rgba(220,38,38,.08);color:rgba(220,38,38,1);">${iconWarn}</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Horas planta</div>
          <div class="kpi-value">${escHtml(fmtTime(horasPlanta))}</div>
          <div class="kpi-meta"><span class="kpi-pill">NIVEL_FORMACION: Evento / Curso Especial</span></div>
        </div>
        <div class="kpi-right">
          <div class="kpi-icon" aria-hidden="true">${iconBar}</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-left">
          <div class="kpi-title">Horas contratistas</div>
          <div class="kpi-value">${escHtml(fmtTime(horasContratistas))}</div>
          <div class="kpi-meta"><span class="kpi-pill">NIVEL_FORMACION: Evento / Curso Especial</span></div>
        </div>
        <div class="kpi-right">
          <div class="kpi-icon" aria-hidden="true">${iconBar}</div>
        </div>
      </div>
</div>
    </div>

    <div class="kpi-embudo">
      <div class="kpi-embudo-head">
        <span class="ico" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 4h18"></path>
            <path d="M6 12h12"></path>
            <path d="M10 20h4"></path>
          </svg>
        </span>
        <span>Embudo Operativo (Aprendices)</span>
      </div>
      <div class="kpi-steps">
        <div class="step-card step-transito">
          <div class="step-title">TRÁNSITO</div>
          <div class="step-value">${escHtml(fmtNum(enTransito))}</div>
          <div class="step-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20v-6"></path><path d="M6 20v-4"></path><path d="M18 20v-8"></path>
            </svg>
          </div>
        </div>

        <div class="step-card step-induccion">
          <div class="step-title">INDUCCIÓN</div>
          <div class="step-value">${escHtml(fmtNum(enInduccion))}</div>
          <div class="step-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 10l-10-5-10 5 10 5 10-5z"></path>
              <path d="M6 12v5c0 1.1 2.7 2 6 2s6-.9 6-2v-5"></path>
            </svg>
          </div>
        </div>

        <div class="step-card step-formacion">
          <div class="step-title">FORMACIÓN</div>
          <div class="step-value">${escHtml(fmtNum(enFormacion))}</div>
          <div class="step-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
          </div>
        </div>

        <div class="step-card step-cert">
          <div class="step-title">CERTIFICACIÓN</div>
          <div class="step-value">${escHtml(fmtNum(porCert + cert))} <span style="font-size:11px;color:var(--muted);font-weight:800;">Total</span></div>
          <div class="step-sub">Por certificar: <b>${escHtml(fmtNum(porCert))}</b></div>
          <div class="step-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div class="kpi-extra-grid">
      <div class="kpi-mini">
        <div>
          <div class="t">Fichas atrasadas</div>
          <div class="v">${escHtml(fmtNum(atrasadas))}</div>
        </div>
      </div>
      <div class="kpi-mini">
        <div>
          <div class="t">Atraso prom. (días)</div>
          <div class="v">${escHtml(Number(atrasoProm).toFixed(1).replace(".",","))}</div>
        </div>
      </div>
      <div class="kpi-mini">
        <div>
          <div class="t">Sin ruta</div>
          <div class="v">${escHtml(fmtNum(sinRuta))}</div>
        </div>
      </div>
      <div class="kpi-mini">
        <div>
          <div class="t">Por certificar</div>
          <div class="v">${escHtml(fmtNum(porCert))}</div>
        </div>
      </div>
    </div>
  `;

  // Ajuste: si el contenedor es muy angosto, oculta flechas del embudo
  try{
    const steps = wrap.querySelector(".kpi-steps");
    if(steps){
      const w = steps.getBoundingClientRect().width;
      if(w < 700){
        steps.classList.add("no-arrows");
        const st = document.createElement("style");
        st.textContent = '#dashboardArea .kpi-steps.no-arrows .step-card:not(:last-child)::after{content:"";}';
        wrap.appendChild(st);
      }
    }
  }catch(e){}
}


function dashSlicerIconHtml(key){
  const svg = {
    responsable: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
    programa: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><rect x="3" y="7" width="18" height="14" rx="2"></rect><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path><path d="M3 13h18"></path></svg>',
    municipio: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11z"></path><circle cx="12" cy="10" r="2.5"></circle></svg>',
    estadoCurso: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M22 12h-4l-3 9-4-18-3 9H2"></path></svg>',
    nivel: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M3 3v18h18"></path><path d="M7 14v4"></path><path d="M12 10v8"></path><path d="M17 6v12"></path></svg>',
    estado: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M12 2l7 4v6l-7 4-7-4V6l7-4z"></path><path d="M19 10l-7 4-7-4"></path><path d="M12 14v8"></path></svg>',
    modalidad: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><rect x="3" y="4" width="18" height="12" rx="2"></rect><path d="M8 20h8"></path><path d="M12 16v4"></path></svg>',
    programaEspecial: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M12 2l1.8 6.2L20 10l-6.2 1.8L12 18l-1.8-6.2L4 10l6.2-1.8L12 2z"></path><path d="M5 21l1-3"></path><path d="M19 21l-1-3"></path></svg>',
    tipo: '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M20.6 13.4L13.4 20.6a2 2 0 0 1-2.8 0L3 13V3h10l7.6 7.6a2 2 0 0 1 0 2.8z"></path><circle cx="7.5" cy="7.5" r="1.5"></circle></svg>'
  }[key] || '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><circle cx="12" cy="12" r="9"></circle><path d="M8 12h8"></path></svg>';

  const safeKey = String(key||"").replace(/[^a-zA-Z0-9_\-]/g,"");
  return '<span class="slicer-ico sico-' + safeKey + '" aria-hidden="true">' + svg + '</span>';
}


function dashRenderSlicers(){
  const leftWrap = document.getElementById("dashSlicersLeft");
  const btnWrap = document.getElementById("dashSlicersButtons");
  if(!leftWrap) return;

  // Sanitizar filtros removidos de la UI
  try{
    const sNivel = DASH_STATE.filters["nivel"];
    if(sNivel && sNivel.size){
      for(const v of Array.from(sNivel)){
        if(dashNormSimple(v) === "OTRO") sNivel.delete(v);
      }
    }
    const sPE = DASH_STATE.filters["programaEspecial"];
    if(sPE && sPE.size){
      for(const v of Array.from(sPE)){
        if(dashNormSimple(v) === "POPULAR") sPE.delete(v);
      }
    }
  }catch(_e){}


  const makeChecklistSlicer = (dim, showHead) => {
    const key = dim.key;
    const ctx = dashGetFilteredRows(key);
    const counts = {};
    ctx.forEach(r => {
      const v = dim.get(r);
      if(String(v||"").trim() === "") return;
      counts[v] = (counts[v] || 0) + 1;
    });

    let ordered;
    if(key === "estado"){
      ordered = DASH_ETAPA_FICHA_ALLOWED.map(v => ({v, c: counts[v] || 0}));
    }else if(key === "estadoCurso"){
      ordered = DASH_ESTADO_CURSO_ALLOWED.map(v => ({v, c: counts[v] || 0}));
    }else{
      const allVals = dashAllValuesForKey(key);
      ordered = (allVals || [])
        .map(v => ({v, c: counts[v] || 0}))
        .sort((a,b)=> (b.c - a.c) || String(a.v).localeCompare(String(b.v), "es"));
    }


    // Exclusiones solicitadas en segmentaciones
    if(key === "nivel"){
      ordered = ordered.filter(o => dashNormSimple(o.v) !== "OTRO");
    }
    if(key === "programaEspecial"){
      // Quitar opción "solo popular"
      ordered = ordered.filter(o => dashNormSimple(o.v) !== "POPULAR");
    }

    const selected = DASH_STATE.filters[key] || new Set();
    const optsHtml = ordered.map(o => {
      const dis = (o.c === 0) && (key !== "estadoCurso");
      const chk = selected.has(o.v) ? "checked" : "";
      return `
        <div class="slicer-opt ${dis ? "disabled" : ""}">
          <label title="${escHtml(o.v)}">
            <input type="checkbox" data-skey="${escHtml(key)}" data-sval="${escHtml(o.v)}" ${chk} ${dis ? "disabled" : ""}/>
            <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escHtml(o.v)}</span>
          </label>
          <span class="count">${fmtNum(o.c)}</span>
        </div>
      `;
    }).join("");

    // Búsqueda dentro del slicer (selección por Enter) para listas largas
    let searchHtml = "";
    if(key === "responsable" || key === "programa" || key === "municipio"){
      const dlId = "dl_" + key;
      const allForDl = (dashAllValuesForKey(key) || []).slice()
        .sort((a,b)=> String(a).localeCompare(String(b), "es"));
      const dlOptions = allForDl.map(v => `<option value="${escHtml(String(v))}"></option>`).join("");
      const ico = `<span aria-hidden="true" class="icon"><svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path></svg></span>`;
      searchHtml = `
        <div class="slicer-search">
          ${ico}
          <input type="search" list="${escHtml(dlId)}" placeholder="Buscar y presionar Enter…" autocomplete="off"
                 data-ssearch="1" data-skey="${escHtml(key)}" />
        </div>
        <datalist id="${escHtml(dlId)}">${dlOptions}</datalist>
      `;
    }


    const head = showHead ? `
      <div class="slicer-head">
        <div class="slicer-head-left">
          ${dashSlicerIconHtml(key)}
          <div class="slicer-title">${escHtml(dim.label)}</div>
        </div>
        <div class="slicer-tools">
          <button type="button" data-sact="all" data-skey="${escHtml(key)}">Todo</button>
          <button type="button" data-sact="none" data-skey="${escHtml(key)}">Nada</button>
        </div>
      </div>
    ` : '';

    return `
      <div class="slicer" id="slicer_${escHtml(key)}">
        ${head}
        <div class="slicer-body">${searchHtml}<div class="slicer-options">${optsHtml}</div></div>
      </div>
    `;
  };

  const makeSearchOnlySlicer = (dim) => {
    const key = dim.key;
    const allVals = dashAllValuesForKey(key);
    const selected = DASH_STATE.filters[key] || new Set();
    const dlId = "dl_" + key;

    const options = (allVals || []).slice().sort((a,b)=> String(a).localeCompare(String(b), "es"))
      .map(v => `<option value="${escHtml(String(v))}"></option>`).join("");

    const chips = Array.from(selected).map(v => {
      return `<div class="slicer-chip" title="${escHtml(String(v))}"><span>${escHtml(String(v))}</span><button type="button" data-srm="1" data-skey="${escHtml(key)}" data-sval="${escHtml(String(v))}">×</button></div>`;
    }).join("");

    return `
      <div class="slicer" id="slicer_${escHtml(key)}">
        <div class="slicer-head">
          <div class="slicer-head-left">
            ${dashSlicerIconHtml(key)}
            <div class="slicer-title">${escHtml(dim.label)}</div>
          </div>
          <div class="slicer-tools">
            <button type="button" data-sact="none" data-skey="${escHtml(key)}">Nada</button>
          </div>
        </div>
        <div class="slicer-body">
          <input class="slicer-search" type="search" list="${escHtml(dlId)}" placeholder="Buscar y presionar Enter…" data-ssearch="1" data-skey="${escHtml(key)}" />
          <datalist id="${escHtml(dlId)}">${options}</datalist>
          <div class="slicer-selected">${chips}</div>
        </div>
      </div>
    `;
  };


  const makeFastButtonSlicer = (dim) => {
    const key = dim.key;
    const ctx = dashGetFilteredRows(key); // excluye su propio filtro para permitir multi desde botones
    const counts = {};
    (ctx || []).forEach(r => {
      const v = dim.get(r);
      if(String(v||"").trim() === "") return;
      counts[v] = (counts[v] || 0) + 1;
    });

    let ordered;
    if(key === "estado"){
      ordered = DASH_ETAPA_FICHA_ALLOWED.map(v => ({v, c: counts[v] || 0}));
    }else if(key === "estadoCurso"){
      ordered = DASH_ESTADO_CURSO_ALLOWED.map(v => ({v, c: counts[v] || 0}));
    }else if(key === "modalidad"){
      ordered = DASH_MODALIDAD_ALLOWED.map(v => ({v, c: counts[v] || 0}));
    }else{
      const allVals = dashAllValuesForKey(key);
      ordered = (allVals || [])
        .map(v => ({v, c: counts[v] || 0}))
        .sort((a,b)=> (b.c - a.c) || String(a.v).localeCompare(String(b.v), "es"));
    }

    // Exclusiones solicitadas
    if(key === "nivel"){
      ordered = ordered.filter(o => dashNormSimple(o.v) !== "OTRO");
    }
    if(key === "programaEspecial"){
      ordered = ordered.filter(o => dashNormSimple(o.v) !== "POPULAR");
    }

    const selected = DASH_STATE.filters[key] || new Set();

    const btns = ordered.map(o => {
      const dis = (o.c === 0) && (key !== "estadoCurso");
      const active = selected.has(o.v);
      return `<button type="button" class="fast-btn ${active ? "active" : ""}" data-fkey="${escHtml(key)}" data-fval="${escHtml(o.v)}" ${dis ? "disabled" : ""} title="${escHtml(o.v)}"><span class="lbl">${escHtml(o.v)}</span><span class="cnt">${fmtNum(o.c)}</span></button>`;
    }).join("");

    return `
      <div class="fast-slicer" id="fast_${escHtml(key)}">
        <div class="fast-head">
          <div class="fast-title">${escHtml(dim.label)}</div>
          <div class="fast-tools">
            <button type="button" data-fact="all" data-fkey="${escHtml(key)}">Todo</button>
            <button type="button" data-fact="none" data-fkey="${escHtml(key)}">Nada</button>
          </div>
        </div>
        <div class="fast-btns">${btns}</div>
      </div>
    `;
  };

  const dimByKey = (k) => DASH_DIMS.find(d => d.key === k);

  // Segmentaciones (orden fijo)
  const slicerOrder = [
    "responsable",
    "programa",
    "municipio"
  ];
  const slicerDims = slicerOrder.map(dimByKey).filter(Boolean);

  leftWrap.innerHTML = slicerDims.map(d => makeChecklistSlicer(d, true)).join("");

  if(btnWrap){
    const fastOrder = ["estadoCurso","nivel","estado","modalidad","programaEspecial","tipo"];
    const fastDims = fastOrder.map(dimByKey).filter(Boolean);
    btnWrap.innerHTML = fastDims.map(d => makeFastButtonSlicer(d)).join("");

    // Bind fast buttons (multi-select)
    btnWrap.querySelectorAll('button.fast-btn[data-fkey][data-fval]').forEach(b => {
      b.addEventListener('click', () => {
        const key = b.getAttribute('data-fkey');
        const val = b.getAttribute('data-fval');
        if(!key) return;
        dashToggleFilter(key, val);
      });
    });

    // Bind fast actions (Todo / Nada)
    btnWrap.querySelectorAll('button[data-fact][data-fkey]').forEach(b => {
      b.addEventListener('click', () => {
        const act = b.getAttribute('data-fact');
        const key = b.getAttribute('data-fkey');
        if(!key) return;

        if(act === "none"){
          DASH_STATE.filters[key] = new Set();
        }else if(act === "all"){
          let vals = dashAllValuesForKey(key) || [];
          // Exclusiones solicitadas (consistente con la UI)
          if(key === "nivel") vals = vals.filter(v => dashNormSimple(v) !== "OTRO");
          if(key === "programaEspecial") vals = vals.filter(v => dashNormSimple(v) !== "POPULAR");
          DASH_STATE.filters[key] = new Set(vals);
        }else{
          return;
        }

        DASH_STATE.critPage = 1;
        DASH_STATE.muniPage = 1;
        dashOnFiltersChanged();
      });
    });
  }


  // Bind checkbox
  document.querySelectorAll('input[type="checkbox"][data-skey][data-sval]').forEach(chk => {
    chk.addEventListener('change', () => {
      const key = chk.getAttribute('data-skey');
      const val = chk.getAttribute('data-sval');
      if(!key) return;
      if(!DASH_STATE.filters[key]) DASH_STATE.filters[key] = new Set();
      if(chk.checked) DASH_STATE.filters[key].add(val);
      else DASH_STATE.filters[key].delete(val);
      dashOnFiltersChanged();
    });
  });

  // Bind Todo/Nada
  document.querySelectorAll('button[data-sact][data-skey]').forEach(btn => {
    btn.addEventListener('click', () => {
      const act = btn.getAttribute('data-sact');
      const key = btn.getAttribute('data-skey');
      if(!key) return;
      if(act === 'all'){
        DASH_STATE.filters[key] = new Set(dashAllValuesForKey(key));
      }else if(act === 'none'){
        DASH_STATE.filters[key] = new Set();
      }
      dashOnFiltersChanged();
    });
  });

  // Bind search-only add (Enter)
  document.querySelectorAll('input[data-ssearch="1"][data-skey]').forEach(inp => {
    inp.addEventListener('keydown', (e) => {
      if(e.key !== 'Enter') return;
      e.preventDefault();
      const key = inp.getAttribute('data-skey');
      const raw = (inp.value || '').trim();
      if(!key || !raw) return;
      const all = dashAllValuesForKey(key) || [];
      const match = all.find(v => dashNormSimple(v) === dashNormSimple(raw));
      if(!match) return;
      if(!DASH_STATE.filters[key]) DASH_STATE.filters[key] = new Set();
      DASH_STATE.filters[key].add(String(match));
      inp.value = '';
      dashOnFiltersChanged();
    });
  });

  // Bind chip remove
  document.querySelectorAll('button[data-srm="1"][data-skey][data-sval]').forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.getAttribute('data-skey');
      const val = btn.getAttribute('data-sval');
      if(!key) return;
      if(DASH_STATE.filters[key]) DASH_STATE.filters[key].delete(val);
      dashOnFiltersChanged();
    });
  });
}


function dashChartDataTop(rows, getter, metricFn, topN){
  const map = {};
  rows.forEach(r => {
    const k = getter(r);
    if(!k) return;
    map[k] = (map[k] || 0) + metricFn(r);
  });
  const arr = Object.keys(map).map(k => ({k, v: map[k]})).sort((a,b)=> b.v - a.v);
  const top = arr.slice(0, topN || 10);
  return { labels: top.map(x=>x.k), values: top.map(x=>x.v) };
}


function dashEnsureSelectedInChart(key, chartData, rowsNoSelf, getter, metricFn){
  try{
    if(!chartData) return;
    const sel = (DASH_STATE && DASH_STATE.filters && DASH_STATE.filters[key]) ? DASH_STATE.filters[key] : null;
    if(!sel || sel.size === 0) return;

    const labels = chartData.labels || (chartData.labels = []);
    const values = chartData.values || (chartData.values = []);
    const present = new Set(labels);

    // Agregación (mismo criterio de la gráfica)
    const agg = {};
    (rowsNoSelf || []).forEach(r => {
      const k = getter(r);
      if(!k) return;
      agg[k] = (agg[k] || 0) + metricFn(r);
    });

    Array.from(sel).forEach(v => {
      if(present.has(v)) return;
      labels.push(v);
      values.push(agg[v] || 0);
      present.add(v);
    });
  }catch(e){}
}




// =========================
// Dashboard: Tabla Aprendices (DF-03) según filtros
// Un registro por aprendiz por ficha (puede repetirse si tomó varios cursos)
// =========================
let DASH_APR_SEARCH_Q = "";
let DASH_APR_SORT = { key:"", dir:"" }; // asc|desc

function dashGetAprRowsFromDF03(filteredRows){
  const out = [];
  if(!DF03_STATE || !DF03_STATE.loaded || !DF03_STATE.fichasMap) return out;

  const baseRef = filteredRows || [];
  try{
    if(!DASH_STATE._aprRowsCache) DASH_STATE._aprRowsCache = new WeakMap();
    const rev = DF03_STATE._rev || 0;
    const cached = DASH_STATE._aprRowsCache.get(baseRef);
    if(cached && cached.rev === rev) return cached.rows;
  }catch(e){}

  // En un solo paso: ficha -> programa, y set de fichas
  const programaByFicha = new Map();
  const fichasSet = new Set();
  for(const r of baseRef){
    const f = normalizeFicha((r && r.ficha) ? r.ficha : "");
    if(!f) continue;
    fichasSet.add(f);
    const p = (r && r.programa) ? String(r.programa).trim() : "";
    if(p && !programaByFicha.has(f)) programaByFicha.set(f, p);
  }

  for(const ficha of fichasSet){
    const agg = DF03_STATE.fichasMap.get(ficha);
    if(!agg || !agg.apr) continue;
    const programa = programaByFicha.get(ficha) || "";
    for(const a of agg.apr.values()){
      const td = a.tipoDoc || "";
      const doc = a.doc || "";
      const nombre = [a.nombre || "", a.apellidos || ""].filter(Boolean).join(" ").trim();
      const tel = (a.telPrincipal || a.telMovil || "").toString().trim();
      const aprob = Number(a.aprobado || 0);
      const pend = Number(a.pendiente || 0);
      const noap = Number(a.noAprobado || 0);
      const total = aprob + pend + noap;

      const row = { td, ficha, doc, nombre, programa, tel, aprob, pend, noap, total };
      // haystack precalculado para búsqueda en tabla
      row.__hay = `${td} ${ficha} ${doc} ${nombre} ${programa} ${tel}`.toLowerCase();
      out.push(row);
    }
  }

  try{
    const rev = DF03_STATE._rev || 0;
    if(DASH_STATE._aprRowsCache) DASH_STATE._aprRowsCache.set(baseRef, {rev, rows: out});
  }catch(e){}

  return out;
}

function dashRenderAprendicesDF03(filteredRows){
  const card = document.getElementById("dashAprDF03Card");
  const tbl = document.getElementById("dashAprDF03Table");
  const tbody = tbl ? tbl.querySelector("tbody") : null;
  const empty = document.getElementById("dashAprDF03Empty");
  if(!card || !tbl || !tbody) return;

  const enabled = !!(DF03_STATE && DF03_STATE.loaded);
  card.style.display = enabled ? "block" : "none";
  if(!enabled) return;

  const rows = dashGetAprRowsFromDF03(filteredRows);
  const q = (DASH_APR_SEARCH_Q || "").trim().toLowerCase();
  let filtered = q ? rows.filter(r => {
    const hay = (r.__hay || "");
    return hay.includes(q);
  }) : rows;

  // Orden: por defecto (como venía). Si el usuario hace clic en un encabezado, ordenar A-Z / Z-A.
  const sk = (DASH_APR_SORT && DASH_APR_SORT.key) ? String(DASH_APR_SORT.key) : "";
  const sd = (DASH_APR_SORT && DASH_APR_SORT.dir) ? String(DASH_APR_SORT.dir) : "";
  const sortEnabled = !!sk;
const df03Rev = (DF03_STATE && DF03_STATE._rev) ? DF03_STATE._rev : 0;
  const dashRev = (DASH_STATE && DASH_STATE._rev) ? DASH_STATE._rev : 0;
  const viewKey = `${df03Rev}|${dashRev}|${q}|${sk}|${sd}|${sortEnabled?1:0}`;

  let usedCache = false;
  if(DASH_STATE){
    const vc = DASH_STATE._aprViewCache;
    if(vc && vc.baseRef === filteredRows && vc.key === viewKey){
      filtered = vc.rows;
      usedCache = true;
    }
  }

  if(!usedCache){
  if(sortEnabled){
    const mult = (sd === "desc") ? -1 : 1;
    filtered.sort((a,b)=>{
      const va = a[sk];
      const vb = b[sk];
      const c = isNumKey(sk) ? ((Number(va)||0) - (Number(vb)||0)) : cmpSmart(va, vb);
      return mult * c || cmpText(a.nombre, b.nombre) || cmpSmart(a.doc, b.doc);
    });
  }else{
    filtered.sort((a,b)=> (b.total - a.total) || (b.pend - a.pend) || (b.aprob - a.aprob) || (b.noap - a.noap) || a.nombre.localeCompare(b.nombre, "es", {sensitivity:"base"}));
  }

    if(DASH_STATE){
      DASH_STATE._aprViewCache = { baseRef: filteredRows, key: viewKey, rows: filtered };
    }
  }



  const pageSize = (DASH_STATE && DASH_STATE.aprPageSize) ? DASH_STATE.aprPageSize : 15;
  const totalRows = filtered.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
  const currPage = (DASH_STATE && DASH_STATE.aprPage) ? DASH_STATE.aprPage : 1;
  const p = Math.min(Math.max(1, currPage), totalPages);
  if(DASH_STATE) DASH_STATE.aprPage = p;

  const startIdx = (p - 1) * pageSize;
  const pageRows = filtered.slice(startIdx, startIdx + pageSize);

  tbody.innerHTML = pageRows.map((r, i) => {
    const rowNo = startIdx + i + 1;
    const telNorm = (typeof normalizePhone === "function") ? normalizePhone(r.tel) : (String(r.tel||"").replace(/\D/g,""));
    const waHref = telNorm ? `https://wa.me/${telNorm}` : "";
    const waBtn = waHref ? `
      <a class="dash-apr-wa" href="${waHref}" target="_blank" rel="noopener" title="Abrir WhatsApp">
        <svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M19.11 17.43c-.28-.14-1.66-.82-1.92-.91-.26-.1-.45-.14-.64.14-.19.28-.73.91-.89 1.1-.16.19-.33.21-.61.07-.28-.14-1.19-.44-2.27-1.4-.84-.75-1.41-1.68-1.57-1.96-.16-.28-.02-.43.12-.57.12-.12.28-.33.42-.49.14-.16.19-.28.28-.47.09-.19.05-.35-.02-.49-.07-.14-.64-1.54-.88-2.11-.23-.55-.47-.47-.64-.48l-.55-.01c-.19 0-.49.07-.75.35-.26.28-.98.96-.98 2.34s1.01 2.72 1.15 2.91c.14.19 1.99 3.04 4.82 4.26.67.29 1.19.46 1.59.59.67.21 1.28.18 1.76.11.54-.08 1.66-.68 1.9-1.34.23-.66.23-1.23.16-1.34-.07-.12-.26-.19-.54-.33zM16 3C8.83 3 3 8.83 3 16c0 2.53.74 4.89 2.02 6.88L3.69 29 10 27.34A12.93 12.93 0 0 0 16 29c7.17 0 13-5.83 13-13S23.17 3 16 3zm0 23.5c-2.18 0-4.2-.64-5.91-1.74l-.42-.26-3.74.98.99-3.64-.27-.45A10.43 10.43 0 0 1 5.5 16C5.5 10.21 10.21 5.5 16 5.5S26.5 10.21 26.5 16 21.79 26.5 16 26.5z"/></svg>
      </a>` : '';

    const telCell = `
      <span class="dash-apr-phone">
        ${waBtn}
        <span>${escapeHtml(r.tel || "")}</span>
      </span>`;

    return `
      <tr data-ficha="${escapeHtml(r.ficha)}">
        <td class="num">${rowNo}</td>
        <td>${escapeHtml(r.td)}</td>
        <td>${escapeHtml(r.ficha)}</td>
        <td>${escapeHtml(r.doc)}</td>
        <td>${escapeHtml(r.nombre)}</td>
        <td title="${escapeHtml(r.programa||"")}">${escapeHtml(r.programa||"")}</td>
        <td>${telCell}</td>
        <td class="num">${fmtNum(r.aprob)}</td>
        <td class="num">${fmtNum(r.pend)}</td>
        <td class="num">${fmtNum(r.noap)}</td>
        <td class="num"><b>${fmtNum(r.total)}</b></td>
      </tr>`;
  }).join("");

  const has = filtered.length > 0;
  if(empty) empty.style.display = has ? "none" : "block";

  dashRenderAprPager(totalRows, p, pageSize);
  dashUpdateAprSortUI();
}

function dashUpdateAprSortUI(){
  const ths = document.querySelectorAll('#dashAprDF03Table thead th.sortable');
  const sk = (DASH_APR_SORT && DASH_APR_SORT.key) ? String(DASH_APR_SORT.key) : '';
  const sd = (DASH_APR_SORT && DASH_APR_SORT.dir) ? String(DASH_APR_SORT.dir) : '';
  ths.forEach(th => {
    const k = th.getAttribute('data-key') || '';
    const ind = th.querySelector('.sort-ind');
    if(!ind) return;
    if(sk && k === sk){
      ind.textContent = (sd === 'desc') ? '▼' : '▲';
      th.classList.add('sort-active');
    }else{
      ind.textContent = '';
      th.classList.remove('sort-active');
    }
  });
}


function dashBindAprDF03UI(){
  if(window.__dashAprDF03Bound) return;
  window.__dashAprDF03Bound = true;

  const inp = document.getElementById("dashAprSearch");
  if(inp){
    const onAprSearch = debounce(() => {
      DASH_APR_SEARCH_Q = inp.value || "";
      if(DASH_STATE) DASH_STATE.aprPage = 1;
      // Solo re-renderiza la tabla (usa cache del dashboard)
      dashRenderAprendicesDF03(dashGetFilteredRows());
    }, 120);
    inp.addEventListener("input", onAprSearch);
  }


  // Ordenar A-Z / Z-A desde encabezados (solo 1 criterio a la vez)
  const ths = document.querySelectorAll("#dashAprDF03Table thead th.sortable");
  ths.forEach(th => {
    th.addEventListener("click", () => {
      const key = th.getAttribute("data-key") || "";
      if(!key) return;

      if(!DASH_APR_SORT) DASH_APR_SORT = { key:"", dir:"" };
      if(DASH_APR_SORT.key === key){
        DASH_APR_SORT.dir = (DASH_APR_SORT.dir === "asc") ? "desc" : "asc";
      }else{
        DASH_APR_SORT.key = key;
        DASH_APR_SORT.dir = "asc";
      }

      if(DASH_STATE) DASH_STATE.aprPage = 1;
      dashRenderAprendicesDF03(dashGetFilteredRows());
    });
  });


  const btn = document.getElementById("dashAprExportBtn");
  if(btn){
    btn.addEventListener("click", () => {
      try{
        if(!DF03_STATE || !DF03_STATE.loaded) return;
        const rows = dashGetAprRowsFromDF03(dashGetFilteredRows());
        const q = (DASH_APR_SEARCH_Q || "").trim().toLowerCase();
        const filtered = q ? rows.filter(r => (`${r.td} ${r.ficha} ${r.doc} ${r.nombre} ${r.programa||""} ${r.tel}`).toLowerCase().includes(q)) : rows;
        const data = [
          ["#","TD","FICHA","NUMERO_DOCUMENTO","NOMBRE APRENDIZ","PROGRAMA","TEL_PRINCIPAL","APROBADO","PENDIENTE POR EVALUAR","NO APROBADO","Total general"],
          ...filtered.map((r,i)=> [i+1, r.td, r.ficha, r.doc, r.nombre, r.programa||"", r.tel, r.aprob, r.pend, r.noap, r.total])
        ];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Aprendices_DF03");
        XLSX.writeFile(wb, `Aprendices_DF03_${new Date().toISOString().slice(0,10)}.xlsx`);
      }catch(e){
        console.error(e);
        alert('No fue posible exportar.');
      }
    });
  }
}
function dashRenderCharts(rows){
  // Las gráficas deben reaccionar a TODAS las segmentaciones (incluida su propia dimensión).
  // Estrategia:
  //  - Etiquetas (labels): se calculan con filas "sin su propio filtro" para mantener categorías visibles.
  //  - Valores: se calculan con filas "totalmente filtradas" para reflejar la selección aplicada.
  const rowsFull = rows || [];

  const aggMap = (arr, getter, metricFn) => {
    const m = Object.create(null);
    (arr || []).forEach(r => {
      const k = getter(r);
      if(!k) return;
      m[k] = (m[k] || 0) + (metricFn(r) || 0);
    });
    return m;
  };

  const valuesFor = (m, labels) => (labels || []).map(l => m[l] || 0);

  const ensureSelectedLabels = (key, labels) => {
    try{
      const sel = (DASH_STATE && DASH_STATE.filters && DASH_STATE.filters[key]) ? DASH_STATE.filters[key] : null;
      if(!sel || sel.size === 0) return;
      const present = new Set(labels || []);
      for(const v of sel){
        if(present.has(v)) continue;
        labels.push(v);
        present.add(v);
      }
    }catch(e){}
  };

  // Estado Curso (fichas)
  const ctxEstadoCurso = dashGetFilteredRows("estadoCurso");
  const getEstadoCurso = (r) => dashEstadoCursoValue(r?.estado);
  const byEstadoCurso = dashChartDataTop(ctxEstadoCurso, getEstadoCurso, (r) => 1, 12);
  ensureSelectedLabels("estadoCurso", byEstadoCurso.labels);
  byEstadoCurso.values = valuesFor(aggMap(rowsFull, getEstadoCurso, (r)=>1), byEstadoCurso.labels);
  dashUpsertChart("estadoCurso", "dashChartEstado", "bar", byEstadoCurso.labels, byEstadoCurso.values, (label) => {
    dashToggleSingleFilter("estadoCurso", label);
  }, { horizontal:true, theme:"green" });

  // Nivel (fichas)
  const ctxNivel = dashGetFilteredRows("nivel");
  const getNivel = (r) => dashNivelValue(r?.nivel);
  const byNivel = dashChartDataTop(ctxNivel, getNivel, (r) => 1, 12);
  ensureSelectedLabels("nivel", byNivel.labels);
  byNivel.values = valuesFor(aggMap(rowsFull, getNivel, (r)=>1), byNivel.labels);
  dashUpsertChart("nivel", "dashChartNivel", "bar", byNivel.labels, byNivel.values, (label) => {
    dashToggleSingleFilter("nivel", label);
  }, { horizontal:true, theme:"green" });

  // Etapa ficha (fichas)
  const ctxEtapa = dashGetFilteredRows("estado");
  const getEtapa = (r) => dashEtapaFichaValue(r?.etapa);
  const byEtapa = dashChartDataTop(ctxEtapa, getEtapa, (r) => 1, 12);
  ensureSelectedLabels("estado", byEtapa.labels);
  byEtapa.values = valuesFor(aggMap(rowsFull, getEtapa, (r)=>1), byEtapa.labels);
  dashUpsertChart("estado", "dashChartEtapa", "bar", byEtapa.labels, byEtapa.values, (label) => {
    dashToggleSingleFilter("estado", label);
  }, { horizontal:true, theme:"green" });

  // Modalidad (fichas) - etiquetas fijas (3)
  const getModalidad = (r) => dashModalidadValue(r?.modalidad);
  const modLabels = [...DASH_MODALIDAD_ALLOWED];
  const modAgg = aggMap(rowsFull, getModalidad, (r)=>1);
  const modValues = modLabels.map(l => modAgg[l] || 0);
  dashUpsertChart("modalidad", "dashChartModalidad", "bar", modLabels, modValues, (label) => {
    dashToggleSingleFilter("modalidad", label);
  }, { legend:true, horizontal:true, theme:"green" });

  // Programa especial (fichas)
  const ctxProgEsp = dashGetFilteredRows("programaEspecial");
  const getProgEsp = (r) => dashProgEspValue(r?.programaEspecial);
  const byProgEsp = dashChartDataTop(ctxProgEsp, getProgEsp, (r) => 1, 12);
  ensureSelectedLabels("programaEspecial", byProgEsp.labels);
  byProgEsp.values = valuesFor(aggMap(rowsFull, getProgEsp, (r)=>1), byProgEsp.labels);
  dashUpsertChart("programaEspecial", "dashChartProgEsp", "bar", byProgEsp.labels, byProgEsp.values, (label) => {
    dashToggleSingleFilter("programaEspecial", label);
  }, { horizontal:true, theme:"green" });

  // Tipo (fichas)
  const ctxTipo = dashGetFilteredRows("tipo");
  const getTipo = (r) => dashTipoValue(r?.tipo);
  const byTipo = dashChartDataTop(ctxTipo, getTipo, (r) => 1, 12);
  ensureSelectedLabels("tipo", byTipo.labels);
  byTipo.values = valuesFor(aggMap(rowsFull, getTipo, (r)=>1), byTipo.labels);
  dashUpsertChart("tipo", "dashChartTipo", "bar", byTipo.labels, byTipo.values, (label) => {
    dashToggleSingleFilter("tipo", label);
  }, { horizontal:true, theme:"green" });

  // Mapa de municipios (tile-map)
  dashRenderMunicipioMap(rowsFull);

  // Top Programas (matriculados)
  const ctxPrograma = dashGetFilteredRows("programa");
  const getPrograma = (r) => dashStr(r?.programa, "(Sin programa)");
  const metPrograma = (r) => Number(r?.matriculados)||0;
  const byPrograma = dashChartDataTop(ctxPrograma, getPrograma, metPrograma, 12);
  ensureSelectedLabels("programa", byPrograma.labels);
  byPrograma.values = valuesFor(aggMap(rowsFull, getPrograma, metPrograma), byPrograma.labels);
  dashUpsertChart("programa", "dashChartPrograma", "bar", byPrograma.labels, byPrograma.values, (label) => {
    dashToggleSingleFilter("programa", label);
  }, { horizontal:true });

  // Tendencia de inicio (fichas por mes)
  const tmap = {};
  (rowsFull || []).forEach(r => {
    const raw = (r?.fechaInicioRaw || r?.fechaInicio);
    const dt = raw ? new Date(raw) : null;
    if(!dt || isNaN(dt.getTime())) return;
    const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;
    tmap[k] = (tmap[k] || 0) + 1;
  });
  const keys = Object.keys(tmap).sort();
  const values = keys.map(k => tmap[k]);
  dashUpsertChart("inicio", "dashChartInicio", "line", keys, values, null, { legend:false });
}



function dashRenderDonutSVG(containerEl, labels, values, onLabelClick, opt){
  // Fallback sin Chart.js: donut SVG interactivo
  if(!containerEl) return;
  const total = (values || []).reduce((a,v)=> a + (Number(v)||0), 0);
  containerEl.innerHTML = "";
  if(!total){
    const msg = document.createElement("div");
    msg.style.opacity = ".7";
    msg.style.fontSize = "12px";
    msg.textContent = "Sin datos para graficar.";
    containerEl.appendChild(msg);
    return;
  }

  const pal = ["#065f46","#0f766e","#15803d","#16a34a","#22c55e","#4ade80","#86efac","#bbf7d0","#047857","#10b981","#34d399"];
  const W = 360, H = 260;
  const cx = W/2, cy = H/2;
  const R = 105, r = 62;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
  svg.setAttribute("width","100%");
  svg.setAttribute("height","260");
  svg.style.display = "block";

  function polarToCartesian(cx, cy, radius, angleRad){
    return {
      x: cx + radius * Math.cos(angleRad),
      y: cy + radius * Math.sin(angleRad)
    };
  }

  function arcPath(cx, cy, R, r, start, end){
    const p1 = polarToCartesian(cx, cy, R, start);
    const p2 = polarToCartesian(cx, cy, R, end);
    const p3 = polarToCartesian(cx, cy, r, end);
    const p4 = polarToCartesian(cx, cy, r, start);
    const large = (end - start) > Math.PI ? 1 : 0;
    // outer arc then inner arc (reverse)
    return [
      `M ${p1.x.toFixed(3)} ${p1.y.toFixed(3)}`,
      `A ${R} ${R} 0 ${large} 1 ${p2.x.toFixed(3)} ${p2.y.toFixed(3)}`,
      `L ${p3.x.toFixed(3)} ${p3.y.toFixed(3)}`,
      `A ${r} ${r} 0 ${large} 0 ${p4.x.toFixed(3)} ${p4.y.toFixed(3)}`,
      "Z"
    ].join(" ");
  }

  let angle = -Math.PI/2; // start at 12 o'clock
  for(let i=0;i<labels.length;i++){
    const v = Number(values[i])||0;
    if(v<=0) continue;
    const frac = v / total;
    const next = angle + frac * Math.PI * 2;

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", arcPath(cx, cy, R, r, angle, next));
    path.setAttribute("fill", pal[i % pal.length]);
    path.style.cursor = "pointer";
    path.style.opacity = "0.85";
    path.addEventListener("mouseenter", () => { path.style.opacity = "1"; });
    path.addEventListener("mouseleave", () => { path.style.opacity = "0.85"; });
    path.addEventListener("click", () => { if(typeof onLabelClick === "function") onLabelClick(labels[i]); });

    const title = document.createElementNS("http://www.w3.org/2000/svg","title");
    const p = Math.round(frac*10000)/100;
    title.textContent = `${labels[i]}: ${fmtNum(v)} (${p}%)`;
    path.appendChild(title);

    svg.appendChild(path);
    angle = next;
  }

  // Center label
  const center = document.createElementNS("http://www.w3.org/2000/svg","text");
  center.setAttribute("x", cx);
  center.setAttribute("y", cy);
  center.setAttribute("text-anchor","middle");
  center.setAttribute("dominant-baseline","middle");
  center.setAttribute("font-size","12");
  center.setAttribute("font-weight","700");
  center.setAttribute("fill","#0f172a");
  center.textContent = "Empresas";
  svg.appendChild(center);

  containerEl.appendChild(svg);
}


function dashHexWithAlpha(color, alphaHex){
  if(color === null || color === undefined) return color;
  const c = String(color).trim();
  // #RRGGBB
  if(/^#([0-9a-fA-F]{6})$/.test(c)) return c + alphaHex;
  // #RRGGBBAA
  if(/^#([0-9a-fA-F]{8})$/.test(c)) return c.slice(0,7) + alphaHex;
  return c;
}

function dashUpsertChart(key, canvasId, type, labels, values, onLabelClick, opt){
  const el = document.getElementById(canvasId);
  if(!el) return;

  const existing = DASH_STATE.charts[key];
  const horizontal = opt && opt.horizontal;

  const data = {
    labels: labels,
    datasets: [{
      label: "",
      data: values
    }]
  };

  // Tema de colores (tonos verdes) para gráficas del dashboard
  if(opt && opt.theme === "green" && (type === "bar" || type === "doughnut")) {
    const pal = ["#065f46","#0f766e","#15803d","#16a34a","#22c55e","#4ade80","#86efac","#bbf7d0","#047857","#10b981","#34d399"];
    const palBg = pal.map(c => c + "B3"); // ~70% alpha
    const n = (labels && labels.length) ? labels.length : (values ? values.length : 0);
    const bg = Array.from({length:n}, (_,i)=> palBg[i % palBg.length]);
    const bd = Array.from({length:n}, (_,i)=> pal[i % pal.length]);
    data.datasets[0].backgroundColor = bg;
    data.datasets[0].borderColor = bd;
    data.datasets[0].borderWidth = 1;
  }


  // Resaltar selección (cuando existe un filtro activo para este gráfico)
  if(opt && opt.filterKey && type === "doughnut"){
    try{
      const sel = (DASH_STATE && DASH_STATE.filters) ? DASH_STATE.filters[opt.filterKey] : null;
      if(sel && sel.size){
        const n = (labels && labels.length) ? labels.length : 0;
        let bg = data.datasets[0].backgroundColor;
        let bd = data.datasets[0].borderColor;

        const bgArr = Array.isArray(bg) ? bg.slice() : Array.from({length:n}, ()=> bg || "#16a34ab3");
        const bdArr = Array.isArray(bd) ? bd.slice() : Array.from({length:n}, ()=> bd || "#16a34a");

        const alphaOn = "E6"; // ~90%
        const alphaOff = "26"; // ~15%

        data.datasets[0].backgroundColor = bgArr.map((c, i) => {
          const lab = (labels && labels[i] !== undefined) ? labels[i] : "";
          const match = (typeof dashMatchValue === "function") ? (dashMatchValue(opt.filterKey, lab) || lab) : lab;
          const isSel = sel.has(match);
          return dashHexWithAlpha(c, isSel ? alphaOn : alphaOff);
        });

        data.datasets[0].borderColor = bdArr.map((c, i) => {
          const lab = (labels && labels[i] !== undefined) ? labels[i] : "";
          const match = (typeof dashMatchValue === "function") ? (dashMatchValue(opt.filterKey, lab) || lab) : lab;
          const isSel = sel.has(match);
          return isSel ? c : dashHexWithAlpha(c, "66");
        });

        data.datasets[0].borderWidth = Array.from({length:n}, (_, i) => {
          const lab = (labels && labels[i] !== undefined) ? labels[i] : "";
          const match = (typeof dashMatchValue === "function") ? (dashMatchValue(opt.filterKey, lab) || lab) : lab;
          return sel.has(match) ? 2 : 1;
        });
      }
    }catch(e){}
  }

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: !!(opt && opt.legend) }
    },
    scales: (type === "doughnut") ? {} : {
      x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
      y: { beginAtZero: true }
    },
    onClick: (evt, elements) => {
      if(!onLabelClick) return;
      if(!elements || elements.length === 0) return;
      const idx = elements[0].index;
      const label = (labels && labels[idx] !== undefined) ? labels[idx] : null;
      if(label !== null) onLabelClick(label);
    }
  };

  // Mostrar porcentajes en tooltips/leyenda para doughnut cuando se solicite
  if(opt && opt.percent && type === "doughnut"){
    const total = (values || []).reduce((a,v)=> a + (Number(v)||0), 0) || 1;

    options.plugins = options.plugins || {};
    options.plugins.tooltip = options.plugins.tooltip || {};
    options.plugins.tooltip.callbacks = {
      label: (ctx) => {
        const v = Number(ctx.raw)||0;
        const p = Math.round((v*10000)/total)/100; // 2 decimales
        const lbl = (ctx.label !== undefined && ctx.label !== null) ? String(ctx.label) : "";
        return `${lbl}: ${fmtNum(v)} (${p}%)`;
      }
    };

    // Leyenda con porcentaje
    options.plugins.legend = options.plugins.legend || { display:true };
    options.plugins.legend.display = true;
    options.plugins.legend.labels = options.plugins.legend.labels || {};
    options.plugins.legend.labels.generateLabels = (chart) => {
      const data = chart.data || {};
      const labs = data.labels || [];
      const vals = (data.datasets && data.datasets[0] && data.datasets[0].data) ? data.datasets[0].data : [];
      const t = vals.reduce((a,v)=> a + (Number(v)||0), 0) || 1;
      return labs.map((l, i) => {
        const v = Number(vals[i])||0;
        const p = Math.round((v*10000)/t)/100;
        return {
          text: `${l} (${p}%)`,
          fillStyle: chart.getDatasetMeta(0).data[i] ? chart.getDatasetMeta(0).data[i].options.backgroundColor : undefined,
          strokeStyle: chart.getDatasetMeta(0).data[i] ? chart.getDatasetMeta(0).data[i].options.borderColor : undefined,
          lineWidth: chart.getDatasetMeta(0).data[i] ? chart.getDatasetMeta(0).data[i].options.borderWidth : 0,
          hidden: isNaN(v) || chart.getDataVisibility(i) === false,
          index: i
        };
      });
    };
  }


  // Horizontal bars
  if(horizontal && type === "bar"){
    options.indexAxis = "y";
    options.scales = {
      x: { beginAtZero: true },
      y: { ticks: { autoSkip: true } }
    };
  }

  if(existing){
    existing.config.type = type;

    // Actualización robusta: mantener referencias de arrays (Chart.js)
    const lblArr = existing.data.labels || (existing.data.labels = []);
    lblArr.splice(0, lblArr.length, ...((labels || []).map(String)));

    if(!existing.data.datasets || !existing.data.datasets.length){
      existing.data.datasets = [{ label:"", data: [] }];
    }
    const d0 = existing.data.datasets[0];
    const datArr = d0.data || (d0.data = []);
    datArr.splice(0, datArr.length, ...((values || []).map(v => Number(v) || 0)));

    // Colores (si están definidos por tema)
    if(data && data.datasets && data.datasets[0]){
      if(data.datasets[0].backgroundColor !== undefined) d0.backgroundColor = data.datasets[0].backgroundColor;
      if(data.datasets[0].borderColor !== undefined) d0.borderColor = data.datasets[0].borderColor;
      if(data.datasets[0].borderWidth !== undefined) d0.borderWidth = data.datasets[0].borderWidth;
    }

    existing.options = options;
    existing.update();
    try{ if(type === 'doughnut') { existing.resize(); } }catch(e){}
    return;
  }

  try{
  DASH_STATE.charts[key] = new Chart(el.getContext("2d"), { type, data, options });
} catch(err){
  // Fallback: si Chart.js no está disponible o falla, renderiza SVG (solo doughnut)
  if(type === "doughnut"){
    const wrap = el.parentElement || el;
    try{
      el.style.display = "none";
      dashRenderDonutSVG(wrap, labels, values, onLabelClick, opt);
      return;
    }catch(e2){
      // no-op
    }
  }
  throw err;
}
}


function dashMetricDisplay(metric){
  switch(metric){
    case "fichas": return "Fichas";
    case "activos": return "Activos";
    case "novedades": return "Novedades";
    case "atrasadas": return "Fichas atrasadas";
    case "matriculados":
    default: return "Matriculados";
  }
}

function dashAggMetric(a, metric){
  if(!a) return 0;
  if(metric === "fichas") return a.fichas || 0;
  if(metric === "activos") return a.activos || 0;
  if(metric === "novedades") return a.novedades || 0;
  if(metric === "atrasadas") return a.atrasadas || 0;
  return a.matric || 0; // matriculados
}

function dashRenderMunicipioMap(rowsCtx){
  const wrap = document.getElementById("dashMapMunicipios");
  if(!wrap) return;

  const metric = (DASH_STATE.mapMetric || "matriculados");

  if(!window.__DASH_LEAFLET){
    window.__DASH_LEAFLET = { map:null, muniLayer:null, deptLayer:null, muniGeo:null, deptGeo:null, loading:false };
  }
  const S = window.__DASH_LEAFLET;

  // Tooltip propio (fallback) para asegurar hover visible aun si el tooltip de Leaflet no se muestra
  let __mapTip = document.getElementById("dashMapHoverTip");
  if(!__mapTip){
    __mapTip = document.createElement("div");
    __mapTip.id = "dashMapHoverTip";
    __mapTip.className = "dash-map-hover-tip";
    __mapTip.style.display = "none";
    // Importante: el contenedor del mapa debe ser relativo para posicionar el tooltip
    if(!wrap.style.position) wrap.style.position = "relative";
    wrap.appendChild(__mapTip);
  }
  function dashMapShowHover(ev, label, fichas){
    try{
      if(!__mapTip) return;
      const pt = (ev && ev.containerPoint) ? ev.containerPoint : null;
      if(!pt) return;
      __mapTip.innerHTML = escapeHtml(String(label||"")) + ", <b>" + fmtNum(Number(fichas)||0) + "</b> fichas";
      __mapTip.style.left = (pt.x + 12) + "px";
      __mapTip.style.top  = (pt.y + 12) + "px";
      __mapTip.style.display = "block";
    }catch(e){}
  }
  function dashMapHideHover(){ try{ if(__mapTip) __mapTip.style.display = "none"; }catch(e){} }


  function normPlace(s){
    let t = (s||"").toString().trim();
    if(!t) return "";
    t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").toUpperCase();

    // Equivalencias municipales (datos vs GeoJSON)
    // Ej: en datos puede venir "MARIQUITA" pero el GeoJSON suele traer "SAN SEBASTIAN DE MARIQUITA"
    if(t === "MARIQUITA") t = "SAN SEBASTIAN DE MARIQUITA";
    if(t === "SAN SEBASTIAN MARIQUITA") t = "SAN SEBASTIAN DE MARIQUITA";

    return t;
  }

  // Municipios conocidos (para no dibujar geometrías que nunca aparecen en los datos)
  const base = dashGetBaseRows();
  const muniSet = new Set(Array.from(PE04_MUNICIPIOS_MASTER || []));
  (base||[]).forEach(r => { const m = dashStr(r?.municipio, "").trim(); if(m) muniSet.add(m); });
  const muniNormSet = new Set(Array.from(muniSet).map(normPlace));

  // Agregación por municipio + departamento (evita homónimos: "SAN LUIS" en distintos dptos)
  const deptNormSet = new Set();
  const agg = {};
  (rowsCtx||[]).forEach(r => {
    const m = dashStr(r?.municipio, "");
    const d = dashStr(r?.departamentoCurso, "");
    const km = normPlace(m);
    const kd = normPlace(d);
    if(kd) deptNormSet.add(kd);
    if(!km) return;
    const k = km + "|" + (kd || "_");
    if(!agg[k]) agg[k] = {name:m, dept:d, fichas:0, matric:0, activos:0, novedades:0, atrasadas:0};
    const x = agg[k];
    x.name = m || x.name;
    x.dept = d || x.dept;
    x.fichas += 1;
    x.matric += (Number(r?.matriculados)||0);
    x.activos += (Number(r?.activos)||0);
    const nov = (Number(r?.condicionado)||0) + (Number(r?.aplazado)||0) + (Number(r?.cancelado)||0) + (Number(r?.retiro)||0);
    x.novedades += nov;
    x.atrasadas += ((Number(r?.diasAtraso)||0) > 0 ? 1 : 0);
  });

  const valOf = (k) => {
    const a = agg[k] || {};
    if(metric === "fichas") return a.fichas || 0;
    if(metric === "activos") return a.activos || 0;
    if(metric === "novedades") return a.novedades || 0;
    if(metric === "atrasadas") return a.atrasadas || 0;
    return a.matric || 0;
  };

  const posVals = Object.keys(agg).map(k => valOf(k)).filter(v => isFinite(v) && Number(v) > 0);
  const maxV = posVals.length ? Math.max(...posVals) : 0;
  const minV = posVals.length ? Math.min(...posVals) : 0;

  const MAP_GREEN_SCALE = {
  min: '#C3E5B2',
  mid: '#39a900',
  max: '#006E3C',
  levels: 15
};

function hexToRgb(hex){
  const h = String(hex||'').replace('#','').trim();
  const full = (h.length===3) ? (h[0]+h[0]+h[1]+h[1]+h[2]+h[2]) : h;
  if(full.length!==6) return [0,0,0];
  const n = parseInt(full, 16);
  return [(n>>16)&255, (n>>8)&255, n&255];
}
function clamp01(x){ return x<0?0:(x>1?1:x); }
function lerp(a,b,t){ return a + (b-a)*t; }

const __cMin = hexToRgb(MAP_GREEN_SCALE.min);
const __cMid = hexToRgb(MAP_GREEN_SCALE.mid);
const __cMax = hexToRgb(MAP_GREEN_SCALE.max);

// Escala discreta (>=15 tonos) con punto medio fijado al 50%
function colorScale(v){
  const nv = Number(v);
  if(!(nv > 0) || !isFinite(nv) || maxV <= 0) return '#ffffff';
  const t = (maxV === minV) ? 1 : clamp01((nv - minV) / (maxV - minV));

  const L = Math.max(15, Number(MAP_GREEN_SCALE.levels)||15);
  const tq = (L<=1) ? t : (Math.round(t*(L-1)) / (L-1)); // cuantizado

  let r,g,b;
  if(tq <= 0.5){
    const u = tq / 0.5;
    r = Math.round(lerp(__cMin[0], __cMid[0], u));
    g = Math.round(lerp(__cMin[1], __cMid[1], u));
    b = Math.round(lerp(__cMin[2], __cMid[2], u));
  }else{
    const u = (tq - 0.5) / 0.5;
    r = Math.round(lerp(__cMid[0], __cMax[0], u));
    g = Math.round(lerp(__cMid[1], __cMax[1], u));
    b = Math.round(lerp(__cMid[2], __cMax[2], u));
  }
  return "rgb("+r+","+g+","+b+")";
}

  const legend = document.getElementById("dashMapLegend");
  if(legend){
    legend.textContent = posVals.length ? ("Rango: " + fmtNum(minV) + " - " + fmtNum(maxV) + " (" + metric + ")") : ("Sin datos (" + metric + ")");
  }

  if(!S.map){
    S.map = L.map(wrap, { zoomControl:true, scrollWheelZoom:false, attributionControl:false });
    S.map.setView([4.5, -74.1], 5);
  }

  const muniUrl = 'https://raw.githubusercontent.com/caticoa3/colombia_mapa/master/co_2018_MGN_MPIO_POLITICO.geojson';
  const deptUrl = 'https://raw.githubusercontent.com/caticoa3/colombia_mapa/master/co_2018_MGN_DPTO_POLITICO.geojson';

  function pickProp(p, keys){
    for(const k of keys){ if(p && p[k] !== undefined && p[k] !== null) return p[k]; }
    return '';
  }

  function ensureLayers(){
    if(S.loading) return;
    if(S.muniGeo && S.deptGeo) return;
    S.loading = true;
    Promise.all([
      fetch(muniUrl).then(r=>r.json()).catch(()=>null),
      fetch(deptUrl).then(r=>r.json()).catch(()=>null)
    ]).then(([muniGeo, deptGeo]) => {
      S.muniGeo = muniGeo;
      S.deptGeo = deptGeo;
      S.loading = false;
      updateLayers();
    }).catch(() => { S.loading = false; });
  }

  function updateLayers(){
    if(!S.muniGeo || !S.muniGeo.features) return;

    const allowDepts = (deptNormSet && deptNormSet.size) ? deptNormSet : null;

    // 1) Municipios (filtrar por municipios presentes y por los dptos del contexto actual)
    let feats = (S.muniGeo.features||[]).filter(f => {
      const p = f.properties || {};
      const name = pickProp(p, ['mpio_cnmbr','MPIO_CNMBR','municipio','MUNICIPIO','name','NAME']);
      const k = normPlace(name);
      return muniNormSet.has(k);
    });

    if(allowDepts){
      feats = feats.filter(f => {
        const p = f.properties || {};
        const dept = pickProp(p, ['dpto_cnmbr','DPTO_CNMBR','departamento','DEPARTAMENTO']);
        return allowDepts.has(normPlace(dept));
      });
    }

    const fc = { type:'FeatureCollection', features: feats };

    if(S.muniLayer){ S.muniLayer.remove(); S.muniLayer = null; }
    S.muniLayer = L.geoJSON(fc, {
      interactive:true,
      style: (f) => {
        const p = f.properties || {};
        const name = pickProp(p, ['mpio_cnmbr','MPIO_CNMBR','municipio','MUNICIPIO','name','NAME']);
        const dept = pickProp(p, ['dpto_cnmbr','DPTO_CNMBR','departamento','DEPARTAMENTO']);
        const k = normPlace(name) + "|" + (normPlace(dept) || "_");
        const v = valOf(k);
        const has = (Number(v)||0) > 0;
        return { color:'#0f172a', weight:0.7, fillColor: has ? colorScale(v) : '#ffffff', fillOpacity: has ? 0.82 : 0.01 };
      },
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const name = pickProp(p, ['mpio_cnmbr','MPIO_CNMBR','municipio','MUNICIPIO','name','NAME']);
        const dept = pickProp(p, ['dpto_cnmbr','DPTO_CNMBR','departamento','DEPARTAMENTO']);
        const k = normPlace(name) + "|" + (normPlace(dept) || "_");
        const v = valOf(k);
        const label = String(name||'') + (dept ? (' ('+dept+')') : '');
        const fichasTip = (agg[k] && Number(agg[k].fichas)) ? Number(agg[k].fichas) : 0;
        const tip = '<b>' + escapeHtml(label) + '</b>, ' + fmtNum(fichasTip) + ' fichas';
        layer.bindTooltip(tip, {sticky:true, direction:'top', opacity:0.95});
        layer.on('mouseover', () => { try{ layer.openTooltip(); }catch(e){} });
        layer.on('mousemove', (ev) => { dashMapShowHover(ev, label, fichasTip); });
        layer.on('mouseout', () => { dashMapHideHover(); });
        layer.on('click', () => { if(name) dashToggleSingleFilter('municipio', dashMatchValue('municipio', String(name))); });
        // Asegurar eventos en todo el polígono (no solo en el borde)
        try{ const el = (layer.getElement && layer.getElement()) ? layer.getElement() : (layer._path||null); if(el) el.style.pointerEvents = 'all'; }catch(e){}

      }
    }).addTo(S.map);


    // 1b) Detalle por municipio (tabla debajo del mapa): Municipio + cantidad de fichas
    try{
      const tbl = document.getElementById("dashMapDetailTable");
      if(tbl){
        const tb = tbl.querySelector("tbody");
        if(tb){
          const rows = [];
          (feats||[]).forEach(f => {
            const p = f.properties || {};
            const name = pickProp(p, ['mpio_cnmbr','MPIO_CNMBR','municipio','MUNICIPIO','name','NAME']);
            const dept = pickProp(p, ['dpto_cnmbr','DPTO_CNMBR','departamento','DEPARTAMENTO']);
            const k = normPlace(name) + "|" + (normPlace(dept) || "_");
            const a = agg[k];
            const c = (a && Number(a.fichas)) ? Number(a.fichas) : 0;
            if(c > 0){
              const label = String(name||'') + (dept ? (' ('+dept+')') : '');
              rows.push({label, muni:String(name||''), fichas:c});
            }
          });
          rows.sort((a,b) => (b.fichas - a.fichas) || a.label.localeCompare(b.label, 'es', {sensitivity:'base'}));
          tb.innerHTML = rows.length
            ? rows.map(r => `<tr data-muni="${escapeHtml(r.muni)}"><td>${escapeHtml(r.label)}</td><td class="num">${fmtNum(r.fichas)}</td></tr>`).join("")
            : `<tr><td colspan="2" style="padding:10px;color:#64748b;">Sin datos para los filtros actuales</td></tr>`;
          // Click: filtra por Municipio (segmentación)
          tb.querySelectorAll("tr[data-muni]").forEach(tr => {
            tr.addEventListener("click", () => {
              const muni = tr.getAttribute("data-muni");
              if(muni) dashToggleSingleFilter("municipio", dashMatchValue("municipio", muni));
            });
          });
        }
      }
    }catch(e){}



    // 2) Límites departamentales (solo los dptos del contexto, para no mostrar todo el país)
    if(S.deptGeo && S.deptGeo.features){
      if(S.deptLayer){ S.deptLayer.remove(); S.deptLayer = null; }
      const deptFeats = (allowDepts)
        ? (S.deptGeo.features||[]).filter(f => {
            const p = f.properties || {};
            const d = pickProp(p, ['dpto_cnmbr','DPTO_CNMBR','departamento','DEPARTAMENTO','DPTO_NOMBRE','DPTO']);
            return allowDepts.has(normPlace(d));
          })
        : (S.deptGeo.features||[]);
      S.deptLayer = L.geoJSON({ type:'FeatureCollection', features: deptFeats }, {
        interactive:false,
        style: { color:'#111827', weight:1.2, fillOpacity:0 }
      }).addTo(S.map);
      try{ S.deptLayer.eachLayer(l=>{ const el = (l.getElement&&l.getElement()) ? l.getElement() : (l._path||null); if(el) el.style.pointerEvents = 'none'; }); }catch(e){};
    }

    // 3) Zoom a la región activa
    try{
      const b = S.muniLayer.getBounds();
      if(b && b.isValid()) S.map.fitBounds(b.pad(0.06));
    }catch(e){}
  }

  if(S.muniGeo) updateLayers();
  else ensureLayers();
}



/* =========================================================
   DASHBOARD: ORDENAMIENTO (Fichas críticas - Top 25)
   - Click en encabezado para ordenar A-Z / Z-A
   ========================================================= */
function dashParseSortableNumber(v){
  if(v == null) return NaN;
  let s = String(v).trim();
  if(!s) return NaN;
  // Mantener signos y separadores, eliminar resto
  s = s.replace(/\s/g,"").replace(/[^0-9.,-]/g,"");
  // es-CO: miles '.' y decimales ','
  if(s.includes(".") && s.includes(",")){
    s = s.replace(/\./g,"").replace(/,/g,".");
  }else if(s.includes(",") && !s.includes(".")){
    s = s.replace(/,/g,".");
  }else{
    const dots = (s.match(/\./g)||[]).length;
    if(dots > 1) s = s.replace(/\./g,"");
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

function dashUpdateCritSortIndicators(){
  const tbl = document.getElementById("dashTblCrit");
  if(!tbl) return;
  const ths = Array.from(tbl.querySelectorAll("thead th"));
  const st = (DASH_STATE && DASH_STATE.critSort) ? DASH_STATE.critSort : null;
  ths.forEach((th, i) => {
    th.classList.add("crit-sortable");
    if(st && st.idx === i){
      th.classList.add("sorted");
      th.setAttribute("data-sort-dir", st.dir);
    }else{
      th.classList.remove("sorted");
      th.removeAttribute("data-sort-dir");
    }
  });
}

function dashUpdateMuniSortIndicators(){
  const tbl = document.getElementById("dashTblMunicipio");
  if(!tbl) return;
  const ths = Array.from(tbl.querySelectorAll("thead th"));
  const st = (DASH_STATE && DASH_STATE.muniSort) ? DASH_STATE.muniSort : null;
  ths.forEach((th, i) => {
    th.classList.add("muni-sortable");
    if(st && st.idx === i){
      th.classList.add("sorted");
      th.setAttribute("data-sort-dir", st.dir);
    }else{
      th.classList.remove("sorted");
      th.removeAttribute("data-sort-dir");
    }
  });
}

function dashInitMuniSortUI(){
  const tbl = document.getElementById("dashTblMunicipio");
  if(!tbl) return;

  // Evitar re-binding
  if(tbl.dataset && tbl.dataset.sortInit === "1") return;
  if(tbl.dataset) tbl.dataset.sortInit = "1";

  const ths = Array.from(tbl.querySelectorAll("thead th"));
  ths.forEach((th, idx) => {
    th.classList.add("muni-sortable");
    th.addEventListener("click", () => {
      if(!DASH_STATE.muniSort) DASH_STATE.muniSort = { idx, dir:"asc" };
      const st = DASH_STATE.muniSort;
      if(st.idx === idx){
        st.dir = (st.dir === "asc") ? "desc" : "asc";
      }else{
        st.idx = idx;
        st.dir = "asc";
      }
      DASH_STATE.muniPage = 1;
      dashUpdateMuniSortIndicators();
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  });

  dashUpdateMuniSortIndicators();
}


function dashSortCritTable(){
  // Ordenamiento se aplica sobre el dataset (antes de paginar), no sobre el DOM.
  dashUpdateCritSortIndicators();
}

function dashApplyCritSort(){
  // Compat: en versiones anteriores se reordenaba el DOM.
  dashUpdateCritSortIndicators();
}

function dashInitCritSortUI(){
  const tbl = document.getElementById("dashTblCrit");
  if(!tbl) return;

  // Evitar re-binding
  if(tbl.dataset && tbl.dataset.sortInit === "1") return;
  if(tbl.dataset) tbl.dataset.sortInit = "1";

  const ths = Array.from(tbl.querySelectorAll("thead th"));
  ths.forEach((th, idx) => {
    th.classList.add("crit-sortable");
    th.addEventListener("click", () => {
      if(!DASH_STATE.critSort) DASH_STATE.critSort = { idx, dir:"asc" };
      const st = DASH_STATE.critSort;
      if(st.idx === idx){
        st.dir = (st.dir === "asc") ? "desc" : "asc";
      }else{
        st.idx = idx;
        st.dir = "asc";
      }
      DASH_STATE.critPage = 1;
      dashUpdateCritSortIndicators();
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  });

  dashUpdateCritSortIndicators();
}



function dashInitCritDoubleScroll(){
  const top = document.getElementById("dashTblCritTopScroll");
  const inner = document.getElementById("dashTblCritTopInner");
  const wrap = document.getElementById("dashTblCritWrap");
  const tbl = document.getElementById("dashTblCrit");
  if(!top || !inner || !wrap || !tbl) return;

  const bindOnce = () => {
    if(top.dataset && top.dataset.syncInit === "1") return;
    if(top.dataset) top.dataset.syncInit = "1";
    let syncing = false;

    top.addEventListener("scroll", () => {
      if(syncing) return;
      syncing = true;
      wrap.scrollLeft = top.scrollLeft;
      syncing = false;
    });
    wrap.addEventListener("scroll", () => {
      if(syncing) return;
      syncing = true;
      top.scrollLeft = wrap.scrollLeft;
      syncing = false;
    });
  };

  const update = () => {
    // Asegura que el scrollbar superior tenga el mismo ancho desplazable que la tabla
    const w = (tbl.scrollWidth || tbl.offsetWidth || 0);
    inner.style.width = Math.max(w, 1) + "px";
    top.scrollLeft = wrap.scrollLeft;
  };

  bindOnce();
  update();

  // Evitar múltiples listeners de resize
  if(!top._resizeBound){
    top._resizeBound = true;
    window.addEventListener("resize", () => setTimeout(update, 0));
  }
}


// =========================================================
// DASHBOARD: PAGINACIÓN + ORDENAMIENTO (Fichas Detalle)
// - Ordenar por encabezado (A-Z / Z-A) y paginar sin perder orden.
// =========================================================
const DASH_CRIT_COLS = [
  {num:false, get:r => String(r?.ficha||"")},                                     // 0 Ficha
  {num:false, get:r => dashStr(r?.estado,"")},                                   // 1 Estado
  {num:false, get:r => dashStr(r?.municipio,"")},                                // 2 Municipio
  {num:false, get:r => dashStr(r?.programa,"")},                                 // 3 Programa
  {num:false, get:r => dashStr(r?.responsable,"")},                              // 4 Responsable
  {num:true,  get:r => Number(r?.diasAtraso)||0},                                // 5 Días atraso
  {num:true,  get:r => Number(r?.matriculados)||0},                              // 6 Matric.
  {num:true,  get:r => Number(r?.activos)||0},                                   // 7 Activos
  {num:true,  get:r => Number(r?.sinRuta)||0},                                   // 8 Sin ruta
  {num:true,  get:r => Number(r?.aprendicesSinJuicio || r?.sinJuicio || 0) || 0},// 9 Sin juicio
  {num:true,  get:r => (Number(r?.condicionado)||0) + (Number(r?.aplazado)||0) + (Number(r?.cancelado)||0) + (Number(r?.retiro)||0)}, // 10 Novedades
  {num:true,  get:r => Number(r?.enTransito)||0},                                // 11 EN_TRANSITO
  {num:true,  get:r => Number(r?.enInduccion)||0},                               // 12 INDUCCION
  {num:true,  get:r => Number(r?.enFormacion || r?.formacion || 0) || 0},        // 13 FORMACION
  {num:true,  get:r => Number(r?.condicionado)||0},                              // 14 CONDICIONADO
  {num:true,  get:r => Number(r?.aplazado)||0},                                  // 15 APLAZADO
  {num:true,  get:r => Number(r?.retiro)||0},                                    // 16 RETIRO_VOLUNTARIO
  {num:true,  get:r => Number(r?.cancelado)||0},                                 // 17 CANCELADO
  {num:true,  get:r => Number(r?.porCertificar)||0},                             // 18 POR_CERTIFICAR
  {num:true,  get:r => (Number(r?.certificados)||0) + (Number(r?.certificado)||0)}, // 19 CERTIFICADO
  {num:true,  get:r => Number(r?.trasladado)||0},                                // 20 TRASLADADO
];

const DASH_MUNI_COLS = [
  {num:false, get:x => String(x?.municipio||"")},                          // 0 Municipio
  {num:true,  get:x => Number(x?.fichas)||0},                              // 1 Fichas
  {num:true,  get:x => Number(x?.cupo)||0},                                // 2 Cupo
  {num:true,  get:x => Number(x?.matric)||0},                              // 3 Matric.
  {num:true,  get:x => Number(x?.activos)||0},                             // 4 Activos
  {num:true,  get:x => {
    const c = Number(x?.cupo)||0;
    const m = Number(x?.matric)||0;
    return c > 0 ? (m / c) : 0;
  }},                                                                      // 5 Ocupación %
  {num:true,  get:x => {
    const m = Number(x?.matric)||0;
    const a = Number(x?.activos)||0;
    return m > 0 ? (a / m) : 0;
  }},                                                                      // 6 Efectividad %
  {num:true,  get:x => Number(x?.atrasadas)||0},                           // 7 Atrasadas
  {num:true,  get:x => Number(x?.enTransito)||0},                          // 8 EN_TRANSITO
  {num:true,  get:x => Number(x?.enInduccion)||0},                         // 9 INDUCCION
  {num:true,  get:x => Number(x?.enFormacion)||0},                         // 10 FORMACION
  {num:true,  get:x => Number(x?.condicionado)||0},                        // 11 CONDICIONADO
  {num:true,  get:x => Number(x?.aplazado)||0},                            // 12 APLAZADO
  {num:true,  get:x => Number(x?.retiro)||0},                              // 13 RETIRO_VOLUNTARIO
  {num:true,  get:x => Number(x?.cancelado)||0},                           // 14 CANCELADO
  {num:true,  get:x => Number(x?.porCertificar)||0},                       // 15 POR_CERTIFICAR
  {num:true,  get:x => Number(x?.certificado)||0},                         // 16 CERTIFICADO
  {num:true,  get:x => Number(x?.trasladado)||0},                          // 17 TRASLADADO
  {num:true,  get:x => Number(x?.sinCert)||0},                             // 18 Aprendices sin certificados
  {num:true,  get:x => Number(x?.sinJuicio)||0},                           // 19 APRENDICES_SIN_JUICIO
  {num:true,  get:x => Number(x?.noAprob)||0},                             // 20 APRENDICES_NO_APROBADOS
];


function dashCritApplySort(baseRows){
  const st = DASH_STATE?.critSort;
  if(!st || st.idx == null) return baseRows;
  const col = DASH_CRIT_COLS[st.idx];
  if(!col) return baseRows;

  const dir = (st.dir === "desc") ? -1 : 1;
  return baseRows.slice().sort((a,b) => {
    const va = col.get(a);
    const vb = col.get(b);
    if(col.num){
      const na = Number(va);
      const nb = Number(vb);
      const aBad = !isFinite(na);
      const bBad = !isFinite(nb);
      if(aBad && bBad) return 0;
      if(aBad) return 1;
      if(bBad) return -1;
      return (na - nb) * dir;
    }
    return String(va).localeCompare(String(vb), "es", {numeric:true, sensitivity:"base"}) * dir;
  });
}


function dashMuniApplySort(baseRows){
  const st = DASH_STATE?.muniSort;
  if(!st || st.idx == null) return baseRows;
  const col = DASH_MUNI_COLS[st.idx];
  if(!col) return baseRows;

  const dir = (st.dir === "desc") ? -1 : 1;
  return baseRows.slice().sort((a,b) => {
    const va = col.get(a);
    const vb = col.get(b);
    if(col.num){
      const na = Number(va);
      const nb = Number(vb);
      const aBad = !isFinite(na);
      const bBad = !isFinite(nb);
      if(aBad && bBad) return 0;
      if(aBad) return 1;
      if(bBad) return -1;
      return (na - nb) * dir;
    }
    return String(va).localeCompare(String(vb), "es", {numeric:true, sensitivity:"base"}) * dir;
  });
}

function dashRenderCritPager(totalRows, page, pageSize){
  const el = document.getElementById("dashTblCritPager");
  if(!el) return;

  const totalPages = Math.max(1, Math.ceil((totalRows || 0) / pageSize));
  const p = Math.min(Math.max(1, page), totalPages);
  DASH_STATE.critPage = p;

  if(totalPages <= 1){
    el.innerHTML = "";
    return;
  }

  const from = totalRows ? ((p - 1) * pageSize + 1) : 0;
  const to = Math.min(p * pageSize, totalRows);

  const maxShow = 9;
  const pages = [];
  for(let i=1; i<=Math.min(maxShow, totalPages); i++) pages.push(i);
  if(totalPages > maxShow){
    pages.push("…");
    pages.push(totalPages);
  }

  const btn = (label, target, disabled, active) => {
    if(label === "…") return `<span class="ellipsis">…</span>`;
    const cls = active ? "active" : "";
    const dis = disabled ? "disabled" : "";
    const t = String(target);
    return `<button type="button" class="${cls}" data-page="${escHtml(t)}" ${dis}>${escHtml(String(label))}</button>`;
  };

  const htmlPages = pages.map(x => btn(x, x, false, x === p)).join("");

  el.innerHTML = `
    <div class="meta">Mostrando ${fmtNum(from)}–${fmtNum(to)} de ${fmtNum(totalRows)}</div>
    <div class="pages">
      ${btn("Anterior", p-1, p<=1, false)}
      ${htmlPages}
      ${btn("Siguiente", p+1, p>=totalPages, false)}
    </div>
  `;

  el.querySelectorAll('button[data-page]').forEach(b => {
    b.addEventListener("click", () => {
      const t = b.getAttribute("data-page");
      const n = parseInt(t, 10);
      if(!isFinite(n)) return;
      const next = Math.min(Math.max(1, n), totalPages);
      DASH_STATE.critPage = next;
      // Mantener la ordenación vigente; re-render completo para consistencia
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  });
}


function dashRenderMuniPager(totalRows, page, pageSize){
  const el = document.getElementById("dashTblMunicipioPager");
  if(!el) return;

  const totalPages = Math.max(1, Math.ceil((totalRows || 0) / pageSize));
  const p = Math.min(Math.max(1, page), totalPages);
  DASH_STATE.muniPage = p;

  if(totalPages <= 1){
    el.innerHTML = "";
    return;
  }

  const from = totalRows ? ((p - 1) * pageSize + 1) : 0;
  const to = Math.min(p * pageSize, totalRows);

  const maxShow = 9;
  const pages = [];
  for(let i=1; i<=totalPages; i++){
    pages.push(i);
  }

  // Ventana con elipsis
  let view = pages;
  if(totalPages > maxShow){
    const keep = new Set([1,2,totalPages-1,totalPages]);
    const left = Math.max(3, p - 2);
    const right = Math.min(totalPages - 2, p + 2);
    for(let i=left; i<=right; i++) keep.add(i);

    const compact = [];
    const sorted = Array.from(keep).sort((a,b)=>a-b);
    let prev = null;
    for(const x of sorted){
      if(prev != null && x - prev > 1) compact.push("…");
      compact.push(x);
      prev = x;
    }
    view = compact;
  }

  const btn = (label, target, disabled, active) => {
    if(label === "…") return `<span class="ellipsis">…</span>`;
    const cls = active ? "active" : "";
    const dis = disabled ? "disabled" : "";
    const t = String(target);
    return `<button type="button" class="${cls}" data-mpage="${escHtml(t)}" ${dis}>${escHtml(String(label))}</button>`;
  };

  const htmlPages = view.map(x => btn(x, x, false, x === p)).join("");

  el.innerHTML = `
    <div class="meta">Mostrando ${fmtNum(from)}–${fmtNum(to)} de ${fmtNum(totalRows)}</div>
    <div class="pages">
      ${btn("Anterior", p-1, p<=1, false)}
      ${htmlPages}
      ${btn("Siguiente", p+1, p>=totalPages, false)}
    </div>
  `;

  el.querySelectorAll('button[data-mpage]').forEach(b => {
    b.addEventListener("click", () => {
      const t = b.getAttribute("data-mpage");
      const n = parseInt(t, 10);
      if(!isFinite(n)) return;
      const next = Math.min(Math.max(1, n), totalPages);
      DASH_STATE.muniPage = next;
      dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
    });
  });
}

function dashRenderAprPager(totalRows, page, pageSize){
  const el = document.getElementById("dashAprDF03Pager");
  if(!el) return;

  const totalPages = Math.max(1, Math.ceil((totalRows || 0) / pageSize));
  const p = Math.min(Math.max(1, page), totalPages);
  if(DASH_STATE) DASH_STATE.aprPage = p;

  if(totalPages <= 1){
    el.innerHTML = "";
    return;
  }

  const from = totalRows ? ((p - 1) * pageSize + 1) : 0;
  const to = Math.min(p * pageSize, totalRows);

  // Ventana de páginas (compacta con elipsis)
  let view = [];
  if(totalPages <= 9){
    for(let i=1;i<=totalPages;i++) view.push(i);
  }else{
    const keep = new Set([1,2,totalPages-1,totalPages,p-1,p,p+1]);
    const left = Math.max(1, p - 2);
    const right = Math.min(totalPages, p + 2);
    for(let i=left; i<=right; i++) keep.add(i);

    const compact = [];
    const sorted = Array.from(keep).filter(x=>x>=1 && x<=totalPages).sort((a,b)=>a-b);
    let prev = null;
    for(const x of sorted){
      if(prev != null && x - prev > 1) compact.push("…");
      compact.push(x);
      prev = x;
    }
    view = compact;
  }

  const btn = (label, target, disabled, active) => {
    if(label === "…") return `<span class="ellipsis">…</span>`;
    const cls = active ? "active" : "";
    const dis = disabled ? "disabled" : "";
    const t = String(target);
    return `<button type="button" class="${cls}" data-apage="${escHtml(t)}" ${dis}>${escHtml(String(label))}</button>`;
  };

  const htmlPages = view.map(x => btn(x, x, false, x === p)).join("");

  el.innerHTML = `
    <div class="meta">Mostrando ${fmtNum(from)}–${fmtNum(to)} de ${fmtNum(totalRows)}</div>
    <div class="pages">
      ${btn("Anterior", p-1, p<=1, false)}
      ${htmlPages}
      ${btn("Siguiente", p+1, p>=totalPages, false)}
    </div>
  `;

  el.querySelectorAll('button[data-apage]').forEach(b => {
    b.addEventListener("click", () => {
      const t = b.getAttribute("data-apage");
      const n = parseInt(t, 10);
      if(!isFinite(n)) return;
      const next = Math.min(Math.max(1, n), totalPages);
      if(DASH_STATE) DASH_STATE.aprPage = next;
      dashRenderAprendicesDF03(dashGetFilteredRows());
    });
  });
}




function dashRenderTables(rows){
  // Tabla detalle: orden base por días de atraso desc (todas las filas), con paginación
  const critBody = document.getElementById("dashTblCritBody");
  if(critBody){
    const baseSorted = rows
      .slice()
      .sort((a,b)=> (Number(b?.diasAtraso)||0) - (Number(a?.diasAtraso)||0) || (Number(b?.activos)||0) - (Number(a?.activos)||0));

    const finalSorted = dashCritApplySort(baseSorted);

    const pageSize = 20;
    const totalRows = finalSorted.length;
    const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    const page = Math.min(Math.max(1, Number(DASH_STATE.critPage)||1), totalPages);
    DASH_STATE.critPage = page;

    const pageRows = finalSorted.slice((page - 1) * pageSize, page * pageSize);

    critBody.innerHTML = pageRows.map(r => {
      const nov = (Number(r?.condicionado)||0) + (Number(r?.aplazado)||0) + (Number(r?.cancelado)||0) + (Number(r?.retiro)||0);
      const sinJuicio = Number(r?.aprendicesSinJuicio || r?.sinJuicio || 0) || 0;

      const matric = Number(r?.matriculados)||0;
      const activos = Number(r?.activos)||0;
      const sinRuta = Number(r?.sinRuta)||0;

      const enTransito = Number(r?.enTransito)||0;
      const enInduccion = Number(r?.enInduccion)||0;
      const enFormacion = Number(r?.enFormacion || r?.formacion || 0) || 0;

      const condicionado = Number(r?.condicionado)||0;
      const aplazado = Number(r?.aplazado)||0;
      const retiro = Number(r?.retiro)||0;

      const cancelado = Number(r?.cancelado)||0;
      const porCertificar = Number(r?.porCertificar)||0;
      const certificado = (Number(r?.certificados)||0) + (Number(r?.certificado)||0);
      const trasladado = Number(r?.trasladado)||0;

      return `
        <tr data-ficha="${escHtml(String(r?.ficha||""))}">
          <td><b>${escHtml(String(r?.ficha||""))}</b></td>
          <td>${escHtml(dashStr(r?.estado,""))}</td>
          <td title="${escHtml(dashStr(r?.municipio,""))}">${escHtml(dashStr(r?.municipio,""))}</td>
          <td title="${escHtml(dashStr(r?.programa,""))}">${escHtml(dashStr(r?.programa,""))}</td>
          <td title="${escHtml(dashStr(r?.responsable,""))}">${escHtml(dashStr(r?.responsable,""))}</td>

          <td class="num">${escHtml(fmtNum(Number(r?.diasAtraso)||0))}</td>
          <td class="num">${escHtml(fmtNum(matric))}</td>
          <td class="num">${escHtml(fmtNum(activos))}</td>
          <td class="num">${escHtml(fmtNum(sinRuta))}</td>
          <td class="num">${escHtml(fmtNum(sinJuicio))}</td>
          <td class="num">${escHtml(fmtNum(nov))}</td>

          <td class="num">${escHtml(fmtNum(enTransito))}</td>
          <td class="num">${escHtml(fmtNum(enInduccion))}</td>
          <td class="num">${escHtml(fmtNum(enFormacion))}</td>
          <td class="num">${escHtml(fmtNum(condicionado))}</td>
          <td class="num">${escHtml(fmtNum(aplazado))}</td>
          <td class="num">${escHtml(fmtNum(retiro))}</td>
          <td class="num">${escHtml(fmtNum(cancelado))}</td>
          <td class="num">${escHtml(fmtNum(porCertificar))}</td>
          <td class="num">${escHtml(fmtNum(certificado))}</td>
          <td class="num">${escHtml(fmtNum(trasladado))}</td>
        </tr>
      `;
    }).join("");

    // Scroll horizontal (arriba y abajo)
    setTimeout(dashInitCritDoubleScroll, 0);

    // Paginación
    dashRenderCritPager(totalRows, page, pageSize);

    // Orden: indicadores según estado
    dashUpdateCritSortIndicators();

    // Click row => set search to ficha
    critBody.querySelectorAll("tr[data-ficha]").forEach(tr => {
      tr.addEventListener("click", () => {
        const ficha = tr.getAttribute("data-ficha") || "";
        const s = document.getElementById("dashSearch");
        if(s){ s.value = ficha; }
        DASH_STATE.search = ficha;
        DASH_STATE.critPage = 1;
        dashRender();
  try{ setTimeout(()=>{ const c = (DASH_STATE && DASH_STATE.charts) ? DASH_STATE.charts.empresaPie : null; if(c && typeof c.resize==='function'){ c.resize(); c.update(); } }, 80); }catch(e){}
      });
    });
  }
  // Resumen por municipio
  const muniBody = document.getElementById("dashTblMunicipioBody");
  if(muniBody){
    const rowsForMuni = dashGetFilteredRows("municipio");

    const g = {};
    // Solo municipios presentes en el dataset filtrado (evita filas sin datos al aplicar segmentaciones)

    // Agrega con filtros actuales
    rowsForMuni.forEach(r => {
      const m = dashStr(r?.municipio, "").trim();
      if(!m) return;
      const mKey = normNoAccents(m).toLowerCase()
        .replace(/[()\[\]{}]/g,'')
        .replace(/\s+/g,' ')
        .trim();
      if(!mKey) return;
      if(mKey === 'sin municipio' || mKey === 'sin dato' || mKey === 'sin datos'
         || mKey.includes('sin municipio') || mKey.includes('sin dato')) return;
      if(!g[m]){
        g[m] = {municipio:m, fichas:0, cupo:0, matric:0, activos:0, atrasadas:0,
          enTransito:0,enInduccion:0,enFormacion:0,condicionado:0,aplazado:0,retiro:0,
          cancelado:0,porCertificar:0,certificado:0,
          trasladado:0,sinCert:0,sinJuicio:0,noAprob:0};
      }
      const x = g[m];
      x.fichas += 1;
      x.cupo += (Number(r?.cupo)||0);
      x.matric += (Number(r?.matriculados)||0);
      x.activos += (Number(r?.activos)||0);
      x.atrasadas += ((Number(r?.diasAtraso)||0) > 0 ? 1 : 0);

      x.enTransito += (Number(r?.enTransito)||0);
      x.enInduccion += (Number(r?.enInduccion)||0);
      x.enFormacion += (Number(r?.enFormacion)||0);
      x.condicionado += (Number(r?.condicionado)||0);
      x.aplazado += (Number(r?.aplazado)||0);
      x.retiro += (Number(r?.retiro)||0);
      x.cancelado += (Number(r?.cancelado)||0);
      x.porCertificar += (Number(r?.porCertificar)||0);
      x.certificado += (Number(r?.certificados)||0) + (Number(r?.certificado)||0);

      // Campos no presentes en todas las fuentes: se dejan en 0 si no vienen      x.trasladado += (Number(r?.trasladado)||0);
      const sj = Number(r?.aprendicesSinJuicio || r?.sinJuicio || 0) || 0;
      x.sinJuicio += sj;
    });

    // Derivados
    Object.values(g).forEach(x => {
      x.sinCert = Math.max((x.matric||0) - (x.certificado||0), 0);
    });

    const baseSorted = Object.values(g)
      .slice()
      .sort((a,b)=> (Number(b?.matric)||0) - (Number(a?.matric)||0) || String(a?.municipio||"").localeCompare(String(b?.municipio||""), "es", {numeric:true, sensitivity:"base"}));

    const finalSorted = dashMuniApplySort(baseSorted);

    const pageSize = 20;
    const totalRows = finalSorted.length;
    const colCount = (document.querySelectorAll('#dashTblMunicipio thead th').length || 1);
    if(totalRows === 0){
      muniBody.innerHTML = `<tr><td colspan="${colCount}" class="dash-empty">Sin registros para los filtros actuales</td></tr>`;
      dashRenderMuniPager(0, 1, pageSize);
      dashUpdateMuniSortIndicators();
      return;
    }
    const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    const page = Math.min(Math.max(1, Number(DASH_STATE.muniPage)||1), totalPages);
    DASH_STATE.muniPage = page;

    const pageRows = finalSorted.slice((page-1)*pageSize, page*pageSize);

    muniBody.innerHTML = pageRows.map(x => {
      const ocup = x.cupo > 0 ? x.matric/x.cupo : 0;
      const efect = x.matric > 0 ? x.activos/x.matric : 0;
      return `
        <tr data-muni="${escHtml(x.municipio)}">
          <td class="sticky"><b>${escHtml(x.municipio)}</b></td>
          <td class="num">${escHtml(fmtNum(x.fichas))}</td>
          <td class="num">${escHtml(fmtNum(x.cupo))}</td>
          <td class="num">${escHtml(fmtNum(x.matric))}</td>
          <td class="num">${escHtml(fmtNum(x.activos))}</td>
          <td class="num">${escHtml(dashFmtPct(ocup))}</td>
          <td class="num">${escHtml(dashFmtPct(efect))}</td>
          <td class="num">${escHtml(fmtNum(x.atrasadas))}</td>
          <td class="num adv">${escHtml(fmtNum(x.enTransito))}</td>
          <td class="num adv">${escHtml(fmtNum(x.enInduccion))}</td>
          <td class="num adv">${escHtml(fmtNum(x.enFormacion))}</td>
          <td class="num adv">${escHtml(fmtNum(x.condicionado))}</td>
          <td class="num adv">${escHtml(fmtNum(x.aplazado))}</td>
          <td class="num adv">${escHtml(fmtNum(x.retiro))}</td>
          <td class="num adv">${escHtml(fmtNum(x.cancelado))}</td>
          <td class="num adv">${escHtml(fmtNum(x.porCertificar))}</td>
          <td class="num adv">${escHtml(fmtNum(x.certificado))}</td>
          <td class="num adv">${escHtml(fmtNum(x.trasladado))}</td>
          <td class="num adv">${escHtml(fmtNum(x.sinCert))}</td>
          <td class="num adv">${escHtml(fmtNum(x.sinJuicio))}</td>
          <td class="num adv">${escHtml(fmtNum(x.noAprob))}</td>
        </tr>
      `;
    }).join("");

    // Paginación
    dashRenderMuniPager(totalRows, page, pageSize);

    // Orden: indicadores según estado
    dashUpdateMuniSortIndicators();

    muniBody.querySelectorAll("tr[data-muni]").forEach(tr => {
      tr.addEventListener("click", () => {
        const muni = tr.getAttribute("data-muni");
        if(!muni) return;
        dashToggleSingleFilter("municipio", muni);
      });
    });

  }
  // (Bloque duplicado removido por corrección de sintaxis)
  // Top 10 Empresas por Aprendices (PE-04) + gráfica circular (tabla y gráfica como segmentación MULTI)
  const empBody = document.getElementById("dashTblEmpresaBody");
  const empCanvas = document.getElementById("dashChartEmpresaPie");
  if(empBody){
    const EXCL = new Set([
      "DEMANDA SOCIAL (SENA)",
      "SERVICIO NACIONAL DE APRENDIZAJE - SENA",
      "(SIN NOMBRE)",
      "SIN NOMBRE"
    ]);

    const normEmp = (s) => (s ?? "")
      .toString()
      .trim()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toUpperCase()
      .replace(/\s+/g," ")
      .trim();

    const isBad = (ne) => (!ne || EXCL.has(ne));
    const metric = (r) => (Number(r?.matriculadosPE04 ?? 0) || 0);

    // Base: mantener categorías visibles aunque exista filtro de empresa,
    // pero respetar el resto de segmentaciones del dashboard.
    const baseRows = (typeof dashGetFilteredRows === "function") ? dashGetFilteredRows("empresa") : (rows || []);

    const agg = new Map();     // ne -> aprendices
    const display = new Map(); // ne -> nombre observado (primer valor)
    for(const r of (baseRows || [])){
      const empRaw = String(r?.empresa || "").trim();
      const ne = normEmp(empRaw);
      if(isBad(ne)) continue;
      const v = metric(r);
      if(v <= 0) continue;
      if(!display.has(ne)) display.set(ne, empRaw);
      agg.set(ne, (agg.get(ne) || 0) + v);
    }

    const topNorm = Array.from(agg.entries())
      .sort((a,b) => (b[1] - a[1]) || String(display.get(a[0]) || a[0]).localeCompare(String(display.get(b[0]) || b[0])))
      .slice(0, 10)
      .map(([ne]) => ne);

    // Render tabla Top 10 (mantiene el Top 10 basado en baseRows)
    const sel = (DASH_STATE && DASH_STATE.filters && DASH_STATE.filters.empresa) ? DASH_STATE.filters.empresa : new Set();
    const topRows = topNorm.map(ne => ({
      empresa: display.get(ne) || ne,
      aprendices: (agg.get(ne) || 0)
    }));

    empBody.innerHTML = topRows.map(x => {
      const match = (typeof dashMatchValue === "function") ? (dashMatchValue("empresa", x.empresa) || x.empresa) : x.empresa;
      const isSel = sel && sel.has(match);
      return `
        <tr data-empresa="${escAttr(x.empresa)}" class="${isSel ? "is-selected" : ""}">
          <td class="sticky">${escHtml(x.empresa)}</td>
          <td class="num">${escHtml(fmtNum(x.aprendices))}</td>
        </tr>
      `;
    }).join("");

    // Tabla como segmentación MULTI (clic alterna selección; permite seleccionar varias)
    empBody.onclick = (ev) => {
      const tr = ev.target && ev.target.closest ? ev.target.closest("tr[data-empresa]") : null;
      if(!tr) return;
      const emp = tr.getAttribute("data-empresa") || "";
      const match = (typeof dashMatchValue === "function") ? (dashMatchValue("empresa", emp) || emp) : emp;
      dashToggleFilter("empresa", match);
    };

    // Gráfica circular (doughnut) -> segmentación MULTI
    if(empCanvas && typeof dashUpsertChart === "function"){
      const labels = topNorm.map(ne => display.get(ne) || ne);
      const values = topNorm.map(ne => (agg.get(ne) || 0));
      dashUpsertChart("empresaPie", "dashChartEmpresaPie", "doughnut", labels, values, (label) => {
        const match = (typeof dashMatchValue === "function") ? (dashMatchValue("empresa", label) || label) : label;
        dashToggleFilter("empresa", match);
      }, { percent:true, theme:"green", filterKey:"empresa" });
    }
  }

}



function syncFichaAcumulativaNav(){
  const btn = document.getElementById("nav-r19");
  if(!btn) return;
  const enabled = !!(DF03_STATE && DF03_STATE.loaded);
  btn.disabled = !enabled;
  btn.classList.toggle("is-disabled", !enabled);
  btn.title = enabled ? "" : "Cargue DF-03 (1 a 5 XML) en el Paso 1 para habilitar Ficha Acumulativa.";
}

function refreshNavBadges(){
  for(let id in REPORTS){
    let count = 0;
    try{
      if(id === "r19"){
        // Ficha Acumulativa: por defecto muestra # fichas DF-03 cargadas; si hay una consulta reciente, muestra # aprendices
        if(DF03_STATE && DF03_STATE.loaded){
          count = (DF03_STATE.lastResultCount && DF03_STATE.lastResultCount > 0)
            ? DF03_STATE.lastResultCount
            : (DF03_STATE.fichasMap ? DF03_STATE.fichasMap.size : 0);
        }else{
          count = 0;
        }
      }else if(id === "dashboard"){
        count = (typeof dashGetBaseRows === "function") ? dashGetBaseRows().length : 0;
      }else{
        const cfg = REPORTS[id];
        if(cfg){
          const model = getViewModel(cfg, id, "");
          count = (model && model.tableRows) ? model.tableRows.length : 0;
        }
      }
    }catch(e){
      count = 0;
    }
    const badge = document.getElementById("c-"+id);
    if(badge) badge.textContent = count;
  }
  syncFichaAcumulativaNav();

}

function resetApp(){
  location.reload();
}

function escHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// Escape para valores en atributos HTML (data-*)
function escAttr(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;")
    .replace(/`/g,"&#96;");
}

function sanitizeFilename(name){
  return String(name || "reporte")
    .trim()
    .replace(/[\/:*?"<>|]+/g, " ")
    .replace(/\s+/g, " ")
    .substring(0, 120);
}

function getSortedDataForExport(config){
  // Exporta exactamente lo que está visible (filtros + búsqueda), sin límite de filas
  let data = getViewModel(config).tableRows;

  const s = SORT_STATE[ACTIVE_REPORT_ID];
  if(s && s.key){
    const colDef = config.columns.find(c => c.key === s.key) || {};
    const isNum = colDef.align === "num";
    const dirMul = (s.dir === "desc") ? -1 : 1;

    data = [...data].sort((a,b) => {
      const av = (a[s.key] ?? "");
      const bv = (b[s.key] ?? "");

      // Vacíos al final
      const aEmpty = (av === null || av === undefined || String(av).trim() === "");
      const bEmpty = (bv === null || bv === undefined || String(bv).trim() === "");
      if(aEmpty && bEmpty) return 0;
      if(aEmpty) return 1;
      if(bEmpty) return -1;

      if(isNum){
        const an = Number(av);
        const bn = Number(bv);
        const aa = isFinite(an) ? an : -Infinity;
        const bb = isFinite(bn) ? bn : -Infinity;
        return (aa - bb) * dirMul;
      }

      return String(av).localeCompare(String(bv), "es", {numeric:true, sensitivity:"base"}) * dirMul;
    });
  }

  return data;
}

function exportTable(){
  const config = REPORTS[ACTIVE_REPORT_ID];
  if(!config){
    alert("Selecciona un reporte para exportar.");
    return;
  }

  const data = getSortedDataForExport(config);

  if(!data.length){
    alert("No hay datos para exportar");
    return;
  }

  // Exporta el reporte ACTIVO (lo que estás viendo), respetando filtros y orden.
  const title = config.title || ("Reporte_" + ACTIVE_REPORT_ID);
  const filename = sanitizeFilename(title) + ".xls";

  let html = '<html><head><meta charset="utf-8"></head><body>';
  html += '<table border="1" cellspacing="0" cellpadding="4">';
  html += "<tr><th>#</th>" + config.columns.map(c => "<th>" + escHtml(c.label) + "</th>").join("") + "</tr>";

  for(let i=0; i<data.length; i++){
    const row = data[i];
    html += "<tr>";
    html += "<td>" + (i+1) + "</td>";
    for(const c of config.columns){
      let v = (row[c.key] ?? "");
      if(c.align === "num"){
        const n = Number(v);
        if(isFinite(n)) v = fmtNum(n);
      }
      html += "<td>" + escHtml(v) + "</td>";
    }
    html += "</tr>";
  }

  html += "</table></body></html>";

  const blob = new Blob(["\ufeff", html], {type: "application/vnd.ms-excel;charset=utf-8"});
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => window.URL.revokeObjectURL(url), 1000);
}

/* =========================================================
   FICHA ACUMULATIVA (DF-03) - MÓDULO ESPECIALIZADO
   - Carga 1 a 5 archivos DF-03 (SpreadsheetML XML)
   - Indexa por ficha para reducir memoria
   - Muestra: KPIs + 2 gráficos + semáforo competencias + lista aprendices (WhatsApp)
   ========================================================= */

let DF03_STATE = {
  loaded: false,
  loading: false,
  fichasMap: new Map(), // ficha -> { meta, comp: Map, apr: Map, stats }
  headerIdx: null,
  lastResultCount: 0,
  currentFicha: "",
  currentAprRows: [],
  aprSearchQ: "",
  faSortKey: "",
  faSortDir: 1
};




function initDF03StartUI(){
  const dz = document.getElementById("df03DropzoneStart");
  const browseLink = document.getElementById("df03BrowseLinkStart");
  const inp = document.getElementById("df03InputStart");

  const openPicker = () => {
    if(!inp) return;
    if(DF03_STATE && DF03_STATE.loading) return;
    inp.click();
  };

  if(browseLink){
    browseLink.addEventListener("click", (e) => {
      e.preventDefault();
      openPicker();
    });
  }

  if(dz){
    dz.addEventListener("click", (e) => {
      const t = e && e.target ? e.target : null;
      if(t && t.id === "df03BrowseLinkStart") return;
      openPicker();
    });

    dz.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " \ "){
        e.preventDefault();
        openPicker();
      }
    });

    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
    ["dragenter","dragover"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        prevent(e);
        dz.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        prevent(e);
        dz.classList.remove("dragover");
      });
    });

    dz.addEventListener("drop", async (e) => {
      const files = Array.from((e.dataTransfer && e.dataTransfer.files) ? e.dataTransfer.files : []);
      await handleDF03FilesSelection(files, inp);
      syncFichaAcumulativaNav();
    });
  }

  if(inp){
    inp.addEventListener("change", async () => {
      const files = Array.from(inp.files || []);
      await handleDF03FilesSelection(files, inp);
      syncFichaAcumulativaNav();
      inp.value = "";
    });
  }
}
function initFichaAcumulativaUI(){
  const dz = document.getElementById("df03Dropzone");
  const browseLink = document.getElementById("df03BrowseLink");
  const inp = document.getElementById("df03Input");
  const searchBtn = document.getElementById("btnFaBuscar");
  const fichaInp = document.getElementById("faFichaInput");

  // Bloquear consulta hasta que DF-03 esté cargado
  setFAConsultaEnabled(!!DF03_STATE.loaded);

  const openPicker = () => {
    if(!inp) return;
    if(DF03_STATE.loading) return;
    inp.click();
  };

  if(browseLink){
    browseLink.addEventListener("click", (e) => {
      e.preventDefault();
      openPicker();
    });
  }

  if(dz){
    dz.addEventListener("click", (e) => {
      const t = e && e.target ? e.target : null;
      if(t && t.id === "df03BrowseLink") return;
      openPicker();
    });

    dz.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        openPicker();
      }
    });

    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
    ["dragenter","dragover"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        prevent(e);
        dz.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        prevent(e);
        dz.classList.remove("dragover");
      });
    });

    dz.addEventListener("drop", async (e) => {
      const files = Array.from((e.dataTransfer && e.dataTransfer.files) ? e.dataTransfer.files : []);
      await handleDF03FilesSelection(files, inp);
    });
  }

  if(inp){
    inp.addEventListener("change", async () => {
      const files = Array.from(inp.files || []);
      await handleDF03FilesSelection(files, inp);
    });
  }

  if(searchBtn){
    searchBtn.addEventListener("click", () => {
      const ficha = normalizeFicha((fichaInp && fichaInp.value) ? fichaInp.value : "");
      renderFAForFicha(ficha);
    });
  }
  if(fichaInp){
    fichaInp.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        const ficha = normalizeFicha(fichaInp.value || "");
        renderFAForFicha(ficha);
      }
    });
  }

  const aprSearchInp = document.getElementById("faAprSearch");
  if(aprSearchInp){
    aprSearchInp.addEventListener("input", () => {
      TABLE_PAGE_STATE["r19_fa_apr"] = 1;
      renderFAAprTable();
    });
  }
}

async function handleDF03FilesSelection(files, inp){
  if(DF03_STATE.loading){
    showFAMsg("⏳ DF-03 se está procesando. Espera a que termine para cargar otros archivos.", false);
    return;
  }

  const list = Array.isArray(files) ? files : [];
  if(!list.length) return;

  // Solo XML (Excel 2003 XML)
  const xmlFiles = list.filter(f => {
    const nameL = (f && f.name ? f.name : "").toLowerCase();
    return nameL.endsWith(".xml");
  });

  if(!xmlFiles.length){
    showFAMsg("⚠️ Selecciona archivos .xml DF-03 (Excel 2003 XML) descargados de SofíaPlus.", true);
    if(inp) inp.value = "";
    return;
  }

  if(xmlFiles.length > 5){
    showFAMsg(`⚠️ Máximo 5 archivos DF-03. Seleccionaste ${xmlFiles.length}.`, true);
    if(inp) inp.value = "";
    return;
  }

  renderDF03FileChips(xmlFiles);
  setFAConsultaEnabled(false);

  await loadDF03Files(xmlFiles);

  setFAConsultaEnabled(true);
  refreshNavBadges();

  // Permite recargar el mismo archivo si hace falta
  if(inp) inp.value = "";
}

/* =========================
   Reportes: selector + PDF
   - Exporta reportes sin filtros (no incluye Dashboard)
   - Ordena reportes en PDF por # filas (desc)
   - Oculta columnas numéricas que sean 0 en todas las filas
   ========================= */

function reportIdsForPdf(){
  // Excluir dashboard y Ficha Acumulativa (por ficha)
  return Object.keys(REPORTS).filter(id => id !== "dashboard" && id !== "r19" && id !== "reports");
}

function initReportsPanel(){
  const list = document.getElementById("reportsList");
  if(!list) return;

  // Orden estable: por número del título (1., 2., 3., ...) y luego módulos especiales
  const specialOrder = { r14: 1000, r15: 1001, r16: 1002, r17: 1003, r18: 1004 };
  const sortKey = (id) => {
    const cfg = REPORTS[id] || {};
    const t = String(cfg.title || "").trim();
    const m = t.match(/^(\d+)\s*\./);
    if(m) return { g: 0, n: parseInt(m[1],10) || 0 };
    if(specialOrder[id] != null) return { g: 1, n: specialOrder[id] };
    return { g: 2, n: 9999 };
  };

  const ids = reportIdsForPdf().slice().sort((a,b) => {
    const ka = sortKey(a), kb = sortKey(b);
    if(ka.g !== kb.g) return ka.g - kb.g;
    if(ka.n !== kb.n) return ka.n - kb.n;
    return String(a).localeCompare(String(b));
  });

  list.innerHTML = ids.map(id => {
    const cfg = REPORTS[id];
    const title = escapeHtml(cfg.title || id);
    const desc = escapeHtml(cfg.desc || "");
    return `
      <label class="rp-item">
        <span class="rp-check"><input type="checkbox" data-rid="${id}" checked></span>
        <span class="rp-meta">
          <div class="rp-name">${title}</div>
          <div class="rp-desc">${desc}</div>
          <div class="rp-pill"><span class="dot"></span><span class="txt">Incluido</span></div>
        </span>
      </label>
    `;
  }).join("");

  const syncItem = (cb) => {
    const item = cb && cb.closest ? cb.closest(".rp-item") : null;
    if(!item) return;
    const txt = item.querySelector(".rp-pill .txt");
    const dot = item.querySelector(".rp-pill .dot");
    const on = !!cb.checked;
    if(txt) txt.textContent = on ? "Incluido" : "Excluido";
    if(dot) dot.style.background = on ? "var(--g-600)" : "var(--border)";
    item.style.opacity = on ? "1" : ".7";
  };

  list.querySelectorAll('input[type="checkbox"][data-rid]').forEach(cb => {
    syncItem(cb);
    cb.addEventListener("change", () => syncItem(cb));
  });

  const btnAll = document.getElementById("rpAll");
  const btnNone = document.getElementById("rpNone");
  const btnPdf = document.getElementById("rpExportPdf");

  if(btnAll) btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"][data-rid]').forEach(c => { c.checked = true; syncItem(c); });
  };
  if(btnNone) btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"][data-rid]').forEach(c => { c.checked = false; syncItem(c); });
  };
  if(btnPdf) btnPdf.onclick = exportSelectedReportsToPDF;
}

function showReportsPanel(){
  document.body.classList.add("reports-mode");
  const panel = document.getElementById("reportsPanel");
  const tbls = document.querySelectorAll(".table-container");
  const pager = document.getElementById("mainTablePager");
  const notes = document.getElementById("satNotes");
  const tools = document.getElementById("tableTools");
    const faTools = document.getElementById("faAprTools");
const kpi = document.getElementById("kpiArea");
  const charts = document.getElementById("chartsArea");
  const excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");

  if(panel) panel.style.display = "block";

  // En modo Reportes no se usa la barra table-tools
  if(tools){
    tools.dataset._wasTableTools = tools.classList.contains("table-tools") ? "1" : "0";
    tools.classList.remove("table-tools");
  }
  if(faTools){
    faTools.dataset._wasTableTools = faTools.classList.contains("table-tools") ? "1" : "0";
    faTools.classList.remove("table-tools");
  }

  // Ocultar cualquier contenido del reporte previamente activo
  tbls.forEach(t => t.style.display = "none");
  if(pager) pager.style.display = "none";
  if(notes) notes.style.display = "none";
  if(tools) tools.style.display = "none";
  if(kpi){ kpi.style.display = "none"; kpi.innerHTML = ""; }
  if(charts){ charts.style.display = "none"; charts.innerHTML = ""; }
  if(excelBtn) excelBtn.style.display = "none";
  try{ destroyCharts(); }catch(e){}

  // Ocultar UI especializada si estuviera visible
  if(typeof hideDashboardView === "function") hideDashboardView();
  if(typeof hideFichaAcumulativaView === "function") hideFichaAcumulativaView();

  initReportsPanel();
}

function hideReportsPanel(){
  document.body.classList.remove("reports-mode");
  const panel = document.getElementById("reportsPanel");
  const tbls = document.querySelectorAll(".table-container");
  const notes = document.getElementById("satNotes");
  const tools = document.getElementById("tableTools");
    const faTools = document.getElementById("faAprTools");
const excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");
  if(panel) panel.style.display = "none";

  // Restaurar class table-tools al salir de Reportes
  if(tools && tools.dataset._wasTableTools === "1") tools.classList.add("table-tools");
  if(faTools && faTools.dataset._wasTableTools === "1") faTools.classList.add("table-tools");

  // Volver a default: el render del reporte activo controlará visibilidad/paginación
  tbls.forEach(t => t.style.display = "");
  if(notes) notes.style.display = "";
  if(tools) tools.style.display = "";
  if(excelBtn) excelBtn.style.display = "inline-block";
}

function parseNumLoose(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/[%\s]/g,"").replace(/\./g,"").replace(/,/g,".");
  const n = Number(cleaned);
  return isFinite(n) ? n : 0;
}


function parseHoursLoose(v){
  // Convierte valores de horas a minutos.
  // Soporta:
  // - "H:MM" o "HH:MM:SS"
  // - DateTime de Excel XML: "YYYY-MM-DDTHH:MM:SS(.sss)" (ej. 1900-01-01T15:55:00.000 -> 39:55)
  // - Numéricos: horas decimales o fracción de día (heurística)
  if(v === null || v === undefined) return 0;
  const s0 = String(v).trim();
  if(!s0) return 0;
  const s = s0.replace(/\s+/g,"");

  // 1) H:MM o H:MM:SS
  let m = s.match(/^(\d+):(\d{1,2})(?::(\d{1,2}))?$/);
  if(m){
    const h = parseInt(m[1],10) || 0;
    const mm = parseInt(m[2],10) || 0;
    const ss = m[3] ? (parseInt(m[3],10) || 0) : 0;
    return (h*60) + mm + (ss/60);
  }

  // 2) DateTime Excel XML: YYYY-MM-DDTHH:MM:SS(.sss)
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?$/);
  if(m){
    const Y = parseInt(m[1],10), Mo = parseInt(m[2],10), D = parseInt(m[3],10);
    const h = parseInt(m[4],10), mi = parseInt(m[5],10), se = parseInt(m[6],10);
    // Base usada por el XML para 0:00 suele ser 1899-12-31T00:00:00.000 (ver PE-04)
    const base = Date.UTC(1899, 11, 31, 0, 0, 0);
    const dt = Date.UTC(Y, (Mo||1)-1, D||1, h||0, mi||0, se||0);
    const diff = (dt - base) / 60000;
    return isFinite(diff) && diff > 0 ? diff : 0;
  }

  // 3) Numérico (horas decimales / fracción de día)
  const cleaned = s.replace(/,/g, ".");
  const n = Number(cleaned);
  if(!isFinite(n)) return 0;

  // Heurística:
  // - Si es fracción pequeña (0 < n < 3) y parece valor de Excel (ej. 0.8326 = 19:59), tratar como días
  // - En caso contrario, tratar como horas decimales
  if(n > 0 && n < 3 && cleaned.includes(".")){
    return n * 24 * 60;
  }
  return n * 60;
}

function pruneZeroColumns(columns, data){
  // Solo ocultar columnas numéricas cuyo total sea 0
  const out = [];
  for(const c of columns){
    const isNum = (c.align === "num");
    if(!isNum){ out.push(c); continue; }
    let sum = 0;
    for(let i=0;i<data.length;i++){
      sum += parseNumLoose(data[i][c.key]);
      if(sum !== 0) break;
    }
    if(sum !== 0) out.push(c);
  }
  // Si por alguna razón quedaron 0 columnas, mantener al menos la primera
  return out.length ? out : columns.slice(0,1);
}

function getViewModelUnfiltered(config, rid){
  // Sin filtros UI (año/nivel/programa especial/búsqueda). Mantiene reglas internas del reporte.
  let base = getBaseRows(config);
  if(typeof applyEstadoExclusion === "function") base = applyEstadoExclusion(base, rid);
  if(typeof config.data === "function"){
    const agg = (config.data(base) || []);
    return { baseRows: base, tableRows: agg };
  }
  return { baseRows: base, tableRows: base };
}

function exportSelectedReportsToPDF(){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("No se pudo cargar jsPDF. Verifica conexión a Internet.");
    return;
  }
  const panel = document.getElementById("reportsPanel");
  if(!panel) return;

  const cbs = Array.from(panel.querySelectorAll('input[type="checkbox"][data-rid]'));
  const checked = cbs.filter(c => c.checked).map(c => c.getAttribute("data-rid"));

  if(!checked.length){
    alert("Selecciona al menos un reporte.");
    return;
  }

  // Helpers PDF
  const stripHtmlPdf = (v) => {
    if(v === null || v === undefined) return "";
    let s = String(v);
    if(s.indexOf("<") !== -1){
      s = s.replace(/<br\s*\/?>/gi, "\n").replace(/<\/?[^>]+>/g, "");
    }
    // Entidades comunes
    s = s.replace(/&nbsp;/g," ")
         .replace(/&amp;/g,"&")
         .replace(/&lt;/g,"<")
         .replace(/&gt;/g,">")
         .replace(/&quot;/g,'"')
         .replace(/&#039;/g,"'");
    return s.trim();
  };

  const satToneRGB = (tone) => {
    if(tone === "sat-red") return [239, 68, 68];
    if(tone === "sat-orange") return [249, 115, 22];
    if(tone === "sat-yellow") return [250, 204, 21];
    return [148, 163, 184]; // gray
  };
  const satToneTextRGB = (tone) => {
    if(tone === "sat-yellow") return [17, 24, 39]; // dark text on yellow
    return [255, 255, 255];
  };
  const satLetter = (label) => {
    const t = String(label||"").toLowerCase();
    if(t.includes("cierre rojo")) return "R";
    if(t.includes("cierre naranja")) return "N";
    if(t.includes("cierre amarillo")) return "A";
    if(t.includes("cierre (obs")) return "O";
    if(t.includes("tránsito alto") || t.includes("transito alto")) return "T";
    if(t.includes("tránsito (obs") || t.includes("transito (obs")) return "T";
    if(t.includes("sin ruta")) return "U";
    if(t.includes("sin programar")) return "P";
    if(t.includes("caída") || t.includes("caida")) return "C";
    if(t.includes("retención baja") || t.includes("retencion baja")) return "B";
    if(t.includes("calidad de datos")) return "D";
    if(t.includes("crítico") || t.includes("critico")) return "C";
    if(t === "alto") return "A";
    if(t === "medio") return "M";
    if(t.includes("observación") || t.includes("observacion")) return "O";
    return (stripHtmlPdf(label).trim().slice(0,1) || "").toUpperCase();
  };
  const satExtractPills = (html) => {
    const out = [];
    const re = /<span[^>]*class="([^"]*sat-pill[^"]*)"[^>]*>(.*?)<\/span>/gi;
    let m;
    const src = String(html || "");
    while((m = re.exec(src))){
      const cls = m[1] || "";
      const txt = stripHtmlPdf(m[2] || "");
      let tone = "sat-gray";
      if(/sat-red/.test(cls)) tone = "sat-red";
      else if(/sat-orange/.test(cls)) tone = "sat-orange";
      else if(/sat-yellow/.test(cls)) tone = "sat-yellow";
      out.push({ tone, text: txt });
    }
    return out;
  };

  // Construir datasets sin filtros (respeta reglas internas del reporte)
  const blocks = checked.map(id => {
    const cfg = REPORTS[id];
    const vm = getViewModelUnfiltered(cfg, id);
    const data = (vm && vm.tableRows) ? vm.tableRows : [];
    return { id, cfg, data, rows: data.length };
  }).filter(b => b.rows > 0);

  if(!blocks.length){
    alert("No hay datos para exportar en los reportes seleccionados.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

  const pageW = doc.internal.pageSize.getWidth();
  const marginX = 36;

  blocks.forEach((b, idx) => {
    if(idx > 0) doc.addPage();

    const title = (b.cfg.title || b.id);
    const desc = (b.cfg.desc || "");

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(title, marginX, 42);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    const descLines = doc.splitTextToSize(desc, pageW - marginX*2);
    doc.text(descLines, marginX, 60);

    const y0 = 60 + (descLines.length * 12) + 10;

    const cols = pruneZeroColumns(b.cfg.columns || [], b.data);
    const head = [ ["#", ...cols.map(c => c.label || c.key)] ];

    const body = b.data.map((row, i) => {
      const arr = [ String(i+1) ];
      for(const c of cols){
        const raw = row[c.key];

        // SAT: Severidad / Alertas como "píldoras" (letra + color), sin HTML
        if(b.id === "r18" && c.key === "severidad"){
          const pills = satExtractPills(raw);
          const p = pills[0] || { tone: "sat-gray", text: stripHtmlPdf(raw) };
          const fill = satToneRGB(p.tone);
          const txtc = satToneTextRGB(p.tone);
          arr.push({
            content: satLetter(p.text),
            styles: { fillColor: fill, textColor: txtc, fontStyle: "bold", halign:"center", valign:"middle" }
          });
          continue;
        }

        if(b.id === "r18" && c.key === "alerts"){
          const pills = satExtractPills(raw);
          const tokens = pills.map(p => ({ tone: p.tone, letter: satLetter(p.text) }));
          arr.push({
            content: "", // se dibuja en didDrawCell
            _satTokens: tokens,
            styles: { cellPadding: 2, halign:"left", valign:"middle" }
          });
          continue;
        }

        // Default: sin HTML
        arr.push(stripHtmlPdf(raw));
      }
      return arr;
    });

    // Fuente dinámica según #columnas
    const colCount = cols.length + 1;
    let fs = 9;
    if(colCount > 16) fs = 7;
    else if(colCount > 12) fs = 8;

    doc.autoTable({
      head,
      body,
      startY: y0,
      margin: { left: marginX, right: marginX },
      styles: { fontSize: fs, cellPadding: 3, overflow: "linebreak" },
      headStyles: { fillColor: [6, 95, 70] },
      theme: "grid",
      didParseCell: function(data){
        // Alinear numéricos a la derecha
        if(data.section === "body" && data.column.index > 0){
          const col = cols[data.column.index - 1];
          if(col && col.align === "num"){
            data.cell.styles.halign = "right";
          }
        }
      },
      didDrawCell: function(data){
        // Dibujar "píldoras" del SAT en PDF (Alertas)
        const raw = data.cell && data.cell.raw ? data.cell.raw : null;
        if(!raw || !raw._satTokens) return;

        const tokens = raw._satTokens || [];
        if(!tokens.length) return;

        const cell = data.cell;
        const pad = 2;
        const h = 12;
        const r = 3;
        const gap = 3;

        let x = cell.x + pad;
        let y = cell.y + pad;
        const maxX = cell.x + cell.width - pad;

        doc.setFont("helvetica", "bold");
        const prevFs = doc.getFontSize();
        doc.setFontSize(Math.max(7, fs - 1));

        const drawToken = (t, label) => {
          const tone = t.tone || "sat-gray";
          const fill = satToneRGB(tone);
          const txtc = satToneTextRGB(tone);
          const w = Math.max(14, doc.getTextWidth(label) + 8);

          // wrap
          if(x + w > maxX){
            x = cell.x + pad;
            y += h + 3;
          }

          doc.setFillColor(fill[0], fill[1], fill[2]);
          if(doc.roundedRect){ doc.roundedRect(x, y, w, h, r, r, "F"); } else { doc.rect(x, y, w, h, "F"); }
          doc.setTextColor(txtc[0], txtc[1], txtc[2]);
          doc.text(label, x + w/2, y + h/2 + 3, { align: "center", baseline: "middle" });

          x += w + gap;
        };

        const maxTokens = 10;
        const show = tokens.slice(0, maxTokens);
        show.forEach(t => drawToken(t, t.letter || ""));
        if(tokens.length > maxTokens){
          drawToken({ tone: "sat-gray" }, "+" + (tokens.length - maxTokens));
        }

        doc.setTextColor(0,0,0);
        doc.setFontSize(prevFs);
      }
    });

    // Footer: total filas
    const endY = doc.lastAutoTable ? doc.lastAutoTable.finalY : y0;
    doc.setFontSize(9);
    doc.setTextColor(80);
    doc.text(`Filas: ${b.rows}`, marginX, endY + 14);
    doc.setTextColor(0);
  });

  const now = new Date();
  // Formato solicitado: YYYYMMDD (sin guiones)
  const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
  doc.save(`reportes_${stamp}.pdf`);
}

// Inicializar al cargar
document.addEventListener("DOMContentLoaded", () => {
  // si existe botón de navegación, no altera la vista inicial
  const nav = document.getElementById("nav-reports");
  if(nav){
    // nada adicional aquí
  }
});

function showFAMsg(msg, isWarn){
  const box = document.getElementById("faMsg");
  const boxStart = document.getElementById("df03StartMsg");

  const apply = (el) => {
    if(!el) return;
    el.classList.remove("hidden");
    el.classList.toggle("warn", !!isWarn);
    el.classList.toggle("ok", !isWarn);
    el.innerHTML = msg;
  };

  apply(box);
  apply(boxStart);
}

function clearFAMsg(){
  const box = document.getElementById("faMsg");
  const boxStart = document.getElementById("df03StartMsg");
  [box, boxStart].forEach(el => {
    if(!el) return;
    el.classList.add("hidden");
    el.innerHTML = "";
  });
}

function setDF03Progress(pct, label){
  const p = Math.max(0, Math.min(100, Math.round(pct)));

  const apply = (wrapId, barId, txtId, labId) => {
    const wrap = document.getElementById(wrapId);
    const bar = document.getElementById(barId);
    const txt = document.getElementById(txtId);
    const lab = document.getElementById(labId);
    if(!wrap || !bar || !txt || !lab) return;

    wrap.classList.remove("hidden");
    bar.value = p;
    txt.textContent = p + "%";
    lab.textContent = label || "Procesando DF-03...";
    if(p >= 100){
      setTimeout(() => wrap.classList.add("hidden"), 800);
    }
  };

  apply("df03ProgressWrap", "df03ProgressBar", "df03ProgressText", "df03ProgressLabel");
  apply("df03ProgressWrapStart", "df03ProgressBarStart", "df03ProgressTextStart", "df03ProgressLabelStart");
}

function updateDF03Pill(filesCount, rowsCount){
  const n = filesCount || 0;
  const r = rowsCount || 0;

  const setTxt = (filesId, rowsId) => {
    const filesTxt = document.getElementById(filesId);
    const rowsTxt = document.getElementById(rowsId);
    if(filesTxt) filesTxt.textContent = `${n} archivo${n === 1 ? "" : "s"}`;
    if(rowsTxt) rowsTxt.textContent = `${fmtNum(r)} fila${r === 1 ? "" : "s"}`;
  };

  setTxt("df03FilesTxt", "df03RowsTxt");
  setTxt("df03FilesTxtStart", "df03RowsTxtStart");

  const pill = document.getElementById("df03Pill");
  if(pill && !document.getElementById("df03FilesTxt") && !document.getElementById("df03RowsTxt")){
    pill.style.display = "inline-flex";
    pill.innerHTML = `<span class="miniDot"></span> ${n} archivo(s) · ${fmtNum(r)} filas`;
  }
}

function setFAConsultaEnabled(enabled){
  const fichaInp = document.getElementById("faFichaInput");
  const btn = document.getElementById("btnFaBuscar");
  const lock = document.getElementById("faConsultaLock");
  const row = document.getElementById("faConsultaRow");

  if(fichaInp) fichaInp.disabled = !enabled;
  if(btn) btn.disabled = !enabled;
  if(row) row.classList.toggle("disabled", !enabled);
  if(lock) lock.style.display = enabled ? "none" : "flex";
}

function renderDF03FileChips(files){
  const arr = Array.isArray(files) ? files : [];

  const renderTo = (id) => {
    const box = document.getElementById(id);
    if(!box) return;

    if(!arr.length){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    box.style.display = "flex";
    box.innerHTML = arr.map(f => {
      const name = (f && f.name) ? f.name : "archivo.xml";
      return `<span class="df03-filechip" title="${escapeHtml(name)}">📄 <span class="name">${escapeHtml(name)}</span></span>`;
    }).join("");
  };

  renderTo("df03FileChips");
  renderTo("df03FileChipsStart");
}

function decodeXmlEntities(s){
  // SpreadsheetML puede traer entidades HTML básicas
  return String(s || "")
    .replace(/&lt;/g,"<")
    .replace(/&gt;/g,">")
    .replace(/&quot;/g,'"')
    .replace(/&apos;/g,"'")
    .replace(/&amp;/g,"&");
}

function parseRowCellsFromXML(rowXml){
  // Extrae celdas y densifica por ss:Index para mantener posiciones
  const cells = [];
  let cur = 0;
  const re = /<Cell\b([^>]*)>([\s\S]*?)<\/Cell>/g;
  let m;
  while((m = re.exec(rowXml)) !== null){
    const attr = m[1] || "";
    const body = m[2] || "";
    const idxM = attr.match(/(?:ss:Index|Index)="(\d+)"/);
    if(idxM){
      cur = parseInt(idxM[1],10) - 1;
    }
    const dM = body.match(/<Data\b[^>]*>([\s\S]*?)<\/Data>/);
    const raw = dM ? decodeXmlEntities(dM[1]).trim() : "";
    cells[cur] = raw;
    cur++;
  }
  return cells;
}

function isDF03HeaderRow(cells){
  if(!cells || cells.length < 10) return false;
  const c0 = normNoAccents(cells[0] || "");
  const c14 = normNoAccents(cells[14] || "");
  const c21 = normNoAccents(cells[21] || "");
  return c0 === "CODIGO_REGIONAL" && c14 === "FICHA" && c21 === "COMPETENCIA";
}

function buildDF03HeaderIndex(cells){
  const idx = {};
  (cells || []).forEach((h, i) => {
    const k = normNoAccents(h || "").replace(/\s+/g,"_");
    if(!k) return;
    idx[k] = i;
  });
  return idx;
}

function df03Get(cells, idx, key, fallbackIndex){
  // key en forma normalizada (ej. FICHA, PROGRAMA, COMPETENCIA)
  const k = normNoAccents(key || "").replace(/\s+/g,"_");
  const pos = (idx && idx[k] !== undefined) ? idx[k] : fallbackIndex;
  return (pos !== undefined && pos !== null) ? (cells[pos] || "") : "";
}

function evalBucket(v){
  const t = normNoAccents(v);
  if(!t) return "SIN_DATO";
  if(t.includes("PENDIENTE")) return "PENDIENTE";
  if(t.includes("APROB")) return "APROBADO";
  if(t.includes("NO_APRO") || t.includes("NO APRO")) return "NO_APROBADO";
  return "OTRO";
}

function ensureFichaAgg(ficha){
  let agg = DF03_STATE.fichasMap.get(ficha);
  if(!agg){
    agg = {
      ficha,
      meta: {},
      stats: {rows:0, aprob:0, pend:0, noap:0, otro:0, sind:0},
      comp: new Map(),   // competencia -> {total, aprob, pend, noap, otro, sind}
      apr: new Map()     // doc -> {doc, nombre, apellidos, telMovil, telPrincipal, convenio, empresa, dir, pend, aprob, total}
    };
    DF03_STATE.fichasMap.set(ficha, agg);
  }
  return agg;
}

function normalizePhone(raw){
  const d = String(raw || "").replace(/\D/g,"");
  if(!d) return "";
  // Caso estándar Colombia: 57 + 10 dígitos
  if(d.startsWith("57") && d.length >= 12) return d.slice(0,12);
  // Si viene con prefijos largos, conservar últimos 10 dígitos
  if(d.length >= 10) return d.slice(-10);
  return d;
}

function toWhatsAppPhone(raw){
  const d0 = String(raw || "").replace(/\D/g,"");
  if(!d0) return "";
  if(d0.startsWith("57") && d0.length >= 12) return d0.slice(0,12);
  const last10 = d0.length >= 10 ? d0.slice(-10) : d0;
  return (last10.length === 10) ? ("57" + last10) : last10;
}

function buildWhatsAppLink(telMovil, message){
  const phone = toWhatsAppPhone(telMovil);
  if(!phone) return "";
  const msg = (message || "").trim();
  const url = msg
    ? `https://api.whatsapp.com/send?phone=${encodeURIComponent(phone)}&text=${encodeURIComponent(msg)}`
    : `https://api.whatsapp.com/send?phone=${encodeURIComponent(phone)}`;
  return url;
}

async function loadDF03Files(files, opts){
  opts = opts || {};
  const append = !!opts.append;
  const label = opts.label || "";

  if(DF03_STATE.loading) return;
  DF03_STATE.loading = true;
  if(!append){
    DF03_STATE.loaded = false;
    DF03_STATE.fichasMap = new Map();
    DF03_STATE.headerIdx = null;
    DF03_STATE.loadedFileMeta = [];
    DF03_STATE.totalRowsCount = 0;
  }
  if(!DF03_STATE.loadedFileMeta) DF03_STATE.loadedFileMeta = [];
  if(DF03_STATE.totalRowsCount === undefined || DF03_STATE.totalRowsCount === null) DF03_STATE.totalRowsCount = 0;


  // UI
  setFAConsultaEnabled(false);
  // Track archivos cargados (para chips)
  try{
    for(const f of (files||[])){
      const nm = (f && f.name) ? String(f.name) : "";
      if(!nm) continue;
      if(!DF03_STATE.loadedFileMeta.some(x => x.name === nm)) DF03_STATE.loadedFileMeta.push({name:nm, size:(f.size||0)});
    }
  }catch(e){}

  renderDF03FileChips(DF03_STATE.loadedFileMeta);
  if(!append) clearFAMsg();
  showFAMsg((label ? ("Procesando " + label + ". ") : "Procesando DF-03. ") + "En archivos grandes, el navegador puede tardar unos minutos.", false);

  const totalBytes = files.reduce((s,f)=> s + (f.size || 0), 0) || 1;
  let bytesRead = 0;
  let rowsCount = 0;

  for(let i=0; i<files.length; i++){
    const f = files[i];
    const label = `Procesando DF-03 (${i+1}/${files.length}) · ${f.name}`;
    setDF03Progress((bytesRead/totalBytes)*100, label);

    const res = await parseDF03FileStream(f, (deltaBytes, addedRows) => {
      bytesRead += (deltaBytes || 0);
      rowsCount += (addedRows || 0);
      const pct = (bytesRead/totalBytes)*100;
      setDF03Progress(pct, label);
    });
  }

  DF03_STATE.loading = false;
  DF03_STATE.loaded = true;
      
  try{ DF03_STATE._rev = (DF03_STATE._rev||0)+1; }catch(e){}
DF03_STATE.lastResultCount = 0;
      refreshNavBadges();

  DF03_STATE.totalRowsCount += (rowsCount || 0);
  updateDF03Pill((DF03_STATE.loadedFileMeta||[]).length, DF03_STATE.totalRowsCount || 0);
  showFAMsg(`✅ DF-03 cargado: ${DF03_STATE.fichasMap.size} fichas indexadas.`, false);
  setDF03Progress(100, "Listo");
  setFAConsultaEnabled(true);
}

async function parseDF03FileStream(file, onProgress){
  // Streaming (preferido). Si el navegador no soporta streams, fallback a FileReader.
  let addedRows = 0;
  let bytesRead = 0;
  const size = file.size || 0;

  const processRow = (cells) => {
    if(!cells || !cells.length) return;
    // Encabezado opcional: si no se detecta, se procesa por posición fija (fallbackIndex).
    // Esto evita que el DF-03 quede vacío cuando el XML no trae encabezados estándar.
    if(DF03_STATE.headerIdx == null){
      if(isDF03HeaderRow(cells)){
        DF03_STATE.headerIdx = buildDF03HeaderIndex(cells);
        return; // saltar fila de encabezados
      }
      // Heurística de fila de datos: debe traer FICHA (col 14) y COMPETENCIA (col 21)
      const _f = normalizeFicha(cells[14] || "");
      const _c = String(cells[21] || "").trim();
      if(_f && _c){
        DF03_STATE.headerIdx = {}; // modo fallback por índice fijo
      }else{
        return;
      }
    }

    // Leer campos con índices por encabezado + fallback fijo (según tabla)
    const idx = DF03_STATE.headerIdx;

    const ficha = normalizeFicha(df03Get(cells, idx, "FICHA", 14));
    if(!ficha) return;

    const tipoDoc = String(df03Get(cells, idx, "TIPO_DOCUMENTO", 4) || df03Get(cells, idx, "TIPO_DE_DOCUMENTO", 4) || "").trim();
    const doc = String(df03Get(cells, idx, "NUMERO_DOCUMENTO", 5) || "").trim();
    const nombre = String(df03Get(cells, idx, "NOMBRE", 6) || "").trim();
    const pa = String(df03Get(cells, idx, "PRIMER_APELLIDO", 7) || "").trim();
    const sa = String(df03Get(cells, idx, "SEGUNDO_APELLIDO", 8) || "").trim();
    const apellidos = [pa, sa].filter(Boolean).join(" ");

    const telMovil = String(df03Get(cells, idx, "TEL_MOVIL", 13) || "").trim();
    const telPrinc = String(df03Get(cells, idx, "TEL_PRINCIPAL", 12) || "").trim();

    const programa = String(df03Get(cells, idx, "PROGRAMA", 20) || "").trim();
    const competencia = String(df03Get(cells, idx, "COMPETENCIA", 21) || "").trim();
    const evaluacion = String(df03Get(cells, idx, "EVALUACION_DE_COMPETENCIA", 22) || "").trim();

    const regional = String(df03Get(cells, idx, "REGIONAL", 1) || "").trim();
    const sede = String(df03Get(cells, idx, "SEDE", 3) || "").trim();
    const convenio = String(df03Get(cells, idx, "CONVENIO", 9) || "").trim();
    const empresa = String(df03Get(cells, idx, "EMPRESA", 10) || "").trim();
    const dir = String(df03Get(cells, idx, "DIR_RESIDENCIA", 11) || "").trim();

    const fin = String(df03Get(cells, idx, "FECHA_FINAL_FICHA", 16) || "").trim();
    const ini = String(df03Get(cells, idx, "FECHA_INICIAL_FICHA", 15) || "").trim();
    const codProg = String(df03Get(cells, idx, "CODIGO_PROGRAMA", 17) || "").trim();
    const version = String(df03Get(cells, idx, "VERSION", 18) || "").trim();
    const durMax = String(df03Get(cells, idx, "DURACION_MAXIMA_PROGRAMA", 19) || "").trim();

    const agg = ensureFichaAgg(ficha);

    // meta (primera vez)
    if(!agg.meta.programa && programa) agg.meta.programa = programa;
    if(!agg.meta.regional && regional) agg.meta.regional = regional;
    if(!agg.meta.sede && sede) agg.meta.sede = sede;
    if(!agg.meta.convenio && convenio) agg.meta.convenio = convenio;
    if(!agg.meta.empresa && empresa) agg.meta.empresa = empresa;
    if(!agg.meta.fechaInicio && ini) agg.meta.fechaInicio = ini;
    if(!agg.meta.fechaFin && fin) agg.meta.fechaFin = fin;
    if(!agg.meta.codigoPrograma && codProg) agg.meta.codigoPrograma = codProg;
    if(!agg.meta.version && version) agg.meta.version = version;
    if(!agg.meta.duracionMaxima && durMax) agg.meta.duracionMaxima = durMax;

    // stats
    agg.stats.rows += 1;
    addedRows += 1;

    const bucket = evalBucket(evaluacion);
    if(bucket === "PENDIENTE") agg.stats.pend += 1;
    else if(bucket === "APROBADO") agg.stats.aprob += 1;
    else if(bucket === "NO_APROBADO") agg.stats.noap += 1;
    else if(bucket === "SIN_DATO") agg.stats.sind += 1;
    else agg.stats.otro += 1;

    // competencia
    if(competencia){
      let c = agg.comp.get(competencia);
      if(!c){
        c = {competencia, total:0, aprob:0, pend:0, noap:0, otro:0, sind:0};
        agg.comp.set(competencia, c);
      }
      c.total += 1;
      if(bucket === "PENDIENTE") c.pend += 1;
      else if(bucket === "APROBADO") c.aprob += 1;
      else if(bucket === "NO_APROBADO") c.noap += 1;
      else if(bucket === "SIN_DATO") c.sind += 1;
      else c.otro += 1;
    }

    // aprendiz
    if(doc){
      const docKey = (tipoDoc && doc) ? (tipoDoc + ":" + doc) : doc;
      let a = agg.apr.get(docKey);
      if(!a){
        a = {tipoDoc, doc, nombre, apellidos, telMovil, telPrincipal: telPrinc, convenio, empresa, dir, total:0, pend:0, aprob:0, noap:0};
        agg.apr.set(docKey, a);
      }else{
        // Completar datos si vienen vacíos
        if(!a.tipoDoc && tipoDoc) a.tipoDoc = tipoDoc;
        if(!a.doc && doc) a.doc = doc;
        if(!a.nombre && nombre) a.nombre = nombre;
        if(!a.apellidos && apellidos) a.apellidos = apellidos;
        if(!a.telMovil && telMovil) a.telMovil = telMovil;
        if(!a.telPrincipal && telPrinc) a.telPrincipal = telPrinc;
        if(!a.convenio && convenio) a.convenio = convenio;
        if(!a.empresa && empresa) a.empresa = empresa;
        if(!a.dir && dir) a.dir = dir;
      }
      a.total += 1;
      if(bucket === "APROBADO") a.aprob += 1;
      else if(bucket === "NO_APROBADO") a.noap += 1;
      else a.pend += 1; // PENDIENTE + SIN_DATO + OTRO -> pendiente
    }
  };

  const fallbackReadAll = async () => {
    const text = await readFileAsync(file);
    const all = String(text || "");
    let buf = all;
    let localRows = 0;
    while(true){
      const s = buf.indexOf("<Row");
      if(s < 0) break;
      const e = buf.indexOf("</Row>", s);
      if(e < 0) break;
      const rowXml = buf.slice(s, e+6);
      buf = buf.slice(e+6);
      const cells = parseRowCellsFromXML(rowXml);
      processRow(cells);
      localRows += 1;
      if(localRows % 2000 === 0){
        if(onProgress) onProgress(size / Math.max(1, (all.length/2000)) , 0); // aproximación
      }
    }
  };

  try{
    if(file.stream && typeof TextDecoderStream !== "undefined"){
      const reader = file.stream().pipeThrough(new TextDecoderStream()).getReader();
      let buf = "";
      bytesRead = 0;
      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        const chunk = value || "";
        buf += chunk;
        bytesRead += chunk.length; // aproximación bytes (utf-16 vs utf-8), suficiente para progreso relativo

        // Procesar filas completas
        while(true){
          const s = buf.indexOf("<Row");
          if(s < 0){
            // mantener cola para evitar crecimiento
            if(buf.length > 2_000_000) buf = buf.slice(-1_000_000);
            break;
          }
          const e = buf.indexOf("</Row>", s);
          if(e < 0){
            if(s > 0) buf = buf.slice(s);
            break;
          }
          const rowXml = buf.slice(s, e+6);
          buf = buf.slice(e+6);
          const cells = parseRowCellsFromXML(rowXml);
          processRow(cells);
        }

        if(onProgress) onProgress(chunk.length, 0);
      }
    }else{
      await fallbackReadAll();
    }
  }catch(e){
    console.error("Error parseando DF-03:", file?.name, e);
    showFAMsg("❌ Error procesando DF-03. Verifica que el archivo sea el XML (Excel 2003) descargado de SofíaPlus.", true);
  }

  // Progreso final del archivo
  if(onProgress){
    const remaining = Math.max(0, (file.size||0) - (bytesRead||0));
    if(remaining) onProgress(remaining, 0);
    if(addedRows) onProgress(0, addedRows);
  }
  return {addedRows};
}

function renderFichaAcumulativaView(){
  // UI toggles
  const tools = document.getElementById("tableTools");
  const fa = document.getElementById("faArea");
  const charts = document.getElementById("chartsArea");
  const tbl = document.querySelector("#reportCard .table-container");
  const gen = document.getElementById("faGeneralArea");
  const faTools = document.getElementById("faAprTools");

  if(tools) tools.style.display = "none";
  if(fa) fa.classList.remove("hidden");
  if(tbl) tbl.style.display = "none";

  var excelBtn = document.querySelector('#reportCard button.btn[onclick="exportTable()"]');
  if(excelBtn) excelBtn.style.display = "none";

  // Charts se usarán para este módulo (se muestran tras la consulta)
  if(charts){
    charts.style.display = "none";
    charts.innerHTML = "";
  }
  destroyCharts();

  // KPI area se mantiene visible, pero limpio
  const kpi = document.getElementById("kpiArea");
  if(kpi) kpi.innerHTML = "";

  if(gen){
    gen.classList.add("hidden");
    gen.innerHTML = "";
  }
  if(faTools){
    faTools.classList.add("hidden");
    const s = document.getElementById("faAprSearch");
    if(s) s.value = "";
    const c = document.getElementById("faAprCounts");
    if(c) c.innerHTML = "";
  }

  // Mensaje contextual
  if(!DF03_STATE.loaded && !DF03_STATE.loading){
    showFAMsg("Carga los archivos DF-03 (1 a 5) para habilitar la consulta.", true);
    updateDF03Pill(0,0);
  }

  // Excel button: deshabilitar (export especializado se puede añadir después)
  var excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");
  if(excelBtn) excelBtn.style.display = "none";
}

function hideFichaAcumulativaView(){
  const tools = document.getElementById("tableTools");
  const fa = document.getElementById("faArea");
  const tbl = document.querySelector("#reportCard .table-container");
  const charts = document.getElementById("chartsArea");
  const gen = document.getElementById("faGeneralArea");
  const faTools = document.getElementById("faAprTools");

  var excelBtn = document.querySelector("#reportCard button.btn[onclick=\"exportTable()\"]");

  if(tools) tools.style.display = "block";
  if(fa) fa.classList.add("hidden");
  if(tbl) tbl.style.display = "block";
  if(excelBtn) excelBtn.style.display = "inline-block";

  if(charts){
    charts.style.display = "grid";
  }

  if(gen){
    gen.classList.add("hidden");
    gen.innerHTML = "";
  }
  if(faTools){
    faTools.classList.add("hidden");
  }
}

function faAprOverallStatus(a){
  const pend = (a && a.pend) ? a.pend : 0;
  const noap = (a && a.noap) ? a.noap : 0;
  const aprob = (a && a.aprob) ? a.aprob : 0;
  if(pend > 0) return "PENDIENTE POR EVALUAR";
  if(noap > 0) return "NO APROBADO";
  if(aprob > 0) return "APROBADO";
  return "PENDIENTE POR EVALUAR";
}

function waPhoneFromTelPrincipal(raw){
  const d = String(raw || "").replace(/\D/g,"");
  if(!d) return "";
  if(d.startsWith("57") && d.length >= 12) return d.slice(0,12);
  if(d.startsWith("3") && d.length === 10) return "57" + d;
  return "";
}

function buildWhatsAppWebLinkFromTel(rawTel, message){
  const phone = waPhoneFromTelPrincipal(rawTel);
  if(!phone) return "";
  const msg = String(message || "").trim();
  const base = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phone)}`;
  return msg ? `${base}&text=${encodeURIComponent(msg)}` : base;
}

function renderFAAprTable(){
  const tblWrap = document.querySelector("#reportCard .table-container");
  const head = document.getElementById("tableHead");
  const body = document.getElementById("tableBody");
  const tools = document.getElementById("faAprTools");
  const countsBox = document.getElementById("faAprCounts");
  if(!tblWrap || !head || !body || !tools) return;

  const allRows = Array.isArray(DF03_STATE.currentAprRows) ? DF03_STATE.currentAprRows : [];
  const inp = document.getElementById("faAprSearch");
  const q = String(inp ? inp.value : "").trim().toLowerCase();
  DF03_STATE.aprSearchQ = q;

  const filtered = q ? allRows.filter(r => {
    const hay = `${r.tipoDoc||""} ${r.doc||""} ${r.nombre||""} ${r.tel||""}`.toLowerCase();
    return hay.includes(q);
  }) : allRows;

  // Totales (sobre el conjunto filtrado, independiente del orden/página)
  const totals = {pend:0, aprob:0, noap:0, total:0};
  filtered.forEach(r => {
    totals.pend += (Number(r.pend) || 0);
    totals.aprob += (Number(r.aprob) || 0);
    totals.noap += (Number(r.noap) || 0);
    totals.total += (Number(r.total) || ((Number(r.pend)||0) + (Number(r.aprob)||0) + (Number(r.noap)||0)));
  });

  // ===== Ordenamiento (A–Z / Z–A) =====
  const sortKey = String(DF03_STATE.faSortKey || "");
  const sortDir = (DF03_STATE.faSortDir === -1) ? -1 : 1;

  const getSortVal = (r, key) => {
    if(!r) return "";
    switch(key){
      case "tipoDoc": return r.tipoDoc || "";
      case "doc": return r.doc || "";
      case "nombre": return r.nombre || "";
      case "tel": return r.tel || "";
      case "aprob": return Number(r.aprob) || 0;
      case "pend": return Number(r.pend) || 0;
      case "noap": return Number(r.noap) || 0;
      case "total": return Number(r.total) || ((Number(r.pend)||0) + (Number(r.aprob)||0) + (Number(r.noap)||0));
      default: return "";
    }
  };

  const sorted = filtered.slice();
  if(sortKey){
    // estable: preserva orden original cuando hay empate
    const withIdx = sorted.map((r, idx) => ({r, idx}));
    withIdx.sort((A, B) => {
      const a = getSortVal(A.r, sortKey);
      const b = getSortVal(B.r, sortKey);

      // numérico
      if(typeof a === "number" || typeof b === "number"){
        const an = Number(a) || 0;
        const bn = Number(b) || 0;
        if(an !== bn) return (an - bn) * sortDir;
        return (A.idx - B.idx);
      }

      // texto (sin tildes)
      const as = normNoAccents(String(a)).toLowerCase();
      const bs = normNoAccents(String(b)).toLowerCase();
      const cmp = as.localeCompare(bs, "es", {sensitivity:"base"});
      if(cmp !== 0) return cmp * sortDir;
      return (A.idx - B.idx);
    });
    for(let i=0;i<withIdx.length;i++) sorted[i] = withIdx[i].r;
  }

  // ===== Paginación (15 por página) =====
  const pageSize = 15;
  const pageKey = "r19_fa_apr"; // clave propia para no interferir con otras tablas
  const totalRows = sorted.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
  const curPageRaw = Number(TABLE_PAGE_STATE[pageKey] || 1);
  const p = Math.min(Math.max(1, curPageRaw), totalPages);
  TABLE_PAGE_STATE[pageKey] = p;

  const startIdx = (p - 1) * pageSize;
  const showRows = sorted.slice(startIdx, startIdx + pageSize);

  // Pager especializado (no usa renderTable)
  const renderFAPager = (totalRows, page, pageSize) => {
    const el = document.getElementById("mainTablePager");
    if(!el) return;

    const totalPages = Math.max(1, Math.ceil((totalRows || 0) / pageSize));
    const p = Math.min(Math.max(1, page), totalPages);
    TABLE_PAGE_STATE[pageKey] = p;

    if(totalPages <= 1){
      el.innerHTML = "";
      el.style.display = "none";
      return;
    }

    const from = totalRows ? ((p - 1) * pageSize + 1) : 0;
    const to = Math.min(p * pageSize, totalRows);

    let view = [];
    if(totalPages <= 9){
      for(let i=1;i<=totalPages;i++) view.push(i);
    }else{
      const keep = new Set([1,2,totalPages-1,totalPages,p-1,p,p+1]);
      const left = Math.max(1, p - 2);
      const right = Math.min(totalPages, p + 2);
      for(let i=left; i<=right; i++) keep.add(i);

      const compact = [];
      const sortedKeep = Array.from(keep).filter(x=>x>=1 && x<=totalPages).sort((a,b)=>a-b);
      let prev = null;
      for(const x of sortedKeep){
        if(prev != null && x - prev > 1) compact.push("…");
        compact.push(x);
        prev = x;
      }
      view = compact;
    }

    const btn = (label, target, disabled, active) => {
      if(label === "…") return `<span class="ellipsis">…</span>`;
      const cls = active ? "active" : "";
      const dis = disabled ? "disabled" : "";
      const t = String(target);
      return `<button type="button" class="${cls}" data-tpage="${escHtml(t)}" ${dis}>${escHtml(String(label))}</button>`;
    };

    const htmlPages = view.map(x => btn(x, x, false, x === p)).join("");

    el.innerHTML = `
      <div class="meta">Mostrando ${fmtNum(from)}–${fmtNum(to)} de ${fmtNum(totalRows)}</div>
      <div class="pages">
        ${btn("Anterior", p-1, p<=1, false)}
        ${htmlPages}
        ${btn("Siguiente", p+1, p>=totalPages, false)}
      </div>
    `;

    el.style.display = "flex";

    el.querySelectorAll('button[data-tpage]').forEach(b => {
      b.addEventListener("click", () => {
        const t = b.getAttribute("data-tpage");
        const n = parseInt(t, 10);
        if(!isFinite(n)) return;
        const next = Math.min(Math.max(1, n), totalPages);
        TABLE_PAGE_STATE[pageKey] = next;
        renderFAAprTable();
      });
    });
  };

  renderFAPager(totalRows, p, pageSize);

  tools.classList.remove("hidden");
  tblWrap.style.display = "block";

  // Caption tipo tabla dinámica
  let cap = document.getElementById("faPivotCaption");
  if(!cap){
    cap = document.createElement("div");
    cap.id = "faPivotCaption";
    cap.className = "pivot-caption";
    tools.appendChild(cap);
  }
  cap.textContent = "Cuenta de EVALUACION_DE_COMPETENCIA (por aprendiz) — vista tipo tabla dinámica";

  const arrow = (key) => (sortKey === key) ? ` <span class="sort-ind">${sortDir === 1 ? "▲" : "▼"}</span>` : "";

  head.innerHTML = `
    <tr class="pivot-head">
      <th class="ctr" style="width:52px;">#</th>
      <th class="ctr" style="width:54px; cursor:pointer;" data-sort="tipoDoc">TD${arrow("tipoDoc")}</th>
      <th style="width:130px; cursor:pointer;" data-sort="doc">NUMERO_DOCUMENTO${arrow("doc")}</th>
      <th style="width:280px; cursor:pointer;" data-sort="nombre">NOMBRE APRENDIZ${arrow("nombre")}</th>
      <th style="width:130px; cursor:pointer;" data-sort="tel">TEL_PRINCIPAL${arrow("tel")}</th>
      <th class="num" style="width:80px; cursor:pointer;" data-sort="aprob">APROBADO${arrow("aprob")}</th>
      <th class="num" style="width:120px; cursor:pointer;" data-sort="pend">PENDIENTE POR EVALUAR${arrow("pend")}</th>
      <th class="num" style="width:90px; cursor:pointer;" data-sort="noap">NO APROBADO${arrow("noap")}</th>
      <th class="num" style="width:90px; cursor:pointer;" data-sort="total">Total general${arrow("total")}</th>
    </tr>
  `;

  // Bind sort clicks
  head.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.getAttribute("data-sort") || "";
      if(!key) return;
      if(DF03_STATE.faSortKey === key){
        DF03_STATE.faSortDir = (DF03_STATE.faSortDir === 1) ? -1 : 1;
      }else{
        DF03_STATE.faSortKey = key;
        DF03_STATE.faSortDir = 1;
      }
      TABLE_PAGE_STATE[pageKey] = 1;
      renderFAAprTable();
    });
  });

  const rowsHtml = showRows.map((r, i) => {
    const rowNo = startIdx + i + 1;
    const telRaw = r.tel || "";
    const wa = buildWhatsAppWebLinkFromTel(telRaw, "");
    const telCell = wa
      ? `<a class="wa-btn" href="${wa}" target="_blank" rel="noopener">${escapeHtml(telRaw || waPhoneFromTelPrincipal(telRaw) || "WhatsApp")}</a>`
      : (telRaw ? escapeHtml(telRaw) : "—");

    const pend = Number(r.pend) || 0;
    const aprob = Number(r.aprob) || 0;
    const noap = Number(r.noap) || 0;
    const total = Number(r.total) || (pend + aprob + noap);

    return `
      <tr>
        <td class="ctr">${rowNo}</td>
        <td>${escapeHtml(r.tipoDoc || "")}</td>
        <td>${escapeHtml(r.doc || "")}</td>
        <td>${escapeHtml(r.nombre || "")}</td>
        <td>${telCell}</td>
        <td class="num">${fmtNum(aprob)}</td>
        <td class="num">${fmtNum(pend)}</td>
        <td class="num">${fmtNum(noap)}</td>
        <td class="num"><b>${fmtNum(total)}</b></td>
      </tr>
    `;
  }).join("");

  const totalRowHtml = `
    <tr class="pivot-total">
      <td colspan="5"><b>Total general</b></td>
      <td class="num"><b>${fmtNum(totals.aprob)}</b></td>
      <td class="num"><b>${fmtNum(totals.pend)}</b></td>
      <td class="num"><b>${fmtNum(totals.noap)}</b></td>
      <td class="num"><b>${fmtNum(totals.total)}</b></td>
    </tr>
  `;

  body.innerHTML = rowsHtml + totalRowHtml;

  if(countsBox){
    countsBox.innerHTML = `
      <span class="pill"><b>Aprendices:</b> ${fmtNum(filtered.length)}</span>
      <span class="pill"><b>Aprobados:</b> ${fmtNum(totals.aprob)}</span>
      <span class="pill"><b>Pendientes:</b> ${fmtNum(totals.pend)}</span>
      <span class="pill"><b>No aprobados:</b> ${fmtNum(totals.noap)}</span>
      <span class="pill"><b>Total:</b> ${fmtNum(totals.total)}</span>
    `;
  }
}



function renderFAForFicha(ficha){
  clearFAMsg();

  // Reset visual de áreas
  const chartsArea = document.getElementById("chartsArea");
  if(chartsArea){
    chartsArea.style.display = "none";
    chartsArea.innerHTML = "";
  }
  destroyCharts();

  const faTools = document.getElementById("faAprTools");
  if(faTools) faTools.classList.add("hidden");

  const tblWrap = document.querySelector("#reportCard .table-container");
  if(tblWrap) tblWrap.style.display = "none";

  const kpi = document.getElementById("kpiArea");
  if(kpi) kpi.innerHTML = "";

  const gen = document.getElementById("faGeneralArea");
  if(gen){
    gen.classList.add("hidden");
    gen.innerHTML = "";
  }

  const res = document.getElementById("faResults");
  if(res){
    res.classList.remove("hidden");
    res.innerHTML = "";
  }

  if(!DF03_STATE.loaded){
    DF03_STATE.lastResultCount = 0;
    refreshNavBadges();
    showFAMsg("⚠️ Primero carga DF-03 (1 a 5 archivos).", true);
    return;
  }
  if(!ficha){
    DF03_STATE.lastResultCount = 0;
    refreshNavBadges();
    showFAMsg("⚠️ Escribe un número de ficha válido.", true);
    return;
  }

  const agg = DF03_STATE.fichasMap.get(ficha);
  if(!agg){
    DF03_STATE.lastResultCount = 0;
    refreshNavBadges();
    showFAMsg(`⚠️ La ficha ${escapeHtml(ficha)} no existe en los DF-03 cargados.`, true);
    return;
  }

  DF03_STATE.currentFicha = ficha;

  const meta = agg.meta || {};
  const comps = Array.from(agg.comp.keys() || []).filter(Boolean).sort((a,b)=> a.localeCompare(b,"es",{sensitivity:"base"}));

  // Datos base del reporte general (DF-49/DF-14A) si está disponible
  const base = (Array.isArray(RAW_DATA) ? RAW_DATA.find(x => normalizeFicha(x.ficha) === ficha) : null);
  let extraChips = "";
  if(base){
    const matBase = base.matriculados || 0;
    const sinJBase = base.aprendicesSinJuicio || 0;
    const pctJuicioBase = matBase > 0 ? Math.round(((matBase - sinJBase) / matBase) * 100) : 100;
    const retBase = matBase > 0 ? Math.round(((base.activos || 0) / matBase) * 100) : 0;
    const cutoff = (document.getElementById("cutoffDate") && document.getElementById("cutoffDate").valueAsDate) ? document.getElementById("cutoffDate").valueAsDate : new Date();
    const risk = calculateRiskScore(base, cutoff);
    extraChips = `
      ${base.estado ? `<span class="fa-chip"><b>Estado (DF-49/DF-14A):</b> ${escapeHtml(base.estado)}</span>` : ``}
      ${base.responsable ? `<span class="fa-chip"><b>Responsable:</b> ${escapeHtml(base.responsable)}</span>` : ``}
      <span class="fa-chip"><b>Matriculados:</b> ${fmtNum(matBase)}</span>
      <span class="fa-chip"><b>Activos:</b> ${fmtNum(base.activos || 0)}</span>
      <span class="fa-chip"><b>% Con juicio:</b> ${fmtNum(pctJuicioBase)}%</span>
      <span class="fa-chip"><b>Retención %:</b> ${fmtNum(retBase)}%</span>
      <span class="fa-chip"><b>SAT Score:</b> ${fmtNum(risk.score)}</span>
    `;
  }

  const faProgName = (meta.programa || (base && base.programa) || ("Ficha " + ficha));
  const faEstado = (base && base.estado) ? String(base.estado).trim() : "";
  const faSubParts = [];
  faSubParts.push("Ficha " + ficha);
  if(meta.regional) faSubParts.push(meta.regional);
  if(meta.sede) faSubParts.push(meta.sede);
  if(meta.version) faSubParts.push("Versión " + meta.version);
  const faSubline = faSubParts.join(" • ");

  const dIniFA = parseDateLoose(meta.fechaInicio || "");
  const dFinFA = parseDateLoose(meta.fechaFin || "");
  let faProgressPct = 0;
  if(dIniFA && dFinFA && dFinFA.getTime() > dIniFA.getTime()){
    const now = new Date();
    const ratio = (now.getTime() - dIniFA.getTime()) / (dFinFA.getTime() - dIniFA.getTime());
    faProgressPct = Math.round(Math.max(0, Math.min(1, ratio)) * 100);
  } else {
    faProgressPct = 0;
  }

  const faMat = base ? (base.matriculados || 0) : 0;
  const faAct = base ? (base.activos || 0) : 0;
  const faSinJ = base ? (base.aprendicesSinJuicio || 0) : 0;
  const faConJuicioPct = faMat > 0 ? Math.round(((faMat - faSinJ) / faMat) * 100) : 100;
  const faRetPct = faMat > 0 ? Math.round((faAct / faMat) * 100) : 0;



  // Bloque general arriba del stats-grid
  if(gen){
    gen.classList.remove("hidden");
    gen.innerHTML = `
      <div class="fa-general fa-general-v2">
        <div class="fa-hero">
          <div class="fa-hero-left" style="min-width:260px; flex:1;">
            <div class="fa-crumb">
              <span class="fa-badge">${escapeHtml(faEstado || "DF-03")}</span>
              <span>›</span>
              <span>DF-03</span>
            </div>
            <div class="fa-title-lg">${escapeHtml(faProgName || "—")}</div>
            <div class="fa-responsable">Responsable: ${escapeHtml(((base && base.responsable) ? String(base.responsable).trim() : "") || "—")}</div>
            <div class="fa-subline">${escapeHtml(faSubline || ("Ficha " + ficha))}</div>
          </div>

          <div class="fa-progress-card">
            <div class="fa-progress-top">
              <div class="t">Progreso del Programa</div>
              <div class="p">${fmtNum(faProgressPct)}%</div>
            </div>
            <div class="fa-progress-bar"><span style="width:${fmtNum(faProgressPct)}%"></span></div>
            <div class="fa-progress-dates">
              <div>${escapeHtml(meta.fechaInicio || "—")}</div>
              <div>${escapeHtml(meta.fechaFin || "—")}</div>
            </div>
          </div>
        </div>

        <div class="fa-kpi-row">
          <div class="fa-kpi-card">
            <div class="k">Aprendices Activos</div>
            <div class="v">${fmtNum(faAct)}</div>
            <div class="s">de ${fmtNum(faMat)} Matriculados</div>
            <div class="fa-kpi-mini"><span><b>${fmtNum(faRetPct)}%</b> Retención</span></div>
          </div>

          <div class="fa-kpi-card">
            <div class="k">Desempeño (% Con Juicio)</div>
            <div class="v">${fmtNum(faConJuicioPct)}%</div>
            <div class="s">${faConJuicioPct < 90 ? "Requiere atención" : "En rango"}</div>
          </div>

          <div class="fa-kpi-card">
            <div class="k">Total Registros (DF-03)</div>
            <div class="v">${fmtNum(agg.stats ? (agg.stats.rows || 0) : 0)}</div>
            <div class="fa-kpi-mini">
              <span><b>${fmtNum(agg.stats ? (agg.stats.aprob || 0) : 0)}</b> Aprobados</span>
              <span><b>${fmtNum(agg.stats ? (agg.stats.pend || 0) : 0)}</b> Pendientes</span>
            </div>
          </div>

          <div class="fa-kpi-card">
            <div class="k">Competencias</div>
            <div class="v">${fmtNum(agg.comp ? agg.comp.size : 0)}</div>
            <div class="s">Asignadas</div>
            <div class="fa-kpi-mini"><a href="#faCompDetails" class="link">Ver detalle →</a></div>
          </div>
        </div>

        <div class="fa-detail-grid">
          <div class="fa-detail-card">
            <div class="fa-detail-title"><span class="dot">i</span> Información Detallada</div>

            <details class="fa-details" id="faCompDetails" style="margin-top:12px;">
              <summary>Competencias del programa (${fmtNum(comps.length)})</summary>
              <div class="fa-tags">
                ${comps.slice(0, 260).map(c => `<span class="fa-tag">${escapeHtml(c)}</span>`).join("")}
                ${comps.length > 260 ? `<span class="fa-tag">+${fmtNum(comps.length - 260)} más</span>` : ``}
              </div>
            </details>
          </div>
        </div>
      </div>
    `;
  }

  // KPIs (stats-grid): ya se muestran en el bloque "Datos generales"
  if(kpi) kpi.innerHTML = "";

  // Charts
  if(chartsArea){
    chartsArea.style.display = "grid";
    const pend = agg.stats ? (agg.stats.pend || 0) : 0;
    const aprob = agg.stats ? (agg.stats.aprob || 0) : 0;
    const noap = agg.stats ? (agg.stats.noap || 0) : 0;
    const otros = agg.stats ? ((agg.stats.otro || 0) + (agg.stats.sind || 0)) : 0;

    chartsArea.innerHTML = `
      <div class="chart-card">
        <div class="chart-title">Distribución de evaluación (registros)</div>
        <div class="chart-wrap h240"><canvas id="faChart1"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Pendientes vs aprobados por competencia (Top 15, 100% apilado)</div>
        <div class="chart-wrap h240"><canvas id="faChart2"></canvas></div>
      </div>
    `;

    try{
      const ctx1 = document.getElementById("faChart1").getContext("2d");
      const ch1 = new Chart(ctx1, {
        type: "doughnut",
        data: {
          labels: ["PENDIENTE", "APROBADO", "NO APROBADO", "OTROS/SIN DATO"],
          datasets: [{ data: [pend, aprob, noap, otros] }]
        },
        options: { responsive:true, maintainAspectRatio:false }
      });
      CHART_INSTANCES.push(ch1);
      const compRows = Array.from(agg.comp.values() || [])
        .map(c => ({
          competencia: c.competencia,
          pend: c.pend || 0,
          aprob: c.aprob || 0
        }))
        .filter(x => (x.pend + x.aprob) > 0)
        .sort((a,b)=> b.pend - a.pend)
        .slice(0, 15);

      const pctAprob = compRows.map(x => {
        const t = x.pend + x.aprob;
        return t ? (x.aprob / t) * 100 : 0;
      });
      const pctPend = compRows.map(x => {
        const t = x.pend + x.aprob;
        return t ? (x.pend / t) * 100 : 0;
      });

      const ctx2 = document.getElementById("faChart2").getContext("2d");
      const ch2 = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: compRows.map(x => x.competencia),
          datasets: [
            { label: "APROBADO", data: pctAprob },
            { label: "PENDIENTE", data: pctPend }
          ]
        },
        options: {
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{
              stacked:true,
              min:0,
              max:100,
              ticks:{ callback:(v)=> v + "%" }
            },
            y:{ stacked:true }
          },
          plugins:{
            tooltip:{
              callbacks:{
                label:(ctx)=>{
                  const idx = ctx.dataIndex;
                  const row = compRows[idx] || {pend:0, aprob:0};
                  const total = (row.pend||0) + (row.aprob||0);
                  const raw = (ctx.dataset && ctx.dataset.label === "PENDIENTE") ? (row.pend||0) : (row.aprob||0);
                  const pct = (typeof ctx.parsed.x === "number") ? ctx.parsed.x : 0;
                  return `${ctx.dataset.label}: ${pct.toFixed(1)}% (${fmtNum(raw)} de ${fmtNum(total)})`;
                }
              }
            },
            legend:{ position:"bottom" }
          }
        }
      });
      CHART_INSTANCES.push(ch2);
    }catch(e){
      console.error("Error rendering DF-03 charts", e);
    }
  }

  // Semáforo de competencias (panel)
  const compList = Array.from(agg.comp.values() || []).map(c => {
    const total = c.total || 0;
    const pendC = c.pend || 0;
    const pct = total ? (pendC/total) : 0;
    let dot = "green", label = "OK";
    if(pendC > 0 && pct >= 0.30){ dot="red"; label="Crítico"; }
    else if(pendC > 0){ dot="amb"; label="Atención"; }
    return {
      competencia: c.competencia,
      total, pend: pendC, aprob: c.aprob||0,
      pct: total ? Math.round(pct*100) : 0,
      dot, label
    };
  }).sort((a,b)=> (b.pend - a.pend) || (b.pct - a.pct) || a.competencia.localeCompare(b.competencia,"es",{sensitivity:"base"}));

  const compHtml = `
    <div class="fa-panel" style="grid-column: 1 / -1;">
      <h4>Semáforo de competencias</h4>
      <div class="fa-list">
        ${compList.slice(0,200).map(c => `
          <div class="fa-item">
            <div class="t"><span class="fa-dot ${c.dot}"></span> ${escapeHtml(c.competencia)}</div>
            <div class="m">
              <span><b>${escapeHtml(c.label)}</b></span>
              <span>Pend: <b>${fmtNum(c.pend)}</b></span>
              <span>Aprob: <b>${fmtNum(c.aprob)}</b></span>
              <span>Total: <b>${fmtNum(c.total)}</b></span>
              <span>%Pend: <b>${fmtNum(c.pct)}%</b></span>
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `;

  if(res){
    res.innerHTML = `<div class="fa-grid">${compHtml}</div>`;
  }

  // Aprendices -> tabla bajo gráficas (con búsqueda)
  const aprRows = Array.from(agg.apr.values() || [])
    .map(a => {
      const nombreFull = [a.nombre || "", a.apellidos || ""].filter(Boolean).join(" ").trim();
      const pend = (a && a.pend) ? a.pend : 0;
      const aprob = (a && a.aprob) ? a.aprob : 0;
      const noap = (a && a.noap) ? a.noap : 0;
      const total = pend + aprob + noap;
      return {
        tipoDoc: a.tipoDoc || "",
        doc: a.doc || "",
        nombre: nombreFull || "",
        tel: a.telPrincipal || "",
        pend, aprob, noap, total
      };
    });

  const prio = r => (r && r.pend > 0) ? 0 : (r && r.noap > 0) ? 1 : 2;
  aprRows.sort((a,b)=> (prio(a) - prio(b)) || a.nombre.localeCompare(b.nombre,"es",{sensitivity:"base"}));
DF03_STATE.currentAprRows = aprRows;
  TABLE_PAGE_STATE["r19_fa_apr"] = 1;

  // Actualizar badge del reporte según # de aprendices (registros)
  DF03_STATE.lastResultCount = agg.apr.size;
  refreshNavBadges();

  // Preservar búsqueda previa
  const faSearch = document.getElementById("faAprSearch");
  if(faSearch){
    faSearch.value = DF03_STATE.aprSearchQ || "";
  }

  renderFAAprTable();
}


// Initial Date
document.getElementById("cutoffDate").valueAsDate = new Date();
renderRequiredChecklist(document.getElementById("fileInput").files);


initFichaAcumulativaUI();

initDF03StartUI();
syncFichaAcumulativaNav();


// Inicializa herramientas de tabla
renderNivelButtons();
renderProgEspButtons();
renderYearDropdown();
updateTableToolsUI();
const _searchEl = document.getElementById("tableSearch");
if(_searchEl){
  _searchEl.addEventListener("input", () => {
    TABLE_SEARCH_Q = _searchEl.value || "";
    TABLE_PAGE_STATE[ACTIVE_REPORT_ID] = 1;
    // Re-render current view to update table + KPIs
    renderTable(REPORTS[ACTIVE_REPORT_ID]);
    renderStats(REPORTS[ACTIVE_REPORT_ID]);
    renderCharts(REPORTS[ACTIVE_REPORT_ID]);
  });
}


// Apply filters re-render
document.getElementById("btnApplyFilters").addEventListener("click", () => {
  // Recalculate atraso days based on new date
  RAW_DATA.forEach(row => {
    row.diasAtraso = calcDiasAtraso(row.fechaFinRaw);
  });

  // SAT: aplicar filtros NO debe registrar un nuevo corte (para no sobrescribir historia/persistencia).
  // Solo actualiza la fecha de corte para recálculos dependientes de fecha.
  SAT_CONTEXT.curDate = satCutoffKey();

  setActiveReport(ACTIVE_REPORT_ID);
  refreshNavBadges();
});

// Clear links for filters (diseño "Limpiar")
(function(){
  const btnNivel = document.getElementById("clearNivel");
  const btnProg = document.getElementById("clearProgEsp");
  if(btnNivel){
    btnNivel.addEventListener("click", () => {
      // Reset: seleccionar todos los niveles (equivale a no restringir)
      const all = new Set(NIVEL_OPTIONS.map(o => o.label));
      setNivelFilters(ACTIVE_REPORT_ID, all);
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
    });
  }
  if(btnProg){
    btnProg.addEventListener("click", () => {
      // Reset: sin filtro de programa especial
      setProgEspFilters(ACTIVE_REPORT_ID, new Set());
      setActiveReport(ACTIVE_REPORT_ID);
      refreshNavBadges();
    });
  }
})();

</script>
</body>
</html>
